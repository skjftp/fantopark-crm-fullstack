<!-- CRM Version:FIELD-MAPPING-FIXED-20250630 -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FanToPark CRM Pro</title>

<!-- Add this COMPREHENSIVE PERFORMANCE OPTIMIZATION script -->
<script>
// COMPREHENSIVE DASHBOARD PERFORMANCE OPTIMIZATION
(function() {
  'use strict';
  
  console.log('🚀 Loading comprehensive performance optimizations...');
  
  // ===============================================
  // 1. SCRIPT LOADING OPTIMIZATION
  // ===============================================
  
  // Defer non-critical scripts until after dashboard loads
  window.deferredScripts = [
    'components/stadium-form.js',
    'components/payment-post-service-form.js', 
    'components/edit-order-form.js',
    'components/client-detail-modal.js',
    'components/gst-invoice-preview.js',
    'components/bulk-assign-modal.js',
    'components/choice-modal.js',
    'components/status-progress-modal.js',
    'components/allocation-management.js',
    'components/help-guide.js',
    'components/quote-upload-modal.js',
    'components/delivery-utils.js'
  ];
  
  window.loadDeferredScripts = function() {
    console.log('📦 Loading deferred scripts...');
    window.deferredScripts.forEach(src => {
      const script = document.createElement('script');
      script.src = src;
      script.async = true;
      document.head.appendChild(script);
    });
  };
  
  // Load deferred scripts after dashboard is ready
  setTimeout(window.loadDeferredScripts, 5000);
  
  // ===============================================
  // 2. DATA PROCESSING OPTIMIZATION  
  // ===============================================
  
  // Cache expensive calculations
  let calculationCache = new Map();
  let lastDataHash = '';
  
  window.getOptimizedDashboardData = function() {
    const leads = window.leads || [];
    const currentHash = leads.length + '-' + (leads[0]?.id || '') + '-' + window.dashboardFilter + '-' + window.selectedSalesPerson + '-' + window.selectedEvent;
    
    // Return cached result if data hasn't changed
    if (currentHash === lastDataHash && calculationCache.has('dashboardData')) {
      console.log('📋 Using cached dashboard calculations');
      return calculationCache.get('dashboardData');
    }
    
    console.log('🔄 Calculating fresh dashboard data...');
    
    // Optimized filtering with early returns
    let filteredLeads = leads;
    
    if (window.dashboardFilter === 'salesPerson' && window.selectedSalesPerson) {
      const selectedUser = window.users?.find(user => user.id === window.selectedSalesPerson);
      if (selectedUser) {
        filteredLeads = leads.filter(lead => lead.assigned_to === selectedUser.email);
      }
    } else if (window.dashboardFilter === 'event' && window.selectedEvent) {
      filteredLeads = leads.filter(lead => lead.lead_for_event === window.selectedEvent);
    }
    
    // Batch calculations
    const calculations = {
      qualified: 0,
      junk: 0, 
      hot: 0,
      warm: 0,
      cold: 0,
      hotValue: 0,
      warmValue: 0,
      coldValue: 0
    };
    
    // Single pass through data
    filteredLeads.forEach(lead => {
      const status = (lead.status || '').toLowerCase();
      const temp = (lead.temperature || lead.status || '').toLowerCase();
      const value = parseFloat(lead.potential_value) || 0;
      
      if (status === 'qualified') calculations.qualified++;
      if (status === 'junk') calculations.junk++;
      
      if (temp === 'hot') {
        calculations.hot++;
        calculations.hotValue += value;
      } else if (temp === 'warm') {
        calculations.warm++;
        calculations.warmValue += value;
      } else if (temp === 'cold') {
        calculations.cold++;
        calculations.coldValue += value;
      }
    });
    
    // Cache the results
    calculationCache.set('dashboardData', calculations);
    lastDataHash = currentHash;
    
    return calculations;
  };
  
  // ===============================================
  // 3. OPTIMIZED CHART CREATION
  // ===============================================
  
  window.createOptimizedCharts = function() {
    const startTime = performance.now();
    console.log('🎨 Creating optimized charts...');
    
    const data = window.getOptimizedDashboardData();
    
    // Check if Chart.js is ready
    if (typeof Chart === 'undefined') {
      console.log('⏳ Chart.js not ready, deferring...');
      setTimeout(window.createOptimizedCharts, 200);
      return;
    }
    
    // Get canvases with single DOM query
    const canvases = {
      leadSplit: document.getElementById('leadSplitChart'),
      tempCount: document.getElementById('tempCountChart'), 
      tempValue: document.getElementById('tempValueChart')
    };
    
    // Verify all canvases exist
    if (!canvases.leadSplit || !canvases.tempCount || !canvases.tempValue) {
      console.log('⏳ Chart canvases not ready, deferring...');
      setTimeout(window.createOptimizedCharts, 200);
      return;
    }
    
    // Destroy existing charts efficiently
    Object.values(canvases).forEach(canvas => {
      const existingChart = Chart.getChart(canvas);
      if (existingChart) existingChart.destroy();
    });
    
    // Create all charts with minimal options for speed
    const commonOptions = {
      responsive: true,
      maintainAspectRatio: false,
      animation: false, // Disable animations for speed
      plugins: { legend: { position: 'bottom' } }
    };
    
    try {
      // Chart 1: Lead Split (simplified)
      new Chart(canvases.leadSplit, {
        type: 'doughnut',
        data: {
          labels: [`Qualified (${data.qualified})`, `Junk (${data.junk})`],
          datasets: [{
            data: [data.qualified, data.junk],
            backgroundColor: ['#10b981', '#ef4444'],
            borderWidth: 0 // Remove borders for speed
          }]
        },
        options: commonOptions
      });
      
      // Chart 2: Temperature Count
      new Chart(canvases.tempCount, {
        type: 'doughnut',
        data: {
          labels: [`Hot (${data.hot})`, `Warm (${data.warm})`, `Cold (${data.cold})`],
          datasets: [{
            data: [data.hot, data.warm, data.cold],
            backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6'],
            borderWidth: 0
          }]
        },
        options: commonOptions
      });
      
      // Chart 3: Temperature Value
      new Chart(canvases.tempValue, {
        type: 'doughnut',
        data: {
          labels: ['Hot Value', 'Warm Value', 'Cold Value'],
          datasets: [{
            data: [data.hotValue, data.warmValue, data.coldValue],
            backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6'],
            borderWidth: 0
          }]
        },
        options: {
          ...commonOptions,
          plugins: {
            ...commonOptions.plugins,
            tooltip: {
              callbacks: {
                label: (context) => `${context.label}: ₹${context.raw.toLocaleString('en-IN')}`
              }
            }
          }
        }
      });
      
      const endTime = performance.now();
      console.log(`✅ Charts created in ${(endTime - startTime).toFixed(2)}ms`);
      
    } catch (error) {
      console.error('❌ Chart creation failed:', error);
    }
  };
  
  // ===============================================
  // 4. OPTIMIZED UPDATE FUNCTION
  // ===============================================
  
  window.updateOptimizedCharts = function() {
    const data = window.getOptimizedDashboardData();
    
    // Batch update all charts
    const updates = [
      {
        id: 'leadSplitChart',
        labels: [`Qualified (${data.qualified})`, `Junk (${data.junk})`],
        data: [data.qualified, data.junk]
      },
      {
        id: 'tempCountChart', 
        labels: [`Hot (${data.hot})`, `Warm (${data.warm})`, `Cold (${data.cold})`],
        data: [data.hot, data.warm, data.cold]
      },
      {
        id: 'tempValueChart',
        data: [data.hotValue, data.warmValue, data.coldValue]
      }
    ];
    
    updates.forEach(({ id, labels, data }) => {
      const canvas = document.getElementById(id);
      if (canvas) {
        const chart = Chart.getChart(canvas);
        if (chart) {
          if (labels) chart.data.labels = labels;
          chart.data.datasets[0].data = data;
          chart.update('none'); // No animation for speed
        }
      }
    });
  };
  
  // ===============================================
  // 5. LAZY LOADING SYSTEM
  // ===============================================
  
  window.initializeDashboardLazy = function() {
    // Only initialize if on dashboard tab
    if (window.activeTab !== 'dashboard') return;
    
    console.log('🎯 Lazy initializing dashboard...');
    
    // Use requestIdleCallback for non-blocking execution
    const runWhenIdle = (callback) => {
      if (window.requestIdleCallback) {
        requestIdleCallback(callback, { timeout: 2000 });
      } else {
        setTimeout(callback, 100);
      }
    };
    
    runWhenIdle(() => {
      if (window.leads && window.leads.length > 0) {
        window.createOptimizedCharts();
      } else {
        // Wait for data
        const checkData = () => {
          if (window.leads && window.leads.length > 0) {
            window.createOptimizedCharts();
          } else {
            setTimeout(checkData, 200);
          }
        };
        checkData();
      }
    });
  };
  
  // ===============================================
  // 6. REPLACE EXISTING FUNCTIONS
  // ===============================================
  
  // Override existing chart functions
  window.createDashboardCharts = window.createOptimizedCharts;
  window.updateChartsWithData = window.updateOptimizedCharts;
  window.initializeDashboardCharts = window.initializeDashboardLazy;
  window.initializeOptimizedCharts = window.createOptimizedCharts;
  
  // Clear caches when data changes
  const originalSetLeads = window.appState?.setLeads;
  if (originalSetLeads) {
    window.appState.setLeads = function(leads) {
      calculationCache.clear();
      lastDataHash = '';
      return originalSetLeads(leads);
    };
  }
  
  console.log('✅ Performance optimizations loaded');
  
  // Auto-initialize if already on dashboard
  setTimeout(() => {
    if (window.activeTab === 'dashboard' || !window.activeTab) {
      window.initializeDashboardLazy();
    }
  }, 1000);
  
})();
</script>  

<script>
// COMPREHENSIVE API CALL CONSOLIDATION
(function() {
  'use strict';
  
  console.log('🔄 Implementing comprehensive API call consolidation...');
  
  // Global flag to prevent multiple simultaneous data fetches
  let isDataFetching = false;
  let dataFetchPromise = null;
  
  // Store original functions
  const originalFetchData = window.renderAppBusinessLogic()?.fetchData;
  const originalFetchMyActions = window.fetchMyActions;
  
  // Consolidated data fetching function
  window.consolidatedDataFetch = async function() {
    // Prevent multiple simultaneous fetches
    if (isDataFetching) {
      console.log('📋 Data fetch already in progress, returning existing promise');
      return dataFetchPromise;
    }
    
    if (!window.isLoggedIn) {
      console.log('❌ Not logged in, skipping data fetch');
      return;
    }
    
    isDataFetching = true;
    console.log('🚀 Starting consolidated data fetch...');
    
    dataFetchPromise = (async () => {
      try {
        // Fetch all core data once
        const [leadsData, inventoryData, ordersData, invoicesData, deliveriesData, clientsData, usersData, stadiumsData] = await Promise.all([
          window.apiCall('/leads').catch(() => ({ data: [] })),
          window.apiCall('/inventory').catch(() => ({ data: [] })),
          window.apiCall('/orders').catch(() => ({ data: [] })),
          window.apiCall('/invoices').catch(() => ({ data: [] })),
          window.apiCall('/deliveries').catch(() => ({ data: [] })),
          window.apiCall('/clients').catch(() => ({ data: [] })),
          window.apiCall('/users').catch(() => ({ data: [] })),
          window.apiCall('/stadiums').catch(() => ({ data: [] }))
        ]);
        
        console.log('✅ All API calls completed, updating state...');
        
        // Update all state at once
        if (window.appState?.setLeads) window.appState.setLeads(leadsData.data || []);
        if (window.appState?.setInventory) window.appState.setInventory(inventoryData.data || []);
        if (window.appState?.setOrders) window.appState.setOrders(ordersData.data || []);
        if (window.appState?.setInvoices) window.appState.setInvoices(invoicesData.data || []);
        if (window.appState?.setDeliveries) window.appState.setDeliveries(deliveriesData.data || []);
        if (window.appState?.setClients) window.appState.setClients(clientsData.data || []);
        if (window.appState?.setUsers) window.appState.setUsers(usersData.data || []);
        if (window.appState?.setStadiums) window.appState.setStadiums(stadiumsData.data || []);
        
        // Update window globals
        window.leads = leadsData.data || [];
        window.inventory = inventoryData.data || [];
        window.orders = ordersData.data || [];
        window.users = usersData.data || [];
        window.allUsers = usersData.data || [];
        
        console.log('✅ Consolidated data fetch completed successfully');
        
      } catch (error) {
        console.error('❌ Consolidated data fetch failed:', error);
      } finally {
        isDataFetching = false;
        dataFetchPromise = null;
      }
    })();
    
    return dataFetchPromise;
  };
  
  // Override the original functions to use consolidated fetch
  if (originalFetchData) {
    window.renderAppBusinessLogic().fetchData = function() {
      console.log('🔄 fetchData called - routing to consolidated fetch');
      return window.consolidatedDataFetch();
    };
  }
  
  if (originalFetchMyActions) {
    window.fetchMyActions = function() {
      console.log('🔄 fetchMyActions called - using existing data + filtering');
      
      // If data is already loaded, just process it
      if (window.leads && window.leads.length > 0) {
        // Process My Actions data from already loaded data
        if (originalFetchMyActions) {
          return originalFetchMyActions();
        }
      } else {
        // If no data, fetch it first
        return window.consolidatedDataFetch().then(() => {
          if (originalFetchMyActions) {
            return originalFetchMyActions();
          }
        });
      }
    };
  }
  
  // Single initialization function
  window.initializeAppData = function() {
    if (!window.isLoggedIn) return;
    
    console.log('🎯 Initializing app data (single call)');
    return window.consolidatedDataFetch();
  };
  
  // Override useEffect to prevent multiple calls
  let isInitialized = false;
  
  const originalUseEffect = React.useEffect;
  React.useEffect = function(callback, deps) {
    // Intercept data fetching useEffects
    const callbackString = callback.toString();
    
    if (callbackString.includes('fetchData') && !isInitialized) {
      console.log('🛑 Intercepting fetchData useEffect - using consolidated approach');
      
      const newCallback = () => {
        if (window.isLoggedIn && !isInitialized) {
          isInitialized = true;
          window.initializeAppData();
        }
      };
      
      return originalUseEffect(newCallback, [window.isLoggedIn]);
    }
    
    // Allow other useEffects to run normally
    return originalUseEffect(callback, deps);
  };
  
  console.log('✅ API call consolidation system enabled');
  
})();
</script> 

<!-- PERFORMANCE OPTIMIZATION SCRIPTS - PLACE FIRST -->
<script> 
(function() {
  'use strict';
  
  const originalLog = console.log;
  
  // Comprehensive patterns to suppress
  const suppressPatterns = [
    // Emojis
    '✅', '🔍', '📊', '🔄', '🎯', '🚀', '❌', '🎉', '📈', '🔧', '🎫', '📝', '📋', '🚚', '🔥',
    
    // Component loading messages
    'component loaded successfully',
    'All app effects initialized',
    'loaded successfully',
    'Performance Optimized',
    'COMPREHENSIVE FIXES APPLIED',
    'FIXED:', 'ENHANCED:',
    
    // Debug messages
    'showAllocationManagement:',
    'allocationManagementInventory:',
    'currentAllocations count:',
    'Not showing allocation management',
    'Not showing delivery form',
    'Bulk Assign Modal',
    'ALLOCATION MANAGEMENT DEBUG',
    'DELIVERY FORM DEBUG',
    'Rendering Enhanced Recent Activity',
    'Auto-updated orders pagination',
    'Chart initialization useEffect triggered',
    'Canvas elements found:',
    'Attempting to initialize charts',
    'Fetched 14 users',
    'useEffect triggered - activeTab:',
    'Test mode state:',
    'Current user:',
    'Is super admin:',
    'User object:',
    'Super admin logged in',
    
    // Available commands
    'Available commands:',
    'To test:',
    'Debug:',
    'form-handlers.js loaded',
    'Payment handler functions added',
    'Applying chart initialization fix',
    'Emergency chart patch loaded',
    'Test mode functions loaded'
  ];
  
  console.log = function(...args) {
    const message = String(args[0] || '');
    const shouldSuppress = suppressPatterns.some(pattern => 
      message.includes(pattern)
    );
    if (!shouldSuppress) {
      originalLog.apply(console, args);
    }
  };
  
  window.toggleDebugLogs = function(enabled = true) {
    console.log = enabled ? originalLog : console.log;
    originalLog(enabled ? '🔧 All logs enabled' : '🔇 Debug logs filtered');
  };
  
  originalLog('🔇 Enhanced console filter activated');
})(); 
  
  
// 1. Global debug control - Set to true to disable all logs
window.PRODUCTION_MODE = true;
window.debugLog = window.PRODUCTION_MODE ? () => {} : console.log;

// 2. Emergency Performance Fixes
(function() {
  'use strict';
  
  
  // GLOBAL LOG SUPPRESSION
  window.EMERGENCY_MODE = true;
  
  // Override console.log for specific patterns
  const originalLog = console.log;
  const logCounts = {};
  const MAX_SAME_LOGS = 3;
  
  console.log = function(...args) {
    if (window.EMERGENCY_MODE) {
      const message = args.join(' ');
      
      // Suppress excessive debug patterns
      const suppressPatterns = [
        '🔍 DEBUGGING STATE SETTERS',
        'state.setShowInventoryForm:',
        'state.setEditingInventory:',
        'state.setShowAllocationManagement:',
        'Available inventory-related setters:',
        '🔍 ALLOCATION FORM DEBUG:',
        '🔍 DELIVERY FORM DEBUG:',
        '❌ Not showing allocation form:',
        'chart not found',
        'Chart not found!'
      ];
      
      // Check if this log should be suppressed
      const shouldSuppress = suppressPatterns.some(pattern => 
        message.includes(pattern)
      );
      
      if (shouldSuppress) {
        // Count this log
        const key = args[0] || 'unknown';
        logCounts[key] = (logCounts[key] || 0) + 1;
        
        // Only allow first few instances
        if (logCounts[key] <= MAX_SAME_LOGS) {
          originalLog.apply(console, args);
          
          if (logCounts[key] === MAX_SAME_LOGS) {
            originalLog(`🚨 [SUPPRESSED] Further "${key}" logs suppressed to improve performance`);
          }
        }
        return;
      }
    }
    
    // Allow other logs through
    originalLog.apply(console, args);
  };
  
  // CHART ERROR SUPPRESSION
  const originalError = console.error;
  const errorCounts = {};
  
  console.error = function(...args) {
    const message = args.join(' ');
    
    // Suppress chart-related errors that are spamming
    if (message.includes('chart') && message.includes('not found')) {
      const key = 'chart-not-found';
      errorCounts[key] = (errorCounts[key] || 0) + 1;
      
      if (errorCounts[key] <= 1) {
        originalError('⚠️ Chart containers not ready - will retry automatically');
      }
      return;
    }
    
    // Allow other errors through
    originalError.apply(console, args);
  };
  
  // PREVENT COMPONENT SPAM
  window._componentLogSuppressionFlags = {};
  
  window.suppressComponentLog = function(componentName, message) {
    const key = `${componentName}-${message}`;
    
    if (!window._componentLogSuppressionFlags[key]) {
      console.log(`📋 ${componentName}: ${message}`);
      window._componentLogSuppressionFlags[key] = true;
      
      // Auto-reset after 30 seconds
      setTimeout(() => {
        delete window._componentLogSuppressionFlags[key];
      }, 30000);
    }
  };
  
  // THROTTLE STATE UPDATES
  window._stateUpdateThrottle = {};
  
  window.throttledStateUpdate = function(key, updateFunction, delay = 100) {
    if (window._stateUpdateThrottle[key]) {
      clearTimeout(window._stateUpdateThrottle[key]);
    }
    
    window._stateUpdateThrottle[key] = setTimeout(() => {
      updateFunction();
      delete window._stateUpdateThrottle[key];
    }, delay);
  };
  
  // HANDLE BROWSER EXTENSION ERRORS
  window.addEventListener('error', function(e) {
    // Suppress extension-related errors
    if (e.filename && (
      e.filename.includes('content_script') ||
      e.filename.includes('extension') ||
      e.message.includes('toString')
    )) {
      e.preventDefault();
      return false;
    }
  });
  
  // CHART INITIALIZATION FIX
  window.safeChartInit = function() {
    if (window._chartInitAttempted) return;
    window._chartInitAttempted = true;
    
    const checkAndInit = () => {
      const containers = ['leadSplitChart', 'tempCountChart', 'tempValueChart'];
      const allReady = containers.every(id => document.getElementById(id));
      
      if (allReady && typeof Chart !== 'undefined') {
        try {
          // Only log success
          if (window.initializeCharts) {
            window.initializeCharts();
            console.log('✅ Charts initialized successfully');
          }
        } catch (error) {
          console.error('❌ Chart initialization failed:', error.message);
        }
      } else {
        // Don't spam retry messages
        setTimeout(checkAndInit, 1000);
      }
    };
    
    checkAndInit();
  };
  
  // PERFORMANCE TRACKER
  window.performanceTracker = {
    _operations: {},
    
    start: function(name) {
      this._operations[name] = performance.now();
    },
    
    end: function(name) {
      if (this._operations[name]) {
        const duration = performance.now() - this._operations[name];
        if (duration > 200) { // Only log slow operations
          console.warn(`⚠️ Slow: ${name} took ${duration.toFixed(2)}ms`);
        }
        delete this._operations[name];
      }
    }
  };
  
  // AUTO-CLEANUP
  window.addEventListener('beforeunload', function() {
    // Clear all timeouts
    Object.values(window._stateUpdateThrottle || {}).forEach(timeout => {
      clearTimeout(timeout);
    });
    
    // Reset flags
    window._componentLogSuppressionFlags = {};
    logCounts = {};
    errorCounts = {};
  });
  
  
})();
</script>

<!-- React and Dependencies -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

  <!-- External Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Load all constant files -->
<script src="constants/config.js"></script>
<script src="constants/status-config.js"></script>
<script src="constants/user-roles.js"></script>
<script src="constants/form-config.js"></script>
<script src="constants/default-data.js"></script>

<!-- Utility Functions -->
<script src="utils/api.js"></script>
<script src="utils/permissions.js"></script>
<script src="utils/helpers.js"></script>
<script src="utils/indian-format.js"></script>  

<!-- Component Files -->

<script src="components/leads.js"></script>
<script src="components/dashboard.js"></script> 
<!-- New Extracted Components -->
<script src="components/main-app-component.js"></script>
<script src="components/app-business-logic.js"></script>
<script src="components/app-effects-lifecycle.js"></script>
<script src="components/simplified-app-component.js"></script>
  
<script src="components/content-router.js"></script>
<script src="components/inventory.js"></script>
<script src="components/financials.js"></script>
<script src="components/orders.js"></script> 
<script src="components/user-management.js"></script>
<script defer src="components/assignment-rules.js"></script>
<script defer src="components/my-actions.js"></script>  
<script defer src="components/stadiums.js"></script> 
<script defer src="components/delivery.js"></script>
<script defer src="components/sports-calendar.js"></script> 
<script defer src="components/reminders.js"></script>
<script defer src="components/inventory-form.js"></script>
<script defer src="components/lead-form.js"></script> 
<script src="components/lead-detail.js"></script>
<script defer src="components/payment-form.js"></script>
<script defer src="components/inventory-detail.js"></script>
<script defer src="components/order-detail-modal.js"></script>
<script src="components/user-form.js"></script>
<script defer src="components/gst-invoice-preview.js"></script>
<script defer src="components/assign-form.js"></script>
<script defer src="components/bulk-assign-modal.js"></script>
<script defer src="components/choice-modal.js"></script> 
<script defer src="components/status-progress-modal.js"></script>
<script defer src="components/allocation-management.js"></script>
<script defer src="components/help-guide.js"></script>  
<script defer src="components/stadium-form.js"></script>
<script defer src="components/payment-post-service-form.js"></script>
<script defer src="components/edit-order-form.js"></script>
<script defer src="components/client-detail-modal.js"></script>
<script defer src="components/payment-submit-handler.js"></script>
<script defer src="components/inventory-form-submit-handler.js"></script>
<script defer src="components/delete-handler.js"></script>
<script src="components/test-mode-system.js"></script>
<script defer src="components/csv-upload-system.js"></script>
<script defer src="components/form-handlers.js"></script>
<script defer src="components/gst-calculation-system.js"></script>
<script defer src="components/communication-system.js"></script>
<script src="components/chart-system.js"></script>
<script src="components/financial-system.js"></script>
<script defer src="components/lead-status-management.js"></script>
<script defer src="components/my-actions-data.js"></script>
<script src="components/user-management-handlers.js"></script>
<script defer src="components/reminder-management.js"></script>
<script defer src="components/allocation-form.js"></script>  
<script defer src="components/delivery-form.js"></script>
<script defer src="components/event-modals.js"></script>
<script defer src="components/reminder-form.js"></script> 
<script defer src="components/enhanced-recent-activity.js"></script>
<script defer src="components/quote-upload-modal.js"></script>
<script defer src="components/delivery-utils.js"></script>  
   


  
<script>
  // ===== FINANCIALS DISPLAY FIX FOR INDIAN FORMAT =====
// Add this script to fix the financial dashboard numbers

// Step 1: Override the renderEnhancedFinancialStats function
window.renderEnhancedFinancialStats = () => {
    const metrics = window.calculateEnhancedFinancialMetrics();

    const statsCards = [
        {
            title: 'Total Sales',
            value: window.formatCurrency(metrics.totalSales), // ✅ Use Indian format
            change: '+12.5%',
            changeType: 'positive',
            icon: '📈'
        },
        {
            title: 'Total Active Sales',
            value: metrics.activeSalesCount.toString(),
            change: '+5.2%',
            changeType: 'positive',
            icon: '🎯'
        },
        {
            title: 'Total Receivables',
            value: window.formatCurrency(metrics.totalReceivables), // ✅ Use Indian format
            change: '-2.1%',
            changeType: 'negative',
            icon: '💰'
        },
        {
            title: 'Total Payables',
            value: window.formatCurrency(metrics.totalPayables), // ✅ Use Indian format
            change: '+8.3%',
            changeType: 'negative',
            icon: '💸'
        },
        {
            title: 'Total Margin',
            value: window.formatCurrency(metrics.totalMargin), // ✅ Use Indian format
            change: '+15.7%',
            changeType: 'positive',
            icon: '📊'
        },
        {
            title: 'Margin %',
            value: `${metrics.marginPercentage}%`,
            change: '+2.3%',
            changeType: 'positive',
            icon: '📈'
        }
    ];

    return React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-6' },
        statsCards.map((stat, index) =>
            React.createElement('div', { 
                key: index,
                className: 'bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow'
            },
                React.createElement('div', { className: 'flex items-center justify-between' },
                    React.createElement('div', null,
                        React.createElement('p', { className: 'text-sm font-medium text-gray-600 dark:text-gray-400' }, stat.title),
                        React.createElement('p', { className: 'text-2xl font-bold text-gray-900 dark:text-white mt-1' }, stat.value)
                    ),
                    React.createElement('div', { className: 'text-2xl' }, stat.icon)
                ),
                React.createElement('div', { className: 'flex items-center mt-4' },
                    React.createElement('span', {
                        className: `text-sm font-medium ${
                            stat.changeType === 'positive' ? 'text-green-600' : 'text-red-600'
                        }`
                    }, stat.change),
                    React.createElement('span', { className: 'text-sm text-gray-500 ml-2' }, 'vs last month')
                )
            )
        )
    );
};

// Step 2: Force refresh the financial display
window.forceFinancialRefresh = function() {
    console.log('🔄 Forcing financial display refresh with Indian formatting...');
    
    // Trigger re-render of the financials component
    if (window.setActiveTab && window.activeTab === 'financials') {
        // Force a re-render by switching tabs and back
        window.setActiveTab('dashboard');
        setTimeout(() => {
            window.setActiveTab('financials');
        }, 100);
    } else {
        // Or just reload financial data
        if (window.loadFinancialData) {
            window.loadFinancialData();
        }
    }
};

console.log('✅ Financials display fix loaded - Indian formatting will be applied');

// Auto-refresh when this script loads
setTimeout(() => {
    window.forceFinancialRefresh();
}, 500);
</script>
  
<script>
// Login Performance Optimization
window.optimizeLoginPerformance = function() {
  // Debounce component re-renders during login
  const originalSetState = window.setState;
  let loginOptimizationActive = false;
  
  // Detect login process
  const originalSetIsLoggedIn = window.setIsLoggedIn;
  if (originalSetIsLoggedIn) {
    window.setIsLoggedIn = function(value) {
      if (value) {
        loginOptimizationActive = true;
        
        // Disable optimization after 3 seconds
        setTimeout(() => {
          loginOptimizationActive = false;
          
        }, 3000);
      }
      
      return originalSetIsLoggedIn(value);
    };
  }
  
  // Reduce component logging during login
  const componentLoggers = [
    'suppressComponentLog',
    'allocLog', 
    'deliveryLog',
    'dashLog'
  ];
  
  componentLoggers.forEach(loggerName => {
    if (window[loggerName]) {
      const originalLogger = window[loggerName];
      window[loggerName] = function(...args) {
        if (!loginOptimizationActive) {
          return originalLogger.apply(this, args);
        }
        // Suppress during login
      };
    }
  });
};

// Apply optimization
window.optimizeLoginPerformance();

</script>  

<!-- CSS Styles -->
<style>
/* Global Styles */
.dark {
  color-scheme: dark;
}

.sidebar-container {
  position: relative;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.sidebar-content {
  flex: 1;
  overflow-y: auto;
}

.sidebar-bottom {
  margin-top: auto;
  padding: 1rem;
  border-top: 1px solid #e5e7eb;
}

/* Dark mode styles */
.dark .sidebar-bottom {
  border-top-color: #374151;
}

/* Sidebar logout section adjustments */
.sidebar-logout {
  position: sticky;
  bottom: 0;
  background: inherit;
  padding: 1rem;
  border-top: 1px solid #e5e7eb;
}

.dark .sidebar-logout {
  border-top-color: #374151;
}

/* For mobile responsiveness */
@media (max-width: 768px) {
  .sidebar-container {
    height: auto;
    min-height: 100vh;
  }
}

/* Scrollbar styling */
.sidebar-content::-webkit-scrollbar {
  width: 4px;
}

.sidebar-content::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.sidebar-content::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 2px;
}

.sidebar-content::-webkit-scrollbar-thumb:hover {
  background: #555;
}

/* Dark mode scrollbar */
.dark .sidebar-content::-webkit-scrollbar-track {
  background: #374151;
}

.dark .sidebar-content::-webkit-scrollbar-thumb {
  background: #6b7280;
}

/* Prevent sidebar overlap issues */
.sidebar-navigation {
  overflow: visible !important;
  position: static !important;
}

/* Fix for modal z-index issues */
.modal-backdrop {
  z-index: 1000;
}

.modal-content {
  z-index: 1001;
}

/* Hide scrollbar for Chrome, Safari and Opera */
.no-scrollbar::-webkit-scrollbar {
  display: none;
}

/* Hide scrollbar for IE, Edge and Firefox */
.no-scrollbar {
  -ms-overflow-style: none;  /* IE and Edge */
  scrollbar-width: none;  /* Firefox */
}

/* Additional overflow and positioning fixes */
.sidebar-container {
  position: relative;
  overflow: visible;
}

.sidebar-container .fixed {
  position: relative !important;
}

.sidebar-container .absolute {
  position: relative !important;
}

/* Prevent negative margins and overlaps */
.sidebar-container > div {
  margin: 0 !important;
}

/* Ensure content doesn't get cut off */
.sidebar-content {
  padding-bottom: 80px; /* Make room for logout button */
}

/* Position logout area properly */
.sidebar-logout {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: inherit;
}

/* Override any problematic positioning */
.sidebar-container .bottom-0 {
  position: static !important;
}

.sidebar-container .left-0 {
  position: static !important;
}

.sidebar-container .right-0 {
  position: static !important;
}

/* Dark theme logout area */
.dark .sidebar-logout {
  background: #1f2937;
  border-top: 1px solid #374151;
}

/* Light theme logout area */
.sidebar-logout {
  background: white;
  border-top: 1px solid #e5e7eb;
}

/* Fix overflow issues in the container */
.sidebar-container {
  overflow-x: hidden;
  overflow-y: visible;
}

/* Make sure navigation doesn't get hidden */
.sidebar-navigation {
  position: relative;
  z-index: 1;
}

/* Logout button positioning */
.sidebar-logout {
  position: relative;
  z-index: 2;
}

/* Responsive fixes */
@media (min-width: 1024px) {
  .sidebar-container {
    height: 100vh;
    position: sticky;
    top: 0;
  }
}

/* Fix for small screens */
@media (max-width: 1023px) {
  .sidebar-logout {
    position: relative;
    margin-top: 2rem;
  }
  
  .sidebar-content {
    padding-bottom: 0;
  }
}

/* Additional positioning fixes */
.sidebar-container > div:last-child {
  margin-top: auto;
}

/* Override any transform or positioning that might cause issues */
.sidebar-container * {
  transform: none !important;
}

.sidebar-container .transform {
  transform: none !important;
}

/* Ensure proper layout flow */
.sidebar-container {
  display: flex;
  flex-direction: column;
}

.sidebar-navigation {
  flex: 1;
  min-height: 0;
}

.sidebar-logout {
  flex-shrink: 0;
}

/* More specific positioning override */
.sidebar-container [style*="position: fixed"],
.sidebar-container [style*="position: absolute"] {
  position: relative !important;
  top: auto !important;
  left: auto !important;
  right: auto !important;
  bottom: auto !important;
}

/* Force relative positioning for problematic elements */
.sidebar-container .absolute,
.sidebar-container .fixed {
  position: relative !important;
  inset: auto !important;
}

/* Alternative approach - hide problematic positioning */
.sidebar-container > div[class*="fixed"],
.sidebar-container > div[class*="absolute"] {
  position: relative !important;
  top: unset !important;
  left: unset !important;
  right: unset !important;
  bottom: unset !important;
}

/* Make logout area visible and prevent hiding */
.sidebar-logout {
  visibility: visible !important;
  display: block !important;
  opacity: 1 !important;
  position: relative !important;
  transform: none !important;
  top: auto !important;
  left: auto !important;
  right: auto !important;
  bottom: auto !important;
  margin-left: 0 !important;
  margin-right: 0 !important;
}

/* Ensure container doesn't hide content */
.sidebar-container {
  max-height: none !important;
  height: auto !important;
  min-height: 100vh;
  overflow: visible !important;
}

/* Force visibility for navigation items */
.sidebar-navigation > * {
  visibility: visible !important;
  position: relative !important;
}

/* Specific fix for logout button container */
.sidebar-container > div:has(.sidebar-logout),
.sidebar-container > div[class*="logout"] {
  position: relative !important;
  visibility: visible !important;
  display: block !important;
}

/* Last resort - force display */
.sidebar-logout,
.sidebar-logout * {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  position: relative !important;
  z-index: 999 !important;
}

/* Alternative container structure fix */
.sidebar-container {
  position: relative !important;
  display: flex !important;
  flex-direction: column !important;
  height: 100vh !important;
  overflow: visible !important;
}

.sidebar-navigation {
  flex: 1 !important;
  overflow-y: auto !important;
  position: relative !important;
}

.sidebar-logout {
  flex-shrink: 0 !important;
  position: relative !important;
  margin-top: auto !important;
}

/* Prevent any CSS that might hide the logout */
.sidebar-container * {
  max-height: none !important;
  overflow: visible !important;
}

/* Ensure proper spacing */
.sidebar-logout {
  padding: 1rem !important;
  margin: 0 !important;
  border-top: 1px solid #e5e7eb !important;
}

.dark .sidebar-logout {
  border-top-color: #374151 !important;
}

/* Remove any transforms or positions that could cause issues */
.sidebar-container * {
  position: static !important;
  transform: none !important;
  left: auto !important;
  right: auto !important;
  top: auto !important;
  bottom: auto !important;
}

/* Exception for the specific layout we want */
.sidebar-container {
  position: relative !important;
  display: flex !important;
  flex-direction: column !important;
}

.sidebar-logout {
  position: relative !important;
  margin-top: auto !important;
}

/* Force visibility for all sidebar elements */
.sidebar-container,
.sidebar-container *,
.sidebar-navigation,
.sidebar-navigation *,
.sidebar-logout,
.sidebar-logout * {
  visibility: visible !important;
  display: block !important;
  opacity: 1 !important;
}

.sidebar-container button,
.sidebar-logout button {
  display: inline-flex !important;
}

/* Ensure no content is cut off */
.sidebar-container {
  min-height: 100vh !important;
  height: auto !important;
  max-height: none !important;
  overflow-y: auto !important;
  overflow-x: hidden;
}

/* Final positioning fix */
.sidebar-container > div:last-child {
  position: relative !important;
  bottom: auto !important;
  left: auto !important;
  right: auto !important;
  margin-top: auto !important;
}

/* Ensure the logout button area is always visible */
.sidebar-logout {
  background: inherit !important;
  position: relative !important;
  z-index: 10 !important;
  margin-top: auto !important;
  flex-shrink: 0 !important;
}

/* Ensure proper stacking context */
.sidebar-container {
  z-index: 1 !important;
}

.sidebar-navigation {
  z-index: 2 !important;
  flex: 1 !important;
  overflow-y: auto !important;
}

.sidebar-logout {
  z-index: 3 !important;
  flex-shrink: 0 !important;
}

/* Remove problematic CSS classes that might interfere */
.sidebar-container .fixed,
.sidebar-container .absolute,
.sidebar-container .sticky {
  position: relative !important;
}

.sidebar-container .inset-0,
.sidebar-container .top-0,
.sidebar-container .bottom-0,
.sidebar-container .left-0,
.sidebar-container .right-0 {
  top: auto !important;
  bottom: auto !important;
  left: auto !important;
  right: auto !important;
  inset: auto !important;
}

/* Override Tailwind positioning utilities specifically in sidebar */
.sidebar-container .absolute {
  position: relative !important;
}

.sidebar-container .fixed {
  position: relative !important;
}

.sidebar-container .inset-x-0 {
  left: auto !important;
  right: auto !important;
}

.sidebar-container .inset-y-0 {
  top: auto !important;
  bottom: auto !important;
}

/* Make sure logout area has proper background */
.sidebar-logout {
  background-color: inherit !important;
}

/* Dark mode background fix */
.dark .sidebar-logout {
  background-color: #1f2937 !important;
}

/* Light mode background fix */
.sidebar-logout {
  background-color: white !important;
}

/* Additional safety measures */
.sidebar-container {
  contain: layout !important;
}

.sidebar-navigation {
  contain: layout !important;
}

/* Prevent any overflow issues */
.sidebar-container {
  overflow-x: hidden !important;
  overflow-y: visible !important;
}

/* Make sure content flows properly */
.sidebar-container > * {
  position: relative !important;
  width: 100% !important;
  flex-shrink: 0 !important;
}

.sidebar-navigation {
  flex-shrink: 1 !important;
  min-height: 0 !important;
}

.sidebar-logout {
  flex-shrink: 0 !important;
}

/* Final override for any problematic styles */
.sidebar-container * [class*="absolute"],
.sidebar-container * [class*="fixed"],
.sidebar-container * [style*="position: absolute"],
.sidebar-container * [style*="position: fixed"] {
  position: relative !important;
}

/* Emergency visibility fix */
.sidebar-container,
.sidebar-navigation,
.sidebar-logout {
  visibility: visible !important;
  display: flex !important;
  flex-direction: column !important;
}

.sidebar-container button,
.sidebar-navigation button,
.sidebar-logout button {
  display: inline-flex !important;
  visibility: visible !important;
}

/* Prevent hidden overflow */
.sidebar-container,
.sidebar-navigation {
  overflow: visible !important;
}

/* One more positioning fix attempt */
.sidebar-container > div:not(.sidebar-navigation):not(.sidebar-logout) {
  position: relative !important;
}

/* Fix for flex container */
.sidebar-container {
  display: flex !important;
  flex-direction: column !important;
  height: 100vh !important;
}

.sidebar-navigation {
  flex: 1 !important;
  display: block !important;
}

.sidebar-logout {
  display: block !important;
  margin-top: auto !important;
}

/* Ensure no elements are positioned outside the container */
.sidebar-container * {
  max-width: 100% !important;
  box-sizing: border-box !important;
}

/* Prevent any negative margins */
.sidebar-container * {
  margin-left: 0 !important;
  margin-right: 0 !important;
}

/* Ensure logout button container is part of the flow */
.sidebar-logout {
  width: 100% !important;
  box-sizing: border-box !important;
  padding: 1rem !important;
}

/* Override any external positioning */
.sidebar-container [style] {
  position: relative !important;
  top: auto !important;
  left: auto !important;
  right: auto !important;
  bottom: auto !important;
  transform: none !important;
}

/* Exception for the container itself */
.sidebar-container {
  position: relative !important;
  display: flex !important;
  flex-direction: column !important;
  transform: none !important;
}

/* Specific fix for any absolutely positioned children */
.sidebar-container > div {
  position: relative !important;
  display: block !important;
  width: 100% !important;
}

/* Ensure logout section is always at the bottom but visible */
.sidebar-logout {
  order: 999 !important;
  position: relative !important;
  margin-top: auto !important;
  background: inherit !important;
  border-top: 1px solid #e5e7eb !important;
}

.dark .sidebar-logout {
  border-top-color: #374151 !important;
  background: #1f2937 !important;
}

/* Override any CSS that might be hiding content */
.sidebar-container * {
  overflow: visible !important;
  clip: none !important;
  clip-path: none !important;
}

/* Ensure all content is accessible */
.sidebar-container * {
  height: auto !important;
  min-height: 0 !important;
  max-height: none !important;
}

/* Specific height for the navigation area */
.sidebar-navigation {
  min-height: 0 !important;
  height: auto !important;
  flex: 1 !important;
}

/* Specific height for logout area */
.sidebar-logout {
  height: auto !important;
  min-height: auto !important;
  flex: none !important;
}

/* Remove any CSS that might interfere with layout */
.sidebar-container .overflow-hidden {
  overflow: visible !important;
}

.sidebar-container .h-full {
  height: auto !important;
}

.sidebar-container .w-full {
  width: 100% !important;
}

/* Force proper display properties */
.sidebar-container {
  display: flex !important;
}

.sidebar-navigation {
  display: block !important;
  flex: 1 !important;
}

.sidebar-logout {
  display: block !important;
  flex: none !important;
}

/* Final attempt - use grid layout as backup */
.sidebar-container {
  display: grid !important;
  grid-template-rows: 1fr auto !important;
  height: 100vh !important;
}

.sidebar-navigation {
  grid-row: 1 !important;
  overflow-y: auto !important;
}

.sidebar-logout {
  grid-row: 2 !important;
}

/* Revert to flex if grid doesn't work */
.sidebar-container {
  display: flex !important;
  flex-direction: column !important;
}

/* Make absolutely sure logout is visible */
.sidebar-logout {
  visibility: visible !important;
  opacity: 1 !important;
  display: block !important;
  position: relative !important;
  z-index: 9999 !important;
  background: white !important;
  border-top: 1px solid #e5e7eb !important;
  padding: 1rem !important;
  margin: 0 !important;
  width: 100% !important;
  box-sizing: border-box !important;
}

.dark .sidebar-logout {
  background: #1f2937 !important;
  border-top-color: #374151 !important;
}

/* Ensure container doesn't cut off content */
.sidebar-container {
  overflow: visible !important;
  min-height: 100vh !important;
  height: auto !important;
  position: relative !important;
}

/* Force layout recalculation if needed */
.sidebar-container::after {
  content: "";
  display: block;
  clear: both;
  height: 0;
  visibility: hidden;
}

/* Logout button area fix */
.sidebar-logout {
  margin-top: auto;
  padding: 1rem;
  border-top: 1px solid #e5e7eb;
}

.sidebar-logout button {
  width: 100%;
  max-width: 200px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  padding: 0.75rem 1rem;
  border-radius: 0.375rem;
  transition: background-color 0.2s;
}

.sidebar-logout button:hover {
  background-color: #f9fafb;
}

/* Prevent any overlay issues */
.sidebar-container > div:last-child {
  position: relative !important;
  bottom: auto !important;
  left: auto !important;
  right: auto !important;
}

.test-mode-active {
  border: 4px solid #dc2626 !important;
  box-shadow: inset 0 0 0 4px #dc2626;
}
</style>
</head>
<body>
<div id="test-mode-indicator" style="display:none; background:#dc2626; color:white; text-align:center; padding:10px; font-weight:bold;">
  🧪 TEST MODE ACTIVE - Delete All buttons enabled
</div>
<script>if(localStorage.getItem('testMode')==='true') document.getElementById('test-mode-indicator').style.display='block';</script>
<div id="root"></div>
<div id="error-message" style="position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 12px 20px; border-radius: 6px; display: none; z-index: 9999;"></div>

<!-- API Configuration and Main App Script -->
<script>
// Show previous logs on page load
window.addEventListener('load', () => {
  const logs = JSON.parse(sessionStorage.getItem('debugLogs') || '[]');
  if (logs.length > 0) {
    
    logs.forEach(log => console.log('[' + (log.time) + '] ' + (log.key) + ':', log.data));
    console.log('=== End Previous Logs ===');
  }
});

// Clear logs button (press Ctrl+Shift+L)
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.shiftKey && e.key === 'L') {
    sessionStorage.removeItem('debugLogs');
    console.log('Debug logs cleared');
  }
});

const { useState, useEffect, useRef } = React; 

window.getRoleDisplayLabel = function(roleName) {
  const roleLabels = {
    'super_admin': 'Super Admin',
    'admin': 'Admin', 
    'sales_manager': 'Sales Manager',
    'sales_executive': 'Sales Executive',
    'finance': 'Finance',
    'supply': 'Supply',
    'warehouse': 'Warehouse'
  };
  return roleLabels[roleName] || roleName;
};

// Configure API endpoint
window.handleProceedFromPreview = () => {
  if (window.currentUploadFile) {
    console.log("🚀 Starting upload with file:", window.currentUploadFile.name);

    const cancelBtn = Array.from(document.querySelectorAll("button")).find(b => b.textContent === "Cancel");
    if (cancelBtn) cancelBtn.click();

    const formData = new FormData();
    formData.append("file", window.currentUploadFile);
    fetch(window.API_CONFIG.API_URL + "/upload/leads/csv", {
      method: "POST",
      headers: { Authorization: authToken ? 'Bearer ' + authToken : '' },
      body: formData
    }).then(response => response.json())
    .then(data => {
      if (data.success) {
        alert("✅ Upload successful!");
        window.location.reload();
      } else {
        alert("❌ Upload failed: " + (data.message || "Unknown error"));
      }
    }).catch(error => {
      console.error("Upload error:", error);
      alert("❌ Upload failed: " + error.message);
    });
  }
};

// ✅ Initialize the SimplifiedApp
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(window.SimplifiedApp));
</script>

<script>
(function() {
  'use strict';
  
  console.log('🚀 Loading permanent chart & filter system...');
  
  // ===============================================
  // USERS ARRAY SYNCHRONIZATION
  // ===============================================
  function ensureUsersArray() {
    // Sync users array for dropdown population
    if (!window.users && window.allUsers) {
      window.users = window.allUsers;
    }
    
    // Fetch users if still not available
    if ((!window.users || window.users.length === 0) && window.fetchUsers) {
      window.fetchUsers();
    }
    
    // Force React to see users array
    if (window.appState?.setUsers && window.users) {
      window.appState.setUsers(window.users);
    }
    if (window.appState?.setAllUsers && window.users) {
      window.appState.setAllUsers(window.users);
    }
  }
  
  // ===============================================
  // CHART UPDATE FUNCTION
  // ===============================================
  window.updateChartsWithData = function(leads) {
  console.log('🔄 Updating charts with filtered data...');
  
  // Get filtered leads based on current filter settings
  let filteredLeads = [...(window.leads || [])];
  
  console.log('📊 Filter state:', {
    dashboardFilter: window.dashboardFilter,
    selectedSalesPerson: window.selectedSalesPerson,
    selectedEvent: window.selectedEvent,
    totalLeads: filteredLeads.length
  });
  
  // Apply sales person filter
  if (window.dashboardFilter === 'salesPerson' && window.selectedSalesPerson) {
    const selectedUser = (window.users || []).find(user => 
      user.id === window.selectedSalesPerson || user.email === window.selectedSalesPerson
    );
    if (selectedUser) {
      filteredLeads = filteredLeads.filter(lead => lead.assigned_to === selectedUser.email);
      console.log('👤 Filtered by sales person:', selectedUser.name, '→', filteredLeads.length, 'leads');
    }
  }
  // Apply event filter
  else if (window.dashboardFilter === 'event' && window.selectedEvent) {
    filteredLeads = filteredLeads.filter(lead => lead.lead_for_event === window.selectedEvent);
    console.log('🎪 Filtered by event:', window.selectedEvent, '→', filteredLeads.length, 'leads');
  }
  
  // Calculate chart data from filtered leads
  const qualified = filteredLeads.filter(l => (l.status || '').toLowerCase() === 'qualified').length;
  const junk = filteredLeads.filter(l => (l.status || '').toLowerCase() === 'junk').length;
  const hot = filteredLeads.filter(l => (l.temperature || '').toLowerCase() === 'hot').length;
  const warm = filteredLeads.filter(l => (l.temperature || '').toLowerCase() === 'warm').length;
  const cold = filteredLeads.filter(l => (l.temperature || '').toLowerCase() === 'cold').length;
  
  // Calculate temperature values
  const hotValue = filteredLeads.filter(l => (l.temperature || '').toLowerCase() === 'hot')
    .reduce((sum, lead) => sum + (parseFloat(lead.potential_value) || 0), 0);
  const warmValue = filteredLeads.filter(l => (l.temperature || '').toLowerCase() === 'warm')
    .reduce((sum, lead) => sum + (parseFloat(lead.potential_value) || 0), 0);
  const coldValue = filteredLeads.filter(l => (l.temperature || '').toLowerCase() === 'cold')
    .reduce((sum, lead) => sum + (parseFloat(lead.potential_value) || 0), 0);
  
  console.log('📊 Chart data:', { qualified, junk, hot, warm, cold, hotValue, warmValue, coldValue });
  
  // Update Lead Split Chart
  const canvas1 = document.getElementById('leadSplitChart');
  if (canvas1) {
    const chart1 = Chart.getChart(canvas1);
    if (chart1) {
      chart1.data.labels = [`Qualified (${qualified})`, `Junk (${junk})`];
      chart1.data.datasets[0].data = [qualified, junk];
      chart1.update('active');
      console.log('✅ Updated Lead Split Chart');
    }
  }
  
  // Update Temperature Count Chart
  const canvas2 = document.getElementById('tempCountChart');
  if (canvas2) {
    const chart2 = Chart.getChart(canvas2);
    if (chart2) {
      chart2.data.labels = [`Hot (${hot})`, `Warm (${warm})`, `Cold (${cold})`];
      chart2.data.datasets[0].data = [hot, warm, cold];
      chart2.update('active');
      console.log('✅ Updated Temperature Count Chart');
    }
  }
  
  // Update Temperature Value Chart
  const canvas3 = document.getElementById('tempValueChart');
  if (canvas3) {
    const chart3 = Chart.getChart(canvas3);
    if (chart3) {
      chart3.data.datasets[0].data = [hotValue, warmValue, coldValue];
      chart3.update('active');
      console.log('✅ Updated Temperature Value Chart');
    }
  }
  
  console.log('✅ All charts updated successfully');
};

// Create the missing handleChartFilterChange function
window.handleChartFilterChange = function() {
  console.log('🎯 handleChartFilterChange called');
  setTimeout(() => {
    if (window.updateChartsWithData && window.leads) {
      window.updateChartsWithData(window.leads);
    }
  }, 100);
};

console.log('✅ Chart update functions loaded');
  
  // ===============================================
  // CHART CREATION FUNCTION
  // ===============================================
  window.createDashboardCharts = function() {
    // Destroy existing charts first
    if (typeof Chart !== 'undefined' && Chart.instances) {
      Object.keys(Chart.instances).forEach(id => {
        try { Chart.instances[id].destroy(); } catch (e) {}
      });
    }
    
    const leads = window.leads || [];
    const qualified = leads.filter(l => (l.status || '').toLowerCase() === 'qualified').length;
    const junk = leads.filter(l => (l.status || '').toLowerCase() === 'junk').length;
    const hot = leads.filter(l => (l.temperature || '').toLowerCase() === 'hot').length;
    const warm = leads.filter(l => (l.temperature || '').toLowerCase() === 'warm').length;
    const cold = leads.filter(l => (l.temperature || '').toLowerCase() === 'cold').length;
    
    // Create Lead Split Chart
    const canvas1 = document.getElementById('leadSplitChart');
    if (canvas1) {
      new Chart(canvas1, {
        type: 'doughnut',
        data: {
          labels: [`Qualified (${qualified})`, `Junk (${junk})`],
          datasets: [{
            data: [qualified, junk],
            backgroundColor: ['#10b981', '#ef4444'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }
    
    // Create Temperature Count Chart
    const canvas2 = document.getElementById('tempCountChart');
    if (canvas2) {
      new Chart(canvas2, {
        type: 'doughnut',
        data: {
          labels: [`Hot (${hot})`, `Warm (${warm})`, `Cold (${cold})`],
          datasets: [{
            data: [hot, warm, cold],
            backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }
    
    // Create Temperature Value Chart
    const canvas3 = document.getElementById('tempValueChart');
    if (canvas3) {
      const hotValue = leads.filter(l => (l.temperature || '').toLowerCase() === 'hot')
        .reduce((sum, lead) => sum + (parseFloat(lead.potential_value) || 0), 0);
      const warmValue = leads.filter(l => (l.temperature || '').toLowerCase() === 'warm')
        .reduce((sum, lead) => sum + (parseFloat(lead.potential_value) || 0), 0);
      const coldValue = leads.filter(l => (l.temperature || '').toLowerCase() === 'cold')
        .reduce((sum, lead) => sum + (parseFloat(lead.potential_value) || 0), 0);
      
      new Chart(canvas3, {
        type: 'doughnut',
        data: {
          labels: ['Hot Value', 'Warm Value', 'Cold Value'],
          datasets: [{
            data: [hotValue, warmValue, coldValue],
            backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.label + ': ₹' + context.raw.toLocaleString('en-IN');
                }
              }
            }
          }
        }
      });
    }
  };
  
  // ===============================================
  // FILTER FUNCTION WRAPPERS
  // ===============================================
  function setupFilterWrappers() {
    // Wrap setDashboardFilter
    if (window.setDashboardFilter) {
      const originalSetDashboardFilter = window.setDashboardFilter;
      window.setDashboardFilter = function(filter) {
        const result = originalSetDashboardFilter(filter);
        setTimeout(() => {
          if (window.updateChartsWithData && window.leads) {
            window.updateChartsWithData(window.leads);
          }
        }, 150);
        return result;
      };
    }
    
    // Wrap setSelectedSalesPerson
    if (window.setSelectedSalesPerson) {
      const originalSetSelectedSalesPerson = window.setSelectedSalesPerson;
      window.setSelectedSalesPerson = function(person) {
        const result = originalSetSelectedSalesPerson(person);
        setTimeout(() => {
          if (window.updateChartsWithData && window.leads) {
            window.updateChartsWithData(window.leads);
          }
        }, 150);
        return result;
      };
    }
    
    // Wrap setSelectedEvent
    if (window.setSelectedEvent) {
      const originalSetSelectedEvent = window.setSelectedEvent;
      window.setSelectedEvent = function(event) {
        const result = originalSetSelectedEvent(event);
        setTimeout(() => {
          if (window.updateChartsWithData && window.leads) {
            window.updateChartsWithData(window.leads);
          }
        }, 150);
        return result;
      };
    }
  }
  
  // ===============================================
  // CHART RESTORATION SYSTEM
  // ===============================================
  function setupChartRestoration() {
    // Auto-restore charts if they go missing
    setInterval(() => {
      if (window.activeTab === 'dashboard') {
        const canvas1 = document.getElementById('leadSplitChart');
        const canvas2 = document.getElementById('tempCountChart');
        const canvas3 = document.getElementById('tempValueChart');
        
        const needsRestoration = !canvas1 || !canvas2 || !canvas3 ||
          !Chart.getChart(canvas1) || !Chart.getChart(canvas2) || !Chart.getChart(canvas3);
        
        if (needsRestoration) {
          setTimeout(window.createDashboardCharts, 500);
        }
      }
    }, 5000); // Check every 5 seconds
  }
  
  // ===============================================
  // INITIALIZATION
  // ===============================================
  function initialize() {
    // Ensure users array is available
    ensureUsersArray();
    
    // Setup filter wrappers
    setupFilterWrappers();
    
    // Setup chart restoration
    setupChartRestoration();
    
    // Force React refresh for dropdown population
    if (window.setLoading) {
      window.setLoading(true);
      setTimeout(() => window.setLoading(false), 50);
    }
    
    // Initialize charts if on dashboard
    if (window.activeTab === 'dashboard') {
      setTimeout(window.createDashboardCharts, 1000);
    }
  }
  
  // ===============================================
  // AUTO-START
  // ===============================================
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initialize, 1500);
    });
  } else {
    setTimeout(initialize, 1500);
  }
  
  console.log('✅ Permanent chart & filter system loaded');
})();
</script>

<!-- =============================================== -->
<!-- FINAL WORKING CHART & FILTER SYSTEM -->
<!-- Add this to the bottom of index.html before </body> -->
<!-- =============================================== -->

<script>
(function() {
  'use strict';
  
  console.log('🚀 Loading final working chart & filter system...');
  
  // ===============================================
  // INITIALIZATION FUNCTION
  // ===============================================
  function initializeChartSystem() {
    console.log('🔧 Initializing chart system...');
    
    // Ensure users array is available
    if (!window.users && window.allUsers) {
      window.users = window.allUsers;
    }
    
    // Fetch users if needed
    if ((!window.users || window.users.length === 0) && window.fetchUsers) {
      window.fetchUsers();
    }
    
    // Create charts if on dashboard
    if (window.activeTab === 'dashboard' && window.createDashboardCharts) {
      setTimeout(() => {
        console.log('📊 Creating dashboard charts...');
        window.createDashboardCharts();
      }, 500);
    }
    
    // Setup filter wrappers
    setTimeout(() => {
      setupFilterWrappers();
    }, 1000);
    
    // Force React refresh for dropdown population
    if (window.setLoading) {
      window.setLoading(true);
      setTimeout(() => window.setLoading(false), 50);
    }
  }
  
  // ===============================================
  // FILTER FUNCTION WRAPPERS
  // ===============================================
  function setupFilterWrappers() {
    console.log('🔧 Setting up filter wrappers...');
    
    // Store original functions safely
    if (!window._chartSystemOriginals) {
      window._chartSystemOriginals = {
        setDashboardFilter: window.setDashboardFilter,
        setSelectedSalesPerson: window.setSelectedSalesPerson,
        setSelectedEvent: window.setSelectedEvent
      };
    }
    
    // Override setDashboardFilter
    if (window.setDashboardFilter) {
      window.setDashboardFilter = function(filter) {
        console.log('🎯 Dashboard filter changing to:', filter);
        
        // Call original function
        if (window._chartSystemOriginals.setDashboardFilter) {
          window._chartSystemOriginals.setDashboardFilter(filter);
        } else {
          window.dashboardFilter = filter;
        }
        
        // Update charts
        setTimeout(() => {
          if (window.updateChartsWithData && window.leads) {
            window.updateChartsWithData(window.leads);
          }
        }, 200);
      };
    }
    
    // Override setSelectedSalesPerson
    if (window.setSelectedSalesPerson) {
      window.setSelectedSalesPerson = function(person) {
        console.log('👤 Sales person changing to:', person);
        
        // Call original function
        if (window._chartSystemOriginals.setSelectedSalesPerson) {
          window._chartSystemOriginals.setSelectedSalesPerson(person);
        } else {
          window.selectedSalesPerson = person;
        }
        
        // Update charts
        setTimeout(() => {
          if (window.updateChartsWithData && window.leads) {
            window.updateChartsWithData(window.leads);
          }
        }, 200);
      };
    }
    
    // Override setSelectedEvent
    if (window.setSelectedEvent) {
      window.setSelectedEvent = function(event) {
        console.log('🎪 Event changing to:', event);
        
        // Call original function
        if (window._chartSystemOriginals.setSelectedEvent) {
          window._chartSystemOriginals.setSelectedEvent(event);
        } else {
          window.selectedEvent = event;
        }
        
        // Update charts
        setTimeout(() => {
          if (window.updateChartsWithData && window.leads) {
            window.updateChartsWithData(window.leads);
          }
        }, 200);
      };
    }
    
    console.log('✅ Filter wrappers configured');
  }
  
  // ===============================================
  // CHART RESTORATION SYSTEM
  // ===============================================
  function setupChartRestoration() {
    // Auto-restore charts if they disappear
    setInterval(() => {
      if (window.activeTab === 'dashboard') {
        const canvas1 = document.getElementById('leadSplitChart');
        const canvas2 = document.getElementById('tempCountChart');
        const canvas3 = document.getElementById('tempValueChart');
        
        const needsCharts = canvas1 && canvas2 && canvas3 && 
          (!Chart.getChart(canvas1) || !Chart.getChart(canvas2) || !Chart.getChart(canvas3));
        
        if (needsCharts && window.createDashboardCharts) {
          console.log('🔧 Auto-restoring missing charts...');
          window.createDashboardCharts();
        }
      }
    }, 10000); // Check every 10 seconds
  }
  
  // ===============================================
  // STARTUP SEQUENCE
  // ===============================================
  function startSystem() {
    // Initialize main system
    initializeChartSystem();
    
    // Setup chart restoration
    setupChartRestoration();
    
    console.log('✅ Chart & filter system fully loaded');
  }
  
  // ===============================================
  // AUTO-START
  // ===============================================
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(startSystem, 2000); // Wait 2 seconds after DOM ready
    });
  } else {
    setTimeout(startSystem, 2000); // Wait 2 seconds
  }
  
})();
</script>  

<script>
// CHART INITIALIZATION FIX - Ensures charts load on page reload
(function() {
  'use strict';
  
  console.log('🔧 Loading chart initialization fix...');
  
  // Enhanced chart creation with proper fallback
  window.ensureChartsExist = function() {
    console.log('🔍 Checking if charts exist...');
    
    const canvas1 = document.getElementById('leadSplitChart');
    const canvas2 = document.getElementById('tempCountChart');
    const canvas3 = document.getElementById('tempValueChart');
    
    if (!canvas1 || !canvas2 || !canvas3) {
      console.log('❌ Chart canvases not found in DOM yet');
      return false;
    }
    
    const chart1Exists = Chart.getChart(canvas1);
    const chart2Exists = Chart.getChart(canvas2);
    const chart3Exists = Chart.getChart(canvas3);
    
    const allChartsExist = chart1Exists && chart2Exists && chart3Exists;
    
    console.log('📊 Chart status:', {
      canvas1: !!canvas1,
      canvas2: !!canvas2, 
      canvas3: !!canvas3,
      chart1: !!chart1Exists,
      chart2: !!chart2Exists,
      chart3: !!chart3Exists,
      allExist: allChartsExist
    });
    
    return allChartsExist;
  };
  
  // Enhanced initialization that waits for data AND DOM
  window.initializeChartsWhenReady = function() {
    console.log('🎯 initializeChartsWhenReady called');
    
    const checkAndCreate = () => {
      // Check if we're on dashboard tab
      if (window.activeTab !== 'dashboard') {
        console.log('📍 Not on dashboard tab, skipping chart creation');
        return;
      }
      
      // Check if data is available
      if (!window.leads || window.leads.length === 0) {
        console.log('📊 No leads data yet, waiting...');
        setTimeout(checkAndCreate, 500);
        return;
      }
      
      // Check if Chart.js is loaded
      if (typeof Chart === 'undefined') {
        console.log('📚 Chart.js not loaded yet, waiting...');
        setTimeout(checkAndCreate, 500);
        return;
      }
      
      // Check if charts already exist
      if (window.ensureChartsExist()) {
        console.log('✅ Charts already exist, updating with current data');
        window.updateChartsWithData(window.leads);
        return;
      }
      
      // Create charts
      console.log('🎨 Creating charts from scratch...');
      if (window.createDashboardCharts) {
        window.createDashboardCharts();
        
        // Verify creation was successful
        setTimeout(() => {
          if (window.ensureChartsExist()) {
            console.log('✅ Charts created successfully');
            window.updateChartsWithData(window.leads);
          } else {
            console.log('❌ Chart creation failed, retrying...');
            setTimeout(checkAndCreate, 1000);
          }
        }, 200);
      } else {
        console.log('❌ createDashboardCharts function not found');
      }
    };
    
    // Start the check
    checkAndCreate();
  };
  
  // Override the original initialization functions
  const originalInitializeDashboardCharts = window.initializeDashboardCharts;
  window.initializeDashboardCharts = function() {
    console.log('🔄 initializeDashboardCharts called - using enhanced version');
    window.initializeChartsWhenReady();
  };
  
  // Monitor active tab changes
  const originalSetActiveTab = window.setActiveTab;
  if (originalSetActiveTab) {
    window.setActiveTab = function(tab) {
      const prevTab = window.activeTab;
      originalSetActiveTab(tab);
      
      // If switching TO dashboard tab, ensure charts exist
      if (tab === 'dashboard' && prevTab !== 'dashboard') {
        console.log('📊 Switched to dashboard tab, ensuring charts exist');
        setTimeout(window.initializeChartsWhenReady, 500);
      }
    };
  }
  
  // Monitor data changes
  let lastLeadsLength = 0;
  setInterval(() => {
    if (window.activeTab === 'dashboard' && window.leads) {
      const currentLength = window.leads.length;
      
      // If data just loaded or changed significantly
      if (currentLength > 0 && (lastLeadsLength === 0 || Math.abs(currentLength - lastLeadsLength) > 5)) {
        console.log('📊 Leads data changed, checking charts...', {
          oldCount: lastLeadsLength,
          newCount: currentLength
        });
        
        if (!window.ensureChartsExist()) {
          console.log('🎨 Charts missing after data load, creating...');
          window.initializeChartsWhenReady();
        }
      }
      
      lastLeadsLength = currentLength;
    }
  }, 2000);
  
  // Force initialization on script load if already on dashboard
  setTimeout(() => {
    if (window.activeTab === 'dashboard' || !window.activeTab) {
      console.log('🎯 Page loaded on dashboard, ensuring charts exist');
      window.initializeChartsWhenReady();
    }
  }, 3000);
  
  console.log('✅ Chart initialization fix loaded');
  
})();
</script>  

  <script>
    (function() {
    'use strict';
    
    console.log('📱 Initializing mobile responsive design...');
    
    // Wait for all components to load
    function initializeMobileResponsive() {
        if (!window.SimplifiedApp || !window.appState) {
            setTimeout(initializeMobileResponsive, 100);
            return;
        }
        
        // Update the SimplifiedApp to use responsive layout
        const originalSimplifiedApp = window.SimplifiedApp;
        
        window.SimplifiedApp = () => {
            const { isLoggedIn } = window.appState;
            
            if (!isLoggedIn) {
                return window.renderLogin();
            }
            
            // Use responsive layout
            return window.renderResponsiveLayout();
        };
        
        // Override the financials renderer with responsive version
        const originalRenderFinancials = window.renderFinancials;
        window.renderFinancials = window.renderResponsiveFinancials || originalRenderFinancials;
        
        // Override sales tab with responsive version
        const originalRenderSalesTab = window.renderSalesTab;
        window.renderSalesTab = window.renderResponsiveSalesTab || originalRenderSalesTab;
        
        // Add viewport meta tag if not present
        if (!document.querySelector('meta[name="viewport"]')) {
            const viewport = document.createElement('meta');
            viewport.name = 'viewport';
            viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
            document.head.appendChild(viewport);
        }
        
        // Add mobile-specific styles
        const mobileStyles = document.createElement('style');
        mobileStyles.textContent = `
            /* Prevent horizontal scroll on mobile */
            body {
                overflow-x: hidden;
            }
            
            /* Improve touch targets */
            button, a, input, select, textarea {
                min-height: 44px;
            }
            
            /* Better mobile table styles */
            @media (max-width: 640px) {
                table {
                    font-size: 14px;
                }
                
                th, td {
                    padding: 8px 4px;
                }
                
                /* Hide less important columns on very small screens */
                .hide-on-mobile {
                    display: none;
                }
            }
            
            /* Smooth scrolling for tabs */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }
            
            /* Better chart responsiveness */
            canvas {
                max-width: 100% !important;
                height: auto !important;
            }
            
            /* Fix for iOS Safari */
            .fixed {
                -webkit-transform: translateZ(0);
            }
        `;
        document.head.appendChild(mobileStyles);
        
        // Force re-render if already logged in
        if (window.renderApp) {
            window.renderApp();
        }
        
        console.log('✅ Mobile responsive design initialized');
    }
    
    // Handle window resize for responsive chart
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            if (window.financialSalesChartInstance) {
                window.financialSalesChartInstance.resize();
            }
        }, 250);
    });
    
    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeMobileResponsive);
    } else {
        initializeMobileResponsive();
    }
})();

// Quick test function to check mobile menu
window.testMobileMenu = () => {
    if (window.appState && window.appState.setIsMobileMenuOpen) {
        window.appState.setIsMobileMenuOpen(true);
        console.log('Mobile menu opened');
    } else {
        console.log('Mobile menu state not available');
    }
};
  </script>
  
</body>
</html>
