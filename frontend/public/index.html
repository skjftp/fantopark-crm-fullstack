<!-- CRM Version:FIELD-MAPPING-FIXED-20250630 -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FanToPark CRM Pro</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Load all constant files -->
<script src="constants/config.js"></script>
<script src="constants/status-config.js"></script>
<script src="constants/user-roles.js"></script>
<script src="constants/form-config.js"></script>
<script src="constants/default-data.js"></script>

<!-- Utility Functions -->
<script src="utils/api.js"></script>
<script src="utils/permissions.js"></script>
<script src="utils/helpers.js"></script>

<!-- Component Files -->
<script src="components/assignment-rules.js"></script>
<script src="components/my-actions.js"></script>
<script src="components/leads.js"></script>
<script src="components/dashboard.js"></script>  
<script src="components/content-router.js"></script>
<script src="components/inventory.js"></script>
<script src="components/financials.js"></script>
<script src="components/orders.js"></script> 
<script src="components/user-management.js"></script>
<script src="components/stadiums.js"></script> 
<script src="components/delivery.js"></script>
<script src="components/sports-calendar.js"></script> 
<script src="components/reminders.js"></script>
<script src="components/inventory-form.js"></script>
<script src="components/lead-form.js"></script> 
<script src="components/lead-detail.js"></script>
<script src="components/payment-form.js"></script>
<script src="components/inventory-detail.js"></script>
<script src="components/order-detail-modal.js"></script>
<script src="components/user-form.js"></script>
<script src="components/gst-invoice-preview.js"></script>
<script src="components/assign-form.js"></script>
<script src="components/bulk-assign-modal.js"></script>
<script src="components/choice-modal.js"></script> 
<script src="components/status-progress-modal.js"></script>
<script src="components/allocation-management.js"></script>
<script src="components/help-guide.js"></script>  
<script src="components/stadium-form.js"></script>
<script src="components/payment-post-service-form.js"></script>
<script src="components/edit-order-form.js"></script>
<script src="components/client-detail-modal.js"></script>
<script src="components/payment-submit-handler.js"></script>
<script src="components/inventory-form-submit-handler.js"></script>
<script src="components/delete-handler.js"></script>
<script src="components/test-mode-system.js"></script>
<script src="components/csv-upload-system.js"></script>
<script src="components/form-handlers.js"></script>
<script src="components/gst-calculation-system.js"></script>
<script src="components/communication-system.js"></script>
<script src="components/chart-system.js"></script>
<script src="components/financial-system.js"></script>
<script src="components/lead-status-management.js"></script>
<script src="components/my-actions-data.js"></script>
<script src="components/user-management-handlers.js"></script>
<script src="components/reminder-management.js"></script>
<script src="components/allocation-form.js"></script>  
<script src="components/delivery-form.js"></script>
<script src="components/event-modals.js"></script>  

<!-- New Extracted Components -->
<script src="components/main-app-component.js"></script>
<script src="components/app-business-logic.js"></script>
<script src="components/app-effects-lifecycle.js"></script>
<script src="components/simplified-app-component.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>  

<!-- API Configuration-->
<script>
// Configure API endpoint
window.handleProceedFromPreview = () => {
  if (window.currentUploadFile) {
    console.log("üöÄ Starting upload with file:", window.currentUploadFile.name);

    const cancelBtn = Array.from(document.querySelectorAll("button")).find(b => b.textContent === "Cancel");
    if (cancelBtn) cancelBtn.click();

    const formData = new FormData();
    formData.append("file", window.currentUploadFile);
    fetch(window.API_CONFIG.API_URL + "/upload/leads/csv", {
      method: "POST",
      headers: { Authorization: authToken ? "Bearer " + authToken : undefined },
      body: formData
    }).then(response => response.json()).then(result => {
      console.log("‚úÖ Upload successful:", result);
      alert("‚úÖ Upload successful: " + result.message);
      window.currentUploadFile = null;
      location.reload();
    }).catch(error => {
      console.error("‚ùå Upload failed:", error);
      alert("‚ùå Upload failed: " + error.message);
    });
  } else {
    alert("No file selected for upload");
  }
};

console.log("üîó window.API_CONFIG.API_URL set to:", window.API_CONFIG.API_URL);
let authToken = localStorage.getItem("crm_auth_token");

if (authToken) {
  console.log("Auth token loaded from localStorage");
}
</script>

<style>
/* Dark mode base styles */
.dark {
  color-scheme: dark;
}

.dark body {
  background-color: #111827;
  color: #f3f4f6;
}

/* Dark mode for main containers */
.dark .bg-white {
  background-color: #1f2937 !important;
}

.dark .bg-gray-50 {
  background-color: #111827 !important;
}

.dark .bg-gray-100 {
  background-color: #0f172a !important;
}

/* Dark mode for text */
.dark .text-gray-900 {
  color: #f3f4f6 !important;
}

.dark .text-gray-800 {
  color: #e5e7eb !important;
}

.dark .text-gray-700 {
  color: #d1d5db !important;
}

.dark .text-gray-600 {
  color: #9ca3af !important;
}

.dark .text-gray-500 {
  color: #6b7280 !important;
}

/* Dark mode for borders */
.dark .border-gray-200 {
  border-color: #374151 !important;
}

.dark .border-gray-300 {
  border-color: #4b5563 !important;
}

.dark .border-b {
  border-color: #374151 !important;
}

/* Dark mode for inputs and forms */
.dark input, .dark select, .dark textarea {
  background-color: #374151 !important;
  border-color: #4b5563 !important;
  color: #f3f4f6 !important;
}

.dark input:focus, .dark select:focus, .dark textarea:focus {
  border-color: #3b82f6 !important;
  background-color: #4b5563 !important;
}

/* Dark mode for hover states */
.dark .hover\:bg-gray-50:hover {
  background-color: #374151 !important;
}

.dark .hover\:bg-gray-100:hover {
  background-color: #4b5563 !important;
}

/* Dark mode for tables */
.dark table {
  background-color: #1f2937 !important;
}

.dark thead {
  background-color: #111827 !important;
}

.dark tbody tr:hover {
  background-color: #374151 !important;
}

/* Dark mode for modals */
.dark .bg-black.bg-opacity-50 {
  background-color: rgba(0, 0, 0, 0.75) !important;
}

/* Dark mode for shadows */
.dark .shadow-sm {
  box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.5) !important;
}

.dark .shadow-md {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5) !important;
}

/* Dark mode for sidebar */
.dark .bg-gray-900 {
  background-color: #0f172a !important;
}

/* Dark mode scrollbars */
.dark ::-webkit-scrollbar {
  background-color: #1f2937;
}

.dark ::-webkit-scrollbar-thumb {
  background-color: #4b5563;
}

.dark ::-webkit-scrollbar-thumb:hover {
  background-color: #6b7280;
}

/* Invoice Styles */
.invoice-preview {
  background: white;
  border: 2px solid #000;
  font-family: Arial, sans-serif;
  font-size: 10px;
  line-height: 1.2;
  margin: 0 auto;
  max-width: 210mm;
  height: fit-content;
  padding: 8mm;
  box-sizing: border-box;
  display: block;
  overflow: hidden;
}

.invoice-header-row {
  display: grid;
  grid-template-columns: 300px 1fr auto;
  padding: 10px 8px;
  border-bottom: 2px solid #000;
  align-items: center;
  margin-bottom: 10px;
  background: #f8f9fa;
}

.company-logo {
  width: 210px;
  height: 150px;
  margin: 0;
}

.company-logo img {
  max-width: 210px;
  max-height: 150px;
  object-fit: contain;
}

.invoice-title {
  text-align: right;
  font-size: 16px;
  font-weight: bold;
  padding-top: 10px;
  color: #2c3e50;
}

.invoice-meta {
  display: grid;
  grid-template-columns: 1fr 1fr;
  padding: 8px;
  border-bottom: 1px solid #000;
  font-size: 10px;
  margin-bottom: 10px;
  background: #f8f9fa;
}

.customer-section {
  padding: 10px 8px;
  border-bottom: 1px solid #000;
  margin-bottom: 12px;
  background: #f8f9fa;
}

.customer-title {
  font-weight: bold;
  margin-bottom: 4px;
  font-size: 10px;
}

.invoice-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 10px;
  margin-bottom: 12px;
}

.invoice-table th {
  background: #2c3e50;
  color: white;
  padding: 6px 4px;
  text-align: left;
  border: 1px solid #000;
  font-weight: bold;
  font-size: 10px;
}

.invoice-table td {
  padding: 6px 4px;
  border: 1px solid #000;
  text-align: left;
  background: white;
}

.totals-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 10px;
  margin-bottom: 12px;
}

.totals-table td {
  padding: 4px;
  border: 1px solid #000;
}

.bank-details {
  display: grid;
  grid-template-columns: 1fr 1fr;
  padding: 10px 8px;
  border: 2px solid #2c3e50;
  font-size: 9px;
  gap: 10px;
  background: #f8f9fa;
  margin-top: 10px;
}

.bank-info h4 {
  margin-bottom: 6px;
  font-size: 10px;
  color: #2c3e50;
  border-bottom: 1px solid #2c3e50;
  padding-bottom: 2px;
}

.bank-info div {
  margin-bottom: 2px;
  line-height: 1.1;
}

.payment-qr {
  text-align: center;
}

.payment-qr img {
  width: 120px;
  height: 120px;
  border: 2px solid #ddd;
  padding: 5px;
  background: white;
}

.invoice-footer {
  margin-top: 10px;
  text-align: center;
  font-size: 8px;
  color: #666;
}

.company-info-section {
  background: white;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 3px;
  margin-bottom: 8px;
}

.company-info-section h4 {
  color: #2c3e50;
  margin-bottom: 6px;
  border-bottom: 1px solid #2c3e50;
  padding-bottom: 2px;
  text-align: center;
  font-size: 9px;
}

@media print {
  body { background: white; padding: 0; margin: 0; }
  .invoice-preview { border: none; box-shadow: none; margin: 0; padding: 5mm; }
  .modal-backdrop { display: none; }
  .sticky { position: relative !important; }
  @page { margin: 10mm; size: A4; }
}

/* Fix for action buttons */
.action-buttons button {
  position: relative;
  z-index: 10;
  cursor: pointer;
}

td .flex button {
  position: relative;
  z-index: 10;
}

/* Logout button fix */
.logout-button-fix {
  position: relative !important;
  width: auto !important;
  height: auto !important;
}

/* Prevent invisible overlays */
button:not(:hover) {
  z-index: auto !important;
}

/* Ensure sidebar stays contained */
.sidebar-container {
  overflow: hidden;
}

/* Logout button area fix */
.sidebar-logout {
  margin-top: auto;
  padding: 1rem;
  border-top: 1px solid #e5e7eb;
}

.sidebar-logout button {
  width: 100%;
  max-width: 200px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  padding: 0.75rem 1rem;
  border-radius: 0.375rem;
  transition: background-color 0.2s;
}

.sidebar-logout button:hover {
  background-color: #f9fafb;
}

/* Prevent any overlay issues */
.sidebar-container > div:last-child {
  position: relative !important;
  bottom: auto !important;
  left: auto !important;
  right: auto !important;
}

.test-mode-active {
  border: 4px solid #dc2626 !important;
  box-shadow: inset 0 0 0 4px #dc2626;
}
</style>
</head>
<body>
<div id="test-mode-indicator" style="display:none; background:#dc2626; color:white; text-align:center; padding:10px; font-weight:bold;">
  üß™ TEST MODE ACTIVE - Delete All buttons enabled
</div>
<script>if(localStorage.getItem('testMode')==='true') document.getElementById('test-mode-indicator').style.display='block';</script>
<div id="root"></div>
<div id="error-message" style="position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 12px 20px; border-radius: 6px; display: none; z-index: 9999;"></div>

<script>
// Show previous logs on page load
window.addEventListener('load', () => {
  const logs = JSON.parse(sessionStorage.getItem('debugLogs') || '[]');
  if (logs.length > 0) {
    console.log('=== Previous Session Logs ===');
    logs.forEach(log => console.log('[' + (log.time) + '] ' + (log.key) + ':', log.data));
    console.log('=== End Previous Logs ===');
  }
});

// Clear logs button (press Ctrl+Shift+L)
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.shiftKey && e.key === 'L') {
    sessionStorage.removeItem('debugLogs');
    console.log('Debug logs cleared');
  }
});

const { useState, useEffect, useRef } = React;

window.getRoleDisplayLabel = function(roleName) {
  const roleLabels = {
    'super_admin': 'Super Admin',
    'admin': 'Admin', 
    'sales_manager': 'Sales Manager',
    'sales_executive': 'Sales Executive',
    'supply_manager': 'Supply Manager',
    'supply_sales_service_manager': 'Supply Sales Service Manager',
    'finance_manager': 'Finance Manager',
    'viewer': 'Viewer'
  };
  return roleLabels[roleName] || roleName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
};

// Helper function to format date for display (DD/MM/YYYY)
const formatDateForDisplay = (dateValue) => {
  if (!dateValue) return 'Not Set';

  try {
    let date;

    if (dateValue instanceof Date) {
      date = dateValue;
    } else if (typeof dateValue === 'string' && dateValue.includes('T')) {
      date = new Date(dateValue);
    } else if (typeof dateValue === 'string') {
      date = new Date(dateValue);
    } else if (typeof dateValue === 'object' && dateValue._seconds) {
      date = new Date(dateValue._seconds * 1000);
    } else {
      return 'Invalid Date';
    }

    if (isNaN(date.getTime())) {
      return 'Invalid Date';
    }

    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();

    return `${day}/${month}/${year}`;
  } catch (error) {
    return 'Error';
  }
};

// Helper function to get lead temperature
const getLeadTemperature = (lead) => {
  if (window.LEAD_STATUSES[lead.status]?.temperature) {
    return window.LEAD_STATUSES[lead.status].temperature;
  }

  if (lead.temperature) {
    return lead.temperature;
  }

  if (['hot', 'warm', 'cold'].includes(lead.status)) {
    return lead.status;
  }

  return null;
};

// Helper function to get display temperature for dashboard
const getDisplayTemperature = (lead) => {
  const temp = getLeadTemperature(lead);
  if (temp && ['hot', 'warm', 'cold'].includes(temp)) {
    return temp;
  }
  if (lead.status === 'quote_requested' && lead.temperature) {
    return lead.temperature;
  }
  return null;
};

// Render the simplified app
ReactDOM.render(React.createElement(window.SimplifiedApp), document.getElementById('root'));
</script>

<script src="components/test-mode-system.js"></script>
</body>
</html>
