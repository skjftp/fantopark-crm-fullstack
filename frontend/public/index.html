<!-- CRM Version:FIELD-MAPPING-FIXED-20250630 -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA">
<link rel="stylesheet" href="css/mobile-responsive.css?v=2">
<link rel="stylesheet" href="css/mobile-enhanced.css?v=3">
<link rel="stylesheet" href="css/dark-mode-fixes.css">  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FanToPark CRM Pro</title>


<script src="utils/logger.js"></script>  

<script>
// Add this BEFORE your React app loads
(function() {
  const originalRemoveChild = Node.prototype.removeChild;
  Node.prototype.removeChild = function(child) {
    if (child && this.contains(child)) {
      return originalRemoveChild.call(this, child);
    }
    console.warn('Attempted to remove non-child node:', child);
    return child;
  };
})();
</script>

  <script>
// Add error tracking
window.addEventListener('error', function(e) {
  if (e.message && e.message.includes('removeChild')) {
    console.error('RemoveChild Error Details:', {
      message: e.message,
      filename: e.filename,
      lineno: e.lineno,
      colno: e.colno,
      stack: e.error?.stack
    });
  }
});
</script>
  
<!-- PERFORMANCE OPTIMIZATION SCRIPTS - PLACE FIRST -->
<script> 
(function() {
  'use strict';
  
  const originalLog = console.log;
  
  // Comprehensive patterns to suppress
  const suppressPatterns = [
    // Emojis
    '✅', '🔍', '📊', '🔄', '🎯', '🚀', '❌', '🎉', '📈', '🔧', '🎫', '📝', '📋', '🚚', '🔥',
    
    // Component loading messages
    'component loaded successfully',
    'All app effects initialized',
    'loaded successfully',
    'Performance Optimized',
    'COMPREHENSIVE FIXES APPLIED',
    'FIXED:', 'ENHANCED:',
    
    // Debug messages
    'showAllocationManagement:',
    'allocationManagementInventory:',
    'currentAllocations count:',
    'Not showing allocation management',
    'Not showing delivery form',
    'Bulk Assign Modal',
    'ALLOCATION MANAGEMENT DEBUG',
    'DELIVERY FORM DEBUG',
    'Rendering Enhanced Recent Activity',
    'Auto-updated orders pagination',
    'Chart initialization useEffect triggered',
    'Canvas elements found:',
    'Attempting to initialize charts',
    'Fetched 14 users',
    'useEffect triggered - activeTab:',
    'Test mode state:',
    'Current user:',
    'Is super admin:',
    'User object:',
    'Super admin logged in',
    
    // Available commands
    'Available commands:',
    'To test:',
    'Debug:',
    'form-handlers.js loaded',
    'Payment handler functions added',
    'Applying chart initialization fix',
    'Emergency chart patch loaded',
    'Test mode functions loaded'
  ];
  
  console.log = function(...args) {
    const message = String(args[0] || '');
    const shouldSuppress = suppressPatterns.some(pattern => 
      message.includes(pattern)
    );
    if (!shouldSuppress) {
      originalLog.apply(console, args);
    }
  };
  
  window.toggleDebugLogs = function(enabled = true) {
    console.log = enabled ? originalLog : console.log;
    originalLog(enabled ? '🔧 All logs enabled' : '🔇 Debug logs filtered');
  };
  
  originalLog('🔇 Enhanced console filter activated');
})(); 
  
  
// 1. Global debug control - Set to true to disable all logs
window.PRODUCTION_MODE = true;
window.debugLog = window.PRODUCTION_MODE ? () => {} : console.log;

// 2. Emergency Performance Fixes
(function() {
  'use strict';
  
  
  // GLOBAL LOG SUPPRESSION
  window.EMERGENCY_MODE = true;
  
  // Override console.log for specific patterns
  const originalLog = console.log;
  const logCounts = {};
  const MAX_SAME_LOGS = 3;
  
  console.log = function(...args) {
    if (window.EMERGENCY_MODE) {
      const message = args.join(' ');
      
      // Suppress excessive debug patterns
      const suppressPatterns = [
        '🔍 DEBUGGING STATE SETTERS',
        'state.setShowInventoryForm:',
        'state.setEditingInventory:',
        'state.setShowAllocationManagement:',
        'Available inventory-related setters:',
        '🔍 ALLOCATION FORM DEBUG:',
        '🔍 DELIVERY FORM DEBUG:',
        '❌ Not showing allocation form:',
        'chart not found',
        'Chart not found!'
      ];
      
      // Check if this log should be suppressed
      const shouldSuppress = suppressPatterns.some(pattern => 
        message.includes(pattern)
      );
      
      if (shouldSuppress) {
        // Count this log
        const key = args[0] || 'unknown';
        logCounts[key] = (logCounts[key] || 0) + 1;
        
        // Only allow first few instances
        if (logCounts[key] <= MAX_SAME_LOGS) {
          originalLog.apply(console, args);
          
          if (logCounts[key] === MAX_SAME_LOGS) {
            originalLog(`🚨 [SUPPRESSED] Further "${key}" logs suppressed to improve performance`);
          }
        }
        return;
      }
    }
    
    // Allow other logs through
    originalLog.apply(console, args);
  };
  
  // CHART ERROR SUPPRESSION
  const originalError = console.error;
  const errorCounts = {};
  
  console.error = function(...args) {
    const message = args.join(' ');
    
    // Suppress chart-related errors that are spamming
    if (message.includes('chart') && message.includes('not found')) {
      const key = 'chart-not-found';
      errorCounts[key] = (errorCounts[key] || 0) + 1;
      
      if (errorCounts[key] <= 1) {
        originalError('⚠️ Chart containers not ready - will retry automatically');
      }
      return;
    }
    
    // Allow other errors through
    originalError.apply(console, args);
  };
  
  // PREVENT COMPONENT SPAM
  window._componentLogSuppressionFlags = {};
  
  window.suppressComponentLog = function(componentName, message) {
    const key = `${componentName}-${message}`;
    
    if (!window._componentLogSuppressionFlags[key]) {
      console.log(`📋 ${componentName}: ${message}`);
      window._componentLogSuppressionFlags[key] = true;
      
      // Auto-reset after 30 seconds
      setTimeout(() => {
        delete window._componentLogSuppressionFlags[key];
      }, 30000);
    }
  };
  
  // THROTTLE STATE UPDATES
  window._stateUpdateThrottle = {};
  
  window.throttledStateUpdate = function(key, updateFunction, delay = 100) {
    if (window._stateUpdateThrottle[key]) {
      clearTimeout(window._stateUpdateThrottle[key]);
    }
    
    window._stateUpdateThrottle[key] = setTimeout(() => {
      updateFunction();
      delete window._stateUpdateThrottle[key];
    }, delay);
  };
  
  // HANDLE BROWSER EXTENSION ERRORS
  window.addEventListener('error', function(e) {
    // Suppress extension-related errors
    if (e.filename && (
      e.filename.includes('content_script') ||
      e.filename.includes('extension') ||
      e.message.includes('toString')
    )) {
      e.preventDefault();
      return false;
    }
  });
  
  // CHART INITIALIZATION FIX
  window.safeChartInit = function() {
    if (window._chartInitAttempted) return;
    window._chartInitAttempted = true;
    
    const checkAndInit = () => {
      const containers = ['leadSplitChart', 'tempCountChart', 'tempValueChart'];
      const allReady = containers.every(id => document.getElementById(id));
      
      if (allReady && typeof Chart !== 'undefined') {
        try {
          // Only log success
          if (window.initializeCharts) {
            window.initializeCharts();
            console.log('✅ Charts initialized successfully');
          }
        } catch (error) {
          console.error('❌ Chart initialization failed:', error.message);
        }
      } else {
        // Don't spam retry messages
        setTimeout(checkAndInit, 1000);
      }
    };
    
    checkAndInit();
  };
  
  // PERFORMANCE TRACKER
  window.performanceTracker = {
    _operations: {},
    
    start: function(name) {
      this._operations[name] = performance.now();
    },
    
    end: function(name) {
      if (this._operations[name]) {
        const duration = performance.now() - this._operations[name];
        if (duration > 200) { // Only log slow operations
          console.warn(`⚠️ Slow: ${name} took ${duration.toFixed(2)}ms`);
        }
        delete this._operations[name];
      }
    }
  };
  
  // AUTO-CLEANUP
  window.addEventListener('beforeunload', function() {
    // Clear all timeouts
    Object.values(window._stateUpdateThrottle || {}).forEach(timeout => {
      clearTimeout(timeout);
    });
    
    // Reset flags
    window._componentLogSuppressionFlags = {};
    logCounts = {};
    errorCounts = {};
  });
  
  
})();
</script>

<!-- React and Dependencies -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
  <script src="components/birthday-component.js"></script>
  <script src="components/mobile-sidebar-autoclose.js"></script>
<script src="components/mobile-navigation.js?v=3"></script>
<script src="components/mobile-cards.js?v=4"></script>
<script src="components/mobile-lead-handlers.js?v=3"></script>
<script src="components/mobile-views.js?v=5"></script>
<script src="components/mobile-forms.js?v=1"></script>
<script src="components/mobile-gestures.js?v=1"></script>

  <!-- External Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Enhanced Financial System -->
<script src="components/enhanced-financial-system.js"></script>

 

<!-- Load all constant files -->
<script src="constants/config.js"></script>
<script src="constants/status-config.js"></script>
<script src="constants/user-roles.js"></script>
<script src="constants/form-config.js"></script>
<script src="constants/default-data.js"></script>

<!-- Utility Functions -->
<script src="utils/api.js"></script>
<script src="utils/permissions.js"></script>
<script src="utils/helpers.js"></script>
<script src="utils/indian-format.js"></script>
  

<!-- Component Files -->
<script src="utils/leads-api.js"></script>
<script src="utils/clients-api.js"></script>  
<script src="components/leads.js"></script>
<script src="components/leads-csv-export.js"></script>
<script src="components/dashboard.js"></script> 
<!-- New Extracted Components -->
<script src="components/main-app-component.js?v=2"></script>
<script src="components/app-business-logic.js"></script>
<script src="components/app-effects-lifecycle.js"></script>
<!-- Load allocation-management.js BEFORE simplified-app-component to ensure handleUnallocate is available -->
<script src="components/allocation-management.js?v=3"></script>
<script src="components/simplified-app-component-fixed.js"></script> 
<script src="components/content-router.js"></script>
<script src="components/inventory.js"></script>
<script src="components/market-rate-tab.js"></script>  
<script src="components/financials.js"></script>
<script src="components/sales-performance.js"></script>
<script src="components/marketing-performance.js"></script>  
<script src="components/orders.js"></script> 
<script src="components/user-management.js"></script>
<script src="components/assignment-rules.js"></script>
<script src="components/my-actions.js"></script>  
<script src="components/stadiums.js"></script> 
<script src="components/delivery.js"></script>
<script src="components/sports-calendar.js"></script> 
<script src="components/reminders.js"></script>
<script defer src="components/inventory-form.js"></script>
<script defer src="components/inventory-form-manager.js"></script>   
<script defer src="components/lead-form.js"></script> 
<script src="components/lead-detail.js"></script>
<script src="components/lead-inclusions.js"></script>  
<script defer src="components/payment-form.js"></script>
<script src="components/inventory-detail.js"></script>
<script defer src="components/order-detail-modal.js"></script>
<script src="components/user-form.js"></script>
<script defer src="components/gst-invoice-preview.js"></script>
<script defer src="components/assign-form.js"></script>
<script defer src="components/bulk-assign-modal.js"></script>
<script defer src="components/choice-modal.js"></script> 
<script defer src="components/status-progress-modal.js"></script>
<!-- Moved allocation-management.js earlier in loading order -->
<script defer src="components/help-guide.js"></script>  
<script defer src="components/stadium-form.js"></script>
<script defer src="components/stadium-notes-modal.js"></script>  
<script src="components/currency-ticker.js"></script> 
<script defer src="components/payment-post-service-form.js"></script>
<script defer src="components/edit-order-form.js"></script>
<script defer src="components/client-detail-modal.js"></script>
<script src="components/journey-generator.js"></script>  
<script defer src="components/payment-submit-handler.js"></script>
<script defer src="components/inventory-form-submit-handler.js"></script>
<script defer src="components/delete-handler.js"></script>
<script defer src="components/csv-upload-system.js"></script>
<script src="components/website-leads-import.js"></script>  
<script src="components/form-handlers.js"></script>
<script defer src="components/gst-calculation-system.js"></script>
<script defer src="components/communication-system.js"></script>
<script src="components/chart-system.js"></script>
<script src="components/financial-system.js"></script>
<script defer src="components/lead-status-management.js"></script>
<script defer src="components/my-actions-data.js"></script>
<script src="components/user-management-handlers.js"></script>
<script defer src="components/reminder-management.js"></script>
<script src="components/allocation-form.js?v=18"></script>  
<script defer src="components/delivery-form.js"></script>
<script defer src="components/event-modals.js"></script>
<script defer src="components/reminder-form.js"></script> 
<script src="components/enhanced-recent-activity.js"></script>
<script defer src="components/quote-upload-modal.js"></script>
<script defer src="components/delivery-utils.js"></script> 
<script defer src="components/proforma-invoice-form.js"></script>
<script src="components/exchange-impact-preview.js"></script>
<script defer src="components/payment-history-modal.js"></script>
<script src="components/change-password.js"></script>  

   
<!-- Add these after your other component scripts -->
<script src="components/responsive-layout.js"></script>

<script>
// Stadium form fields configuration
window.stadiumFormFields = [
  { name: 'name', label: 'Stadium Name', type: 'text', required: true, placeholder: 'e.g., Wankhede Stadium' },
  { name: 'city', label: 'City', type: 'text', required: true, placeholder: 'e.g., Mumbai' },
  { name: 'state', label: 'State/Province', type: 'text', required: false, placeholder: 'e.g., Maharashtra' },
  { name: 'country', label: 'Country', type: 'select', required: true, options: [
    'India', 'United States', 'United Kingdom', 'Australia', 'Canada', 'South Africa',
    'New Zealand', 'West Indies', 'Sri Lanka', 'Bangladesh', 'Pakistan', 'Afghanistan',
    'Spain', 'Germany', 'France', 'Italy', 'Brazil', 'Argentina', 'Japan', 'China', 'Other'
  ]},
  { name: 'sport_type', label: 'Primary Sport', type: 'select', required: true, options: [
    'Cricket', 'Football', 'Basketball', 'Tennis', 'Hockey', 'Baseball', 
    'Rugby', 'Athletics', 'Formula 1', 'Multi-Sport', 'Other'
  ]},
  { name: 'capacity', label: 'Seating Capacity', type: 'number', required: false, placeholder: 'e.g., 33000' },
  { name: 'opened_year', label: 'Year Opened', type: 'number', required: false, placeholder: 'e.g., 1974' },
  { name: 'nickname', label: 'Nickname', type: 'text', required: false, placeholder: 'e.g., The Home of Cricket' },
  { name: 'website', label: 'Website', type: 'url', required: false, placeholder: 'https://example.com' },
  { name: 'image_url', label: 'Stadium Image URL', type: 'url', required: false, placeholder: 'https://example.com/stadium.jpg' }
];
</script>
  
<script>
// COMPREHENSIVE API CALL CONSOLIDATION
(function() {
  'use strict';
  
  console.log('🔄 Implementing comprehensive API call consolidation...');
  
  // Global flag to prevent multiple simultaneous data fetches
  let isDataFetching = false;
  let dataFetchPromise = null;
  
  // Store original functions
  const originalFetchData = window.renderAppBusinessLogic()?.fetchData;
  const originalFetchMyActions = window.fetchMyActions;
  
// Consolidated data fetching function
window.consolidatedDataFetch = async function() {
    if (!window.isLoggedIn) {
        console.log('❌ Not logged in, skipping data fetch');
        return;
    }
    
    console.log('🚀 Starting consolidated data fetch (leads excluded)...');
    
    try {
        // Don't fetch leads - they're handled by pagination
        const [inventoryData, ordersData, invoicesData, deliveriesData, clientsData, usersData, stadiumsData] = await Promise.all([
            window.apiCall('/inventory').catch(() => ({ data: [] })),
            window.apiCall('/orders').catch(() => ({ data: [] })),
            window.apiCall('/invoices').catch(() => ({ data: [] })),
            window.apiCall('/deliveries').catch(() => ({ data: [] })),
            window.apiCall('/clients').catch(() => ({ data: [] })),
            window.apiCall('/users').catch(() => ({ data: [] })),
            window.apiCall('/stadiums').catch(() => ({ data: [] }))
        ]);
        
        // Update all state EXCEPT leads
        if (window.appState?.setInventory) window.appState.setInventory(inventoryData.data || []);
        if (window.appState?.setOrders) window.appState.setOrders(ordersData.data || []);
        if (window.appState?.setInvoices) window.appState.setInvoices(invoicesData.data || []);
        if (window.appState?.setDeliveries) window.appState.setDeliveries(deliveriesData.data || []);
        if (window.appState?.setClients) window.appState.setClients(clientsData.data || []);
        if (window.appState?.setUsers) window.appState.setUsers(usersData.data || []);
        if (window.appState?.setStadiums) window.appState.setStadiums(stadiumsData.data || []);
        
        // Remove these lines:
        // window.leads = leadsData.data || [];
        // if (window.appState?.setLeads) window.appState.setLeads(leadsData.data || []);
        
        console.log('✅ Consolidated data fetch completed (leads excluded)');
    } catch (error) {
        console.error('❌ Consolidated data fetch failed:', error);
    }
};


window.initializeDarkMode = function() {
  const savedDarkMode = localStorage.getItem('crm_dark_mode') === 'true';
  if (savedDarkMode) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }
  return savedDarkMode;
};

// Call this before React renders:
window.initializeDarkMode();
  
  // Override the original functions to use consolidated fetch
  if (originalFetchData) {
    window.renderAppBusinessLogic().fetchData = function() {
      console.log('🔄 fetchData called - routing to consolidated fetch');
      return window.consolidatedDataFetch();
    };
  }
  
  if (originalFetchMyActions) {
    window.fetchMyActions = function() {
      console.log('🔄 fetchMyActions called - using existing data + filtering');
      
      // If data is already loaded, just process it
      if (window.leads && window.leads.length > 0) {
        // Process My Actions data from already loaded data
        if (originalFetchMyActions) {
          return originalFetchMyActions();
        }
      } else {
        // If no data, fetch it first
        return window.consolidatedDataFetch().then(() => {
          if (originalFetchMyActions) {
            return originalFetchMyActions();
          }
        });
      }
    };
  }
  
  // Single initialization function
  window.initializeAppData = function() {
    if (!window.isLoggedIn) return;
    
    console.log('🎯 Initializing app data (single call)');
    return window.consolidatedDataFetch();
  };
  
  // Override useEffect to prevent multiple calls
  let isInitialized = false;
  
  const originalUseEffect = React.useEffect;
  React.useEffect = function(callback, deps) {
    // Intercept data fetching useEffects
    const callbackString = callback.toString();
    
    if (callbackString.includes('fetchData') && !isInitialized) {
      console.log('🛑 Intercepting fetchData useEffect - using consolidated approach');
      
      const newCallback = () => {
        if (window.isLoggedIn && !isInitialized) {
          isInitialized = true;
          window.initializeAppData();
        }
      };
      
      return originalUseEffect(newCallback, [window.isLoggedIn]);
    }
    
    // Allow other useEffects to run normally
    return originalUseEffect(callback, deps);
  };
  
  console.log('✅ API call consolidation system enabled');
  
})();
</script>     
<script>
// Login Performance Optimization
window.optimizeLoginPerformance = function() {
  // Debounce component re-renders during login
  const originalSetState = window.setState;
  let loginOptimizationActive = false;
  
  // Detect login process
  const originalSetIsLoggedIn = window.setIsLoggedIn;
  if (originalSetIsLoggedIn) {
    window.setIsLoggedIn = function(value) {
      if (value) {
        loginOptimizationActive = true;
        
        // Disable optimization after 3 seconds
        setTimeout(() => {
          loginOptimizationActive = false;
          
        }, 3000);
      }
      
      return originalSetIsLoggedIn(value);
    };
  }
  
  // Reduce component logging during login
  const componentLoggers = [
    'suppressComponentLog',
    'allocLog', 
    'deliveryLog',
    'dashLog'
  ];
  
  componentLoggers.forEach(loggerName => {
    if (window[loggerName]) {
      const originalLogger = window[loggerName];
      window[loggerName] = function(...args) {
        if (!loginOptimizationActive) {
          return originalLogger.apply(this, args);
        }
        // Suppress during login
      };
    }
  });
};

// Apply optimization
window.optimizeLoginPerformance();

</script>  

<!-- CSS Styles -->
<style>

    /* Quick Dark Mode Fixes */
  .dark .bg-white:hover,
  .dark [class*="hover:bg-gray"]:hover,
  .dark .hover\:bg-gray-50:hover,
  .dark .hover\:bg-gray-100:hover {
    background-color: rgb(55 65 81) !important;
  }
  
  .dark .text-gray-900,
  .dark .text-gray-800 {
    color: rgb(243 244 246) !important;
  }
  
  .dark .text-gray-600,
  .dark .text-gray-500 {
    color: rgb(156 163 175) !important;
  }

  /* Stadium Notes Modal Styles */
.stadium-notes-indicator {
  animation: pulse-dot 2s ease-in-out infinite;
}

@keyframes pulse-dot {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.2); opacity: 0.8; }
  100% { transform: scale(1); opacity: 1; }
}

/* Color classes for note categories */
.bg-blue-50 { background-color: #eff6ff; }
.bg-purple-50 { background-color: #f5f3ff; }
.bg-green-50 { background-color: #f0fdf4; }
.bg-yellow-50 { background-color: #fefce8; }
.bg-indigo-50 { background-color: #eef2ff; }
.bg-red-50 { background-color: #fef2f2; }
.bg-teal-50 { background-color: #f0fdfa; }
.bg-pink-50 { background-color: #fdf2f8; }

/* Dark mode colors */
.dark .bg-blue-900\/20 { background-color: rgba(30, 58, 138, 0.2); }
.dark .bg-purple-900\/20 { background-color: rgba(88, 28, 135, 0.2); }
.dark .bg-green-900\/20 { background-color: rgba(20, 83, 45, 0.2); }

  /* Add this CSS to your main stylesheet or in a style tag in index.html */

/* Fix search bar positioning and z-index issues */
.lead-client-toggle-container {
  position: relative;
  z-index: 10;
}

/* Ensure proper spacing and no overlap */
.filters-search-container {
  position: relative;
  z-index: 5;
  margin-top: 1rem;
  background-color: white;
}

/* Fix for search input specifically */
.search-input-container {
  position: relative;
  z-index: 1;
}

/* Prevent overlap when switching views */
.view-transition-fix {
  min-height: 60px; /* Adjust based on your search bar height */
  transition: all 0.3s ease;
}

/* If using React transitions */
.fade-enter {
  opacity: 0;
  transform: translateY(-10px);
}

.fade-enter-active {
  opacity: 1;
  transform: translateY(0);
  transition: opacity 300ms, transform 300ms;
}

.fade-exit {
  opacity: 1;
}

.fade-exit-active {
  opacity: 0;
  transform: translateY(-10px);
  transition: opacity 300ms, transform 300ms;
}

/* Ensure proper stacking context */
#leads-content-wrapper {
  position: relative;
  z-index: 1;
}

/* Fix any dropdown overlaps */
.filter-dropdown {
  position: relative;
  z-index: 20;
}

/* Add to your view toggle implementation */
.lead-management-header {
  position: sticky;
  top: 0;
  background-color: white;
  z-index: 100;
  padding: 1rem 0;
  border-bottom: 1px solid #e5e7eb;
}

  /* Birthday Animation Styles */
.birthday-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.5s ease;
}

/* ... (rest of the CSS from the artifact) ... */

  /* Ensure proper dark mode inheritance */
.dark main {
  background-color: rgb(17 24 39); /* gray-900 */
  color: rgb(243 244 246); /* gray-100 */
}

/* Fix for any nested containers that might override */
.dark .bg-white {
  background-color: rgb(31 41 55); /* gray-800 */
}

.dark .bg-gray-50 {
  background-color: rgb(17 24 39); /* gray-900 */
}

/* Ensure table containers respect dark mode */
.dark .bg-white.rounded-lg.shadow {
  background-color: rgb(31 41 55); /* gray-800 */
}

/* Fix text colors in dark mode */
.dark .text-gray-900 {
  color: rgb(243 244 246); /* gray-100 */
}

.dark .text-gray-600 {
  color: rgb(156 163 175); /* gray-400 */
}

.dark .text-gray-500 {
  color: rgb(209 213 219); /* gray-300 */
}

 /* Quick fix for tab overlay issues */
.flex-1.overflow-auto > div {
    position: relative;
    z-index: 1;
    background: white;
    min-height: 100vh;
}

.dark .flex-1.overflow-auto > div {
    background: #111827;
}

/* Hide inactive tab content */
[data-tab]:not([data-active="true"]) {
    display: none !important;
} 
  
  /* Target the orders management section specifically */
[id*="orders"] table th,
div:has(> h1:contains("Orders Management")) table th {
  padding: 8px 12px !important;
  font-size: 11px !important;
}

[id*="orders"] table td,
div:has(> h1:contains("Orders Management")) table td {
  padding: 6px 12px !important;
  font-size: 13px !important;
}

/* Compact status badges */
[id*="orders"] .rounded-full,
div:has(> h1:contains("Orders Management")) .rounded-full {
  padding: 2px 8px !important;
  font-size: 11px !important;
}

/* Compact action buttons */
[id*="orders"] button,
div:has(> h1:contains("Orders Management")) button {
  padding: 4px 8px !important;
  font-size: 12px !important;
}

/* Reduce gaps between elements */
[id*="orders"] .gap-1 {
  gap: 4px !important;
}

[id*="orders"] .gap-2 {
  gap: 8px !important;
}

/* Compact the header section */
[id*="orders"] h1,
div:has(> h1:contains("Orders Management")) h1 {
  font-size: 1.5rem !important;
  margin-bottom: 1rem !important;
}

/* Reduce overall padding */
[id*="orders"] > div,
div:has(> h1:contains("Orders Management")) > div {
  padding: 1rem !important;
}

/* Compact filter section if present */
[id*="orders"] .mb-6 {
  margin-bottom: 1rem !important;
}

[id*="orders"] .p-4 {
  padding: 0.75rem !important;
}

/* Adjust row height */
[id*="orders"] tbody tr {
  height: auto !important;
}

/* Make table more dense */
[id*="orders"] table {
  border-spacing: 0 !important;
}

/* Ensure text doesn't wrap unnecessarily */
[id*="orders"] .whitespace-nowrap {
  white-space: nowrap !important;
}

/* Optional: Add hover effect for better UX */
[id*="orders"] tbody tr:hover {
  background-color: rgba(0, 0, 0, 0.02) !important;
}

.dark [id*="orders"] tbody tr:hover {
  background-color: rgba(255, 255, 255, 0.02) !important;
}
  
/* Global Styles */
.dark {
  color-scheme: dark;
}

.sidebar-container {
  position: relative;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.sidebar-content {
  flex: 1;
  overflow-y: auto;
}

.sidebar-bottom {
  margin-top: auto;
  padding: 1rem;
  border-top: 1px solid #e5e7eb;
}

/* Dark mode styles */
.dark .sidebar-bottom {
  border-top-color: #374151;
}

/* Sidebar logout section adjustments */
.sidebar-logout {
  position: sticky;
  bottom: 0;
  background: inherit;
  padding: 1rem;
  border-top: 1px solid #e5e7eb;
}

.dark .sidebar-logout {
  border-top-color: #374151;
}

/* For mobile responsiveness */
@media (max-width: 768px) {
  .sidebar-container {
    height: auto;
    min-height: 100vh;
  }
}

/* Scrollbar styling */
.sidebar-content::-webkit-scrollbar {
  width: 4px;
}

.sidebar-content::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.sidebar-content::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 2px;
}

.sidebar-content::-webkit-scrollbar-thumb:hover {
  background: #555;
}

/* Dark mode scrollbar */
.dark .sidebar-content::-webkit-scrollbar-track {
  background: #374151;
}

.dark .sidebar-content::-webkit-scrollbar-thumb {
  background: #6b7280;
}

/* Prevent sidebar overlap issues */
.sidebar-navigation {
  overflow: visible !important;
  position: static !important;
}

/* Fix for modal z-index issues */
.modal-backdrop {
  z-index: 1000;
}

.modal-content {
  z-index: 1001;
}

/* Hide scrollbar for Chrome, Safari and Opera */
.no-scrollbar::-webkit-scrollbar {
  display: none;
}

/* Hide scrollbar for IE, Edge and Firefox */
.no-scrollbar {
  -ms-overflow-style: none;  /* IE and Edge */
  scrollbar-width: none;  /* Firefox */
}

/* Additional overflow and positioning fixes */
.sidebar-container {
  position: relative;
  overflow: visible;
}

.sidebar-container .fixed {
  position: relative !important;
}

.sidebar-container .absolute {
  position: relative !important;
}

/* Prevent negative margins and overlaps */
.sidebar-container > div {
  margin: 0 !important;
}

/* Ensure content doesn't get cut off */
.sidebar-content {
  padding-bottom: 80px; /* Make room for logout button */
}

/* Position logout area properly */
.sidebar-logout {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: inherit;
}

/* Override any problematic positioning */
.sidebar-container .bottom-0 {
  position: static !important;
}

.sidebar-container .left-0 {
  position: static !important;
}

.sidebar-container .right-0 {
  position: static !important;
}

/* Dark theme logout area */
.dark .sidebar-logout {
  background: #1f2937;
  border-top: 1px solid #374151;
}

/* Light theme logout area */
.sidebar-logout {
  background: white;
  border-top: 1px solid #e5e7eb;
}

/* Fix overflow issues in the container */
.sidebar-container {
  overflow-x: hidden;
  overflow-y: visible;
}

/* Make sure navigation doesn't get hidden */
.sidebar-navigation {
  position: relative;
  z-index: 1;
}

/* Logout button positioning */
.sidebar-logout {
  position: relative;
  z-index: 2;
}

/* Responsive fixes */
@media (min-width: 1024px) {
  .sidebar-container {
    height: 100vh;
    position: sticky;
    top: 0;
  }
}

/* Fix for small screens */
@media (max-width: 1023px) {
  .sidebar-logout {
    position: relative;
    margin-top: 2rem;
  }
  
  .sidebar-content {
    padding-bottom: 0;
  }
}

/* Additional positioning fixes */
.sidebar-container > div:last-child {
  margin-top: auto;
}

/* Override any transform or positioning that might cause issues */
.sidebar-container * {
  transform: none !important;
}

.sidebar-container .transform {
  transform: none !important;
}

/* Ensure proper layout flow */
.sidebar-container {
  display: flex;
  flex-direction: column;
}

.sidebar-navigation {
  flex: 1;
  min-height: 0;
}

.sidebar-logout {
  flex-shrink: 0;
}

/* More specific positioning override */
.sidebar-container [style*="position: fixed"],
.sidebar-container [style*="position: absolute"] {
  position: relative !important;
  top: auto !important;
  left: auto !important;
  right: auto !important;
  bottom: auto !important;
}

/* Force relative positioning for problematic elements */
.sidebar-container .absolute,
.sidebar-container .fixed {
  position: relative !important;
  inset: auto !important;
}

/* Alternative approach - hide problematic positioning */
.sidebar-container > div[class*="fixed"],
.sidebar-container > div[class*="absolute"] {
  position: relative !important;
  top: unset !important;
  left: unset !important;
  right: unset !important;
  bottom: unset !important;
}

/* Make logout area visible and prevent hiding */
.sidebar-logout {
  visibility: visible !important;
  display: block !important;
  opacity: 1 !important;
  position: relative !important;
  transform: none !important;
  top: auto !important;
  left: auto !important;
  right: auto !important;
  bottom: auto !important;
  margin-left: 0 !important;
  margin-right: 0 !important;
}

/* Ensure container doesn't hide content */
.sidebar-container {
  max-height: none !important;
  height: auto !important;
  min-height: 100vh;
  overflow: visible !important;
}

/* Force visibility for navigation items */
.sidebar-navigation > * {
  visibility: visible !important;
  position: relative !important;
}

/* Specific fix for logout button container */
.sidebar-container > div:has(.sidebar-logout),
.sidebar-container > div[class*="logout"] {
  position: relative !important;
  visibility: visible !important;
  display: block !important;
}

/* Last resort - force display */
.sidebar-logout,
.sidebar-logout * {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  position: relative !important;
  z-index: 999 !important;
}

/* Alternative container structure fix */
.sidebar-container {
  position: relative !important;
  display: flex !important;
  flex-direction: column !important;
  height: 100vh !important;
  overflow: visible !important;
}

.sidebar-navigation {
  flex: 1 !important;
  overflow-y: auto !important;
  position: relative !important;
}

.sidebar-logout {
  flex-shrink: 0 !important;
  position: relative !important;
  margin-top: auto !important;
}

/* Prevent any CSS that might hide the logout */
.sidebar-container * {
  max-height: none !important;
  overflow: visible !important;
}

/* Ensure proper spacing */
.sidebar-logout {
  padding: 1rem !important;
  margin: 0 !important;
  border-top: 1px solid #e5e7eb !important;
}

.dark .sidebar-logout {
  border-top-color: #374151 !important;
}

/* Remove any transforms or positions that could cause issues */
.sidebar-container * {
  position: static !important;
  transform: none !important;
  left: auto !important;
  right: auto !important;
  top: auto !important;
  bottom: auto !important;
}

/* Exception for the specific layout we want */
.sidebar-container {
  position: relative !important;
  display: flex !important;
  flex-direction: column !important;
}

.sidebar-logout {
  position: relative !important;
  margin-top: auto !important;
}

/* Force visibility for all sidebar elements */
.sidebar-container,
.sidebar-container *,
.sidebar-navigation,
.sidebar-navigation *,
.sidebar-logout,
.sidebar-logout * {
  visibility: visible !important;
  display: block !important;
  opacity: 1 !important;
}

.sidebar-container button,
.sidebar-logout button {
  display: inline-flex !important;
}

/* Ensure no content is cut off */
.sidebar-container {
  min-height: 100vh !important;
  height: auto !important;
  max-height: none !important;
  overflow-y: auto !important;
  overflow-x: hidden;
}

/* Final positioning fix */
.sidebar-container > div:last-child {
  position: relative !important;
  bottom: auto !important;
  left: auto !important;
  right: auto !important;
  margin-top: auto !important;
}

/* Ensure the logout button area is always visible */
.sidebar-logout {
  background: inherit !important;
  position: relative !important;
  z-index: 10 !important;
  margin-top: auto !important;
  flex-shrink: 0 !important;
}

/* Ensure proper stacking context */
.sidebar-container {
  z-index: 1 !important;
}

.sidebar-navigation {
  z-index: 2 !important;
  flex: 1 !important;
  overflow-y: auto !important;
}

.sidebar-logout {
  z-index: 3 !important;
  flex-shrink: 0 !important;
}

/* Remove problematic CSS classes that might interfere */
.sidebar-container .fixed,
.sidebar-container .absolute,
.sidebar-container .sticky {
  position: relative !important;
}

.sidebar-container .inset-0,
.sidebar-container .top-0,
.sidebar-container .bottom-0,
.sidebar-container .left-0,
.sidebar-container .right-0 {
  top: auto !important;
  bottom: auto !important;
  left: auto !important;
  right: auto !important;
  inset: auto !important;
}

/* Override Tailwind positioning utilities specifically in sidebar */
.sidebar-container .absolute {
  position: relative !important;
}

.sidebar-container .fixed {
  position: relative !important;
}

.sidebar-container .inset-x-0 {
  left: auto !important;
  right: auto !important;
}

.sidebar-container .inset-y-0 {
  top: auto !important;
  bottom: auto !important;
}

/* Make sure logout area has proper background */
.sidebar-logout {
  background-color: inherit !important;
}

/* Dark mode background fix */
.dark .sidebar-logout {
  background-color: #1f2937 !important;
}

/* Light mode background fix */
.sidebar-logout {
  background-color: white !important;
}

/* Additional safety measures */
.sidebar-container {
  contain: layout !important;
}

.sidebar-navigation {
  contain: layout !important;
}

/* Prevent any overflow issues */
.sidebar-container {
  overflow-x: hidden !important;
  overflow-y: visible !important;
}

/* Make sure content flows properly */
.sidebar-container > * {
  position: relative !important;
  width: 100% !important;
  flex-shrink: 0 !important;
}

.sidebar-navigation {
  flex-shrink: 1 !important;
  min-height: 0 !important;
}

.sidebar-logout {
  flex-shrink: 0 !important;
}

/* Final override for any problematic styles */
.sidebar-container * [class*="absolute"],
.sidebar-container * [class*="fixed"],
.sidebar-container * [style*="position: absolute"],
.sidebar-container * [style*="position: fixed"] {
  position: relative !important;
}

/* Emergency visibility fix */
.sidebar-container,
.sidebar-navigation,
.sidebar-logout {
  visibility: visible !important;
  display: flex !important;
  flex-direction: column !important;
}

.sidebar-container button,
.sidebar-navigation button,
.sidebar-logout button {
  display: inline-flex !important;
  visibility: visible !important;
}

/* Prevent hidden overflow */
.sidebar-container,
.sidebar-navigation {
  overflow: visible !important;
}

/* One more positioning fix attempt */
.sidebar-container > div:not(.sidebar-navigation):not(.sidebar-logout) {
  position: relative !important;
}

/* Fix for flex container */
.sidebar-container {
  display: flex !important;
  flex-direction: column !important;
  height: 100vh !important;
}

.sidebar-navigation {
  flex: 1 !important;
  display: block !important;
}

.sidebar-logout {
  display: block !important;
  margin-top: auto !important;
}

/* Ensure no elements are positioned outside the container */
.sidebar-container * {
  max-width: 100% !important;
  box-sizing: border-box !important;
}

/* Prevent any negative margins */
.sidebar-container * {
  margin-left: 0 !important;
  margin-right: 0 !important;
}

/* Ensure logout button container is part of the flow */
.sidebar-logout {
  width: 100% !important;
  box-sizing: border-box !important;
  padding: 1rem !important;
}

/* Override any external positioning */
.sidebar-container [style] {
  position: relative !important;
  top: auto !important;
  left: auto !important;
  right: auto !important;
  bottom: auto !important;
  transform: none !important;
}

/* Exception for the container itself */
.sidebar-container {
  position: relative !important;
  display: flex !important;
  flex-direction: column !important;
  transform: none !important;
}

/* Specific fix for any absolutely positioned children */
.sidebar-container > div {
  position: relative !important;
  display: block !important;
  width: 100% !important;
}

/* Ensure logout section is always at the bottom but visible */
.sidebar-logout {
  order: 999 !important;
  position: relative !important;
  margin-top: auto !important;
  background: inherit !important;
  border-top: 1px solid #e5e7eb !important;
}

.dark .sidebar-logout {
  border-top-color: #374151 !important;
  background: #1f2937 !important;
}

/* Override any CSS that might be hiding content */
.sidebar-container * {
  overflow: visible !important;
  clip: none !important;
  clip-path: none !important;
}

/* Ensure all content is accessible */
.sidebar-container * {
  height: auto !important;
  min-height: 0 !important;
  max-height: none !important;
}

/* Specific height for the navigation area */
.sidebar-navigation {
  min-height: 0 !important;
  height: auto !important;
  flex: 1 !important;
}

/* Specific height for logout area */
.sidebar-logout {
  height: auto !important;
  min-height: auto !important;
  flex: none !important;
}

/* Remove any CSS that might interfere with layout */
.sidebar-container .overflow-hidden {
  overflow: visible !important;
}

.sidebar-container .h-full {
  height: auto !important;
}

.sidebar-container .w-full {
  width: 100% !important;
}

/* Force proper display properties */
.sidebar-container {
  display: flex !important;
}

.sidebar-navigation {
  display: block !important;
  flex: 1 !important;
}

.sidebar-logout {
  display: block !important;
  flex: none !important;
}

/* Final attempt - use grid layout as backup */
.sidebar-container {
  display: grid !important;
  grid-template-rows: 1fr auto !important;
  height: 100vh !important;
}

.sidebar-navigation {
  grid-row: 1 !important;
  overflow-y: auto !important;
}

.sidebar-logout {
  grid-row: 2 !important;
}

/* Revert to flex if grid doesn't work */
.sidebar-container {
  display: flex !important;
  flex-direction: column !important;
}

/* Make absolutely sure logout is visible */
.sidebar-logout {
  visibility: visible !important;
  opacity: 1 !important;
  display: block !important;
  position: relative !important;
  z-index: 9999 !important;
  background: white !important;
  border-top: 1px solid #e5e7eb !important;
  padding: 1rem !important;
  margin: 0 !important;
  width: 100% !important;
  box-sizing: border-box !important;
}

.dark .sidebar-logout {
  background: #1f2937 !important;
  border-top-color: #374151 !important;
}

/* Ensure container doesn't cut off content */
.sidebar-container {
  overflow: visible !important;
  min-height: 100vh !important;
  height: auto !important;
  position: relative !important;
}

/* Force layout recalculation if needed */
.sidebar-container::after {
  content: "";
  display: block;
  clear: both;
  height: 0;
  visibility: hidden;
}

/* Logout button area fix */
.sidebar-logout {
  margin-top: auto;
  padding: 1rem;
  border-top: 1px solid #e5e7eb;
}

.sidebar-logout button {
  width: 100%;
  max-width: 200px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  padding: 0.75rem 1rem;
  border-radius: 0.375rem;
  transition: background-color 0.2s;
}

.sidebar-logout button:hover {
  background-color: #f9fafb;
}

/* Prevent any overlay issues */
.sidebar-container > div:last-child {
  position: relative !important;
  bottom: auto !important;
  left: auto !important;
  right: auto !important;
}

</style>
</head>
<body>
<div id="root"></div>
<div id="error-message" style="position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 12px 20px; border-radius: 6px; display: none; z-index: 9999;"></div>

<!-- API Configuration and Main App Script -->
<script>
// Show previous logs on page load
window.addEventListener('load', () => {
  const logs = JSON.parse(sessionStorage.getItem('debugLogs') || '[]');
  if (logs.length > 0) {
    
    logs.forEach(log => console.log('[' + (log.time) + '] ' + (log.key) + ':', log.data));
    console.log('=== End Previous Logs ===');
  }
});

// Clear logs button (press Ctrl+Shift+L)
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.shiftKey && e.key === 'L') {
    sessionStorage.removeItem('debugLogs');
    console.log('Debug logs cleared');
  }
});

const { useState, useEffect, useRef } = React; 

window.getRoleDisplayLabel = function(roleName) {
  const roleLabels = {
    'super_admin': 'Super Admin',
    'admin': 'Admin', 
    'sales_manager': 'Sales Manager',
    'sales_executive': 'Sales Executive',
    'finance': 'Finance',
    'supply': 'Supply',
    'warehouse': 'Warehouse'
  };
  return roleLabels[roleName] || roleName;
};

// Configure API endpoint
window.handleProceedFromPreview = () => {
  if (window.currentUploadFile) {
    console.log("🚀 Starting upload with file:", window.currentUploadFile.name);

    const cancelBtn = Array.from(document.querySelectorAll("button")).find(b => b.textContent === "Cancel");
    if (cancelBtn) cancelBtn.click();

    const formData = new FormData();
    formData.append("file", window.currentUploadFile);
    fetch(window.API_CONFIG.API_URL + "/upload/leads/csv", {
      method: "POST",
      headers: { Authorization: authToken ? 'Bearer ' + authToken : '' },
      body: formData
    }).then(response => response.json())
    .then(data => {
      if (data.success) {
        alert("✅ Upload successful!");
        window.location.reload();
      } else {
        alert("❌ Upload failed: " + (data.message || "Unknown error"));
      }
    }).catch(error => {
      console.error("Upload error:", error);
      alert("❌ Upload failed: " + error.message);
    });
  }
};

// ✅ Initialize the SimplifiedApp
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(window.SimplifiedApp));
</script>

  <script>
// Ensure leads initialize after login
let leadsInitCheckInterval = setInterval(() => {
    if (window.isLoggedIn && window.appState && window.LeadsAPI && !window.leadsInitialized) {
        console.log('🚀 Auto-initializing leads module');
        window.initializeLeadsModule();
        clearInterval(leadsInitCheckInterval);
    }
}, 1000);
</script>

  <script>
// Ensure financial data fetch function exists
window.fetchFinancialData = window.fetchFinancialData || function() {
    console.log('📊 Fetching financial data...');
    
    // If data is already being fetched, don't duplicate
    if (window._financialDataFetching) return;
    
    window._financialDataFetching = true;
    
    // Use your existing data fetch logic
    if (window.consolidatedDataFetch) {
        window.consolidatedDataFetch().then(() => {
            window._financialDataFetching = false;
            
            // Force financial stats update
            if (window.activeTab === 'financials' && window.renderFinancials) {
                window.renderFinancials();
            }
        });
    } else if (window.apiCall) {
        // Fallback to direct API calls
        Promise.all([
            window.apiCall('/orders'),
            window.apiCall('/invoices')
        ]).then(([ordersData, invoicesData]) => {
            if (window.appState) {
                window.appState.setOrders(ordersData.data || []);
                window.appState.setInvoices(invoicesData.data || []);
            }
            window._financialDataFetching = false;
            
            // Force re-render
            if (window.activeTab === 'financials' && window.renderFinancials) {
                window.renderFinancials();
            }
        });
    }
};
</script>

  <script>
(function() {
    'use strict';
    
    console.log('📱 Initializing mobile responsive design...');
    
    // Store original renderers
    let originalRenderers = {};
    
    function initializeMobileResponsive() {
        // Wait for all critical components
        if (!window.SimplifiedApp || !window.appState || !window.calculateEnhancedFinancialMetrics) {
            setTimeout(initializeMobileResponsive, 100);
            return;
        }
        
        // Store original renderers before overriding
        originalRenderers = {
            renderFinancials: window.renderFinancials,
            renderEnhancedFinancialStats: window.renderEnhancedFinancialStats,
            SimplifiedApp: window.SimplifiedApp
        };
        
        // Fix the financial stats renderer to ensure data loads
        window.renderEnhancedFinancialStats = function() {
            // Force data refresh before rendering
            if (window.calculateEnhancedFinancialMetrics) {
                const metrics = window.calculateEnhancedFinancialMetrics();
                
                // Ensure we have real data, not zeros
                if (!metrics || metrics.totalSales === 0) {
                    console.log('📊 Financial data not ready, fetching...');
                    
                    // Force data fetch
                    if (window.fetchFinancialData) {
                        window.fetchFinancialData();
                    }
                    
                    // Retry render after delay
                    setTimeout(() => {
                        if (window.renderFinancials) {
                            window.renderFinancials();
                        }
                    }, 500);
                    
                    // Return loading state
                    return React.createElement('div', { className: 'p-6 text-center' }, 
                        'Loading financial data...'
                    );
                }
                
                // Call original renderer with proper data
                if (originalRenderers.renderEnhancedFinancialStats) {
                    return originalRenderers.renderEnhancedFinancialStats.call(this);
                }
            }
        };
        
        // Update SimplifiedApp with proper lifecycle handling
        window.SimplifiedApp = function() {
            const { isLoggedIn } = window.appState;
            
            // Use effect to handle data loading on mount
            React.useEffect(() => {
                if (isLoggedIn && window.activeTab === 'financials') {
                    // Ensure financial data is loaded
                    if (window.fetchFinancialData) {
                        window.fetchFinancialData();
                    }
                }
            }, [isLoggedIn, window.activeTab]);
            
            if (!isLoggedIn) {
                return window.renderLogin();
            }
            
            return window.renderResponsiveLayout();
        };
        
        // Fix tab switching to ensure data loads
        const originalSetActiveTab = window.setActiveTab;
        window.setActiveTab = function(tab) {
            if (originalSetActiveTab) {
                originalSetActiveTab(tab);
            }
            
            // Force data refresh when switching to financials
            if (tab === 'financials') {
                setTimeout(() => {
                    if (window.fetchFinancialData) {
                        window.fetchFinancialData();
                    }
                    // Force re-render
                    if (window.renderApp) {
                        window.renderApp();
                    }
                }, 100);
            }
        };
        
        // Add viewport meta tag
        if (!document.querySelector('meta[name="viewport"]')) {
            const viewport = document.createElement('meta');
            viewport.name = 'viewport';
            viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
            document.head.appendChild(viewport);
        }
        
        console.log('✅ Mobile responsive design initialized with data loading fixes');
    }
    
    // Delay initialization to ensure DOM is ready
    setTimeout(initializeMobileResponsive, 2000);
})();
</script>

 <script>
// Ensure financial data loads when finance tab is active
document.addEventListener('DOMContentLoaded', function() {
    // Small delay to ensure everything is initialized
    setTimeout(() => {
        if (window.appState?.activeTab === 'finance' && window.fetchFinancialData) {
            console.log('Finance tab active on load, fetching data...');
            window.fetchFinancialData();
        }
    }, 500);
});
</script>   

<!-- CLEAN API-BASED CHART SYSTEM -->
<script>
(function() {
  'use strict';
  
  console.log('🚀 Loading clean API-based chart system...');
  
  // Simple chart creation that always uses API
  window.createDashboardCharts = function() {
    console.log('📊 Creating dashboard charts using API...');
    
    // Check if we're on dashboard
    if (window.activeTab !== 'dashboard') {
      return;
    }
    
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
      console.log('⏳ Waiting for Chart.js...');
      setTimeout(window.createDashboardCharts, 500);
      return;
    }
    
    // Check if API function exists
    if (!window.fetchChartDataFromAPI) {
      console.log('⏳ Waiting for API functions...');
      setTimeout(window.createDashboardCharts, 500);
      return;
    }
    
    // Fetch chart data from API
    window.fetchChartDataFromAPI();
  };
  
  // Handle filter changes - directly call API
  window.handleChartFilterChange = function() {
    console.log('🎯 Filter changed, refreshing from API...');
    if (window.fetchChartDataFromAPI) {
      window.fetchChartDataFromAPI();
    }
  };
  
  // Initialize when dashboard becomes active
  const originalSetActiveTab = window.setActiveTab;
  if (originalSetActiveTab) {
    window.setActiveTab = function(tab) {
      originalSetActiveTab(tab);
      if (tab === 'dashboard') {
        setTimeout(window.createDashboardCharts, 500);
      }
    };
  }
  
// Initialize on page load if dashboard is active AND user is logged in
document.addEventListener('DOMContentLoaded', function() {
    // Watch for login and dashboard
    let dashboardCheckInterval = setInterval(() => {
        if (window.isLoggedIn && window.appState) {
            // Clear the interval
            clearInterval(dashboardCheckInterval);
            
            // If on dashboard or no tab selected (default is dashboard)
            if (!window.activeTab || window.activeTab === 'dashboard') {
                console.log('📊 User logged in, initializing dashboard...');
                
                // Wait a bit for data to load
                setTimeout(() => {
                    if (window.fetchChartDataFromAPI) {
                        window.fetchChartDataFromAPI();
                    } else if (window.createDashboardCharts) {
                        window.createDashboardCharts();
                    }
                }, 1000);
            }
        }
    }, 500);
});
  
  // All chart function aliases point to API-based creation
  window.initializeOptimizedCharts = window.createDashboardCharts;
  window.initializeChartsAdvanced = window.createDashboardCharts;
  window.smartChartInit = window.createDashboardCharts;
  window.createChartsWithCurrentData = window.createDashboardCharts;
  window.updateChartsWithData = window.createDashboardCharts;
  window.initializeChartsWhenReady = window.createDashboardCharts;
  window.updateOptimizedCharts = window.createDashboardCharts;
  
  console.log('✅ Clean chart system loaded');
})();
</script>
    
</body>
</html>
