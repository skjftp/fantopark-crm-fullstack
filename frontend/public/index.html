<!-- CRM Version:FIELD-MAPPING-FIXED-20250630 -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FanToPark CRM Pro</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>  

<!-- API Configuration--->
<script>
// Configure API endpoint
const API_URL = "https://fantopark-backend-150582227311.us-central1.run.app/api";

// Global function to handle proceed from preview
window.handleProceedFromPreview = () => {
if (window.currentUploadFile) {
console.log("üöÄ Starting upload with file:", window.currentUploadFile.name);

// Close any open modals by clicking cancel/close buttons
const cancelBtn = Array.from(document.querySelectorAll("button")).find(b => b.textContent === "Cancel");
if (cancelBtn) cancelBtn.click();

// Trigger the upload with the stored file
const formData = new FormData();
formData.append("file", window.currentUploadFile);
fetch(API_URL + "/upload/leads/csv", {
method: "POST",
headers: { Authorization: authToken ? "Bearer " + authToken : undefined },
body: formData
}).then(response => response.json()).then(result => {
console.log("‚úÖ Upload successful:", result);
alert("‚úÖ Upload successful: " + result.message);
window.currentUploadFile = null;
location.reload();
}).catch(error => {
console.error("‚ùå Upload failed:", error);
alert("‚ùå Upload failed: " + error.message);
});
} else {
alert("No file selected for upload");
}
};


console.log("üîó API_URL set to:", API_URL);
console.log("üîó API_URL:", API_URL);
// Get stored auth token
let authToken = localStorage.getItem("crm_auth_token");

// Update authToken if found in localStorage
if (authToken) {
console.log("Auth token loaded from localStorage");
}

// API helper function
async function apiCall(endpoint, options = {}) {
const config = {
...options,
headers: {
'Content-Type': 'application/json',
...(authToken ? { 'Authorization': 'Bearer ' + (authToken) } : {}),
...options.headers
}
};



const response = await fetch((API_URL) + (endpoint), config);

console.log('API Request:', {
url: (API_URL) + (endpoint),
method: config.method || 'GET',
headers: config.headers
});
console.log('Response Status:', response.status, response.statusText);

if (response.status === 401) {
// Token expired or invalid
console.error('401 Unauthorized - Authentication failed');
console.error('Endpoint:', endpoint);
console.error('Response status:', response.status);
localStorage.removeItem('crm_auth_token');
authToken = null;  // Clear the global authToken variable
authToken = null;  // Clear the global authToken variable
localStorage.removeItem('crm_user');

// Don't reload immediately for login attempts
if (endpoint !== '/auth/login') {
window.location.reload();
}
throw new Error('Authentication failed - Invalid credentials');
}

if (!response.ok) {
const errorText = await response.text();
console.error('API Error Response:', errorText);
throw new Error('API Error: ' + (response.statusText) + ' - ' + (errorText));
}

const data = await response.json();
console.log('API Response from ' + (endpoint) + ':', data);
return data;
}
</script>

<style>
/* Dark mode base styles */
.dark {
color-scheme: dark;
}

.dark body {
background-color: #111827;
color: #f3f4f6;
}

/* Dark mode for main containers */
.dark .bg-white {
background-color: #1f2937 !important;
}

.dark .bg-gray-50 {
background-color: #111827 !important;
}

.dark .bg-gray-100 {
background-color: #0f172a !important;
}

/* Dark mode for text */
.dark .text-gray-900 {
color: #f3f4f6 !important;
}

.dark .text-gray-800 {
color: #e5e7eb !important;
}

.dark .text-gray-700 {
color: #d1d5db !important;
}

.dark .text-gray-600 {
color: #9ca3af !important;
}

.dark .text-gray-500 {
color: #6b7280 !important;
}

/* Dark mode for borders */
.dark .border-gray-200 {
border-color: #374151 !important;
}

.dark .border-gray-300 {
border-color: #4b5563 !important;
}

.dark .border-b {
border-color: #374151 !important;
}

/* Dark mode for inputs and forms */
.dark input, .dark select, .dark textarea {
background-color: #374151 !important;
border-color: #4b5563 !important;
color: #f3f4f6 !important;
}

.dark input:focus, .dark select:focus, .dark textarea:focus {
border-color: #3b82f6 !important;
background-color: #4b5563 !important;
}

/* Dark mode for hover states */
.dark .hover\:bg-gray-50:hover {
background-color: #374151 !important;
}

.dark .hover\:bg-gray-100:hover {
background-color: #4b5563 !important;
}

/* Dark mode for tables */
.dark table {
background-color: #1f2937 !important;
}

.dark thead {
background-color: #111827 !important;
}

.dark tbody tr:hover {
background-color: #374151 !important;
}

/* Dark mode for modals */
.dark .bg-black.bg-opacity-50 {
background-color: rgba(0, 0, 0, 0.75) !important;
}

/* Dark mode for shadows */
.dark .shadow-sm {
box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.5) !important;
}

.dark .shadow-md {
box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5) !important;
}

/* Dark mode for sidebar */
.dark .bg-gray-900 {
background-color: #0f172a !important;
}

/* Dark mode scrollbars */
.dark ::-webkit-scrollbar {
background-color: #1f2937;
}

.dark ::-webkit-scrollbar-thumb {
background-color: #4b5563;
}

.dark ::-webkit-scrollbar-thumb:hover {
background-color: #6b7280;
}


/* Invoice Styles - Updated to match invoice module */
.invoice-preview {
background: white;
border: 2px solid #000;
font-family: Arial, sans-serif;
font-size: 10px;
line-height: 1.2;
margin: 0 auto;
max-width: 210mm;
height: fit-content;
padding: 8mm;
box-sizing: border-box;
display: block;
overflow: hidden;
}
.invoice-header-row {
display: grid;
grid-template-columns: 300px 1fr auto;
padding: 10px 8px;
border-bottom: 2px solid #000;
align-items: center;
margin-bottom: 10px;
background: #f8f9fa;
}
.company-logo {
width: 210px;
height: 150px;
margin: 0;
}
.company-logo img {
max-width: 210px;
max-height: 150px;
object-fit: contain;
}
.invoice-title {
text-align: right;
font-size: 16px;
font-weight: bold;
padding-top: 10px;
color: #2c3e50;
}
.invoice-meta {
display: grid;
grid-template-columns: 1fr 1fr;
padding: 8px;
border-bottom: 1px solid #000;
font-size: 10px;
margin-bottom: 10px;
background: #f8f9fa;
}
.customer-section {
padding: 10px 8px;
border-bottom: 1px solid #000;
margin-bottom: 12px;
background: #f8f9fa;
}
.customer-title {
font-weight: bold;
margin-bottom: 4px;
font-size: 10px;
}
.invoice-table {
width: 100%;
border-collapse: collapse;
font-size: 10px;
margin-bottom: 12px;
}
.invoice-table th {
background: #2c3e50;
color: white;
padding: 6px 4px;
text-align: left;
border: 1px solid #000;
font-weight: bold;
font-size: 10px;
}
.invoice-table td {
padding: 6px 4px;
border: 1px solid #000;
text-align: left;
background: white;
}
.totals-table {
width: 100%;
border-collapse: collapse;
font-size: 10px;
margin-bottom: 12px;
}
.totals-table td {
padding: 4px;
border: 1px solid #000;
}
.bank-details {
display: grid;
grid-template-columns: 1fr 1fr;
padding: 10px 8px;
border: 2px solid #2c3e50;
font-size: 9px;
gap: 10px;
background: #f8f9fa;
margin-top: 10px;
}
.bank-info h4 {
margin-bottom: 6px;
font-size: 10px;
color: #2c3e50;
border-bottom: 1px solid #2c3e50;
padding-bottom: 2px;
}
.bank-info div {
margin-bottom: 2px;
line-height: 1.1;
}
.payment-qr {
text-align: center;
}
.payment-qr img {
width: 120px;
height: 120px;
border: 2px solid #ddd;
padding: 5px;
background: white;
}
.invoice-footer {
margin-top: 10px;
text-align: center;
font-size: 8px;
color: #666;
}
.company-info-section {
background: white;
padding: 8px;
border: 1px solid #ddd;
border-radius: 3px;
margin-bottom: 8px;
}
.company-info-section h4 {
color: #2c3e50;
margin-bottom: 6px;
border-bottom: 1px solid #2c3e50;
padding-bottom: 2px;
text-align: center;
font-size: 9px;
}
@media print {
body { background: white; padding: 0; margin: 0; }
.invoice-preview { border: none; box-shadow: none; margin: 0; padding: 5mm; }
.modal-backdrop { display: none; }
.sticky { position: relative !important; }
@page { margin: 10mm; size: A4; }
}
/* Fix for action buttons */
.action-buttons button {
position: relative;
z-index: 10;
cursor: pointer;
}
td .flex button {
position: relative;
z-index: 10;
}

/* Logout button fix */
.logout-button-fix {
position: relative !important;
width: auto !important;
height: auto !important;
}

/* Prevent invisible overlays */
button:not(:hover) {
z-index: auto !important;
}

/* Ensure sidebar stays contained */
.sidebar-container {
overflow: hidden;
}


/* Logout button area fix */
.sidebar-logout {
margin-top: auto;
padding: 1rem;
border-top: 1px solid #e5e7eb;
}

.sidebar-logout button {
width: 100%;
max-width: 200px;
margin: 0 auto;
display: flex;
align-items: center;
padding: 0.75rem 1rem;
border-radius: 0.375rem;
transition: background-color 0.2s;
}

.sidebar-logout button:hover {
background-color: #f9fafb;
}

/* Prevent any overlay issues */
.sidebar-container > div:last-child {
position: relative !important;
bottom: auto !important;
left: auto !important;
right: auto !important;
}

</style>

<style>
.test-mode-active {
border: 4px solid #dc2626 !important;
box-shadow: inset 0 0 0 4px #dc2626;
}

/* Logout button fix */
.logout-button-fix {
position: relative !important;
width: auto !important;
height: auto !important;
}

/* Prevent invisible overlays */
button:not(:hover) {
z-index: auto !important;
}

/* Ensure sidebar stays contained */
.sidebar-container {
overflow: hidden;
}


/* Logout button area fix */
.sidebar-logout {
margin-top: auto;
padding: 1rem;
border-top: 1px solid #e5e7eb;
}

.sidebar-logout button {
width: 100%;
max-width: 200px;
margin: 0 auto;
display: flex;
align-items: center;
padding: 0.75rem 1rem;
border-radius: 0.375rem;
transition: background-color 0.2s;
}

.sidebar-logout button:hover {
background-color: #f9fafb;
}

/* Prevent any overlay issues */
.sidebar-container > div:last-child {
position: relative !important;
bottom: auto !important;
left: auto !important;
right: auto !important;
}

</style>
</head>
<body>
<div id="test-mode-indicator" style="display:none; background:#dc2626; color:white; text-align:center; padding:10px; font-weight:bold;">
üß™ TEST MODE ACTIVE - Delete All buttons enabled
</div>
<script>if(localStorage.getItem('testMode')==='true') document.getElementById('test-mode-indicator').style.display='block';</script>
<div id="root"></div>
<div id="error-message" style="position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 12px 20px; border-radius: 6px; display: none; z-index: 9999;"></div>
<script>

// Persistent logging for debugging
const debugLog = (key, data) => {
const logs = JSON.parse(sessionStorage.getItem('debugLogs') || '[]');
logs.push({ time: new Date().toISOString(), key, data });
sessionStorage.setItem('debugLogs', JSON.stringify(logs));
console.log('[' + (key) + ']', data);
};



// Show previous logs on page load
window.addEventListener('load', () => {
const logs = JSON.parse(sessionStorage.getItem('debugLogs') || '[]');
if (logs.length > 0) {
console.log('=== Previous Session Logs ===');
logs.forEach(log => console.log('[' + (log.time) + '] ' + (log.key) + ':', log.data));
console.log('=== End Previous Logs ===');
}
});

// Clear logs button (press Ctrl+Shift+L)
document.addEventListener('keydown', (e) => {
if (e.ctrlKey && e.shiftKey && e.key === 'L') {
sessionStorage.removeItem('debugLogs');
console.log('Debug logs cleared');
}
});

const { useState, useEffect, useRef } = React;

// User roles and permissions configuration
const USER_ROLES = {
super_admin: {
label: 'Super Admin',
permissions: {
dashboard: { read: true, write: true, delete: true, manage_users: true,
finance: { read: true, write: true, delete: true, approve: true }},
leads: { read: true, write: true, delete: true, assign: true, progress: true },
inventory: { read: true, write: true, delete: true, allocate: true },
orders: { read: true, write: true, delete: true, approve: true, assign: true },
finance: { read: true, write: true, delete: true, approve: true },
delivery: { read: true, write: true, delete: true },
users: { read: true, write: true, delete: true, manage_roles: true }
}
},
admin: {
label: 'Admin',
permissions: {
dashboard: { read: true, write: true, delete: true, manage_users: false },
leads: { read: true, write: true, delete: true, assign: true, progress: true },
inventory: { read: true, write: true, delete: true, allocate: true },
orders: { read: true, write: true, delete: true, approve: false, assign: true },
finance: { read: true, write: false, delete: false, approve: false },
delivery: { read: true, write: true, delete: true },
users: { read: true, write: false, delete: false, manage_roles: false }
}
},
sales_manager: {
label: 'Sales Manager',
permissions: {
dashboard: { read: true, write: false, delete: false, manage_users: false },
leads: { read: true, write: true, delete: false, assign: true, progress: true },
inventory: { read: true, write: false, delete: false, allocate: false },
orders: { read: true, write: false, delete: false, approve: false, assign: false },
finance: { read: true, write: false, delete: false, approve: false },
delivery: { read: true, write: false, delete: false },
users: { read: false, write: false, delete: false, manage_roles: false }
}
},
sales_executive: {
label: 'Sales Executive',
permissions: {
dashboard: { read: true, write: false, delete: false, manage_users: false },
leads: { read: true, write: true, delete: true, assign: false, progress: true }, // Changed: added delete
inventory: { read: true, write: false, delete: false, allocate: false },
orders: { read: true, write: true, delete: false, approve: false, assign: false }, // Changed: added write
finance: { read: false, write: false, delete: false, approve: false },
delivery: { read: true, write: false, delete: false },
users: { read: false, write: false, delete: false, manage_roles: false }
}
},
supply_sales_service_manager: {
label: 'Supply Sales Service Manager',
permissions: {
dashboard: { read: true, write: true, delete: true, manage_users: false },
leads: { read: true, write: true, delete: true, assign: true, progress: true },
inventory: { read: true, write: true, delete: true, allocate: true },
orders: { read: true, write: true, delete: true, approve: true, assign: true },
finance: { read: true, write: true, delete: true, approve: true },
delivery: { read: true, write: true, delete: true },
stadiums: { read: true, write: true, delete: true }, 
users: { read: false, write: false, delete: false, manage_roles: false }
}
},
finance_manager: {
label: 'Finance Manager',
permissions: {
dashboard: { read: true, write: false, delete: false, manage_users: false },
leads: { read: true, write: false, delete: false, assign: false, progress: false },
inventory: { read: true, write: false, delete: false, allocate: false },
orders: { read: true, write: false, delete: false, approve: true, assign: false },
finance: { read: true, write: true, delete: true, approve: true },
delivery: { read: true, write: false, delete: false },
users: { read: false, write: false, delete: false, manage_roles: false }
}
},
viewer: {
label: 'Viewer',
permissions: {
dashboard: { read: true, write: false, delete: false, manage_users: false },
leads: { read: true, write: false, delete: false, assign: false, progress: false },
inventory: { read: true, write: false, delete: false, allocate: false },
orders: { read: true, write: false, delete: false, approve: false, assign: false },
finance: { read: true, write: false, delete: false, approve: false },
delivery: { read: true, write: false, delete: false },
users: { read: false, write: false, delete: false, manage_roles: false }
}
}
};



const stadiumFormFields = [
{ name: 'name', label: 'Stadium Name', type: 'text', required: true, placeholder: 'e.g., Wankhede Stadium' },
{ name: 'city', label: 'City', type: 'text', required: true, placeholder: 'e.g., Mumbai' },
{ name: 'state', label: 'State/Province', type: 'text', required: false, placeholder: 'e.g., Maharashtra' },
{ name: 'country', label: 'Country', type: 'select', required: true, options: [
'India', 'United States', 'United Kingdom', 'Australia', 'Canada', 'South Africa',
'New Zealand', 'West Indies', 'Sri Lanka', 'Bangladesh', 'Pakistan', 'Afghanistan',
'Spain', 'Germany', 'France', 'Italy', 'Brazil', 'Argentina', 'Japan', 'China', 'Other'
]},
{ name: 'sport_type', label: 'Primary Sport', type: 'select', required: true, options: [
'Cricket', 'Football', 'Basketball', 'Tennis', 'Hockey', 'Baseball', 
'Rugby', 'Athletics', 'Formula 1', 'Multi-Sport', 'Other'
]},
{ name: 'capacity', label: 'Seating Capacity', type: 'number', required: false, placeholder: 'e.g., 33000' },
{ name: 'opened_year', label: 'Year Opened', type: 'number', required: false, placeholder: 'e.g., 1974' },
{ name: 'nickname', label: 'Nickname/Alternative Name', type: 'text', required: false, placeholder: 'e.g., Home of Cricket' },
{ name: 'website', label: 'Official Website', type: 'url', required: false, placeholder: 'https://...' },
{ name: 'notes', label: 'Additional Notes', type: 'textarea', required: false, placeholder: 'Famous matches, renovations, etc.' }
];


// Helper function to display user names instead of emails

// Priority styling helper functions
const getPriorityStyles = (priority) => {
  switch (priority) {
    case "P1":
      return "bg-red-100 border-l-4 border-red-500 text-red-800";
    case "P2":
      return "bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800";
    case "P3":
      return "bg-green-100 border-l-4 border-green-500 text-green-800";
    default:
      return "bg-gray-100 border-l-4 border-gray-500 text-gray-800";
  }
};

const getPriorityBadgeColor = (priority) => {
  switch (priority) {
    case "P1":
      return "bg-red-500 text-white";
    case "P2":
      return "bg-yellow-500 text-white";
    case "P3":
      return "bg-green-500 text-white";
    default:
      return "bg-gray-500 text-white";
  }
};
// Helper function to display user names instead of emails
const getUserDisplayName = (email, usersList) => {
if (!email || !usersList) return email || 'Unassigned';
const user = usersList.find(u => u.email === email);
return user ? user.name : email;
};



const getBaseAmount = (data) => {




if (data.type_of_sale === 'Service Fee') {
return parseFloat(data.service_fee_amount) || 0;
}
return data.invoice_items?.reduce((sum, item) => 
sum + ((item.quantity || 0) * (item.rate || 0)), 0
) || 0;
}; 

const formatDateForInput = (dateValue) => {
if (!dateValue) return '';

try {
// Handle different date formats
let date;

// If it's already a Date object
if (dateValue instanceof Date) {
date = dateValue;
}
// If it's an ISO string (from CSV upload)
else if (typeof dateValue === 'string' && dateValue.includes('T')) {
date = new Date(dateValue);
}
// If it's a simple date string (YYYY-MM-DD)
else if (typeof dateValue === 'string') {
date = new Date(dateValue);
}
// If it's a Firestore timestamp object
else if (typeof dateValue === 'object' && dateValue._seconds) {
date = new Date(dateValue._seconds * 1000);
}
else {
return '';
}

// Check if date is valid
if (isNaN(date.getTime())) {
return '';
}

// Convert to YYYY-MM-DD format for HTML input
const year = date.getFullYear();
const month = String(date.getMonth() + 1).padStart(2, '0');
const day = String(date.getDate()).padStart(2, '0');

return `${year}-${month}-${day}`;
} catch (error) {
console.error('Date formatting error:', error);
return '';
}
};



// Helper function to get proper role display label
const getRoleDisplayLabel = (roleName) => {
// Map of role names to display labels
const roleLabels = {
'super_admin': 'Super Admin',
'admin': 'Admin', 
'sales_manager': 'Sales Manager',
'sales_executive': 'Sales Executive',
'supply_manager': 'Supply Manager', // Legacy
'supply_sales_service_manager': 'Supply Sales Service Manager', // Updated
'finance_manager': 'Finance Manager',
'viewer': 'Viewer'
};



return roleLabels[roleName] || roleName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
};



// Helper function to format date for display (DD/MM/YYYY)
const formatDateForDisplay = (dateValue) => {
if (!dateValue) return 'Not Set';

try {
let date;

if (dateValue instanceof Date) {
date = dateValue;
} else if (typeof dateValue === 'string' && dateValue.includes('T')) {
date = new Date(dateValue);
} else if (typeof dateValue === 'string') {
date = new Date(dateValue);
} else if (typeof dateValue === 'object' && dateValue._seconds) {
date = new Date(dateValue._seconds * 1000);
} else {
return 'Invalid Date';
}

if (isNaN(date.getTime())) {
return 'Invalid Date';
}

const day = String(date.getDate()).padStart(2, '0');
const month = String(date.getMonth() + 1).padStart(2, '0');
const year = date.getFullYear();

return `${day}/${month}/${year}`;
} catch (error) {
return 'Error';
}
};





// Default users (in production, this would come from a database)
const DEFAULT_USERS = [
{
id: 1,
name: 'Admin User',
email: 'admin@fantopark.com',
password: 'admin123',
role: 'super_admin',
department: 'Administration',
status: 'active',
created_date: '2024-01-01'
},
{
id: 2,
name: 'Varun',
email: 'varun@fantopark.com',
password: 'sales123',
role: 'sales_manager',
department: 'Sales',
status: 'active',
created_date: '2024-01-15'
},
{
id: 3,
name: 'Pratik',
email: 'pratik@fantopark.com',
password: 'sales123',
role: 'sales_executive',
department: 'Sales',
status: 'active',
created_date: '2024-01-15'
},
{
id: 4,
name: 'Ankita',
email: 'ankita@fantopark.com',
password: 'sales123',
role: 'sales_executive',
department: 'Sales',
status: 'active',
created_date: '2024-01-15'
},
{
id: 5,
name: 'Amit',
email: 'amit@fantopark.com',
password: 'sales123',
role: 'sales_executive',
department: 'Sales',
status: 'active',
created_date: '2024-01-15'
},
{
id: 6,
name: 'Amisha',
email: 'amisha@fantopark.com',
password: 'sales123',
role: 'sales_executive',
department: 'Sales',
status: 'active',
created_date: '2024-01-15'
},
{
id: 7,
name: 'Manmeet',
email: 'manmeet@fantopark.com',
password: 'sales123',
role: 'sales_executive',
department: 'Sales',
status: 'active',
created_date: '2024-01-15'
},
{
id: 8,
name: 'Akshay Singh',
email: 'akshay@fantopark.com',
password: 'supply123',
role: 'supply_sales_service_manager',
department: 'Supply Chain',
status: 'active',
created_date: '2024-01-20'
},
{
id: 9,
name: 'Shafeeq',
email: 'shafeeq@fantopark.com',
password: 'supply123',
role: 'supply_sales_service_manager',
department: 'Supply Chain',
status: 'active',
created_date: '2024-01-20'
},
{
id: 10,
name: 'Ankit',
email: 'ankit@fantopark.com',
password: 'supply123',
role: 'supply_sales_service_manager',
department: 'Supply Chain',
status: 'active',
created_date: '2024-01-20'
},
{
id: 11,
name: 'Finance Manager',
email: 'finance@fantopark.com',
password: 'finance123',
role: 'finance_manager',
department: 'Finance',
status: 'active',
created_date: '2024-01-10'
}
];

// Lead and Order statuses (unchanged)
const LEAD_STATUSES = {
unassigned: { 
label: 'Unassigned', 
color: 'bg-gray-100 text-gray-800', 
next: ['assigned', 'attempt_1', 'attempt_2', 'attempt_3'] 
},
assigned: { 
label: 'Assigned', 
color: 'bg-blue-100 text-blue-800', 
next: ['contacted', 'attempt_1', 'attempt_2', 'attempt_3'] 
},
contacted: { 
label: 'Contacted', 
color: 'bg-yellow-100 text-yellow-800', 
next: ['qualified', 'junk', 'pickup_later'] // Added pickup_later
},
attempt_1: { 
label: 'Attempt 1', 
color: 'bg-yellow-50 text-yellow-700', 
next: ['contacted', 'attempt_2', 'junk', 'pickup_later'] // Added pickup_later
},
attempt_2: { 
label: 'Attempt 2', 
color: 'bg-orange-50 text-orange-700', 
next: ['contacted', 'attempt_3', 'junk', 'pickup_later'] // Added pickup_later
},
attempt_3: { 
label: 'Attempt 3', 
color: 'bg-red-50 text-red-700', 
next: ['contacted', 'junk', 'pickup_later'] // Added pickup_later
},
qualified: { 
label: 'Qualified', 
color: 'bg-green-100 text-green-800', 
next: ['hot', 'warm', 'cold', 'pickup_later'] // Added pickup_later
},
junk: { 
label: 'Junk', 
color: 'bg-red-100 text-red-800', 
next: [] 
},
hot: { 
label: 'Hot Lead', 
color: 'bg-red-100 text-red-800', 
next: ['quote_requested', 'converted', 'dropped', 'pickup_later'], // Added pickup_later
temperature: 'hot'
},
warm: { 
label: 'Warm Lead', 
color: 'bg-orange-100 text-orange-800', 
next: ['quote_requested', 'converted', 'dropped', 'pickup_later'], // Added pickup_later
temperature: 'warm'
},
cold: { 
label: 'Cold Lead', 
color: 'bg-blue-100 text-blue-800', 
next: ['quote_requested', 'converted', 'dropped', 'pickup_later'], // Added pickup_later
temperature: 'cold'
},
quote_requested: {
label: 'Quote Requested',
color: 'bg-purple-100 text-purple-800',
next: ['converted', 'dropped', 'pickup_later'], // Added pickup_later
parallel: true
},
converted: { 
label: 'Converted', 
color: 'bg-green-100 text-green-800', 
next: ['payment', 'payment_post_service', 'payment_received', 'pickup_later'] // Added pickup_later
},
payment_received: { 
label: 'Payment Received', 
color: 'bg-green-100 text-green-800', 
next: [] 
},
dropped: { 
label: 'Dropped', 
color: 'bg-gray-100 text-gray-800', 
next: ['pickup_later'] // Added pickup_later
},
payment: { 
label: 'Payment Received',
color: 'bg-emerald-100 text-emerald-800', 
next: [] 
},
payment_post_service: {
label: 'Payment Post Service',
color: 'bg-purple-100 text-purple-800',
next: ['payment']
},
// NEW: Pick Up Later status
pickup_later: {
label: 'Pick Up Later',
color: 'bg-indigo-100 text-indigo-800',
next: ['contacted', 'qualified', 'hot', 'warm', 'cold', 'quote_requested', 'converted', 'dropped'],
requires_followup_date: true
}
};



const ORDER_STATUSES = {
pending_approval: { 
label: 'Pending Approval', 
color: 'bg-yellow-100 text-yellow-800', 
next: ['approved', 'rejected'] 
},
approved: { 
label: 'Approved', 
color: 'bg-green-100 text-green-800', 
next: ['service_assigned'] 
},
service_assigned: { 
label: 'Service Assigned', 
color: 'bg-blue-100 text-blue-800', 
next: ['completed'] 
},
completed: { 
label: 'Completed', 
color: 'bg-gray-100 text-gray-800', 
next: [] 
},
rejected: { 
label: 'Rejected', 
color: 'bg-red-100 text-red-800', 
next: [] 
}
};



// Add this after ORDER_STATUSES
const INDIAN_STATES = [
'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh', 'Goa', 'Gujarat', 
'Haryana', 'Himachal Pradesh', 'Jharkhand', 'Karnataka', 'Kerala', 'Madhya Pradesh', 
'Maharashtra', 'Manipur', 'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Punjab', 
'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura', 'Uttar Pradesh', 
'Uttarakhand', 'West Bengal', 'Andaman and Nicobar Islands', 'Chandigarh', 
'Dadra and Nagar Haveli and Daman and Diu', 'Delhi', 'Jammu and Kashmir', 'Ladakh', 
'Lakshadweep', 'Puducherry'
];

// Team configurations removed - now using dynamic users from database

const getStatusIcon = (status) => {
const statusIcons = {
'qualified': '‚úÖ',
'junk': 'üóëÔ∏è',
'hot': 'üî•',
'warm': 'üå§Ô∏è',
'cold': '‚ùÑÔ∏è',
'quote_requested': 'üìã',
'converted': 'üí∞',
'dropped': '‚ùå',
'pickup_later': '‚è∞',
'contacted': 'üìû',
'attempt_1': 'üìû¬π',
'attempt_2': 'üìû¬≤',
'attempt_3': 'üìû¬≥',
'payment': 'üí≥',
'payment_post_service': 'üìÖ',
'payment_received': '‚úÖ'
};


return statusIcons[status] || 'üìù';
};



// Replace existing calculateGST function

// Helper function to get lead temperature (preserves temperature through parallel stages)
const getLeadTemperature = (lead) => {
// If current status has temperature, use it
if (LEAD_STATUSES[lead.status]?.temperature) {
return LEAD_STATUSES[lead.status].temperature;
}

// If it's a parallel stage, get temperature from lead data
if (lead.temperature) {
return lead.temperature;
}

// Fallback to status if it's a temperature status
if (['hot', 'warm', 'cold'].includes(lead.status)) {
return lead.status;
}

return null;
};



// Helper function to get display temperature for dashboard
const getDisplayTemperature = (lead) => {
const temp = getLeadTemperature(lead);
if (temp && ['hot', 'warm', 'cold'].includes(temp)) {
return temp;
}
// For quote_requested, check if it was previously hot/warm/cold
if (lead.status === 'quote_requested' && lead.temperature) {
return lead.temperature;
}
return null;
};



function App() {
// Authentication states
const [isLoggedIn, setIsLoggedIn] = useState(false);
const [testMode, setTestMode] = useState(() => {
return localStorage.getItem('testMode') === 'true';
});
const [user, setUser] = useState(null);
const [email, setEmail] = useState('');
const [password, setPassword] = useState('');
const [activeTab, setActiveTab] = useState(() => {
const savedTab = localStorage.getItem('crm_active_tab');
return savedTab || 'dashboard';
});
const [loading, setLoading] = useState(false);

// Users management

// Initialize empty, will fetch from API
const [leads, setLeads] = useState([]);
const [inventory, setInventory] = useState([]);
// Add this line near other useState declarations
const [editingInventory, setEditingInventory] = useState(null);
const [showInventoryForm, setShowInventoryForm] = useState(false);
const [orders, setOrders] = useState([]);
const [orderToAssign, setOrderToAssign] = useState(null);
const [reminders, setReminders] = useState([]);
const [showReminderDashboard, setShowReminderDashboard] = useState(false);
const [reminderStats, setReminderStats] = useState({
total: 0,
overdue: 0,
due_today: 0,
pending: 0
}); 
const [sportsEvents, setSportsEvents] = useState([]);
const [showEventForm, setShowEventForm] = useState(false);
const [showEventDetail, setShowEventDetail] = useState(false);
const [currentEvent, setCurrentEvent] = useState(null);
const [eventFormData, setEventFormData] = useState({
title: "",
date: "",
time: "",
venue: "",
category: "cricket",
description: "",
ticket_available: false,
fantopark_package: ""
});
const [calendarView, setCalendarView] = useState("month");
const [selectedDate, setSelectedDate] = useState(new Date());
const [showOrderAssignModal, setShowOrderAssignModal] = useState(false);
const [showAllocationManagement, setShowAllocationManagement] = React.useState(false);
const [showInventoryDetail, setShowInventoryDetail] = useState(false);
const [currentInventoryDetail, setCurrentInventoryDetail] = useState(null);
const [currentAllocations, setCurrentAllocations] = React.useState([]);
const [showOrderForm, setShowOrderForm] = useState(false);
const [inventoryEventTypeFilter, setInventoryEventTypeFilter] = useState('all');
const [inventorySortField, setInventorySortField] = useState('event_date');
const [inventorySortDirection, setInventorySortDirection] = useState('desc'); // 'asc' or 'desc'
const [allocationManagementInventory, setAllocationManagementInventory] = React.useState(null);
const [leadsSourceFilter, setLeadsSourceFilter] = useState('all');
const [leadsBusinessTypeFilter, setLeadsBusinessTypeFilter] = useState('all');
const [leadsEventFilter, setLeadsEventFilter] = useState('all');
const [leadsSortField, setLeadsSortField] = useState('date_of_enquiry');
const [leadsSortDirection, setLeadsSortDirection] = useState('desc');
const [showBulkAssignModal, setShowBulkAssignModal] = useState(false);
const [bulkAssignSelections, setBulkAssignSelections] = useState({});
const [bulkAssignLoading, setBulkAssignLoading] = useState(false);
const [selectedStatusFilters, setSelectedStatusFilters] = useState([]);
const [showStatusFilterDropdown, setShowStatusFilterDropdown] = useState(false);
const statusDropdownRef = React.useRef(null);
const [stadiums, setStadiums] = useState([]);
const [showStadiumForm, setShowStadiumForm] = useState(false);
const [editingStadium, setEditingStadium] = useState(null);
const [stadiumFormData, setStadiumFormData] = useState({});
const [stadiumSortField, setStadiumSortField] = useState('name');
const [stadiumSortDirection, setStadiumSortDirection] = useState('asc');
const [stadiumSearchQuery, setStadiumSearchQuery] = useState('');
const [stadiumSportFilter, setStadiumSportFilter] = useState('all');
const [dynamicRoles, setDynamicRoles] = useState({});
const [rolesLoaded, setRolesLoaded] = useState(false);
const [viewMode, setViewMode] = useState('leads'); // 'leads' or 'clients'
const [clients, setClients] = useState([]);
const [clientsLoading, setClientsLoading] = useState(false);
const [selectedClient, setSelectedClient] = useState(null);
const [showClientDetail, setShowClientDetail] = useState(false);
const [phoneCheckLoading, setPhoneCheckLoading] = useState(false);
const [clientSuggestion, setClientSuggestion] = useState(null);
const [showClientSuggestion, setShowClientSuggestion] = useState(false);
const [phoneCheckTimeout, setPhoneCheckTimeout] = useState(null);
const [showStatusProgressModal, setShowStatusProgressModal] = useState(false);
const [statusProgressOptions, setStatusProgressOptions] = useState([]);
const [selectedStatus, setSelectedStatus] = useState('');
const [followUpDate, setFollowUpDate] = useState('');
const [followUpNotes, setFollowUpNotes] = useState('');
const [uploadPreview, setUploadPreview] = useState(null);
const [showPreview, setShowPreview] = useState(false);
const [proceedAfterPreview, setProceedAfterPreview] = useState(false);
const [previewLoading, setPreviewLoading] = useState(false);
const [clientDetectionResults, setClientDetectionResults] = useState([]);
const [showClientDetectionResults, setShowClientDetectionResults] = useState(false);
const [calendarFilters, setCalendarFilters] = React.useState({});
const [showImportModal, setShowImportModal] = React.useState(false);



// 1. Enhanced Customer Type Classification
const [paymentData, setPaymentData] = useState({
legal_name: '',
gstin: '',
registered_address: '',
category_of_sale: 'Corporate',
type_of_sale: 'Tour',
indian_state: 'Haryana',
is_outside_india: false,

// NEW: Enhanced customer classification
customer_type: 'indian', // 'indian', 'nri', 'foreigner'
event_location: 'india', // 'india', 'outside_india'
payment_currency: 'INR', // 'INR', 'USD', 'EUR', 'GBP'

advance_amount: '',
payment_method: 'bank_transfer',
transaction_id: '',
payment_date: new Date().toISOString().split('T')[0],
payment_proof: '',
notes: '',
gst_certificate: '',
pan_card: '',

invoice_items: [
{
description: '',
additional_info: '',
quantity: 1,
rate: 0
}
],

service_fee_amount: '',
gst_rate: 5,

// NEW: TCS fields
tcs_applicable: false,
tcs_rate: 5, // Default to 5%
tcs_amount: 0,
tcs_rate_editable: true, // Allow manual override
});

const addInvoiceItem = () => {
const newItems = [...(paymentData.invoice_items || [])];
newItems.push({
description: '',
additional_info: '',
quantity: 1,
rate: 0
});
handlePaymentInputChange('invoice_items', newItems);
};



const removeInvoiceItem = (index) => {
if (paymentData.invoice_items.length <= 1) {
alert('At least one invoice item is required');
return;
}
const newItems = paymentData.invoice_items.filter((_, i) => i !== index);
handlePaymentInputChange('invoice_items', newItems);
};



// Fixed version for post-deployment input issues
const updateInvoiceItem = (index, field, value) => {
// Create a completely new array to ensure React detects the change
const newItems = JSON.parse(JSON.stringify(paymentData.invoice_items || []));
newItems[index][field] = value;

// Force a state update with new reference
setPaymentData(prevData => ({
...prevData,
invoice_items: newItems
}));
}; 

// Enhanced GST and TCS Calculation Function
const calculateGSTAndTCS = (baseAmount, paymentData) => {
const isIntraState = paymentData.indian_state === 'Haryana' && !paymentData.is_outside_india;
const isOutsideIndia = paymentData.event_location === 'outside_india';
const isIndian = paymentData.customer_type === 'indian';
const isNRIOrForeigner = ['nri', 'foreigner'].includes(paymentData.customer_type);
const isINRPayment = paymentData.payment_currency === 'INR';
const isCorporate = paymentData.category_of_sale === 'Corporate';
const isServiceFee = paymentData.type_of_sale === 'Service Fee';

let gstApplicable = false;
let gstRate = 0;
let tcsApplicable = false;
let tcsRate = paymentData.tcs_rate || 5; // Standard TCS rate

// TCS Logic: CORRECTED
if (isOutsideIndia) {
// Event outside India
if (isIndian) {
// All Indian clients pay TCS for events outside India
tcsApplicable = true;
} else if (isNRIOrForeigner && isINRPayment) {
// NRI/Foreigner pay TCS only if they pay in INR
tcsApplicable = true;
}
}
// If event is in India, NO ONE pays TCS

// GST Logic: CORRECTED with Service Fee handling
if (isServiceFee) {
// Service Fee: Always 18% GST regardless of customer type or location
gstApplicable = true;
gstRate = 18;
} else {
// Tour Package: Variable rates based on customer type and location
if (isIndian) {
// Domestic clients (Indian)
if (isCorporate) {
// B2B: Always 18% regardless of event location
gstApplicable = true;
gstRate = 18;
} else {
// B2C: Always 5% regardless of event location  
gstApplicable = true;
gstRate = 5;
}
} else if (isNRIOrForeigner) {
// International clients (NRI/Foreigner)
if (!isOutsideIndia) {
// Event in India: Always 5% GST for international clients
gstApplicable = true;
gstRate = 5;
} else {
// Event outside India
if (isINRPayment) {
// Pay in INR: 5% GST
gstApplicable = true;
gstRate = 5;
} else {
// Pay in foreign currency: No GST
gstApplicable = false;
}
}
}
}

// Calculate amounts
const gstAmount = gstApplicable ? (baseAmount * gstRate) / 100 : 0;
const cgstAmount = gstApplicable && isIntraState ? gstAmount / 2 : 0;
const sgstAmount = gstApplicable && isIntraState ? gstAmount / 2 : 0;
const igstAmount = gstApplicable && !isIntraState ? gstAmount : 0;

const tcsAmount = tcsApplicable ? (baseAmount * tcsRate) / 100 : 0;

return {
gst: {
applicable: gstApplicable,
rate: gstRate,
cgst: cgstAmount,
sgst: sgstAmount,
igst: igstAmount,
total: gstAmount
},
tcs: {
applicable: tcsApplicable,
rate: tcsRate,
amount: tcsAmount
},
finalAmount: baseAmount + gstAmount + tcsAmount
};


};



const formatCurrency = (amount) => {
return amount.toLocaleString('en-IN', {
minimumFractionDigits: 2,
maximumFractionDigits: 2
});
};



// Safe number formatting helper
const safeFormatNumber = (value) => {
const num = parseFloat(value) || 0;
return num.toLocaleString('en-IN');
};



const handlePaymentInputChange = (field, value) => {
  setPaymentData(prev => {
    const updated = { ...prev, [field]: value };
    
    // Auto-update GST rate based on type_of_sale
    if (field === 'type_of_sale') {
      if (value === 'Service Fee') {
        updated.gst_rate = 18;
      } else if (value === 'Tour') {
        updated.gst_rate = 5;
      } else {
        updated.gst_rate = 18;
      }
    }
    
    // Handle TCS rate changes manually
    if (field === 'tcs_rate') {
      const baseAmount = getBaseAmount(updated);
      const newTcsAmount = updated.tcs_applicable ? (baseAmount * parseFloat(value)) / 100 : 0;
      updated.tcs_amount = newTcsAmount;
      // Mark that rate was manually selected
      updated.tcs_rate_manual = true;
    }
    
    // Auto-determine TCS applicability when customer type or currency changes
    if (['customer_type', 'event_location', 'payment_currency'].includes(field)) {
      const baseAmount = getBaseAmount(updated);
      const calculation = calculateGSTAndTCS(baseAmount, updated);
      updated.tcs_applicable = calculation.tcs.applicable;
      
      // Only update TCS rate if it wasn't manually set, or if customer type changed
      if (!updated.tcs_rate_manual || field === 'customer_type') {
        updated.tcs_rate = calculation.tcs.rate;
        updated.tcs_rate_manual = false; // Reset manual flag when customer type changes
      }
      
      // Recalculate TCS amount with current (possibly manual) rate
      const currentTcsRate = updated.tcs_rate || calculation.tcs.rate;
      updated.tcs_amount = calculation.tcs.applicable ? (baseAmount * currentTcsRate) / 100 : 0;
    }
    
    // Recalculate TCS when invoice items or service fee amount changes
    if (['invoice_items', 'service_fee_amount'].includes(field)) {
      const baseAmount = getBaseAmount(updated);
      if (updated.tcs_applicable) {
        const currentTcsRate = updated.tcs_rate || 5;
        updated.tcs_amount = (baseAmount * currentTcsRate) / 100;
      }
    }
    
    return updated;
  });
};



// Edit order function - in App scope
const openEditOrderForm = (order) => {
if (!order) {
alert('Order data not found');
return;
}

if (!hasPermission('orders', 'write')) {
alert('You do not have permission to edit orders');
return;
}

setCurrentOrderForEdit(order);
setOrderEditData({
...order,
status: order.status || 'pending_approval',
rejection_reason: order.rejection_reason || '',
assigned_to: order.assigned_to || ''
});
setShowEditOrderForm(true);
};




const handleBulkAssignSubmit = async () => {
if (Object.keys(bulkAssignSelections).length === 0) {
alert('Please select at least one lead to assign.');
return;
}

setBulkAssignLoading(true);
let successCount = 0;
let errorCount = 0;

try {
for (const [leadId, assigneeEmail] of Object.entries(bulkAssignSelections)) {
try {
const response = await apiCall(`/leads/${leadId}`, {
method: 'PUT',
body: JSON.stringify({
assigned_to: assigneeEmail,
status: 'assigned'
})
});

if (response.error) {
console.error(`Failed to assign lead ${leadId}:`, response.error);
errorCount++;
} else {
successCount++;
}
} catch (error) {
console.error(`Error assigning lead ${leadId}:`, error);
errorCount++;
}
}

alert(`Bulk assignment completed!\n‚úÖ ${successCount} leads assigned successfully\n‚ùå ${errorCount} failed`);

// FIXED: Use the correct function name to refresh leads data
// Try these in order - use whichever function name you have:
if (typeof fetchData === 'function') {
await fetchData(); // Most likely this one
} else if (typeof loadLeads === 'function') {
await loadLeads();
} else if (typeof refreshLeads === 'function') {
await refreshLeads();
} else if (typeof getData === 'function') {
await getData();
} else {
// If none of the above work, just reload the page
window.location.reload();
}

// Close modal and reset selections
setShowBulkAssignModal(false);
setBulkAssignSelections({});

} catch (error) {
console.error('Bulk assignment error:', error);
alert('Error during bulk assignment: ' + error.message);
} finally {
setBulkAssignLoading(false);
}
};



const fetchClients = async () => {
setClientsLoading(true);
try {
const response = await apiCall('/clients');
setClients(response.data || []);
console.log(`Fetched ${response.data?.length || 0} clients`);
} catch (error) {
console.error('Failed to fetch clients:', error);
alert('Failed to load clients: ' + error.message);
} finally {
setClientsLoading(false);
}
};



const fetchUserRoles = async () => {
try {
const response = await apiCall('/roles');
const roleMap = {};

// Convert API roles to permission format
response.data.forEach(role => {
roleMap[role.name] = {
label: role.label,
permissions: role.permissions
};


});

setDynamicRoles(roleMap);
setRolesLoaded(true);
} catch (error) {
console.error('Failed to fetch roles:', error);
// Fallback to hardcoded roles if API fails
setDynamicRoles(USER_ROLES);
setRolesLoaded(true);
}
};



const handleStatusFilterToggle = (status) => {
setSelectedStatusFilters(prev => {
if (prev.includes(status)) {
return prev.filter(s => s !== status);
} else {
return [...prev, status];
}
});
};



const handleSelectAllStatuses = () => {
if (selectedStatusFilters.length === Object.keys(LEAD_STATUSES).length) {
setSelectedStatusFilters([]);
} else {
setSelectedStatusFilters(Object.keys(LEAD_STATUSES));
}
};



// Add this function for checking phone numbers
const checkPhoneForClient = async (phone) => {
if (!phone || phone.length < 10) {
setClientSuggestion(null);
setShowClientSuggestion(false);
return;
}

// Normalize phone number (remove spaces, +91, etc.)
const normalizedPhone = phone.replace(/[\s\-\+]/g, '').replace(/^91/, '');

if (normalizedPhone.length < 10) {
setClientSuggestion(null);
setShowClientSuggestion(false);
return;
}

setPhoneCheckLoading(true);
try {
const response = await apiCall(`/leads/check-phone/${normalizedPhone}`);
if (response.exists && response.suggestion) {
setClientSuggestion(response.suggestion);
setShowClientSuggestion(true);
} else {
setClientSuggestion(null);
setShowClientSuggestion(false);
}
} catch (error) {
console.error('Error checking phone:', error);
setClientSuggestion(null);
setShowClientSuggestion(false);
} finally {
setPhoneCheckLoading(false);
}
};



// Add this function to handle phone input changes with debouncing
const handlePhoneChange = (value) => {
setLeadFormData(prev => ({ ...prev, phone: value }));

// Clear existing timeout
if (phoneCheckTimeout) {
clearTimeout(phoneCheckTimeout);
}

// Set new timeout for phone check (debounce)
const newTimeout = setTimeout(() => {
checkPhoneForClient(value);
}, 500); // Check after 500ms of no typing

setPhoneCheckTimeout(newTimeout);
};



// Add this function to apply client suggestions
const applyClientSuggestion = () => {
if (clientSuggestion) {
setLeadFormData(prev => ({
...prev,
assigned_to: clientSuggestion.suggested_assigned_to,
company: clientSuggestion.client_history[0]?.company || prev.company,
city_of_residence: clientSuggestion.client_history[0]?.city_of_residence || prev.city_of_residence,
country_of_residence: clientSuggestion.client_history[0]?.country_of_residence || prev.country_of_residence,
business_type: clientSuggestion.client_history[0]?.business_type || prev.business_type,
annual_income_bracket: clientSuggestion.client_history[0]?.annual_income_bracket || prev.annual_income_bracket
}));
setShowClientSuggestion(false);
alert('Client information applied! This lead will be linked to the existing client.');
}
};



const handleClearAllStatuses = () => {
setSelectedStatusFilters([]);
};



const getStatusFilterDisplayText = () => {
if (selectedStatusFilters.length === 0) {
return 'All Statuses';
} else if (selectedStatusFilters.length === 1) {
return LEAD_STATUSES[selectedStatusFilters[0]].label;
} else if (selectedStatusFilters.length === Object.keys(LEAD_STATUSES).length) {
return 'All Statuses';
} else {
return `${selectedStatusFilters.length} statuses selected`;
}
}; 
// Helper function to update order status


const fetchStadiums = async () => {
try {
const response = await apiCall('/stadiums');
setStadiums(response.data || []);
console.log('‚úÖ Loaded', response.data?.length || 0, 'stadiums');
} catch (error) {
console.error('‚ùå Error fetching stadiums:', error);
setStadiums([]);
}
};



// Stadium form submission
const handleStadiumFormSubmit = async (e) => {
e.preventDefault();
setLoading(true);

try {
const stadiumData = {
...stadiumFormData,
created_by: user.name,
created_date: new Date().toISOString(),
updated_date: new Date().toISOString()
};



if (editingStadium) {
// Update existing stadium
const response = await apiCall(`/stadiums/${editingStadium.id}`, {
method: 'PUT',
body: JSON.stringify({ ...stadiumData, id: editingStadium.id })
});

setStadiums(prev => prev.map(stadium => 
stadium.id === editingStadium.id ? response.data : stadium
));
alert('‚úÖ Stadium updated successfully!');
} else {
// Create new stadium
const response = await apiCall('/stadiums', {
method: 'POST',
body: JSON.stringify(stadiumData)
});

setStadiums(prev => [...prev, response.data]);
alert('‚úÖ Stadium added successfully!');
}

closeStadiumForm();
} catch (error) {
console.error('‚ùå Error saving stadium:', error);
alert('‚ùå Error saving stadium: ' + error.message);
} finally {
setLoading(false);
}
};



// Delete stadium
const handleDeleteStadium = async (stadiumId, stadiumName) => {
if (!confirm(`Are you sure you want to delete "${stadiumName}"?`)) return;

try {
await apiCall(`/stadiums/${stadiumId}`, { method: 'DELETE' });
setStadiums(prev => prev.filter(stadium => stadium.id !== stadiumId));
alert('‚úÖ Stadium deleted successfully!');
} catch (error) {
console.error('‚ùå Error deleting stadium:', error);
alert('‚ùå Error deleting stadium: ' + error.message);
}
};



// Form helpers
const openStadiumForm = (stadium = null) => {
setEditingStadium(stadium);
setStadiumFormData(stadium || {});
setShowStadiumForm(true);
};



const closeStadiumForm = () => {
setShowStadiumForm(false);
setEditingStadium(null);
setStadiumFormData({});
};



const handleStadiumInputChange = (name, value) => {
setStadiumFormData(prev => ({
...prev,
[name]: value
}));
};




const updateOrderStatus = async (orderId, newStatus, rejectionReason = '') => {
setLoading(true);
try {
const updateData = {
status: newStatus,
updated_date: new Date().toISOString(),
updated_by: user.name
};



// Add specific fields based on status
if (newStatus === 'rejected' && rejectionReason) {
updateData.rejection_reason = rejectionReason;
updateData.rejected_date = new Date().toISOString();
updateData.rejected_by = user.name;
} else if (newStatus === 'approved') {
updateData.approved_date = new Date().toISOString();
updateData.approved_by = user.name;

// Generate invoice if needed
const order = orders.find(o => o.id === orderId);
if (order && (order.requires_gst_invoice || order.gstin)) {
const invoiceNumber = 'STTS/INV/' + (new Date().getFullYear()) + '/' + (String(Date.now()).slice(-6));
updateData.invoice_number = invoiceNumber;
updateData.invoice_id = Date.now();
}
} else if (newStatus === 'pending_approval') {
// Clear rejection/approval data when moving back to pending
updateData.rejection_reason = null;
updateData.rejected_date = null;
updateData.rejected_by = null;
updateData.approved_date = null;
updateData.approved_by = null;
}

// Update in backend
await apiCall('/orders/' + (orderId), {
method: 'PUT',
body: JSON.stringify(updateData)
});

// Update local state
setOrders(prev => 
prev.map(order => 
order.id === orderId 
? { ...order, ...updateData }
: order
)
);

alert('Order status updated to: ' + (newStatus));
} catch (error) {
console.error('Error updating order status:', error);
alert('Failed to update order status');
} finally {
setLoading(false);
}
}

const [invoices, setInvoices] = useState([]);
const [deliveries, setDeliveries] = useState([]);
const [receivables, setReceivables] = useState([]);
const [emailNotifications, setEmailNotifications] = useState([]);
const [allUsers, setAllUsers] = useState([]);
const [users, setUsers] = useState([]);
const [myLeads, setMyLeads] = useState([]);
const [myQuoteRequested, setMyQuoteRequested] = useState([]);
const [myOrders, setMyOrders] = useState([]);
const [myDeliveries, setMyDeliveries] = useState([]);
const [myReceivables, setMyReceivables] = useState([]);

// Add data fetching function
const fetchData = async () => {
if (!isLoggedIn || !authToken) return;

try {
const [leadsData, inventoryData, ordersData, invoicesData, deliveriesData, clientsData] = await Promise.all([
apiCall('/leads').catch(() => ({ data: [] })),
apiCall('/inventory').catch(() => ({ data: [] })),
apiCall('/orders').catch(() => ({ data: [] })),
apiCall('/invoices').catch(() => ({ data: [] })),
apiCall('/deliveries').catch(() => ({ data: [] })),
apiCall('/clients').catch(() => ({ data: [] }))
]);

setLeads(leadsData.data || []);
setInventory(inventoryData.data || []);
setOrders(ordersData.data || []);
setInvoices(invoicesData.data || []);
setDeliveries(deliveriesData.data || []);
setClients(clientsData.data || []);
} catch (error) {
console.error('Error fetching data:', error);
}
};



// Fetch data when logged in
useEffect(() => {
if (isLoggedIn) {
fetchData();
}


// Fetch My Actions data
console.log('useEffect triggered - activeTab:', activeTab, 'isLoggedIn:', isLoggedIn);
if (activeTab === 'myactions') {
} else if (activeTab === 'finance') {
console.log('Finance tab active, fetching financial data...');
fetchFinancialData();
console.log('My Actions tab is active, calling fetchMyActions...');
fetchMyActions();
}
}, [isLoggedIn, activeTab]);

useEffect(() => {
if (isLoggedIn) {
fetchReminders();
// Set up auto-refresh every 5 minutes
const interval = setInterval(fetchReminders, 5 * 60 * 1000);
return () => clearInterval(interval);
}
}, [isLoggedIn]);


useEffect(() => {
if (viewMode === 'clients' && isLoggedIn) {
fetchClients();
}
}, [viewMode, isLoggedIn]);




// Add after other state variables

const [searchQuery, setSearchQuery] = useState('');
const [statusFilter, setStatusFilter] = useState('all');
// Google Cloud Storage Integration
// Google Cloud Storage Integration
const UPLOAD_URL_FUNCTION = 'https://asia-south1-enduring-wharf-464005-h7.cloudfunctions.net/getSignedUploadUrl';
const READ_URL_FUNCTION = 'https://asia-south1-enduring-wharf-464005-h7.cloudfunctions.net/getSignedReadUrl';

// Get signed URL for uploading
const getUploadUrl = async (fileName, fileType, documentType) => {
try {
const response = await fetch(UPLOAD_URL_FUNCTION, {
method: 'POST',
headers: {
'Content-Type': 'application/json'},
body: JSON.stringify({
fileName,
fileType,
documentType
})
});

if (!response.ok) {
const error = await response.json();
throw new Error(error.error || 'Failed to get upload URL');
}

return await response.json();
} catch (error) {
console.error('Error getting upload URL:', error);
throw error;
}
};



// Upload file to Google Cloud Storage
const uploadFileToGCS = async (file, documentType) => {
try {
// Step 1: Get signed upload URL
const { uploadUrl, filePath, publicUrl } = await getUploadUrl(
file.name,
file.type,
documentType
);

// Step 2: Upload file directly to GCS
const uploadResponse = await fetch(uploadUrl, {
method: 'PUT',
headers: {
'Content-Type': file.type},
body: file
});

if (!uploadResponse.ok) {
throw new Error('Failed to upload file to storage');
}

// Return file information
return {
filePath,
publicUrl,
originalName: file.name,
size: file.size,
type: file.type,
uploadedAt: new Date().toISOString()
};


} catch (error) {
console.error('Upload error:', error);
throw error;
}
};



// Get signed URL for reading/viewing files
const getFileViewUrl = async (filePath) => {
try {
const response = await fetch(READ_URL_FUNCTION, {
method: 'POST',
headers: {
'Content-Type': 'application/json'},
body: JSON.stringify({ filePath })
});

if (!response.ok) {
throw new Error('Failed to get file URL');
}

const data = await response.json();
return data.url;
} catch (error) {
console.error('Error getting file URL:', error);
return null;
}
};


const [showOrderDetail, setShowOrderDetail] = useState(false);
const [selectedOrderForAssignment, setSelectedOrderForAssignment] = useState(null);
const [showOrderAssignmentModal, setShowOrderAssignmentModal] = useState(false);
const [showEditOrderForm, setShowEditOrderForm] = useState(false);
const [currentOrderForEdit, setCurrentOrderForEdit] = useState(null);
const [orderEditData, setOrderEditData] = useState({});
const [inventoryDueDateFilter, setInventoryDueDateFilter] = useState('all');
const [inventoryEventFilter, setInventoryEventFilter] = useState('all');
const [currentLeadsPage, setCurrentLeadsPage] = useState(1);
const [currentInventoryPage, setCurrentInventoryPage] = useState(1);
const [itemsPerPage] = useState(10);
const [currentOrderDetail, setCurrentOrderDetail] = useState(null);

// Form states
const [showAddForm, setShowAddForm] = useState(false);
const [showEditForm, setShowEditForm] = useState(false);
const [showAssignForm, setShowAssignForm] = useState(false);
const [showPaymentForm, setShowPaymentForm] = useState(false);
const [showLeadDetail, setShowLeadDetail] = useState(false);
const [showAllocationForm, setShowAllocationForm] = useState(false);
const [showEditInventoryForm, setShowEditInventoryForm] = useState(false);
const [showUserManagement, setShowUserManagement] = useState(false);
const [showUserForm, setShowUserForm] = useState(false);
const [roles, setRoles] = useState([]);
const [showRoleForm, setShowRoleForm] = useState(false);
const [rolesInitialized, setRolesInitialized] = useState(false);

// Financials state
const [financialData, setFinancialData] = useState({
activeSales: [],
sales: [],
receivables: [],
payables: [],
expiringInventory: []
});
const [financialFilters, setFinancialFilters] = useState({
clientName: '',
assignedPerson: '',
dateFrom: '',
dateTo: '',
status: 'all',
expiringDays: 7,
clientName: '',
assignedPerson: '',
dateFrom: '',
dateTo: '',
status: 'all'
});
const [activeFinancialTab, setActiveFinancialTab] = useState('sales');
const [financialStats, setFinancialStats] = useState({
totalSales: 0,
totalReceivables: 0,
totalPayables: 0,
expiringValue: 0
});
const [editingRole, setEditingRole] = useState(null);
const [roleFormData, setRoleFormData] = useState({
name: '',
label: '',
description: '',
permissions: {
dashboard: { read: false, write: false, delete: false, manage_users: false },
leads: { read: false, write: false, delete: false, assign: false, progress: false },
inventory: { read: false, write: false, delete: false, allocate: false },
orders: { read: false, write: false, delete: false, approve: false, assign: false },
finance: { read: false, write: false, delete: false, approve: false },
delivery: { read: false, write: false, delete: false },
users: { read: false, write: false, delete: false, manage_roles: false }
}
});
const [editingUser, setEditingUser] = useState(null);
const [showCSVUploadModal, setShowCSVUploadModal] = useState(false);
const [availableRoles, setAvailableRoles] = useState([]);
const [csvUploadType, setCSVUploadType] = useState('');
const [currentForm, setCurrentForm] = useState('');
const [currentLead, setCurrentLead] = useState(null);
const [currentInventory, setCurrentInventory] = useState(null);
const [darkMode, setDarkMode] = useState(() => {
return localStorage.getItem('crm_dark_mode') === 'true';
});
const [currentUser, setCurrentUser] = useState(null);
const [formData, setFormData] = useState({});
const [allocationData, setAllocationData] = useState({});
const [userFormData, setUserFormData] = useState({});
const [showInvoicePreview, setShowInvoicePreview] = useState(false);
const [currentInvoice, setCurrentInvoice] = useState(null);
const [showDeliveryForm, setShowDeliveryForm] = useState(false);
const [currentDelivery, setCurrentDelivery] = useState(null);
const [deliveryFormData, setDeliveryFormData] = useState({});
const [showPaymentPostServiceForm, setShowPaymentPostServiceForm] = useState(false);
const [showHelpGuide, setShowHelpGuide] = useState(false);
const [paymentPostServiceData, setPaymentPostServiceData] = useState({});
const [showChoiceModal, setShowChoiceModal] = useState(false);
const [currentLeadForChoice, setCurrentLeadForChoice] = useState(null);
const [choiceOptions, setChoiceOptions] = useState([]);


// Dashboard stats
const [dashboardStats, setDashboardStats] = useState({
totalLeads: 0,
activeDeals: 0,
thisMonthRevenue: 0,
pendingDeliveries: 0,
inventoryValue: 0
});

// Dashboard filter states for pie charts
const [dashboardFilter, setDashboardFilter] = useState('overall');
const [selectedSalesPerson, setSelectedSalesPerson] = useState('');
const [selectedEvent, setSelectedEvent] = useState('');
const [events, setEvents] = useState([]);
const [salesPeople, setSalesPeople] = useState([]);
const [chartInstances, setChartInstances] = useState({
leadSplit: null,
tempCount: null,
tempValue: null
});


// Permission check function
// Updated Permission check function with dynamic roles
const hasPermission = (module, action) => {
if (user?.role === 'super_admin') return true;
if (!user || !user.role) {
console.log('No user or role found');
return false;
}

// Use dynamic roles if loaded, otherwise fallback to hardcoded
const availableRoles = rolesLoaded ? dynamicRoles : USER_ROLES;
const userRole = availableRoles[user.role];

if (!userRole) {
console.log('Role not found in available roles:', user.role);
console.log('Available roles:', Object.keys(availableRoles));
return false;
}

const modulePermissions = userRole.permissions[module];
if (!modulePermissions) {
console.log('Module permissions not found:', module);
return false;
}

const hasAccess = modulePermissions[action] === true;
console.log(`Permission check: ${user.role} -> ${module}.${action} = ${hasAccess}`);
return hasAccess;
};



const canAccessTab = (tabId) => {
if (!user) return false;
// My Actions is available to all logged-in users
if (tabId === 'myactions') return true;
// Reminders available to users who can read leads
if (tabId === 'reminders') return hasPermission('leads', 'read');
// Sports Calendar available to users who can read leads (for now, or adjust as needed)
if (tabId === 'sports-calendar') return hasPermission('leads', 'read');
return hasPermission(tabId, 'read');
};




// Test mode logging
useEffect(() => {
console.log('Test mode state:', testMode);
console.log('Current user:', currentUser);
console.log('Is super admin:', currentUser?.role === 'super_admin');
console.log('User object:', JSON.stringify(currentUser));

// Force re-render when user changes
if (currentUser && currentUser.role === 'super_admin') {
console.log('Super admin logged in - test mode toggle should be visible');
}
}, [testMode, currentUser]);

React.useEffect(() => {
if (isLoggedIn) {
fetchData();
fetchStadiums(); // Add this line
}
}, [isLoggedIn]); 

// Persist authentication state
useEffect(() => {
try {
const savedUser = localStorage.getItem('crm_user');
const savedLoginState = localStorage.getItem('crm_auth_token');

if (savedUser && savedLoginState) {
const userData = JSON.parse(savedUser);
setUser(userData);
setCurrentUser(userData);
authToken = savedLoginState;
setIsLoggedIn(true);
// Fetch users for dropdowns
fetchUsers();
// Clear any cached user management data
setUsers([]);
}
} catch (e) {
console.log('Failed to restore auth state:', e);
}
}, []);

useEffect(() => {
localStorage.setItem('crm_active_tab', activeTab);
}, [activeTab]);


// Calculate dashboard stats
// Initialize dashboard stats
useEffect(() => {
if (isLoggedIn) {
calculateDashboardStats();
}
}, [isLoggedIn]);

useEffect(() => {
const handleClickOutside = (event) => {
if (statusDropdownRef.current && !statusDropdownRef.current.contains(event.target)) {
setShowStatusFilterDropdown(false);
}
};


document.addEventListener('mousedown', handleClickOutside);
return () => document.removeEventListener('mousedown', handleClickOutside);
}, []);

// Add useEffect to extract filter data when leads or users change
useEffect(() => {
if (leads.length > 0 || users.length > 0) {
extractFiltersData();
}
}, [leads, users]);

const getFilteredLeads = () => {
let filteredLeads = [...leads];

if (dashboardFilter === 'salesperson' && selectedSalesPerson) {
filteredLeads = filteredLeads.filter(lead => lead.assigned_to === selectedSalesPerson);
}

if (dashboardFilter === 'event' && selectedEvent) {
filteredLeads = filteredLeads.filter(lead => lead.lead_for_event === selectedEvent);
}

return filteredLeads;
};    

// Update stats when filter changes
useEffect(() => {
if (leads.length > 0) {
calculateDashboardStats();
}
}, [dashboardFilter, selectedSalesPerson, selectedEvent, leads]);

useEffect(() => {
console.log('Chart initialization useEffect triggered', {
activeTab,
leadsCount: leads.length,
chartExists: typeof Chart !== 'undefined'
});

if (activeTab === 'dashboard' && leads.length > 0 && typeof Chart !== 'undefined') {
// Wait a bit longer for DOM to be ready and add additional checks
const timeoutId = setTimeout(() => {
console.log('Attempting to initialize charts...');

// Check if canvas elements exist
const canvas1 = document.getElementById('leadSplitChart');
const canvas2 = document.getElementById('tempCountChart');  
const canvas3 = document.getElementById('tempValueChart');

console.log('Canvas elements found:', {
leadSplit: !!canvas1,
tempCount: !!canvas2,
tempValue: !!canvas3
});

if (canvas1 && canvas2 && canvas3) {
initializeChartsAdvanced();

// Then update with current data
setTimeout(() => {
const filteredLeads = getFilteredLeads();
updateCharts(filteredLeads);
}, 100);
} else {
console.log('Canvas elements not ready yet, retrying...');
// Retry after another delay
setTimeout(() => {
initializeChartsAdvanced();
const filteredLeads = getFilteredLeads();
updateCharts(filteredLeads);
}, 500);
}
}, 200); // Increased delay

return () => clearTimeout(timeoutId);
}

// Cleanup when leaving dashboard
if (activeTab !== 'dashboard') {
if (chartInstances.leadSplit) {
chartInstances.leadSplit.destroy();
chartInstances.leadSplit = null;
}
if (chartInstances.tempCount) {
chartInstances.tempCount.destroy();
chartInstances.tempCount = null;
}
if (chartInstances.tempValue) {
chartInstances.tempValue.destroy();
chartInstances.tempValue = null;
}
}
}, [activeTab, leads.length]); // Include leads.length to ensure data is available


// Add useEffect to update stats when filter changes
useEffect(() => {
if (leads.length > 0) {
calculateDashboardStats();
}
}, [dashboardFilter, selectedSalesPerson, selectedEvent]);

// Apply dark mode on mount
useEffect(() => {
if (darkMode) {
document.documentElement.classList.add('dark');
} else {
document.documentElement.classList.remove('dark');
}
}, [darkMode]);
// Chart initialization
useEffect(() => {
if (isLoggedIn && hasPermission('finance', 'read')) {
const chartElement = document.getElementById('receivablesPieChart');
if (chartElement && receivables.filter(r => r.status === 'pending').length > 0) {
const ctx = chartElement.getContext('2d');

// Destroy existing chart if any
if (window.receivablesChart) {
window.receivablesChart.destroy();
}

// Group receivables by salesperson
const receivablesBySalesperson = {};
receivables
.filter(r => r.status === 'pending')
.forEach(receivable => {
const salesperson = receivable.assigned_to || 'Unassigned';
receivablesBySalesperson[salesperson] = (receivablesBySalesperson[salesperson] || 0) + receivable.expected_amount;
});

window.receivablesChart = new Chart(ctx, {
type: 'pie',
data: {
labels: Object.keys(receivablesBySalesperson),
datasets: [{
data: Object.values(receivablesBySalesperson),
backgroundColor: [
'#3B82F6', '#EF4444', '#10B981', '#F59E0B', 
'#8B5CF6', '#EC4899', '#14B8A6', '#F97316'
]
}]
},
options: {
responsive: true,
maintainAspectRatio: false
}
});
}
}
}, [isLoggedIn, receivables, user]);
// Add this useEffect to handle scheduled notifications
useEffect(() => {
const checkScheduledNotifications = () => {
const now = new Date();
emailNotifications
.filter(n => n.status === 'scheduled' && new Date(n.scheduled_date) <= now)
.forEach(notification => {
sendEmailNotification(notification);
});
};



const interval = setInterval(checkScheduledNotifications, 60000); // Check every minute
return () => clearInterval(interval);
}, [emailNotifications]);

// ADD this new useEffect after your existing ones:
useEffect(() => {
if (users.length === 0) {
setUsers(DEFAULT_USERS);
}
}, []);
// Fetch all users on app initialization
useEffect(() => {
if (isLoggedIn && allUsers.length === 0) {
fetchUsers();
}
}, [isLoggedIn]);


useEffect(() => {
try {
localStorage.setItem('crm_deliveries', JSON.stringify(deliveries));
} catch (e) {
console.log('Failed to save deliveries:', e);
}
}, [deliveries]);

useEffect(() => {
try {
localStorage.setItem('crm_receivables', JSON.stringify(receivables));
} catch (e) {
console.log('Failed to save receivables:', e);
}
}, [receivables]);

useEffect(() => {
try {
localStorage.setItem('crm_email_notifications', JSON.stringify(emailNotifications));
} catch (e) {
console.log('Failed to save notifications:', e);
}
}, [emailNotifications]);


const assignOrderToService = async (orderId, assignee) => {

const openEditOrderForm = (order) => {
alert(`Edit Order: ${order.order_number}

Client: ${order.client_name}
Email: ${order.client_email}
Event: ${order.event_name || 'N/A'}
Tickets: ${order.tickets_allocated || 0}
Amount: ‚Çπ${order.total_amount || 0}

Status: ${order.status}`);
};


setLoading(true);
try {
const updateData = {
assigned_to: assignee, // This will now be an email
status: 'service_assigned',
assigned_date: new Date().toISOString()
};



await apiCall('/orders/' + (orderId), {
method: 'PUT',
body: JSON.stringify(updateData)
});

setOrders(prev => 
prev.map(order => 
order.id === orderId 
? { ...order, ...updateData }
: order
)
);

const openOrderForm = () => {
setShowOrderForm(true);
// Initialize any form data if needed
};



// Create delivery entry when assigning to supply team
const order = orders.find(o => o.id === orderId);
if (order) {
const newDelivery = {
// id will be generated by Firestore
order_id: orderId,
order_number: order.order_number,
client_name: order.client_name,
client_email: order.client_email,
client_phone: order.client_phone,
event_name: order.event_name || 'N/A',
event_date: order.event_date || new Date().toISOString().split('T')[0],
tickets_count: order.tickets_allocated || 0,
amount: order.total_amount || 0,

// Delivery form fields
delivery_type: 'offline',
pickup_location: '',
pickup_date: '',
pickup_time: '',
delivery_location: order.delivery_address || order.client_address || '',
delivery_date: '',
delivery_time: '',
delivery_person: assignee,
delivery_notes: '',
online_platform: '',
online_link: '',

// Status and metadata
assigned_to: assignee, // This will now be an email
status: 'pending',
created_date: new Date().toISOString().split('T')[0],
created_by: user.name
};



// Add to deliveries state
setDeliveries(prev => [...prev, newDelivery]);

console.log('Delivery entry created:', newDelivery);

// Save delivery to backend
try {
const deliveryResponse = await apiCall('/deliveries', {
method: 'POST',
body: JSON.stringify(newDelivery)
});
console.log('Delivery saved to backend:', deliveryResponse);
// Update local state with backend response if it has an ID
if (deliveryResponse && deliveryResponse.data && deliveryResponse.data.id) {
setDeliveries(prev => prev.map(d => 
d.id === newDelivery.id ? { ...d, id: deliveryResponse.data.id } : d
));
}
} catch (error) {
console.error('Failed to save delivery to backend:', error);
}
}

alert('Order assigned to ' + (assignee) + ' successfully!');
} catch (error) {
console.error('Error assigning order:', error);
alert('Failed to assign order');
} finally {
setLoading(false);
}
};



const fetchReminders = async () => {
if (!isLoggedIn) return;

try {
const response = await apiCall('/reminders');
if (response.data) {
const userReminders = response.data.filter(r => 
r.assigned_to === user.email || 
['sales_manager', 'admin', 'super_admin'].includes(user.role)
);

setReminders(userReminders);

// Calculate stats
const now = new Date();
const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

const stats = {
total: userReminders.length,
overdue: userReminders.filter(r => new Date(r.due_date) < now && r.status === 'pending').length,
due_today: userReminders.filter(r => {
const dueDate = new Date(r.due_date);
return dueDate >= today && dueDate < new Date(today.getTime() + 24*60*60*1000) && r.status === 'pending';
}).length,
pending: userReminders.filter(r => r.status === 'pending').length
};



setReminderStats(stats);
}
} catch (error) {
console.error('Error fetching reminders:', error);
}
};



// Complete a reminder
const completeReminder = async (reminderId, notes = '') => {
try {
await apiCall(`/reminders/${reminderId}/complete`, {
method: 'POST',
body: JSON.stringify({ notes })
});

setReminders(prev => prev.map(r => 
r.id === reminderId 
? { ...r, status: 'completed', completed_date: new Date().toISOString() }
: r
));

alert('‚úÖ Reminder completed successfully!');
await fetchReminders();
} catch (error) {
console.error('Error completing reminder:', error);
alert('‚ùå Failed to complete reminder');
}
};



// Snooze a reminder
const snoozeReminder = async (reminderId, hours = 24) => {
try {
const snoozeUntil = new Date();
snoozeUntil.setHours(snoozeUntil.getHours() + hours);

await apiCall(`/reminders/${reminderId}/snooze`, {
method: 'POST',
body: JSON.stringify({ snooze_until: snoozeUntil.toISOString() })
});

alert(`‚è∞ Reminder snoozed for ${hours} hours`);
await fetchReminders();
} catch (error) {
console.error('Error snoozing reminder:', error);
alert('‚ùå Failed to snooze reminder');
}
};



const deleteReminder = async (reminderId) => {
// Confirm before deleting
if (!confirm('Are you sure you want to delete this reminder? This action cannot be undone.')) {
return;
}

try {
await apiCall(`/reminders/${reminderId}`, {
method: 'DELETE'
});

// Update local state to remove the deleted reminder
setReminders(prevReminders => 
prevReminders.filter(r => r.id !== reminderId)
);

// Update reminder stats
await fetchReminders();

alert('üóëÔ∏è Reminder deleted successfully!');
} catch (error) {
console.error('Error deleting reminder:', error);
alert('‚ùå Failed to delete reminder: ' + error.message);
}
}; 

// Helper functions
const formatRelativeTime = (dateString) => {
const date = new Date(dateString);
const now = new Date();
const diffMs = date - now;
const diffHours = Math.round(diffMs / (1000 * 60 * 60));
const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));

if (diffMs < 0) {
const pastHours = Math.abs(diffHours);
const pastDays = Math.abs(diffDays);

if (pastDays > 0) {
return `${pastDays} day${pastDays > 1 ? 's' : ''} overdue`;
} else {
return `${pastHours} hour${pastHours > 1 ? 's' : ''} overdue`;
}
} else {
if (diffDays > 0) {
return `in ${diffDays} day${diffDays > 1 ? 's' : ''}`;
} else if (diffHours > 0) {
return `in ${diffHours} hour${diffHours > 1 ? 's' : ''}`;
} else {
return 'now';
}
}
};



const getPriorityColor = (priority) => {
switch (priority) {
case 'urgent': return 'text-red-600 bg-red-100';
case 'high': return 'text-orange-600 bg-orange-100';
case 'medium': return 'text-blue-600 bg-blue-100';
case 'low': return 'text-gray-600 bg-gray-100';
default: return 'text-gray-600 bg-gray-100';
}
};



const openOrderDetail = (order) => {
setCurrentOrderDetail(order);
setShowOrderDetail(true);
};



const renderOrderDetailModal = () => {
if (!showOrderDetail || !currentOrderDetail) return null;

return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
onClick: (e) => e.target === e.currentTarget && setShowOrderDetail(false)
},
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6' },
React.createElement('div', { className: 'flex justify-between items-center mb-4' },
React.createElement('h2', { className: 'text-2xl font-bold' }, 
'Order Details: ' + (currentOrderDetail.order_number)
),
React.createElement('button', {
onClick: () => setShowOrderDetail(false),
className: 'text-gray-400 hover:text-gray-600 text-2xl'
}, '‚úï')
),
React.createElement('div', { className: 'space-y-4' },
React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('h3', { className: 'font-semibold mb-2' }, 'Client Information'),
React.createElement('p', null, React.createElement('strong', null, 'Name: '), currentOrderDetail.client_name),
React.createElement('p', null, React.createElement('strong', null, 'Email: '), currentOrderDetail.client_email),
React.createElement('p', null, React.createElement('strong', null, 'Phone: '), currentOrderDetail.client_phone)
),
React.createElement('div', null,
React.createElement('h3', { className: 'font-semibold mb-2' }, 'Order Information'),
React.createElement('p', null, React.createElement('strong', null, 'Event: '), currentOrderDetail.event_name || 'N/A'),
React.createElement('p', null, React.createElement('strong', null, 'Tickets: '), currentOrderDetail.tickets_allocated || 0),
React.createElement('p', null, React.createElement('strong', null, 'Amount: '), '‚Çπ' + (currentOrderDetail.total_amount || 0))
)
),
currentOrderDetail.approval_notes && React.createElement('div', { className: 'bg-gray-100 dark:bg-gray-700 p-4 rounded' },
React.createElement('h3', { className: 'font-semibold mb-2' }, 'Approval Notes'),
React.createElement('p', null, currentOrderDetail.approval_notes)
),
React.createElement('div', { className: 'flex justify-end space-x-2 mt-6' },
currentOrderDetail.status === 'pending_approval' && hasPermission('orders', 'approve') && [
React.createElement('button', {
key: 'approve',
className: 'bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700',
onClick: () => {
handleOrderApproval(currentOrderDetail.id, 'approve');
setShowOrderDetail(false);
}
}, 'Approve Order'),
React.createElement('button', {
key: 'reject',
className: 'bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700',
onClick: () => {
handleOrderApproval(currentOrderDetail.id, 'reject');
setShowOrderDetail(false);
}
}, 'Reject Order')
]
)
)
)
);
}

const renderOrderAssignmentModal = () => {
if (!showOrderAssignmentModal || !selectedOrderForAssignment) return null;

const supplyTeamUsers = (users || []).filter(u => 
['supply_executive', 'supply_sales_service_manager'].includes(u.role)
);

return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
onClick: (e) => {
if (e.target === e.currentTarget) {
setShowOrderAssignmentModal(false);
setSelectedOrderForAssignment(null);
}
}
},
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full' },
React.createElement('h3', { className: 'text-lg font-semibold mb-4' }, 
'Assign Order to Supply Team'
),
React.createElement('div', { className: 'space-y-2' },
supplyTeamUsers.map(user =>
React.createElement('button', {
key: user.email,
className: 'w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors',
onClick: () => {
assignOrderToService(selectedOrderForAssignment.id, user.email);
setShowOrderAssignmentModal(false);
setSelectedOrderForAssignment(null);
}
},
React.createElement('div', { className: 'font-medium' }, user.name),
React.createElement('div', { className: 'text-sm text-gray-500' }, user.role)
)
)
),
React.createElement('button', {
className: 'mt-4 w-full text-center text-gray-500 hover:text-gray-700',
onClick: () => {
setShowOrderAssignmentModal(false);
setSelectedOrderForAssignment(null);
}
}, 'Cancel')
)
);
};


;

const getInventoryDueInDays = (eventDate) => {
const today = new Date();
const event = new Date(eventDate);
const diffTime = event - today;
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
return diffDays;
};




const calculateDashboardStats = () => {
let filteredLeads = leads;

// Apply filters
if (dashboardFilter === 'salesPerson' && selectedSalesPerson) {
filteredLeads = leads.filter(l => l.assigned_to === selectedSalesPerson);
} else if (dashboardFilter === 'event' && selectedEvent) {
filteredLeads = leads.filter(l => l.lead_for_event === selectedEvent);
}

const stats = {
totalLeads: filteredLeads.length,
activeDeals: filteredLeads.filter(l => ['hot', 'warm', 'qualified'].includes(l.status)).length,
thisMonthRevenue: 0,
pendingDeliveries: deliveries.filter(d => d.status === 'pending').length,
inventoryValue: inventory.reduce((sum, item) => sum + (item.price * item.quantity), 0)
};


setDashboardStats(stats);

// Update charts with filtered data
updateCharts(filteredLeads);
};



// HOW TO FIX THE DUPLICATE FUNCTION ERRORS

// The problem: You have these functions declared TWICE in your code:
// 1. extractFiltersData
// 2. updateCharts

// SOLUTION:

// Step 1: Use your text editor's search function (Ctrl+F or Cmd+F)
// Search for each of these function names:

// Search for: "const extractFiltersData"
// You'll find 2 occurrences - DELETE ONE OF THEM

// Search for: "const updateCharts" 
// You'll find 2 occurrences - DELETE ONE OF THEM

// Step 2: Make sure you keep only ONE instance of each function
// The functions should look like this (KEEP ONLY ONE OF EACH):

// ===== KEEP ONLY ONE extractFiltersData =====
const extractFiltersData = () => {
// Extract unique events from leads
const uniqueEvents = [...new Set(leads.map(l => l.lead_for_event).filter(e => e))];
setEvents(uniqueEvents);

// Extract sales people from users
const salesUsers = users.filter(u => 
u.role === 'sales_executive' || u.role === 'sales_manager'
);
setSalesPeople(salesUsers);
};



// ===== KEEP ONLY ONE updateCharts =====
const updateCharts = (filteredLeads) => {
console.log('Updating charts with', filteredLeads.length, 'leads');

// Lead Split Chart (Qualified vs Junk)
const qualifiedCount = filteredLeads.filter(l => l.status === 'qualified').length;
const junkCount = filteredLeads.filter(l => l.status === 'junk').length;
console.log('Lead Split:', { qualified: qualifiedCount, junk: junkCount });

// Temperature Count
// Temperature Count (including parallel stages)
const hotCount = filteredLeads.filter(l => getDisplayTemperature(l) === 'hot').length;
const warmCount = filteredLeads.filter(l => getDisplayTemperature(l) === 'warm').length;
const coldCount = filteredLeads.filter(l => getDisplayTemperature(l) === 'cold').length;
console.log('Temperature Count:', { hot: hotCount, warm: warmCount, cold: coldCount });

// Temperature Value
// Temperature Value (including parallel stages)
const hotValue = filteredLeads.filter(l => getDisplayTemperature(l) === 'hot')
.reduce((sum, l) => sum + (l.potential_value || 0), 0);
const warmValue = filteredLeads.filter(l => getDisplayTemperature(l) === 'warm')
.reduce((sum, l) => sum + (l.potential_value || 0), 0);
const coldValue = filteredLeads.filter(l => getDisplayTemperature(l) === 'cold')
.reduce((sum, l) => sum + (l.potential_value || 0), 0);
console.log('Temperature Value:', { hot: hotValue, warm: warmValue, cold: coldValue });

// Update charts if they exist
if (chartInstances.leadSplit) {
chartInstances.leadSplit.data.datasets[0].data = [qualifiedCount, junkCount];
chartInstances.leadSplit.update();
console.log('Lead Split chart updated');
} else {
console.log('Lead Split chart not found!');
}

if (chartInstances.tempCount) {
chartInstances.tempCount.data.datasets[0].data = [hotCount, warmCount, coldCount];
chartInstances.tempCount.update();
console.log('Temp Count chart updated');
} else {
console.log('Temp Count chart not found!');
}

if (chartInstances.tempValue) {
chartInstances.tempValue.data.datasets[0].data = [hotValue, warmValue, coldValue];
chartInstances.tempValue.update();
console.log('Temp Value chart updated');
} else {
console.log('Temp Value chart not found!');
}
};




// Function to initialize charts
const initializeChartsAdvanced = () => {
console.log('Initializing advanced charts...');

// Destroy existing charts first
Object.keys(chartInstances).forEach(key => {
if (chartInstances[key]) {
chartInstances[key].destroy();
chartInstances[key] = null;
}
});

// Lead Split Chart 
const ctx1 = document.getElementById('leadSplitChart');
if (ctx1) {
try {
chartInstances.leadSplit = new Chart(ctx1, {
type: 'pie',
data: {
labels: ['Qualified', 'Junk'],
datasets: [{
data: [0, 0],
backgroundColor: ['#10b981', '#ef4444'],
borderWidth: 2,
borderColor: '#ffffff'
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
position: 'bottom',
labels: {
padding: 15,
font: { size: 12, weight: 'bold' },
usePointStyle: true,
pointStyle: 'circle'
}
},
tooltip: {
backgroundColor: 'rgba(0, 0, 0, 0.8)',
titleColor: '#ffffff',
bodyColor: '#ffffff',
borderColor: '#ffffff',
borderWidth: 1,
cornerRadius: 8,
displayColors: true,
callbacks: {
title: function(context) {
return 'Lead Split Analysis';
},
label: function(context) {
const label = context.label || '';
const value = context.parsed || 0;
const total = context.dataset.data.reduce((a, b) => a + b, 0);
const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
return [
`Status: ${label}`,
`Count: ${value} leads`,
`Percentage: ${percentage}%`
];
}
}
}
}
}
});
} catch (error) {
console.error('Error creating advanced Lead Split chart:', error);
}
}

// Temperature Count Chart
const ctx2 = document.getElementById('tempCountChart');
if (ctx2) {
try {
chartInstances.tempCount = new Chart(ctx2, {
type: 'pie',
data: {
labels: ['Hot', 'Warm', 'Cold'],
datasets: [{
data: [0, 0, 0],
backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6'],
borderWidth: 2,
borderColor: '#ffffff'
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
position: 'bottom',
labels: {
padding: 15,
font: { size: 12, weight: 'bold' },
usePointStyle: true,
pointStyle: 'circle'
}
},
tooltip: {
backgroundColor: 'rgba(0, 0, 0, 0.8)',
titleColor: '#ffffff',
bodyColor: '#ffffff',
borderColor: '#ffffff',
borderWidth: 1,
cornerRadius: 8,
displayColors: true,
callbacks: {
title: function(context) {
return 'Lead Temperature Count';
},
label: function(context) {
const label = context.label || '';
const value = context.parsed || 0;
const total = context.dataset.data.reduce((a, b) => a + b, 0);
const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
return [
`Temperature: ${label}`,
`Count: ${value} leads`,
`Percentage: ${percentage}%`
];
}
}
}
}
}
});
} catch (error) {
console.error('Error creating advanced Temp Count chart:', error);
}
}

// Temperature Value Chart
const ctx3 = document.getElementById('tempValueChart');
if (ctx3) {
try {
chartInstances.tempValue = new Chart(ctx3, {
type: 'pie',
data: {
labels: ['Hot', 'Warm', 'Cold'],
datasets: [{
data: [0, 0, 0],
backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6'],
borderWidth: 2,
borderColor: '#ffffff'
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
position: 'bottom',
labels: {
padding: 15,
font: { size: 12, weight: 'bold' },
usePointStyle: true,
pointStyle: 'circle'
}
},
tooltip: {
backgroundColor: 'rgba(0, 0, 0, 0.8)',
titleColor: '#ffffff',
bodyColor: '#ffffff',
borderColor: '#ffffff',
borderWidth: 1,
cornerRadius: 8,
displayColors: true,
callbacks: {
title: function(context) {
return 'Lead Temperature Value';
},
label: function(context) {
const label = context.label || '';
const value = context.parsed || 0;
const total = context.dataset.data.reduce((a, b) => a + b, 0);
const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;

// Format value in Lacs with better formatting
let formattedValue;
if (value >= 10000000) { // 1 Crore
formattedValue = (value / 10000000).toFixed(2) + ' Cr';
} else if (value >= 100000) { // 1 Lac
formattedValue = (value / 100000).toFixed(2) + ' L';
} else if (value >= 1000) { // 1 Thousand
formattedValue = (value / 1000).toFixed(1) + ' K';
} else {
formattedValue = value.toString();
}

return [
`Temperature: ${label}`,
`Value: ‚Çπ${formattedValue}`,
`Percentage: ${percentage}%`
];
}
}
}
}
}
});
} catch (error) {
console.error('Error creating advanced Temp Value chart:', error);
}
}

console.log('Advanced chart initialization complete');
};



const formatValueInLacs = (value) => {
if (value >= 100000) {
return (value / 100000).toFixed(2) + 'L';
} else if (value >= 1000) {
return (value / 1000).toFixed(1) + 'K';
} else {
return value.toString();
}
};




// Authentication
const handleLogin = async (e) => {
debugLog('LOGIN_START', { email, timestamp: Date.now() });
e.preventDefault();
setLoading(true);

try {
const response = await apiCall('/auth/login', {
method: 'POST',
body: JSON.stringify({ email, password })
});
debugLog('LOGIN_RESPONSE', { 
response, 
hasToken: response?.token !== undefined,
hasUser: response?.user !== undefined,
responseType: typeof response
});

console.log("Login response structure:", response);
console.log("Response type:", typeof response);
console.log("Has token?", response.token !== undefined);
console.log("Has user?", response.user !== undefined);
if (response.token && response.user) {
authToken = response.token;  // Update global authToken variable
localStorage.setItem('crm_auth_token', response.token);
localStorage.setItem('crm_user', JSON.stringify(response.user));
setUser(response.user);
debugLog('LOGIN_SUCCESS', { user: response.user });
setIsLoggedIn(true);
await fetchUserRoles();
// Clear any cached user management data
setUsers([]);
setEmail('');
setPassword('');
}
} catch (error) {
debugLog('LOGIN_ERROR', { error: error.message, stack: error.stack });
console.error("Login failed:", error.message || "Invalid credentials");
console.error("Full error:", error);
} finally {
setLoading(false);
}
};




const handleLogout = () => {
setIsLoggedIn(false);
setUser(null);
setCurrentUser(null);
setEmail('');
setPassword('');
setActiveTab('dashboard');
try {
localStorage.removeItem('crm_user');
localStorage.removeItem('crm_auth_token');
authToken = null;  // Clear the global authToken variable
authToken = null;  // Clear the global authToken variable
} catch (e) {
console.log('Failed to clear auth state:', e);
}
};



// User Management Functions
const openUserManagement = () => {
if (!hasPermission('users', 'read')) {
alert('You do not have permission to access user management');
return;
}
setShowUserManagement(true);
};



const openUserForm = (editUser = null) => {
if (editUser && !hasPermission('users', 'write')) {
alert('You do not have permission to edit users');
return;
}
if (!editUser && !hasPermission('users', 'write')) {
alert('You do not have permission to create users');
return;
}

setCurrentUser(editUser);
if (editUser) {
// Editing existing user
setUserFormData({
name: editUser.name,
email: editUser.email,
role: editUser.role,
status: editUser.status || 'active'
});
} else {
// Creating new user
setUserFormData({
name: '',
email: '',
role: '',
password: '',
status: 'active'
});
}
setShowUserForm(true);
};



const handleDeleteUser = async (userId, userName) => {
if (!hasPermission('users', 'delete')) {
alert('You do not have permission to delete users');
return;
}

if (!confirm(`Are you sure you want to delete user "${userName}"? This action cannot be undone.`)) {
return;
}

setLoading(true);
try {
await apiCall(`/users/${userId}`, { method: 'DELETE' });
console.log('User deleted successfully');

// Remove user from the list
setUsers(prev => prev.filter(u => u.id !== userId));
showNotification('User deleted successfully', 'success');
} catch (error) {
console.error('Error deleting user:', error);
showNotification(error.message || 'Failed to delete user', 'error');
} finally {
setLoading(false);
}
};




const closeUserForm = () => {
setShowUserForm(false);
setEditingUser(null);
setUserFormData({
name: '',
email: '',
password: '',
role: 'viewer',
department: '',
status: 'active'
});
};



const handleUserSubmit = async (e) => {
e.preventDefault();
setLoading(true);

try {
const endpoint = editingUser ? '/users/' + (editingUser.id) : '/users';
const method = editingUser ? 'PUT' : 'POST';

const response = await apiCall(endpoint, {
method: method,
body: JSON.stringify(userFormData)
});

if (response.error) {
throw new Error(response.error);
}

console.log(editingUser ? 'User updated successfully' : 'User created successfully');

// Refresh users list
fetchUsers();

// Close form
setShowUserForm(false);
setEditingUser(null);
setUserFormData({
name: '',
email: '',
password: '',
role: 'viewer',
department: '',
payment_status: 'paid'
});
} catch (error) {
console.error('Error saving user:', error);
alert(error.message || 'Failed to save user');
} finally {
setLoading(false);
}
};




const fetchUsers = async () => {
try {
const response = await apiCall('/users');
if (response.data) {
setUsers(response.data);
}
} catch (error) {
console.error('Failed to fetch users:', error);
}
};



// Enhanced handleMarkAsPaid function with inventory integration
const handleMarkAsPaid = async (payableId) => {
try {
console.log('handleMarkAsPaid called with payableId:', payableId);

const payable = financialData.payables?.find(p => p.id === payableId);

if (!payable) {
console.error('Payable not found:', payableId);
alert('Payable not found.');
return;
}

console.log('Found payable:', payable);

// If linked to inventory, open inventory edit form
if (payable.inventoryId) {
console.log('Payable is linked to inventory:', payable.inventoryId);

const inventoryItem = inventory.find(inv => inv.id === payable.inventoryId);

if (!inventoryItem) {
console.error('Related inventory item not found:', payable.inventoryId);
alert('Related inventory item not found. Please refresh and try again.');
await fetchInventory();
return;
}

console.log('Found inventory item:', inventoryItem);
console.log('Opening inventory edit form for payable payment...');

// Set up for editing with payment focus
// Pre-fill form data with payment context
const inventoryWithContext = {
...inventoryItem,
_payableContext: {
payableId: payable.id,
payableAmount: payable.amount,
fromPayables: true
}
};



setEditingInventory(inventoryWithContext);

// Pre-fill form data for payment
// Calculate correct payment amounts
// When coming from payables, we're paying off the pending balance
const currentTotal = parseFloat(inventoryItem.totalPurchaseAmount || 0);
const currentPaid = parseFloat(inventoryItem.amountPaid || 0);
const pendingBalance = parseFloat(payable.amount || 0); // What we owe

console.log('Payable form pre-fill calculation:', {
currentTotal,
currentPaid,
pendingBalance,
action: 'Setting form to mark as fully paid'
});

// Pre-fill form to mark as FULLY PAID by default
setFormData({
...inventoryItem,
totalPurchaseAmount: currentTotal, // Keep original total
amountPaid: currentTotal, // Set paid amount = total amount (fully paid)
paymentStatus: 'paid' // Mark as paid by default
});

setShowInventoryForm(true);

return;
}

// For non-inventory payables, use traditional mark as paid
console.log('Processing non-inventory payable...');
const confirmPaid = confirm(`Mark payable of ‚Çπ${payable.amount} as paid?`);
if (!confirmPaid) return;

setLoading(true);

const response = await apiCall(`/finance/payables/${payableId}`, {
method: 'PUT',
body: JSON.stringify({
status: 'paid',
paid_date: new Date().toISOString(),
payment_notes: 'Marked as paid manually'
})
});

if (response.error) {
throw new Error(response.error);
}

console.log('Payable marked as paid successfully');
alert('Payable marked as paid!');
await fetchFinancialData();

} catch (error) {
console.error('Error handling mark as paid:', error);
alert('Failed to process payment: ' + error.message);
} finally {
setLoading(false);
}
};



const fetchFinancialData = async () => {
try {
console.log('Fetching financial data...');
const [ordersRes, invoicesRes, payablesRes, inventoryRes, receivablesRes] = await Promise.all([
apiCall('/orders'),
apiCall('/invoices'),
apiCall('/payables'),
apiCall('/inventory'),
apiCall('/receivables').catch(() => ({ data: [] }))
]);

const ordersData = ordersRes.data || [];
const invoicesData = invoicesRes.data || [];
const payablesData = payablesRes.data || [];
const inventoryData = inventoryRes.data || [];
const receivablesData = receivablesRes.data || [];

console.log('Raw receivables data:', receivablesData);

const today = new Date();
today.setHours(0, 0, 0, 0);

// FIXED: Process active sales (orders in progress with event date in future)
const activeSalesData = ordersData
.filter(order => {
// Include orders that are approved OR in service/delivery process
const validStatuses = ['approved', 'service_assigned', 'in_progress', 'delivery_scheduled', 'pending_delivery'];

if (!validStatuses.includes(order.status)) {
// Skip completed, cancelled, rejected orders
console.log(`Skipping order ${order.id} with status: ${order.status}`);
return false;
}

// Only include if event date is in future
if (!order.event_date) {
console.log(`Skipping order ${order.id} - no event date`);
return false;
}

const eventDate = new Date(order.event_date);
eventDate.setHours(0, 0, 0, 0);
const isEventInFuture = eventDate >= today;

console.log(`Order ${order.id}: status=${order.status}, eventDate=${order.event_date}, inFuture=${isEventInFuture}`);
return isEventInFuture;
})
.map(order => ({
id: order.id,
date: order.created_at || order.created_date || new Date().toISOString(),
invoice_number: order.invoice_number || 'INV-' + order.id,
clientName: order.lead_name || order.client_name || 'N/A',
assignedTo: order.assigned_to || order.sales_person || order.created_by || 'Unassigned',
amount: parseFloat(order.final_amount || order.total_amount || 0),
status: 'active',
event_date: order.event_date,
payment_status: order.payment_status || 'pending',
order_type: order.order_type,
order_status: order.status // Keep original status for reference
}));

// FIXED: Process completed sales - orders that are completed OR have past event dates
const salesData = ordersData
.filter(order => {
// Include if explicitly completed or delivered
if (order.status === 'completed' || order.status === 'delivered') {
console.log(`Including completed order ${order.id} with status: ${order.status}`);
return true;
}

// Include if event date has passed (regardless of status, except rejected/cancelled)
if (order.status !== 'rejected' && order.status !== 'cancelled' && order.event_date) {
const eventDate = new Date(order.event_date);
eventDate.setHours(0, 0, 0, 0);
const isEventPast = eventDate < today;

if (isEventPast) {
console.log(`Including past event order ${order.id}: eventDate=${order.event_date}, status=${order.status}`);
return true;
}
}

return false;
})
.map(order => ({
id: order.id,
date: order.created_at || order.created_date || new Date().toISOString(),
invoice_number: order.invoice_number || 'INV-' + order.id,
clientName: order.lead_name || order.client_name || 'N/A',
assignedTo: order.assigned_to || order.sales_person || order.created_by || 'Unassigned',
amount: parseFloat(order.final_amount || order.total_amount || 0),
status: order.payment_status === 'paid' ? 'paid' : 'completed',
event_date: order.event_date,
payment_status: order.payment_status || 'pending'
}));

// Process receivables - ensure all fields are properly mapped
const processedReceivables = receivablesData.map(r => {
console.log('Processing receivable:', r);
return {
...r,
// Ensure all required fields are present
amount: parseFloat(r.expected_amount || r.amount || 0),
balance_amount: parseFloat(r.balance_amount || r.expected_amount || r.amount || 0),
invoice_number: r.invoice_number || r.invoice_id || 'N/A',
due_date: r.due_date || r.expected_payment_date || new Date().toISOString(),
client_name: r.client_name || 'N/A',
assigned_to: r.assigned_to || 'Unassigned',
status: r.status || 'pending'
};


});

console.log('Processed receivables:', processedReceivables);

// Filter only unpaid receivables
const unpaidReceivables = processedReceivables.filter(r => r.status !== 'paid');

console.log('Unpaid receivables to display:', unpaidReceivables);

// Calculate totals
const totalActiveSales = activeSalesData.reduce((sum, sale) => sum + sale.amount, 0);
const totalSales = salesData.reduce((sum, sale) => sum + sale.amount, 0);
const totalReceivables = unpaidReceivables.reduce((sum, rec) => 
sum + (rec.balance_amount || rec.amount || 0), 0
);
const totalPayables = payablesData.reduce((sum, pay) => 
sum + parseFloat(pay.amount || 0), 0
);

// Log the results
console.log('=== FINANCIAL DATA SUMMARY ===');
console.log(`Active Sales: ${activeSalesData.length} orders, Total: ‚Çπ${totalActiveSales.toLocaleString()}`);
console.log(`Completed Sales: ${salesData.length} orders, Total: ‚Çπ${totalSales.toLocaleString()}`);
console.log(`Receivables: ${unpaidReceivables.length} entries, Total: ‚Çπ${totalReceivables.toLocaleString()}`);
console.log(`Payables: ${payablesData.length} entries, Total: ‚Çπ${totalPayables.toLocaleString()}`);

// Update state
setFinancialData({
activeSales: activeSalesData,
sales: salesData,
receivables: unpaidReceivables,
payables: payablesData,
expiringInventory: inventoryData.filter(item => {
if (!item.event_date || item.allocated) return false;
const days = Math.ceil((new Date(item.event_date) - new Date()) / (1000 * 60 * 60 * 24));
return days <= 7 && days >= 0;
})
});

console.log('Financial data set:', {
activeSales: activeSalesData.length,
sales: salesData.length,
receivables: unpaidReceivables.length,
payables: payablesData.length
});

} catch (error) {
console.error('Error fetching financial data:', error);
alert('Failed to load financial data. Please refresh the page.');
}
};




// Record payment for receivable
const recordPayment = async (receivableId) => {
const paymentAmount = prompt('Enter payment amount:');
if (!paymentAmount) return;

const paymentMode = prompt('Enter payment mode (bank_transfer/cash/cheque):', 'bank_transfer');
const transactionId = prompt('Enter transaction ID (optional):');

try {
setLoading(true);
const response = await apiCall('/receivables/record-payment/' + (receivableId), 'PUT', {
payment_amount: parseFloat(paymentAmount),
payment_date: new Date().toISOString(),
payment_mode: paymentMode,
transaction_id: transactionId
});

alert('Payment recorded successfully!');
fetchFinancialData(); // Refresh data
} catch (error) {
console.error('Error recording payment:', error);
alert('Failed to record payment');
} finally {
setLoading(false);
}
};




const fetchMyActions = async () => {
console.log('===== fetchMyActions CALLED =====');
console.log('Timestamp:', new Date().toISOString());
console.log('Current user:', user);
console.log('User email:', user?.email);
console.log('User role:', user?.role);
console.log('Is logged in:', isLoggedIn);
console.log('Loading state:', loading);

if (!user) {
console.error('No user object - cannot fetch actions');
return;
}

if (!user) {
console.log('No user logged in');
return;
}

try {
setLoading(true);
console.log('Fetching actions for:', user.name, '(' + user.email + ')');

// Fetch all data in parallel
const [leadsResponse, ordersResponse, deliveriesResponse, receivablesResponse] = await Promise.all([
apiCall('/leads').catch(err => { console.error('Failed to fetch leads:', err); return { data: [] }; }),
apiCall('/orders').catch(err => { console.error('Failed to fetch orders:', err); return { data: [] }; }),
apiCall('/deliveries').catch(err => { console.error('Failed to fetch deliveries:', err); return { data: [] }; }),
apiCall('/receivables').catch(err => { console.error('Failed to fetch receivables:', err); return { data: [] }; })
]);

// Debug: Log all API responses
console.log('=== API RESPONSES RECEIVED ===');
console.log('Leads response:', leadsResponse);
console.log('Number of leads:', leadsResponse?.data?.length || 0);
if (leadsResponse?.data?.length > 0) {
console.log('First lead full data:', leadsResponse.data[0]);
console.log('Lead assignment field:', leadsResponse.data[0].assigned_to || leadsResponse.data[0].assignedTo || 'NOT FOUND');
}

// Filter leads assigned to me
// Filter leads assigned to me
if (leadsResponse && leadsResponse.data) {
const assignedLeads = leadsResponse.data.filter(lead => {
console.log('\n--- Checking Lead ---');
console.log('Lead:', lead);
console.log('Lead name:', lead.name);
console.log('Lead assigned_to:', lead.assigned_to);
console.log('Lead assignedTo:', lead.assignedTo);
console.log('My email:', user.email);

const isAssigned = lead.assigned_to === user.email;
console.log('Match result:', isAssigned);

return isAssigned;
});

// Filter quote requested leads for supply managers and supply sales service managers
const quoteRequestedLeads = leadsResponse.data.filter(lead => {
if (lead.status === 'quote_requested') {
// Check if user is supply_manager or has supply_sales_service role
return (user.role === 'supply_manager' || 
user.role === 'supply_sales_service_manager' ||
lead.quote_assigned_to === user.email);
}
return false;
});

console.log('\n=== FILTER RESULTS ===');
console.log('Total leads:', leadsResponse.data.length);
console.log('Assigned to me:', assignedLeads.length);
console.log('Quote requested for me:', quoteRequestedLeads.length);
console.log('Assigned leads:', assignedLeads);
console.log('Quote requested leads:', quoteRequestedLeads);

setMyLeads(assignedLeads);
setMyQuoteRequested(quoteRequestedLeads);
} else {
setMyLeads([]);
setMyQuoteRequested([]);
}

// Filter orders based on role
if (ordersResponse && ordersResponse.data) {
let assignedOrders = [];

if (user.role === 'supply_sales_service_manager' || user.role === 'supply_executive') {
assignedOrders = ordersResponse.data.filter(order => 
order.status === 'approved' && order.assigned_to === user.email
);
} else if (user.role === 'finance_manager' || user.role === 'finance_executive') {
assignedOrders = ordersResponse.data.filter(order => 
order.status === 'pending_approval'
);
}

console.log('My orders:', assignedOrders.length);
setMyOrders(assignedOrders);
} else {
setMyOrders([]);
}

// Filter deliveries
if (deliveriesResponse && deliveriesResponse.data) {
const assignedDeliveries = deliveriesResponse.data.filter(delivery => 
delivery.assigned_to === user.email
);
console.log('My deliveries:', assignedDeliveries.length);
setMyDeliveries(assignedDeliveries);
} else {
setMyDeliveries([]);
}

// Get overdue receivables
if (receivablesResponse && receivablesResponse.data) {
const today = new Date();
const overdueReceivables = receivablesResponse.data.filter(rec => {
if (rec.status === 'paid') return false;
const dueDate = new Date(rec.due_date);
return dueDate < today;
});
console.log('Overdue receivables:', overdueReceivables.length);
setMyReceivables(overdueReceivables);
} else {
setMyReceivables([]);
}

setLoading(false);
} catch (error) {
console.error('Error in fetchMyActions:', error);
setLoading(false);
}
};



window.chartInstances = chartInstances;
window.calculateDashboardStats = calculateDashboardStats;
window.debugCharts = () => {
console.log('=== Chart Debug Info ===');
console.log('Canvas elements:', {
leadSplit: document.getElementById('leadSplitChart'),
tempCount: document.getElementById('tempCountChart'),
tempValue: document.getElementById('tempValueChart')
});
console.log('Chart instances:', window.chartInstances);
console.log('Current leads:', leads);
console.log('Lead statuses:', leads.map(l => ({ name: l.name, status: l.status })));
};



// 5. Function to manually initialize charts:
window.forceInitCharts = () => {
console.log('Force initializing charts...');
initializeChartsAdvanced();
};    

window.debugDashboard = () => {
console.log('=== Dashboard Debug ===');
console.log('Active tab:', activeTab);
console.log('Leads count:', leads.length);
console.log('Chart.js loaded:', typeof Chart !== 'undefined');
console.log('Canvas elements in DOM:', {
leadSplit: !!document.getElementById('leadSplitChart'),
tempCount: !!document.getElementById('tempCountChart'),
tempValue: !!document.getElementById('tempValueChart')
});
console.log('Chart instances:', {
leadSplit: !!chartInstances.leadSplit,
tempCount: !!chartInstances.tempCount,
tempValue: !!chartInstances.tempValue
});

// Try to reinitialize
if (activeTab === 'dashboard') {
console.log('Attempting manual chart initialization...');
initializeChartsAdvanced();
}
};



// Enhanced lead progression function with permission check
// Status update function with permission check
const updateLeadStatus = async (leadId, newStatus) => {
if (!hasPermission('leads', 'progress')) {
alert('You do not have permission to progress leads');
return;
}

try {
setLoading(true);

// CRITICAL: Get the full lead object first
const currentLead = leads.find(l => l.id === leadId);
if (!currentLead) {
alert('Lead not found');
setLoading(false);
return;
}

// Include ALL fields from current lead
const updateData = {
...currentLead,  // This includes EVERYTHING
status: newStatus,
last_contact_date: new Date().toISOString(),
[(newStatus) + '_date']: new Date().toISOString(),
updated_date: new Date().toISOString()
};



console.log('Updating lead with full data:', updateData);

// API call to update lead status
const response = await apiCall('/leads/' + (leadId), {
method: 'PUT',
body: JSON.stringify(updateData)
});

// Update local state with response from server
console.log("Status update response:", response);
setLeads(prevLeads => 
prevLeads.map(lead => 
lead.id === leadId ? response.data : lead
)
);

// Update current lead if in detail view
if (showLeadDetail && currentLead?.id === leadId) {
setCurrentLead(response.data);
}

setLoading(false);
alert('Lead status updated successfully!');
} catch (error) {
console.error('Error updating lead status:', error);
setLoading(false);
alert('Failed to update lead status: ' + error.message);
}
};




// 2. REPLACE your renderStatusProgressModal function with this corrected version:

const renderStatusProgressModal = () => {
// NO useState declarations here - they're now at top level!

const handleStatusUpdate = async () => {
if (!selectedStatus) {
alert('Please select a status');
return;
}

const selectedStatusConfig = LEAD_STATUSES[selectedStatus];

// Check if follow-up date is required
if (selectedStatusConfig.requires_followup_date && !followUpDate) {
alert('Follow-up date is required for this status');
return;
}

try {
setLoading(true);

// Handle payment status specially
if (selectedStatus === 'payment') {
setShowStatusProgressModal(false);
openPaymentForm(currentLead);
setLoading(false);
return;
}

if (selectedStatus === 'payment_post_service') {
setShowStatusProgressModal(false);
openPaymentPostServiceForm(currentLead);
setLoading(false);
return;
}

// Prepare update data
const updateData = {
...currentLead,
status: selectedStatus,
last_contact_date: new Date().toISOString(),
[(selectedStatus) + '_date']: new Date().toISOString(),
updated_date: new Date().toISOString()
};



// Add follow-up specific fields if applicable
if (selectedStatusConfig.requires_followup_date && followUpDate) {
updateData.next_follow_up_date = followUpDate;
updateData.follow_up_notes = followUpNotes;
updateData.follow_up_reason = selectedStatus === 'pickup_later' ? 'Pick up later' : 'Follow up required';

// Store previous status for pickup_later
if (selectedStatus === 'pickup_later') {
updateData.previous_status = currentLead.status;
}
}

// Update lead status
const response = await apiCall('/leads/' + currentLead.id, {
method: 'PUT',
body: JSON.stringify(updateData)
});

// Update local state
setLeads(prevLeads => 
prevLeads.map(lead => 
lead.id === currentLead.id ? response.data : lead
)
);

// Update current lead if in detail view
if (showLeadDetail && currentLead?.id === currentLead.id) {
setCurrentLead(response.data);
}

setLoading(false);
setShowStatusProgressModal(false);

// Clear the form after successful update
setSelectedStatus('');
setFollowUpDate('');
setFollowUpNotes('');

// Show success message with follow-up info
if (selectedStatusConfig.requires_followup_date && followUpDate) {
alert(`Lead status updated successfully! Follow-up scheduled for ${new Date(followUpDate).toLocaleString()}`);
} else {
alert('Lead status updated successfully!');
}
} catch (error) {
console.error('Error updating lead status:', error);
setLoading(false);
alert('Failed to update lead status: ' + error.message);
}
};



const handleModalClose = () => {
setShowStatusProgressModal(false);
// Clear form when closing
setSelectedStatus('');
setFollowUpDate('');
setFollowUpNotes('');
};



if (!showStatusProgressModal) return null;

return React.createElement('div', { 
className: 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50' 
},
React.createElement('div', { 
className: 'bg-white rounded-lg p-6 w-full max-w-md max-h-screen overflow-y-auto' 
},
React.createElement('h3', { 
className: 'text-lg font-medium text-gray-900 mb-4' 
}, 'Progress Lead: ' + (currentLead?.name || '')),

React.createElement('p', { 
className: 'text-sm text-gray-600 mb-4' 
}, 'Current Status: ' + LEAD_STATUSES[currentLead?.status]?.label),

// Status selection
React.createElement('div', { className: 'mb-4' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Select New Status:'),
React.createElement('select', {
value: selectedStatus,
onChange: (e) => setSelectedStatus(e.target.value),
className: 'w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500'
},
React.createElement('option', { value: '' }, 'Choose status...'),
statusProgressOptions.map(option =>
React.createElement('option', { 
key: option.value, 
value: option.value 
}, `${option.icon || ''} ${option.label}`)
)
)
),

// Follow-up date field (shown when required)
selectedStatus && LEAD_STATUSES[selectedStatus]?.requires_followup_date && 
React.createElement('div', { className: 'mb-4' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 
'üìÖ Follow-up Date: *'
),
React.createElement('input', {
type: 'datetime-local',
value: followUpDate,
onChange: (e) => setFollowUpDate(e.target.value),
className: 'w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500',
min: new Date().toISOString().slice(0, 16) // Prevent past dates
}),
React.createElement('p', { className: 'text-xs text-gray-500 mt-1' },
'This will create an automatic reminder for follow-up'
)
),

// Follow-up notes field (shown when follow-up date is required)
selectedStatus && LEAD_STATUSES[selectedStatus]?.requires_followup_date && 
React.createElement('div', { className: 'mb-4' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 
'üìù Follow-up Notes:'
),
React.createElement('textarea', {
value: followUpNotes,
onChange: (e) => setFollowUpNotes(e.target.value),
placeholder: selectedStatus === 'pickup_later' 
? 'Why are we picking this up later? Add context for future reference...'
: 'Add notes for the follow-up...',
rows: 3,
className: 'w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500'
})
),

// Action buttons
React.createElement('div', { className: 'flex justify-end space-x-3 mt-6' },
React.createElement('button', {
type: 'button',
onClick: handleModalClose,
className: 'px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:ring-2 focus:ring-blue-500'
}, 'Cancel'),
React.createElement('button', {
type: 'button',
onClick: handleStatusUpdate,
disabled: loading,
className: 'px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 disabled:opacity-50 focus:ring-2 focus:ring-blue-500'
}, loading ? 'Updating...' : 'Update Status')
)
)
);
};



const handleLeadProgression = (lead) => {
if (!hasPermission('leads', 'progress')) {
alert('You do not have permission to progress leads');
return;
}

const currentStatus = lead.status;
const nextOptions = LEAD_STATUSES[currentStatus]?.next || [];

if (nextOptions.length === 0) {
alert('This lead is already at the final stage.');
return;
}

// Check if any of the next options require follow-up date (like pickup_later)
const hasFollowUpOptions = nextOptions.some(status => 
LEAD_STATUSES[status]?.requires_followup_date
);

if (nextOptions.length === 1) {
const nextStatus = nextOptions[0];

// Handle pickup_later status (requires follow-up date)
if (nextStatus === 'pickup_later') {
setCurrentLead(lead);
setShowStatusProgressModal(true);
setStatusProgressOptions([{
value: 'pickup_later',
label: LEAD_STATUSES['pickup_later'].label,
color: LEAD_STATUSES['pickup_later'].color,
requires_followup_date: true
}]);
return;
}

// Handle payment status (existing logic)
if (nextStatus === 'payment') {
if (currentStatus === 'payment_post_service') {
// Coming from payment_post_service, collect payment
const receivable = receivables.find(r => r.lead_id === lead.id && r.status === 'pending');
if (receivable) {
collectPostServicePayment(receivable);
} else {
openPaymentForm(lead);
}
} else {
openPaymentForm(lead);
}
return;
}

// For other single status transitions (including attempts)
updateLeadStatus(lead.id, nextStatus);
} else {
// Multiple options available - need to show choice modal

// Handle special case for converted status with payment options (existing logic)
if (currentStatus === 'converted' && 
nextOptions.includes('payment') && 
nextOptions.includes('payment_post_service')) {

// Check if pickup_later is also an option
if (nextOptions.includes('pickup_later')) {
// Show enhanced choice modal with pickup_later option
setCurrentLeadForChoice(lead);
setChoiceOptions([
{ value: 'payment', label: 'Collect Payment Now', icon: 'üí≥' },
{ value: 'payment_post_service', label: 'Payment Post Service', icon: 'üìÖ' },
{ value: 'pickup_later', label: 'Pick Up Later', icon: '‚è∞', requires_followup_date: true }
]);
setShowChoiceModal(true);
} else {
// Original logic for payment choices
setCurrentLeadForChoice(lead);
setChoiceOptions([
{ value: 'payment', label: 'Collect Payment Now', icon: 'üí≥' },
{ value: 'payment_post_service', label: 'Payment Post Service', icon: 'üìÖ' }
]);
setShowChoiceModal(true);
}
} 
// If any option requires follow-up date, use the enhanced modal
else if (hasFollowUpOptions) {
setCurrentLead(lead);
setShowStatusProgressModal(true);
setStatusProgressOptions(nextOptions.map(status => ({
value: status,
label: LEAD_STATUSES[status].label,
color: LEAD_STATUSES[status].color,
requires_followup_date: LEAD_STATUSES[status].requires_followup_date,
icon: getStatusIcon(status) // Helper function for icons
})));
} 
// Otherwise use the existing choice modal (this handles attempts and all other flows)
else {
setCurrentLeadForChoice(lead);
setChoiceOptions(nextOptions.map(status => ({
value: status,
label: LEAD_STATUSES[status].label,
icon: getStatusIcon(status)
})));
setShowChoiceModal(true);
}
}
};



const handleQuoteRequestStage = async (lead, newStatus) => {
try {
setLoading(true);

// Preserve temperature when moving to quote_requested
const currentTemperature = getLeadTemperature(lead);

const updateData = {
...lead,
status: newStatus,
temperature: currentTemperature, // Preserve the temperature
quote_requested_date: new Date().toISOString(),
last_contact_date: new Date().toISOString(),
updated_date: new Date().toISOString(),
// Dual assignment: keep original assignee and add sales service manager
quote_assigned_to: user.role === 'supply_manager' ? user.email : 'supply.service@fantopark.com', // Auto-assign based on role
dual_assignment: true
};



const response = await apiCall(`/leads/${lead.id}`, {
method: 'PUT',
body: JSON.stringify(updateData)
});

// Update local state
setLeads(prevLeads => 
prevLeads.map(l => 
l.id === lead.id ? response.data : l
)
);

// Update current lead if in detail view
if (showLeadDetail && currentLead?.id === lead.id) {
setCurrentLead(response.data);
}

setLoading(false);
alert('Lead moved to Quote Requested stage and assigned to Sales Service Manager!');
} catch (error) {
console.error('Error updating lead to quote requested:', error);
setLoading(false);
alert('Failed to update lead status: ' + error.message);
}
};



// Enhanced Choice Modal Handler to support pickup_later
const handleChoiceSelection = async (choice) => {
try {
setLoading(true);

// If choice requires follow-up date, switch to the enhanced modal
if (choice.requires_followup_date) {
setShowChoiceModal(false);
setCurrentLead(currentLeadForChoice);
setShowStatusProgressModal(true);
setStatusProgressOptions([{
value: choice.value,
label: choice.label,
color: LEAD_STATUSES[choice.value]?.color || 'bg-gray-100 text-gray-800',
requires_followup_date: true
}]);
setLoading(false);
return;
}

// Handle payment choices (existing logic)
if (choice.value === 'payment') {
setShowChoiceModal(false);
openPaymentForm(currentLeadForChoice);
setLoading(false);
return;
}

if (choice.value === 'payment_post_service') {
setShowChoiceModal(false);
openPaymentPostServiceForm(currentLeadForChoice);
setLoading(false);
return;
}

// For regular status updates
await updateLeadStatus(currentLeadForChoice.id, choice.value);
setShowChoiceModal(false);
setLoading(false);
} catch (error) {
console.error('Error handling choice selection:', error);
setLoading(false);
alert('Failed to update lead status: ' + error.message);
}
};





// Form handlers with permission checks
const openAddForm = (type) => {
if (!hasPermission(type === 'lead' ? 'leads' : (type === 'order' ? 'orders' : type), 'write')) {
alert('You do not have permission to create ' + (type) + 's');
return;
}
setCurrentForm(type);
setFormData({});
setShowAddForm(true);
};



const openEditForm = (lead) => {
if (!hasPermission('leads', 'write')) {
alert('You do not have permission to edit leads');
return;
}

setCurrentLead(lead);

// ‚úÖ FIXED: Convert date format for HTML date input
const processedLead = { ...lead };
if (processedLead.date_of_enquiry) {
try {
const date = new Date(processedLead.date_of_enquiry);
if (!isNaN(date.getTime())) {
// Convert to YYYY-MM-DD format for HTML date input
processedLead.date_of_enquiry = date.toISOString().split('T')[0];
}
} catch (error) {
console.warn('Could not parse date:', processedLead.date_of_enquiry);
// Set to current date as fallback
const now = new Date();
processedLead.date_of_enquiry = now.toISOString().split('T')[0];
}
}

setFormData(processedLead);
setShowEditForm(true);
};



const openAssignForm = (lead) => {
if (!hasPermission('leads', 'assign')) {
alert('You do not have permission to assign leads');
return;
}
setCurrentLead(lead);
setFormData({ assigned_team: 'sales', assigned_to: '' });
setShowAssignForm(true);
};



const openPaymentForm = (lead) => {
  if (!hasPermission('leads', 'write')) {
    alert('You do not have permission to manage payments');
    return;
  }
  
  setCurrentLead(lead);
  
  // Initialize payment data with defaults
  const initialPaymentData = {
    // Basic payment details
    advance_amount: '', // Changed from payment_amount
    payment_method: 'bank_transfer', // ADD: Default payment method
    transaction_id: '',
    payment_date: new Date().toISOString().split('T')[0],
    payment_proof: '',
    notes: '',
    
    // NEW: Enhanced customer classification
    customer_type: 'indian', // 'indian', 'nri', 'foreigner'
    event_location: 'india', // 'india', 'outside_india'
    payment_currency: 'INR', // 'INR', 'USD', 'EUR', 'GBP'
    
    // NEW: TCS fields with enhanced support
    tcs_applicable: false,
    tcs_rate: 5, // Default to 5%
    tcs_amount: 0,
    tcs_rate_manual: false, // Track if rate was manually selected
    
    // GST and Legal details
    gstin: lead.gstin || '', // ADD: Get from lead if available
    legal_name: lead.legal_name || lead.name || '', // CHANGE: Prioritize legal_name
    category_of_sale: lead.business_type === 'B2B' ? 'Corporate' : 'Retail', // CHANGE: Map to Corporate/Retail
    type_of_sale: 'Tour', // Tour or Service Fee
    registered_address: lead.registered_address || '', // ADD: Get from lead if available
    indian_state: 'Haryana',
    is_outside_india: false,
    gst_certificate: null,
    pan_card: null,
    
    // ENHANCED: Multi-row invoice items with additional info support
    invoice_items: [{
      description: lead.lead_for_event || 'Travel Package',
      additional_info: '', // NEW: For bracket info like (Lorem Ipsum)
      quantity: lead.number_of_people || 1,
      rate: lead.last_quoted_price || 0
    }],
    
    // GST calculations
    gst_rate: 5, // Default to 5% for Tour packages
    service_fee_amount: 0, // Only for Service Fee type
    
    // ADD: Missing fields for receivables and post-service payments
    from_receivable: false,
    payment_post_service: false,
    receivable_id: null,
    receivable_amount: 0
  };
  
  // Calculate initial TCS applicability and rate
  const baseAmount = lead.last_quoted_price * (lead.number_of_people || 1) || 0;
  if (baseAmount > 0) {
    const calculation = calculateGSTAndTCS(baseAmount, initialPaymentData);
    initialPaymentData.tcs_applicable = calculation.tcs.applicable;
    initialPaymentData.tcs_rate = calculation.tcs.rate;
    initialPaymentData.tcs_amount = calculation.tcs.amount;
  }
  
  setPaymentData(initialPaymentData);
  setShowPaymentForm(true);
};



const handleMarkPaymentFromReceivable = async (receivable) => {
console.log('Mark Payment clicked for receivable:', receivable);

// Check different possible field names for lead ID
const leadId = receivable.lead_id || receivable.leadId || receivable.lead;

if (!leadId) {
// If still no lead ID, check if there's an order we can get the lead from
if (receivable.order_id) {
const order = orders.find(o => o.id === receivable.order_id);
if (order && order.lead_id) {
const lead = leads.find(l => l.id === order.lead_id);
if (lead) {
setCurrentLead(lead);
openPaymentForm(lead);
setPaymentData(prev => ({
...prev,
payment_post_service: true,
advance_amount: receivable.balance_amount || receivable.expected_amount || receivable.amount || ''
,
from_receivable: true,
receivable_id: receivable.id,
receivable_amount: receivable.balance_amount || receivable.expected_amount || receivable.amount || 0
}));
return;
}
}
}

alert('Cannot find associated lead for this receivable.');
console.error('Receivable structure:', receivable);
return;
}

// Continue with normal flow if lead_id exists
const lead = leads.find(l => l.id === leadId);

if (!lead) {
try {
console.log('Fetching lead from API:', leadId);
const response = await apiCall('/leads/' + leadId);
const leadData = response.data || response;

setCurrentLead(leadData);
openPaymentForm(leadData);
setPaymentData(prev => ({
...prev,
payment_post_service: true,
advance_amount: receivable.balance_amount || receivable.expected_amount || receivable.amount || ''
,
from_receivable: true,
receivable_id: receivable.id,
receivable_amount: receivable.balance_amount || receivable.expected_amount || receivable.amount || 0
}));
} catch (error) {
console.error('Error fetching lead:', error);
alert('Could not find associated lead: ' + error.message);
}
} else {
setCurrentLead(lead);
openPaymentForm(lead);
setPaymentData(prev => ({
...prev,
payment_post_service: true,
advance_amount: receivable.balance_amount || receivable.expected_amount || receivable.amount || ''
,
from_receivable: true,
receivable_id: receivable.id,
receivable_amount: receivable.balance_amount || receivable.expected_amount || receivable.amount || 0
}));
}
};



const openLeadDetail = (lead) => {
setCurrentLead(lead);
setShowLeadDetail(true);
};



const openAllocationForm = (inventoryItem) => {
if (!hasPermission('inventory', 'allocate')) {
alert('You do not have permission to allocate inventory');
return;
}
setCurrentInventory(inventoryItem);
setAllocationData({
lead_id: '',
tickets_allocated: 1,
allocation_date: new Date().toISOString().split('T')[0],
notes: ''
});
setShowAllocationForm(true);
};



const openEditInventoryForm = (inventoryItem) => {
if (!hasPermission('inventory', 'write')) {
alert('You do not have permission to edit inventory');
return;
}
setCurrentInventory(inventoryItem);
setFormData(inventoryItem);
setShowEditInventoryForm(true);
};



// Add this right after the openEditInventoryForm function
const handleEditInventory = async (inventoryData) => {
try {
setLoading(true);

console.log('Updating inventory with data:', inventoryData);

// Validate payment amounts
const totalAmount = parseFloat(inventoryData.totalPurchaseAmount || 0);
const amountPaid = parseFloat(inventoryData.amountPaid || 0);

if (amountPaid > totalAmount) {
alert('Amount paid cannot be greater than total purchase amount.');
setLoading(false);
return;
}

// Auto-set payment status
if (amountPaid >= totalAmount) {
inventoryData.paymentStatus = 'paid';
} else if (amountPaid > 0) {
inventoryData.paymentStatus = 'partial';
} else {
inventoryData.paymentStatus = 'pending';
}

// Update inventory (this will automatically sync payables via backend)
const response = await apiCall(`/inventory/${editingInventory.id}`, {
method: 'PUT',
body: JSON.stringify(inventoryData)
});

if (response.error) {
throw new Error(response.error);
}

// Update local state
setInventory(prev => prev.map(item => 
item.id === editingInventory.id 
? { ...item, ...inventoryData }
: item
));

// Refresh financial data to show updated payables
if (hasPermission('finance', 'read')) {
await fetchFinancialData();
}

alert(response.message || 'Inventory updated successfully! Payables have been synced automatically.');
setShowInventoryForm(false);
setEditingInventory(null);

} catch (error) {
console.error('Error updating inventory:', error);
alert('Failed to update inventory: ' + error.message);
} finally {
setLoading(false);
}
};



const openInventoryDetail = (inventoryItem) => {
setCurrentInventoryDetail(inventoryItem);
setShowInventoryDetail(true);
};



// 3. ADD THIS FUNCTION to close inventory detail:
const closeInventoryDetail = () => {
setShowInventoryDetail(false);
setCurrentInventoryDetail(null);
};



const openAddInventoryForm = () => {
console.log('openAddInventoryForm called');

// Fetch stadiums if not already loaded
if (stadiums.length === 0) {
fetchStadiums();
}

// Set up for new inventory item
setEditingInventory({ 
id: null, // Indicates this is a new item
event_name: '',
event_date: '',
event_type: '',
sports: '',
venue: '',
// Add other default fields as needed
});

// Initialize form data with empty values
setFormData({
event_name: '',
event_date: '',
event_type: '',
sports: '',
venue: '',
day_of_match: '',
category_of_ticket: '',
total_tickets: '',
available_tickets: '',
mrp_of_ticket: '',
buying_price: '',
selling_price: '',
stand: '',
inclusions: '',
booking_person: '',
procurement_type: '',
notes: '',
paymentStatus: 'pending',
supplierName: '',
supplierInvoice: '',
totalPurchaseAmount: '',
amountPaid: '',
paymentDueDate: ''
});

setShowInventoryForm(true);
console.log('Inventory form should now be visible with empty form data');
};



const handleCopyInventory = async (item) => {
try {
setLoading(true);

// Create a copy of the inventory item with modified fields
const copiedData = {
...item,
// Remove ID and system fields that shouldn't be copied
id: undefined,
created_date: undefined,
updated_date: undefined,

// Modify the event name to indicate it's a copy
event_name: item.event_name + ' (Copy)',

// Reset availability to match total tickets (fresh inventory)
available_tickets: item.total_tickets,

// Clear payment-related fields for fresh start
paymentStatus: 'pending',
amountPaid: 0,
supplierInvoice: '',

// Update creation info
created_by: JSON.parse(localStorage.getItem('crm_user') || '{}').name || 'Unknown User',
notes: (item.notes || '') + (item.notes ? '\n\n' : '') + 'Copied from original inventory on ' + new Date().toLocaleDateString()
};



console.log('Creating copy of inventory:', copiedData);

// Call API to create the copied inventory
const response = await apiCall('/inventory', {
method: 'POST',
body: JSON.stringify(copiedData)
});

if (response.error) {
throw new Error(response.error);
}

console.log('Copy created successfully:', response.data);

// Update local state by adding the new item to the inventory array
setInventory(prev => [...prev, response.data]);

alert(`‚úÖ Inventory copied successfully!\n\nNew event: "${copiedData.event_name}"\nTotal tickets: ${copiedData.total_tickets}\nAvailable tickets: ${copiedData.available_tickets}`);

} catch (error) {
console.error('Error copying inventory:', error);
alert('‚ùå Failed to copy inventory: ' + error.message);
} finally {
setLoading(false);
}
};





const openDeliveryForm = (delivery) => {
if (!hasPermission('delivery', 'write')) {
alert('You do not have permission to manage deliveries');
return;
}
setCurrentDelivery(delivery);
setDeliveryFormData({
delivery_type: delivery.delivery_type || 'offline',
pickup_location: delivery.pickup_location || '',
delivery_location: delivery.delivery_location || '',
pickup_date: '',
pickup_time: '',
delivery_date: '',
delivery_time: '',
delivery_person: delivery.assigned_to || '',
delivery_notes: '',
online_platform: '',
online_link: ''
});
setShowDeliveryForm(true);
};



const openPaymentPostServiceForm = (lead) => {
if (!hasPermission('leads', 'write')) {
alert('You do not have permission to manage payment post service');
return;
}
setCurrentLead(lead);
setPaymentPostServiceData({
expected_payment_date: '',
expected_amount: lead.last_quoted_price || 0,
service_date: '',
service_details: '',
payment_terms: '30 days',
reminder_days: '7',
notes: ''
});
setShowPaymentPostServiceForm(true);
};



const handlePaymentPostServiceInputChange = (field, value) => {
setPaymentPostServiceData(prev => ({ ...prev, [field]: value }));
};



const handlePaymentPostServiceSubmit = async (e) => {
e.preventDefault();

if (!hasPermission('leads', 'write')) {
alert('You do not have permission to manage payment post service');
return;
}

setLoading(true);

try {
// Update lead status via API
const leadResponse = await apiCall('/leads/' + (currentLead.id), {
method: 'PUT',
body: JSON.stringify({
status: 'payment_post_service',
payment_post_service_details: paymentPostServiceData,
payment_post_service_date: new Date().toISOString()
})
});

// Update local state
setLeads(prev => 
prev.map(lead => 
lead.id === currentLead.id ? leadResponse : lead
)
);

// Create order with all required fields
const newOrder = {
order_number: 'ORD-' + (Date.now()),
lead_id: currentLead.id,
client_name: currentLead.name,
client_email: currentLead.email,
client_phone: currentLead.phone,

// Required order fields for backend
event_name: currentLead?.lead_for_event || 'Post Service Payment',
event_date: paymentPostServiceData.service_date || new Date().toISOString().split('T')[0],
tickets_allocated: 1,
ticket_category: 'Post Service',
price_per_ticket: parseFloat(paymentPostServiceData.expected_amount) || 0,
total_amount: parseFloat(paymentPostServiceData.expected_amount) || 0,

// Payment post service specific fields
expected_amount: parseFloat(paymentPostServiceData.expected_amount),
expected_payment_date: paymentPostServiceData.expected_payment_date,
service_description: paymentPostServiceData.service_details,
notes: paymentPostServiceData.notes,
payment_terms: paymentPostServiceData.payment_terms,

// Order metadata
order_type: 'payment_post_service',
payment_status: 'pending',
status: 'pending_approval',
requires_gst_invoice: true,
created_date: new Date().toISOString(),
created_by: user.name,
assigned_to: ''  // Will be assigned later
};



// Create order in backend
try {
console.log('Creating payment post service order:', JSON.stringify(newOrder, null, 2));
const orderResponse = await apiCall('/orders', {
method: 'POST',
body: JSON.stringify(newOrder)
});
console.log('Order created in backend (Post Service):', orderResponse);

// Use the response data or fallback to newOrder
const finalOrder = orderResponse.data || orderResponse || newOrder;
if (!finalOrder.id && newOrder.order_number) {
finalOrder.id = newOrder.order_number;
}

setOrders(prev => [...prev, finalOrder]);

setLoading(false);
alert('Payment Post Service order created successfully! Awaiting approval.');
closeForm();
} catch (orderError) {
console.error('Failed to create order in backend:', orderError);

// Add to local state with the order_number as id
newOrder.id = newOrder.order_number;
setOrders(prev => [...prev, newOrder]);

setLoading(false);
alert('Warning: Order may not have been saved to server. Please check orders page.');
closeForm();
}
} catch (error) {
setLoading(false);
alert('Failed to process payment post service. Please try again.');
console.error('Payment post service error:', error);
}
};




const collectPostServicePayment = (receivable) => {
const lead = leads.find(l => l.id === receivable.lead_id);
if (lead) {
setCurrentLead(lead);
setPaymentData({
...paymentData,
advance_amount: receivable.expected_amount,
payment_post_service: true,
from_receivable: true,
receivable_id: receivable.id,
receivable_amount: receivable.expected_amount || receivable.balance_amount || receivable.amount || 0
});
setShowPaymentForm(true);
}
};



const sendEmailNotification = (notification) => {
console.log('Email Notification:', {
to: notification.recipient,
subject: notification.subject,
body: notification.body,
sent_at: new Date().toISOString()
});

// Update notification status
setEmailNotifications(prev => 
prev.map(n => 
n.id === notification.id 
? { ...n, status: 'sent', sent_date: new Date().toISOString() }
: n
)
);
};



const handleDeliverySubmit = async (e) => {
e.preventDefault();
if (!hasPermission('delivery', 'write')) {
alert('You do not have permission to manage deliveries');
return;
}

setLoading(true);

try {
await new Promise(resolve => setTimeout(resolve, 1000));

// Update delivery in backend
try {
await apiCall('/deliveries/' + (currentDelivery.id), {
method: 'PUT',
body: JSON.stringify({
...currentDelivery,
...deliveryFormData,
status: 'scheduled',
scheduled_date: new Date().toISOString()
})
});
console.log('Delivery updated in backend');
} catch (error) {
console.error('Failed to update delivery in backend:', error);
}

setDeliveries(prev => 
prev.map(delivery => 
delivery.id === currentDelivery.id 
? { 
...delivery, 
...deliveryFormData,
status: 'scheduled',
scheduled_date: new Date().toISOString().split('T')[0]
} 
: delivery
)
);

setLoading(false);
alert('Delivery scheduled successfully!');
closeForm();
} catch (error) {
setLoading(false);
alert('Failed to schedule delivery. Please try again.');
}
};



const deleteDelivery = async (deliveryId) => {
if (!hasPermission('delivery', 'write')) {
alert('You do not have permission to delete deliveries');
return;
}

if (!confirm('Are you sure you want to delete this delivery? This action cannot be undone.')) {
return;
}

setLoading(true);
try {
await apiCall('/deliveries/' + (deliveryId), {
method: 'DELETE'
});

setDeliveries(prev => prev.filter(d => d.id !== deliveryId));

alert('Delivery deleted successfully!');
} catch (error) {
console.error('Failed to delete delivery:', error);
alert('Failed to delete delivery. Please try again.');
} finally {
setLoading(false);
}
};



const closeForm = () => {
setShowAddForm(false);
setShowEditForm(false);
setShowAssignForm(false);
setShowPaymentForm(false);
setShowLeadDetail(false);
setShowAllocationForm(false);
setShowEditInventoryForm(false);
setShowChoiceModal(false);
setShowInvoicePreview(false);
setShowDeliveryForm(false);
setShowPaymentPostServiceForm(false);
setCurrentForm('');
setCurrentLead(null);
setCurrentInventory(null);
setCurrentLeadForChoice(null);
setCurrentInvoice(null);
setCurrentDelivery(null);
setChoiceOptions([]);
setFormData({});
setPaymentData({});
setAllocationData({});
setDeliveryFormData({});
setPaymentPostServiceData({});
};



const handleInputChange = (field, value, itemIndex = null, itemField = null) => {
if (itemIndex !== null && itemField !== null) {
updateInvoiceItem(itemIndex, itemField, value);
} else {
setPaymentData(prevData => ({
...prevData,
[field]: value
}));
}
};



const handleFormDataChange = (field, value) => {
console.log('Form field changed:', field, '=', value);
setFormData(prev => ({
...prev,
[field]: value
}));
}; 

const handleUserInputChange = (field, value) => {
setUserFormData(prev => ({ ...prev, [field]: value }));
};



const handleAllocationInputChange = (field, value) => {
setAllocationData(prev => ({ ...prev, [field]: value }));
};


const handleDeliveryInputChange = (field, value) => {
setDeliveryFormData(prev => ({ ...prev, [field]: value }));
};



// Delete function with permission check
const handleDelete = async (type, id, name) => {
console.log("handleDelete called:", type, id, name);
const modulePermissions = {
'leads': 'leads',
'inventory': 'inventory',
'orders': 'orders'
};



if (!hasPermission(modulePermissions[type], 'delete')) {
alert('You do not have permission to delete ' + (type));
return;
}

if (!confirm('Are you sure you want to delete ' + (name) + '?')) return;

setLoading(true);
try {
// Special handling for orders - convert delete to cancel
console.log("Processing order deletion as cancellation");
if (type === 'orders') {
console.log("Deleting order permanently");
try {
// Actually delete the order
await apiCall('/' + (type) + '/' + (id), {
method: 'DELETE'
});

// If successful, remove from local state
setOrders(prev => prev.filter(order => order.id !== id));

setLoading(false);
alert('Order deleted successfully!');
} catch (deleteError) {
console.error("Delete failed:", deleteError);
console.log("Delete error details:", deleteError.message, deleteError.status);

// If backend doesn't support DELETE, mark as deleted instead
if (deleteError.message && (deleteError.message.includes('404') || deleteError.message.includes('405'))) {
console.log("Backend doesn't support DELETE, marking as deleted");
try {
await apiCall('/orders/' + (id), {
method: 'PUT',
body: JSON.stringify({
status: 'deleted',
deleted_date: new Date().toISOString(),
deleted_by: user?.name || 'Admin',
is_deleted: true
})
});

// Remove from local view
setOrders(prev => prev.filter(order => order.id !== id));
alert('Order marked as deleted successfully!');
return;
} catch (putError) {
console.error("PUT also failed:", putError);
}
}
// If DELETE not supported, remove locally with warning
setOrders(prev => prev.filter(order => order.id !== id));
setLoading(false);
alert('Order removed. Note: This may reappear on refresh if server delete is not supported.');
}setLoading(false);
alert('Order cancelled successfully!');
} else {
// For leads and inventory, try actual DELETE
try {
console.log("Making API call to:", '/' + (type) + '/' + (id));
await apiCall('/' + (type) + '/' + (id), {
method: 'DELETE'
});

// If successful, update local state
switch (type) {
case 'leads':
setLeads(prev => prev.filter(item => item.id !== id));
break;
case 'inventory':
setInventory(prev => prev.filter(item => item.id !== id));
break;
}

setLoading(false);
alert((type === 'inventory' ? 'Event' : type.slice(0, -1)) + ' deleted successfully!');
} catch (deleteError) {
// If DELETE fails, just remove from local state with warning
switch (type) {
case 'leads':
setLeads(prev => prev.filter(item => item.id !== id));
break;
case 'inventory':
setInventory(prev => prev.filter(item => item.id !== id));
break;
}

setLoading(false);
alert((type === 'inventory' ? 'Event' : type.slice(0, -1)) + ' removed locally. May reappear on refresh if server delete is not supported.');
}
}
} catch (error) {
setLoading(false);
alert('Failed to process ' + (type === 'inventory' ? 'event' : type.slice(0, -1)) + ': ' + (error.message));
}
};



// User Management Modal
const renderUserManagement = () => {
if (!showUserManagement) return null;

return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
onClick: (e) => e.target === e.currentTarget && closeUserForm()
},
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg w-full max-w-6xl max-h-[95vh] overflow-y-auto' },
React.createElement('div', { className: 'sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center' },
React.createElement('h2', { className: 'text-2xl font-bold text-gray-900' }, 'User Management'),
React.createElement('div', { className: 'flex space-x-2' },
hasPermission('users', 'write') && React.createElement('button', {
onClick: () => openUserForm(user),
className: 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700'
}, '+ Add User'),
React.createElement('button', {
onClick: () => setShowUserManagement(false),
className: 'text-gray-400 hover:text-gray-600 text-2xl'
}, '‚úï')
)
),
React.createElement('div', { className: 'p-6' },
React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-900' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'User'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Role'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Department'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Status'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Payment'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Created'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Actions')
)
),
React.createElement('tbody', { className: 'bg-white divide-y divide-gray-200' },
users.map(user =>
React.createElement('tr', { key: user.id, className: 'hover:bg-gray-50' },
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'text-sm font-medium text-gray-900' }, user.name),
React.createElement('div', { className: 'text-sm text-gray-500' }, user.email)
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('span', {
className: `px-2 py-1 text-xs rounded ${
user.role === 'super_admin' ? 'bg-purple-100 text-purple-800' :
user.role === 'admin' ? 'bg-blue-100 text-blue-800' :
user.role.includes('manager') ? 'bg-green-100 text-green-800' :
'bg-gray-100 text-gray-800'
}`
}, getRoleDisplayLabel(user.role))
),
React.createElement('td', { className: 'px-6 py-4 text-sm text-gray-900' }, user.department),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('span', {
className: `px-2 py-1 text-xs rounded ${
user.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
}`
}, user.status.charAt(0).toUpperCase() + user.status.slice(1))
),
React.createElement('td', { className: 'px-6 py-4 text-sm text-gray-900' }, 
new Date(user.created_date).toLocaleDateString()
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'flex space-x-2' },
hasPermission('users', 'write') && React.createElement('button', {
onClick: () => openUserForm(),
className: 'text-blue-600 hover:text-blue-900 text-sm px-2 py-1 rounded border border-blue-200 hover:bg-blue-50'
}, 'Edit'),
hasPermission('users', 'delete') && user.id !== 1 && React.createElement('button', {
onClick: () => handleDeleteUser(user.id, user.name),
className: 'text-red-600 hover:text-red-900 text-sm px-2 py-1 rounded border border-red-200 hover:bg-red-50',
disabled: loading
}, loading ? 'Deleting...' : 'Delete')
)
)
)
)
)
)
)
)
)
);
};



const renderFinancials = () => {
// Filter data based on filters
const applyFilters = (data) => {
return data.filter(item => {
if (financialFilters.clientName && !item.clientName?.toLowerCase().includes(financialFilters.clientName.toLowerCase())) return false;
if (financialFilters.assignedPerson && !item.assignedTo?.toLowerCase().includes(financialFilters.assignedPerson.toLowerCase())) return false;
if (financialFilters.dateFrom && new Date(item.date) < new Date(financialFilters.dateFrom)) return false;
if (financialFilters.dateTo && new Date(item.date) > new Date(financialFilters.dateTo)) return false;
if (financialFilters.status !== 'all' && item.status !== financialFilters.status) return false;
return true;
});
};



return React.createElement('div', { className: 'space-y-6' },
// Header with stats cards
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-4 gap-4 mb-6' },
// Total Sales Card
React.createElement('div', { className: 'bg-green-50 dark:bg-green-900 p-4 rounded-lg' },
React.createElement('h3', { className: 'text-sm font-medium text-green-800 dark:text-green-200' }, 'Total Sales'),
React.createElement('p', { className: 'text-2xl font-bold text-green-600' }, 
'‚Çπ' + ((financialData.sales || []).reduce((sum, sale) => 
sum + parseFloat(sale.amount || sale.total_amount || sale.final_amount || 0), 0
)).toLocaleString()
)
),
// Total Active Sales Card
React.createElement('div', { className: 'bg-purple-50 dark:bg-purple-900 p-4 rounded-lg' },
React.createElement('h3', { className: 'text-sm font-medium text-purple-800 dark:text-purple-200' }, 'Total Active Sales'),
React.createElement('p', { className: 'text-2xl font-bold text-purple-600' }, 
'‚Çπ' + ((financialData.activeSales || []).reduce((sum, sale) => 
sum + parseFloat(sale.amount || 0), 0
)).toLocaleString()
)
),
// Total Receivables Card
React.createElement('div', { className: 'bg-blue-50 dark:bg-blue-900 p-4 rounded-lg' },
React.createElement('h3', { className: 'text-sm font-medium text-blue-800 dark:text-blue-200' }, 'Total Receivables'),
React.createElement('p', { className: 'text-2xl font-bold text-blue-600' }, 
'‚Çπ' + ((financialData.receivables || []).reduce((sum, rec) => 
sum + parseFloat(rec.balance_amount || rec.expected_amount || rec.amount || 0), 0
)).toLocaleString()
)
),
// Total Payables Card
React.createElement('div', { className: 'bg-red-50 dark:bg-red-900 p-4 rounded-lg' },
React.createElement('h3', { className: 'text-sm font-medium text-red-800 dark:text-red-200' }, 'Total Payables'),
React.createElement('p', { className: 'text-2xl font-bold text-red-600' }, 
'‚Çπ' + ((financialData.payables || []).reduce((sum, pay) => 
sum + parseFloat(pay.amount || 0), 0
)).toLocaleString()
)
),

// Expiring Inventory Card
React.createElement('div', { className: 'bg-yellow-50 dark:bg-yellow-900 p-4 rounded-lg' },
React.createElement('h3', { className: 'text-sm font-medium text-yellow-800 dark:text-yellow-200' }, 'Expiring Inventory Value'),
React.createElement('p', { className: 'text-2xl font-bold text-yellow-900 dark:text-yellow-100' }, 
'‚Çπ' + (financialStats.expiringValue.toLocaleString())
)
)
),

// Filters
React.createElement('div', { className: 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow' },
React.createElement('h3', { className: 'text-lg font-semibold mb-4' }, 'Filters'),
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-5 gap-4' },
React.createElement('input', {
type: 'text',
placeholder: 'Client Name',
value: financialFilters.clientName,
onChange: (e) => setFinancialFilters(prev => ({ ...prev, clientName: e.target.value })),
className: 'px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
}),
React.createElement('input', {
type: 'text',
placeholder: 'Assigned Person',
value: financialFilters.assignedPerson,
onChange: (e) => setFinancialFilters(prev => ({ ...prev, assignedPerson: e.target.value })),
className: 'px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
}),
React.createElement('input', {
type: 'date',
value: financialFilters.dateFrom,
onChange: (e) => setFinancialFilters(prev => ({ ...prev, dateFrom: e.target.value })),
className: 'px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
}),
React.createElement('input', {
type: 'date',
value: financialFilters.dateTo,
onChange: (e) => setFinancialFilters(prev => ({ ...prev, dateTo: e.target.value })),
className: 'px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
}),
React.createElement('button', {
onClick: () => setFinancialFilters({
clientName: '',
assignedPerson: '',
dateFrom: '',
dateTo: '',
status: 'all'
}),
className: 'bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600'
}, 'Clear Filters')
)
),

// Tabs
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow' },
React.createElement('div', { className: 'border-b dark:border-gray-700' },
React.createElement('div', { className: 'flex space-x-1' },
['activesales', 'sales', 'receivables', 'payables', 'expiring'].map(tab =>
React.createElement('button', {
key: tab,
onClick: () => setActiveFinancialTab(tab),
className: `px-4 py-2 font-medium ${
activeFinancialTab === tab
? 'text-blue-600 border-b-2 border-blue-600'
: 'text-gray-500 hover:text-gray-700'
}`
}, tab.charAt(0).toUpperCase() + tab.slice(1))
)
)
),

// Tab Content
React.createElement('div', { className: 'p-6' },
activeFinancialTab === 'activesales' && renderActiveSalesTab(applyFilters(financialData.activeSales || [])),
activeFinancialTab === 'sales' && renderSalesTab(applyFilters(financialData.sales)),
activeFinancialTab === 'receivables' && renderReceivablesTab(applyFilters(financialData.receivables)),
activeFinancialTab === 'payables' && renderPayablesTab(applyFilters(financialData.payables)),
activeFinancialTab === 'expiring' && renderExpiringTab(financialData.expiringInventory)
)
)
);
};



// Export Events to Excel
const exportEventsToExcel = async () => {
  try {
    const params = new URLSearchParams();
    if (calendarFilters.geography) params.append('geography', calendarFilters.geography);
    if (calendarFilters.sport_type) params.append('sport_type', calendarFilters.sport_type);
    if (calendarFilters.priority) params.append('priority', calendarFilters.priority);
    params.append('sort_by', 'date'); // Default sort by date

    const response = await fetch(`${API_URL}/events/export/excel?${params.toString()}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('crm_auth_token')}`
      }
    });

    if (response.ok) {
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `events_calendar_${new Date().toISOString().split('T')[0]}.xlsx`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      alert('Events exported successfully!');
    } else {
      throw new Error('Failed to export events');
    }
  } catch (error) {
    console.error('Export error:', error);
    alert('Failed to export events: ' + error.message);
  }
};




// Import Events from Excel
const importEventsFromExcel = async (file) => {
  try {
    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        // Parse Excel file
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        console.log('Parsed Excel data:', jsonData);

        const response = await fetch(`${API_URL}/events/import/excel`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('crm_auth_token')}`
          },
          body: JSON.stringify({ excelData: jsonData })
        });

        const result = await response.json();
        
        if (result.success) {
          await fetchSportsEvents(); // Refresh the events list
          alert(result.message);
          setShowImportModal(false);
        } else {
          throw new Error(result.error || 'Failed to import events');
        }
      } catch (error) {
        console.error('Import processing error:', error);
        alert('Failed to process Excel file: ' + error.message);
      }
    };
    reader.readAsArrayBuffer(file);
  } catch (error) {
    console.error('Import error:', error);
    alert('Failed to import events: ' + error.message);
  }
};



const renderImportModal = () => {
  if (!showImportModal) return null;

  return React.createElement('div', {
    className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
    onClick: () => setShowImportModal(false)
  },
    React.createElement('div', {
      className: 'bg-white dark:bg-gray-800 rounded-lg w-full max-w-md p-6',
      onClick: (e) => e.stopPropagation()
    },
      React.createElement('h2', { className: 'text-2xl font-bold mb-4' }, 'Import Events from Excel'),
      React.createElement('div', { className: 'mb-4' },
        React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Select Excel File'),
        React.createElement('input', {
          type: 'file',
          accept: '.xlsx,.xls',
          onChange: (e) => {
            const file = e.target.files[0];
            if (file) {
              importEventsFromExcel(file);
            }
          },
          className: 'w-full p-2 border border-gray-300 rounded-lg'
        })
      ),
      React.createElement('div', { className: 'text-sm text-gray-600 mb-4' },
        React.createElement('p', null, 'Expected columns:'),
        React.createElement('ul', { className: 'list-disc list-inside text-xs mt-1' },
          React.createElement('li', null, 'Event Name'),
          React.createElement('li', null, 'Event Type'),
          React.createElement('li', null, 'Sport Type'),
          React.createElement('li', null, 'Geography'),
          React.createElement('li', null, 'Start Date'),
          React.createElement('li', null, 'End Date')
        )
      ),
      React.createElement('div', { className: 'flex justify-end space-x-3' },
        React.createElement('button', {
          onClick: () => setShowImportModal(false),
          className: 'px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50'
        }, 'Cancel')
      )
    )
  );
};


  

  
const renderActiveSalesTab = (activeSales) => {
return React.createElement('div', { className: 'space-y-4' },
React.createElement('h4', { className: 'text-lg font-semibold mb-4' }, 'Active Sales (Post-Service Payment Orders)'),

React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-700' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Date'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Invoice #'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Client'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Sales Person'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Amount'),
)
),
React.createElement('tbody', { className: 'divide-y divide-gray-200 dark:divide-gray-700' },
activeSales.length > 0 ?
activeSales.map(sale =>
React.createElement('tr', { key: sale.id },
React.createElement('td', { className: 'px-4 py-2' }, 
new Date(sale.date).toLocaleDateString()
),
React.createElement('td', { className: 'px-4 py-2' }, sale.invoice_number),
React.createElement('td', { className: 'px-4 py-2' }, sale.clientName),
React.createElement('td', { className: 'px-4 py-2' }, sale.assignedTo),
React.createElement('td', { className: 'px-4 py-2' }, 
'‚Çπ' + sale.amount.toLocaleString()
),
React.createElement('td', { className: 'px-4 py-2' },
React.createElement('button', {
className: 'text-blue-600 hover:text-blue-800',
onClick: () => recordPayment(rec.id)
}, '')
)
)
)
: React.createElement('tr', null,
React.createElement('td', { 
colSpan: 6, 
className: 'px-4 py-8 text-center text-gray-500' 
}, 'No active sales')
)
)
)
)
);
};




const renderSalesTab = (sales) => {
return React.createElement('div', { className: 'space-y-4' },
// Sales Chart
React.createElement('div', { className: 'h-64 bg-gray-50 dark:bg-gray-700 rounded-lg p-4' },
React.createElement('h4', { className: 'text-lg font-semibold mb-4' }, 'Sales Trend'),
React.createElement('div', { className: 'text-center text-gray-500 mt-20' }, 
'Sales chart visualization would go here'
)
),

// Sales Table
React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-700' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Date'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Invoice #'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Client'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Sales Person'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Amount'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Status')
)
),
React.createElement('tbody', { className: 'divide-y divide-gray-200 dark:divide-gray-700' },
sales.length > 0 ? sales.map(sale =>
React.createElement('tr', { key: sale.id },
React.createElement('td', { className: 'px-4 py-3 text-sm' }, 
new Date(sale.date).toLocaleDateString()
),
React.createElement('td', { className: 'px-4 py-3 text-sm' }, sale.invoiceNumber),
React.createElement('td', { className: 'px-4 py-3 text-sm' }, sale.clientName),
React.createElement('td', { className: 'px-4 py-3 text-sm' }, sale.assignedTo),
React.createElement('td', { className: 'px-4 py-3 text-sm font-medium' }, 
'‚Çπ' + ((sale.amount || 0).toLocaleString())
),
React.createElement('td', { className: 'px-4 py-3' },
React.createElement('span', {
className: `px-2 py-1 text-xs rounded ${
sale.status === 'paid' ? 'bg-green-100 text-green-800' :
sale.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
'bg-gray-100 text-gray-800'
}`
}, sale.status)
)
)
) : React.createElement('tr', null,
React.createElement('td', { 
colSpan: 6, 
className: 'px-4 py-8 text-center text-gray-500' 
}, 'No sales data found')
)
)
)
)
);
};



// UPDATED RECEIVABLES TABLE FUNCTION - REPLACE YOUR EXISTING renderReceivablesTab FUNCTION
const renderReceivablesTab = (receivables) => {
return React.createElement('div', { className: 'space-y-4' },
React.createElement('h4', { className: 'text-lg font-semibold mb-4' }, 'Receivables'),

React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-700' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Due Date'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Invoice #'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Client'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Amount'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Days Overdue'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Actions')
)
),
React.createElement('tbody', { className: 'divide-y divide-gray-200 dark:divide-gray-700' },
receivables.length > 0 ?
receivables.map(rec => {
// Calculate days overdue/until due
const dueDate = new Date(rec.due_date);
const today = new Date();
today.setHours(0, 0, 0, 0);
dueDate.setHours(0, 0, 0, 0);
const daysDiff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
const isOverdue = daysDiff < 0;

return React.createElement('tr', { key: rec.id },
React.createElement('td', { className: 'px-4 py-3' },
React.createElement('div', null,
dueDate.toLocaleDateString(),
isOverdue && React.createElement('span', { 
className: 'ml-2 text-xs text-red-600' 
}, 'Overdue')
)
),
React.createElement('td', { className: 'px-4 py-3' }, rec.invoice_number || 'N/A'),
React.createElement('td', { className: 'px-4 py-3' }, rec.client_name || 'N/A'),
React.createElement('td', { className: 'px-4 py-3' }, formatCurrency(rec.amount || rec.expected_amount || 0)),
React.createElement('td', { className: 'px-4 py-3' },
React.createElement('span', {
className: isOverdue ? 'text-red-600' : 'text-green-600'
}, isOverdue ? `${Math.abs(daysDiff)} days overdue` : daysDiff === 0 ? 'Due today' : `Not due`)
),
// UPDATED ACTIONS COLUMN WITH DELETE BUTTON
React.createElement('td', { className: 'px-4 py-3' },
React.createElement('div', { className: 'flex space-x-2' },
React.createElement('button', {
className: 'text-blue-600 hover:text-blue-800 font-medium',
onClick: () => handleMarkPaymentFromReceivable(rec),
title: 'Mark Payment Received'
}, 'Mark Payment'),
React.createElement('button', {
onClick: () => deleteReceivable(rec.id),
className: 'text-red-600 hover:text-red-800 font-medium',
title: 'Delete Receivable'
}, 'üóëÔ∏è Delete')
)
)
);
}) : React.createElement('tr', null,
React.createElement('td', { 
colSpan: 6, 
className: 'px-4 py-8 text-center text-gray-500' 
}, 'No receivables found')
)
)
)
)
);
};



// UPDATED PAYABLES TABLE FUNCTION - REPLACE YOUR EXISTING renderPayablesTab FUNCTION
const renderPayablesTab = (payables) => {
return React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-700' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Due Date'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Supplier'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Invoice #'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Amount'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Status'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Actions')
)
),
React.createElement('tbody', { className: 'divide-y divide-gray-200 dark:divide-gray-700' },
financialData.payables && financialData.payables.length > 0 ? financialData.payables.map(pay =>
React.createElement('tr', { key: pay.id },
React.createElement('td', { className: 'px-4 py-3 text-sm' }, 
new Date(pay.dueDate).toLocaleDateString()
),
React.createElement('td', { className: 'px-4 py-3 text-sm' }, 
React.createElement('div', { className: 'flex items-center' },
React.createElement('span', { className: 'text-sm text-gray-900' }, pay.supplierName),
pay.inventoryId && React.createElement('span', {
className: 'ml-2 px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full font-medium',
title: `Linked to inventory item: ${pay.inventoryId}`
}, 'üì¶ Inventory')
)
),
React.createElement('td', { className: 'px-4 py-3 text-sm' }, pay.invoiceNumber),
React.createElement('td', { className: 'px-4 py-3 text-sm font-medium' }, 
'‚Çπ' + (pay.amount?.toLocaleString() || '0')
),
React.createElement('td', { className: 'px-4 py-3' },
React.createElement('span', {
className: `px-2 py-1 text-xs rounded ${
pay.status === 'paid' ? 'bg-green-100 text-green-800' :
pay.status === 'scheduled' ? 'bg-blue-100 text-blue-800' :
'bg-yellow-100 text-yellow-800'
}`
}, pay.status?.charAt(0).toUpperCase() + pay.status?.slice(1) || 'Pending')
),
// UPDATED ACTIONS COLUMN WITH DELETE BUTTON
React.createElement('td', { className: 'px-4 py-3' },
React.createElement('div', { className: 'flex space-x-2' },
pay.status !== 'paid' ? React.createElement('button', {
onClick: () => handleMarkAsPaid(pay.id),
className: `px-3 py-1 rounded text-sm font-medium transition-colors ${
pay.inventoryId 
? 'bg-blue-100 text-blue-700 hover:bg-blue-200 border border-blue-300' 
: 'bg-green-100 text-green-700 hover:bg-green-200 border border-green-300'
}`,
title: pay.inventoryId ? 'Edit payment details in inventory' : 'Mark as paid directly'
}, 
pay.inventoryId ? '‚úèÔ∏è Edit Payment' : '‚úÖ Mark as Paid'
) : React.createElement('span', { 
className: 'text-gray-500 text-sm' 
}, 'Paid'),
React.createElement('button', {
onClick: () => deletePayable(pay.id),
className: 'text-red-600 hover:text-red-800 font-medium',
title: 'Delete Payable'
}, 'üóëÔ∏è Delete')
)
)
)
) : React.createElement('tr', null,
React.createElement('td', { 
colSpan: 6, 
className: 'px-4 py-8 text-center text-gray-500' 
}, 'No payables found')
)
)
)
);
};



// ADD these components where you have your other component definitions:

const ReminderCard = (reminder, isOverdue) => {
const lead = leads.find(l => l.id === reminder.lead_id);

return React.createElement('div', {
key: reminder.id,
className: `border rounded-lg p-4 ${isOverdue ? 'border-red-300 bg-red-50 dark:bg-red-900/20' : 'border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800'}`
},
React.createElement('div', {
className: 'flex items-start justify-between'
},
React.createElement('div', {
className: 'flex-1'
},
React.createElement('div', {
className: 'flex items-center space-x-3 mb-2'
},
React.createElement('span', {
className: `px-2 py-1 rounded text-xs font-medium ${getPriorityColor(reminder.priority)}`
}, reminder.priority.toUpperCase()),
React.createElement('span', {
className: `text-sm ${isOverdue ? 'text-red-600 font-semibold' : 'text-gray-600 dark:text-gray-400'}`
}, formatRelativeTime(reminder.due_date)),
reminder.auto_generated && React.createElement('span', {
className: 'px-2 py-1 bg-purple-100 text-purple-600 rounded text-xs'
}, 'Auto')
),
React.createElement('h4', {
className: 'font-semibold text-gray-900 dark:text-white mb-1'
}, reminder.title),
React.createElement('p', {
className: 'text-sm text-gray-600 dark:text-gray-400 mb-2'
}, reminder.description),
lead && React.createElement('div', {
className: 'text-sm text-blue-600 dark:text-blue-400'
}, `üë§ ${lead.name} - ${lead.phone} - ${lead.lead_for_event || 'General'}`)
),
React.createElement('div', {
className: 'flex space-x-2'
},
React.createElement('button', {
onClick: () => completeReminder(reminder.id, 'Completed from dashboard'),
className: 'px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700'
}, '‚úì Complete'),
React.createElement('button', {
onClick: () => snoozeReminder(reminder.id, 24),
className: 'px-3 py-1 bg-yellow-600 text-white rounded text-sm hover:bg-yellow-700'
}, '‚è∞ Snooze'),
lead && React.createElement('button', {
onClick: () => {
setCurrentLead(lead);
setShowEditForm(true);
setShowReminderDashboard(false);
},
className: 'px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700'
}, 'üë§ View Lead')
)
)
);
};



const ReminderDashboard = () => {
if (!showReminderDashboard) return null;

const pendingReminders = reminders.filter(r => r.status === 'pending');
const overdueReminders = pendingReminders.filter(r => new Date(r.due_date) < new Date());
const todayReminders = pendingReminders.filter(r => {
const today = new Date();
const reminderDate = new Date(r.due_date);
return reminderDate.toDateString() === today.toDateString();
});

return React.createElement('div', {
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50'
},
React.createElement('div', {
className: 'bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-6xl h-5/6 flex flex-col'
},
// Header
React.createElement('div', {
className: 'flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700'
},
React.createElement('h2', {
className: 'text-2xl font-bold text-gray-900 dark:text-white flex items-center'
},
React.createElement('span', { className: 'mr-3' }, 'üîî'),
'Smart Follow-up Reminders'
),
React.createElement('button', {
onClick: () => setShowReminderDashboard(false),
className: 'text-gray-400 hover:text-gray-600 text-2xl'
}, '√ó')
),

// Stats Cards
React.createElement('div', {
className: 'grid grid-cols-4 gap-4 p-6 bg-gray-50 dark:bg-gray-900'
},
React.createElement('div', {
className: 'bg-white dark:bg-gray-800 rounded-lg p-4 text-center shadow'
},
React.createElement('div', {
className: 'text-2xl font-bold text-blue-600'
}, reminderStats.total),
React.createElement('div', {
className: 'text-sm text-gray-600 dark:text-gray-400'
}, 'Total Reminders')
),
React.createElement('div', {
className: 'bg-white dark:bg-gray-800 rounded-lg p-4 text-center shadow'
},
React.createElement('div', {
className: 'text-2xl font-bold text-red-600'
}, reminderStats.overdue),
React.createElement('div', {
className: 'text-sm text-gray-600 dark:text-gray-400'
}, 'Overdue')
),
React.createElement('div', {
className: 'bg-white dark:bg-gray-800 rounded-lg p-4 text-center shadow'
},
React.createElement('div', {
className: 'text-2xl font-bold text-orange-600'
}, reminderStats.due_today),
React.createElement('div', {
className: 'text-sm text-gray-600 dark:text-gray-400'
}, 'Due Today')
),
React.createElement('div', {
className: 'bg-white dark:bg-gray-800 rounded-lg p-4 text-center shadow'
},
React.createElement('div', {
className: 'text-2xl font-bold text-green-600'
}, reminderStats.pending),
React.createElement('div', {
className: 'text-sm text-gray-600 dark:text-gray-400'
}, 'Pending')
)
),

// Reminders List
React.createElement('div', {
className: 'flex-1 overflow-auto p-6'
},
// Overdue Section
overdueReminders.length > 0 && React.createElement('div', {
className: 'mb-8'
},
React.createElement('h3', {
className: 'text-lg font-semibold text-red-600 mb-4 flex items-center'
},
React.createElement('span', { className: 'mr-2' }, 'üö®'),
`Overdue (${overdueReminders.length})`
),
React.createElement('div', {
className: 'space-y-3'
},
overdueReminders.map(reminder => 
ReminderCard(reminder, true)
)
)
),

// Due Today Section
todayReminders.length > 0 && React.createElement('div', {
className: 'mb-8'
},
React.createElement('h3', {
className: 'text-lg font-semibold text-orange-600 mb-4 flex items-center'
},
React.createElement('span', { className: 'mr-2' }, '‚è∞'),
`Due Today (${todayReminders.length})`
),
React.createElement('div', {
className: 'space-y-3'
},
todayReminders.map(reminder => 
ReminderCard(reminder, false)
)
)
),

// All Pending Reminders
React.createElement('div', null,
React.createElement('h3', {
className: 'text-lg font-semibold text-gray-700 dark:text-gray-300 mb-4 flex items-center'
},
React.createElement('span', { className: 'mr-2' }, 'üìã'),
`All Pending (${pendingReminders.length})`
),
React.createElement('div', {
className: 'space-y-3'
},
pendingReminders.map(reminder => 
ReminderCard(reminder, new Date(reminder.due_date) < new Date())
)
)
)
)
)
);
};



const renderExpiringTab = (expiring) => {
return React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-700' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Product'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Batch #'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Expiry Date'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Days Until Expiry'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Quantity'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Value'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Actions')
)
),
React.createElement('tbody', { className: 'divide-y divide-gray-200 dark:divide-gray-700' },
expiring.length > 0 ? expiring.map(item => {
const daysUntilExpiry = Math.floor((new Date(item.expiryDate) - new Date()) / (1000 * 60 * 60 * 24));
return React.createElement('tr', { key: item.id },
React.createElement('td', { className: 'px-4 py-3 text-sm' }, item.productName),
React.createElement('td', { className: 'px-4 py-3 text-sm' }, item.batchNumber),
React.createElement('td', { className: 'px-4 py-3 text-sm' }, 
new Date(item.expiryDate).toLocaleDateString()
),
React.createElement('td', { className: 'px-4 py-3' },
React.createElement('span', {
className: `px-2 py-1 text-xs rounded ${
daysUntilExpiry < 30 ? 'bg-red-100 text-red-800' :
daysUntilExpiry < 90 ? 'bg-yellow-100 text-yellow-800' :
'bg-green-100 text-green-800'
}`
}, (daysUntilExpiry) + ' days')
),
React.createElement('td', { className: 'px-4 py-3 text-sm' }, item.quantity),
React.createElement('td', { className: 'px-4 py-3 text-sm font-medium' }, 
'‚Çπ' + ((item.quantity * item.price).toLocaleString())
),
React.createElement('td', { className: 'px-4 py-3' },
React.createElement('button', {
className: 'text-blue-600 hover:text-blue-800 text-sm'
}, 'Create Offer')
)
);
}) : React.createElement('tr', null,
React.createElement('td', { 
colSpan: 7, 
className: 'px-4 py-8 text-center text-gray-500' 
}, 'No expiring inventory found')
)
)
)
);
};








// User Form Modal

const renderUserForm = () => {
if (!showUserForm) return null;

return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
onClick: (e) => e.target === e.currentTarget && closeUserForm()
},
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-lg' },
React.createElement('div', { className: 'flex justify-between items-center mb-6' },
React.createElement('h2', { className: 'text-xl font-bold text-gray-900 dark:text-white' }, 
currentUser ? 'Edit User' : 'Add New User'
),
React.createElement('button', {
onClick: () => closeUserForm(),
className: 'text-gray-400 hover:text-gray-600 text-2xl'
}, '‚úï')
),
React.createElement('form', { onSubmit: handleUserSubmit },
React.createElement('div', { className: 'space-y-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Full Name *'),
React.createElement('input', {
type: 'text',
value: userFormData.name || '',
onChange: (e) => handleUserInputChange('name', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true
})
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Email *'),
React.createElement('input', {
type: 'email',
value: userFormData.email || '',
onChange: (e) => handleUserInputChange('email', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true
})
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
currentUser ? 'Password (leave blank to keep current)' : 'Password *'
),
React.createElement('input', {
type: 'password',
autoComplete: 'current-password',
value: userFormData.password || '',
onChange: (e) => handleUserInputChange('password', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: !currentUser
})
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Role *'),
React.createElement('select', {
value: userFormData.role || 'viewer',
onChange: (e) => handleUserInputChange('role', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true
},
roles.map(role =>
React.createElement('option', { key: role.name, value: role.name }, role.label)
)
)
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Department'),
React.createElement('select', {
value: userFormData.department || '',
onChange: (e) => handleUserInputChange('department', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500'
},
React.createElement('option', { value: '' }, 'Select Department'),
['Administration', 'Sales', 'Supply Chain', 'Finance', 'Marketing', 'Operations'].map(dept =>
React.createElement('option', { key: dept, value: dept }, dept)
)
)
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Status *'),
React.createElement('select', {
value: userFormData.status || 'active',
onChange: (e) => handleUserInputChange('status', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true
},
React.createElement('option', { value: 'active' }, 'Active'),
React.createElement('option', { value: 'inactive' }, 'Inactive'),
React.createElement('option', { value: 'suspended' }, 'Suspended')
)
)
),
React.createElement('div', { className: 'flex space-x-4 mt-6 pt-4 border-t' },
React.createElement('button', {
type: 'button',
onClick: () => closeUserForm(),
className: 'flex-1 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50'
}, 'Cancel'),
React.createElement('button', {
type: 'submit',
disabled: loading,
className: 'flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50'
}, loading ? 'Saving...' : (currentUser ? 'Update User' : 'Create User'))
)
)
)
);
};



// [Rest of the component code remains the same, but with permission checks added to buttons and actions]
// [I'll include the key rendering functions with permission checks integrated]

const renderChoiceModal = () => {
if (!showChoiceModal) return null;

return React.createElement('div', { 
className: 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50' 
},
React.createElement('div', { 
className: 'bg-white rounded-lg p-6 w-full max-w-md' 
},
React.createElement('h3', { 
className: 'text-lg font-medium text-gray-900 mb-4' 
}, 'Choose Next Step for: ' + (currentLeadForChoice?.name || '')),

React.createElement('div', { className: 'space-y-2' },
choiceOptions.map((option, index) =>
React.createElement('button', {
key: index,
onClick: () => handleChoiceSelection(option),
disabled: loading,
className: `w-full p-3 text-left border border-gray-300 rounded-lg hover:bg-gray-50 focus:ring-2 focus:ring-blue-500 disabled:opacity-50 ${
option.requires_followup_date ? 'border-indigo-300 bg-indigo-50' : ''
}`
},
React.createElement('div', { className: 'flex items-center justify-between' },
React.createElement('span', { className: 'flex items-center' },
React.createElement('span', { className: 'text-lg mr-2' }, option.icon || 'üìù'),
React.createElement('span', { className: 'font-medium' }, option.label)
),
option.requires_followup_date && 
React.createElement('span', { 
className: 'text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded' 
}, 'Requires Follow-up Date')
)
)
)
),

React.createElement('div', { className: 'mt-6 flex justify-end' },
React.createElement('button', {
onClick: () => setShowChoiceModal(false),
className: 'px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50'
}, 'Cancel')
)
)
);
};



// ===== COMMUNICATION COMPONENTS - INSERT THIS BLOCK =====
// Insert this BEFORE the line "const renderSidebar = () => {"

// Communication Timeline Component
const CommunicationTimeline = ({ leadId, leadName }) => {
const [communications, setCommunications] = React.useState([]);
const [loading, setLoading] = React.useState(false);
const [showAddForm, setShowAddForm] = React.useState(false);

const fetchCommunications = async () => {
if (!leadId) return;

try {
setLoading(true);
const response = await apiCall(`/communications/lead/${leadId}`);
setCommunications(response.data || []);
} catch (error) {
console.error('Error fetching communications:', error);
} finally {
setLoading(false);
}
};



React.useEffect(() => {
fetchCommunications();
}, [leadId]);

const addCommunication = async (commData) => {
try {
const response = await apiCall('/communications', {
method: 'POST',
body: JSON.stringify({
...commData,
lead_id: leadId
})
});

if (response.data) {
setCommunications(prev => [response.data, ...prev]);
setShowAddForm(false);
alert('Communication logged successfully!');
}
} catch (error) {
console.error('Error adding communication:', error);
alert('Failed to log communication: ' + error.message);
}
};



const getCommIcon = (type) => {
const icons = {
call: 'üìû',
email: 'üìß', 
whatsapp: 'üí¨',
meeting: 'ü§ù',
sms: 'üì±',
system: 'ü§ñ'
};


return icons[type] || 'üìù';
};



const getOutcomeColor = (outcome) => {
const colors = {
interested: 'bg-green-100 text-green-800',
not_interested: 'bg-red-100 text-red-800',
follow_up: 'bg-yellow-100 text-yellow-800',
closed: 'bg-gray-100 text-gray-800'
};


return colors[outcome] || 'bg-blue-100 text-blue-800';
};



return React.createElement('div', { className: 'bg-white rounded-lg shadow-sm border mt-6' },
React.createElement('div', { className: 'p-4 border-b flex justify-between items-center' },
React.createElement('h3', { className: 'text-lg font-semibold flex items-center gap-2' },
React.createElement('span', null, 'üìû'),
`Communication Timeline (${communications.length})`
),
React.createElement('button', {
onClick: () => setShowAddForm(true),
className: 'px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700'
}, '+ Add Communication')
),

showAddForm && React.createElement('div', { className: 'p-4 bg-gray-50 border-b' },
React.createElement(CommunicationForm, {
onSubmit: addCommunication,
onCancel: () => setShowAddForm(false)
})
),

React.createElement('div', { className: 'p-4' },
loading ? React.createElement('div', { className: 'text-center py-8' }, 'Loading communications...') :
communications.length === 0 ? React.createElement('div', { className: 'text-center py-8 text-gray-500' },
'No communications yet. Click "Add Communication" to start tracking interactions.'
) :
React.createElement('div', { className: 'space-y-4' },
communications.map((comm, index) => 
React.createElement('div', { 
key: comm.id,
className: 'flex gap-4 p-3 border-l-4 border-blue-200 bg-gray-50 rounded-r'
},
React.createElement('div', { className: 'flex-shrink-0' },
React.createElement('div', { className: 'w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-lg' },
getCommIcon(comm.communication_type)
)
),

React.createElement('div', { className: 'flex-1' },
React.createElement('div', { className: 'flex items-start justify-between' },
React.createElement('div', null,
React.createElement('h4', { className: 'font-medium text-gray-900' }, comm.subject || `${comm.communication_type} ${comm.direction}`),
React.createElement('p', { className: 'text-sm text-gray-600 mt-1' }, comm.content)
),
React.createElement('div', { className: 'text-xs text-gray-500 text-right' },
React.createElement('div', null, new Date(comm.created_date).toLocaleDateString()),
React.createElement('div', null, new Date(comm.created_date).toLocaleTimeString())
)
),

React.createElement('div', { className: 'flex gap-2 mt-2 flex-wrap' },
comm.duration_minutes && React.createElement('span', { className: 'px-2 py-1 bg-gray-200 text-xs rounded' }, 
`${comm.duration_minutes} min`
),
comm.outcome && React.createElement('span', { className: `px-2 py-1 text-xs rounded ${getOutcomeColor(comm.outcome)}` }, 
comm.outcome.replace('_', ' ')
),
comm.temperature && comm.temperature !== 'warm' && React.createElement('span', { 
className: `px-2 py-1 text-xs rounded ${comm.temperature === 'hot' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`
}, comm.temperature),
comm.is_auto_logged && React.createElement('span', { className: 'px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded' }, 'Auto-logged')
),

React.createElement('div', { className: 'text-xs text-gray-500 mt-1' },
`by ${comm.created_by_name || comm.created_by}`
)
)
)
)
)
)
);
};



// COMPLETE FIXED AssignmentRulesManager component
// ULTRA-FIXED: AssignmentRulesManager with multiple safeguards against infinite re-renders
// COMPLETELY FIXED AssignmentRulesManager - No more infinite re-renders
const AssignmentRulesManager = React.memo(({ currentUser }) => {
  // Simple state without complex initialization tracking
  const [rules, setRules] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showForm, setShowForm] = useState(false);
  const [editingRule, setEditingRule] = useState(null);
  const [testingRule, setTestingRule] = useState(false);
  const [availableUsers, setAvailableUsers] = useState([]);
  const [isRunningAssignment, setIsRunningAssignment] = useState(false);
  const [assignmentResults, setAssignmentResults] = useState(null);
  const [showResults, setShowResults] = useState(false);

  const [ruleFormData, setRuleFormData] = useState({
    name: '',
    description: '',
    priority: 1,
    conditions: {
      potential_value: '',
      potential_value_operator: 'gte',
      business_type: '',
      lead_source: ''
    },
    assignment_strategy: 'weighted_round_robin',
    assignees: [],
    is_active: true
  });

  // Simple refs without complex state management
  const mounted = useRef(true);
  const loadingInProgress = useRef(false);

  // Simple load functions without useCallback (causing issues)
  const loadRules = async () => {
    if (loadingInProgress.current || !mounted.current) return;
    
    try {
      loadingInProgress.current = true;
      const response = await apiCall('/assignment-rules');
      if (mounted.current) {
        setRules(response.data || []);
      }
    } catch (error) {
      console.error('Error loading assignment rules:', error);
      if (mounted.current) {
        alert('Error loading assignment rules: ' + error.message);
      }
    } finally {
      loadingInProgress.current = false;
      if (mounted.current) {
        setLoading(false);
      }
    }
  };

  const loadAvailableUsers = async () => {
    try {
      // Use existing users data if available
      if (window.users && window.users.length > 0) {
        if (mounted.current) {
          setAvailableUsers(window.users);
        }
      } else {
        const response = await apiCall('/users');
        if (mounted.current) {
          setAvailableUsers(response.data || []);
        }
      }
    } catch (error) {
      console.error('Error loading users:', error);
      // Don't show alert for users loading - not critical
    }
  };

  // Single initialization effect - ONLY runs once
  useEffect(() => {
    let isMounted = true;
    
    const initialize = async () => {
      if (!isMounted) return;
      
      setLoading(true);
      await loadRules();
      await loadAvailableUsers();
      
      // Make refresh function globally accessible
      if (isMounted) {
        window.refreshAssignmentRules = loadRules;
      }
    };

    initialize();

    // Cleanup function
    return () => {
      isMounted = false;
      mounted.current = false;
      if (window.refreshAssignmentRules) {
        delete window.refreshAssignmentRules;
      }
    };
  }, []); // CRITICAL: Empty dependency array, runs only once

  // Helper functions
  const resetForm = () => {
    setRuleFormData({
      name: '',
      description: '',
      priority: 1,
      conditions: {
        potential_value: '',
        potential_value_operator: 'gte',
        business_type: '',
        lead_source: ''
      },
      assignment_strategy: 'weighted_round_robin',
      assignees: [],
      is_active: true
    });
    setEditingRule(null);
    setShowForm(false);
  };

  const editRule = (rule) => {
    setRuleFormData(rule);
    setEditingRule(rule);
    setShowForm(true);
  };

  const toggleRule = async (ruleId, currentStatus) => {
    try {
      await apiCall(`/assignment-rules/${ruleId}`, {
        method: 'PUT',
        body: JSON.stringify({ is_active: !currentStatus })
      });
      await loadRules(); // Refresh rules after toggle
    } catch (error) {
      alert('Error updating rule: ' + error.message);
    }
  };

  const deleteRule = async (ruleId) => {
    if (!confirm('Are you sure you want to delete this assignment rule?')) return;

    try {
      await apiCall(`/assignment-rules/${ruleId}`, { 
        method: 'DELETE' 
      });
      await loadRules(); // Refresh rules after delete
    } catch (error) {
      alert('Error deleting rule: ' + error.message);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    try {
      const ruleData = {
        ...ruleFormData,
        conditions: buildConditions(ruleFormData.conditions),
        created_by: currentUser?.email
      };

      if (editingRule) {
        await apiCall(`/assignment-rules/${editingRule.id}`, {
          method: 'PUT',
          body: JSON.stringify(ruleData)
        });
      } else {
        await apiCall('/assignment-rules', {
          method: 'POST',
          body: JSON.stringify(ruleData)
        });
      }

      resetForm();
      await loadRules(); // Refresh rules after save
    } catch (error) {
      console.error('Error saving rule:', error);
      alert('Error saving rule: ' + error.message);
    }
  };

  const buildConditions = (formConditions) => {
    const conditions = {};

    if (formConditions.potential_value) {
      conditions.potential_value = {};
      conditions.potential_value[formConditions.potential_value_operator] = 
        parseInt(formConditions.potential_value);
    }

    if (formConditions.business_type) {
      conditions.business_type = { eq: formConditions.business_type };
    }

    if (formConditions.lead_source) {
      conditions.source = { eq: formConditions.lead_source };
    }

    return conditions;
  };

  const formatConditions = (conditions) => {
    if (!conditions) return 'None';
    
    const formatted = [];
    
    if (conditions.potential_value) {
      const operator = Object.keys(conditions.potential_value)[0];
      const value = conditions.potential_value[operator];
      const opText = operator === 'gte' ? '>=' : operator === 'lte' ? '<=' : operator;
      formatted.push(`Value ${opText} ‚Çπ${value.toLocaleString()}`);
    }
    
    if (conditions.business_type) {
      formatted.push(`Business: ${conditions.business_type.eq}`);
    }
    
    if (conditions.source) {
      formatted.push(`Source: ${conditions.source.eq}`);
    }
    
    return formatted.length > 0 ? formatted.join(', ') : 'None';
  };

  const testRule = async () => {
    try {
      setTestingRule(true);
      const response = await apiCall('/assignment-rules/test', {
        method: 'POST'
      });
      
      if (response.success) {
        alert(`Test Results:\n\nTotal Leads: ${response.totalLeads}\nMatched Leads: ${response.matchedLeads}\nAssignment Preview: ${response.assignmentPreview.join(', ')}`);
      } else {
        alert('Test failed: ' + response.message);
      }
    } catch (error) {
      console.error('Error testing rules:', error);
      alert('Error testing rules: ' + error.message);
    } finally {
      setTestingRule(false);
    }
  };

  const runAssignment = async () => {
    if (!confirm('This will run automatic assignment for all unassigned leads. Continue?')) {
      return;
    }

    try {
      setIsRunningAssignment(true);
      setAssignmentResults(null);

      const response = await apiCall('/assignment-rules/run-assignment', {
        method: 'POST'
      });

      if (response.success) {
        setAssignmentResults(response);
        setShowResults(true);

        // Refresh data
        await loadRules();

        alert(`Assignment Complete!\n\nProcessed: ${response.processedCount} leads\nAssigned: ${response.assignedCount} leads\nUnassigned: ${response.unassignedCount} leads`);
      } else {
        alert('Assignment failed: ' + response.message);
      }
    } catch (error) {
      console.error('Error running assignment:', error);
      alert('Error running assignment: ' + error.message);
    } finally {
      setIsRunningAssignment(false);
    }
  };

  // Simple loading state
  if (loading) {
    return React.createElement('div', { className: 'flex flex-col items-center justify-center py-16' },
      React.createElement('div', { className: 'animate-spin w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full' }),
      React.createElement('p', { className: 'mt-4 text-gray-600' }, 'Loading assignment rules...')
    );
  }

  return React.createElement('div', { className: 'space-y-6' },
    // Header with buttons
    React.createElement('div', { className: 'flex justify-between items-center' },
      React.createElement('h1', { className: 'text-3xl font-bold text-gray-900 dark:text-white' }, 'Assignment Rules Manager'),
      React.createElement('div', { className: 'flex space-x-3' },
        React.createElement('button', {
          onClick: () => {
            setLoading(true);
            loadRules();
          },
          className: 'bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700'
        }, 'üîÑ Refresh'),
        React.createElement('button', {
          onClick: runAssignment,
          disabled: isRunningAssignment || rules.filter(r => r.is_active).length === 0,
          className: 'bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg disabled:opacity-50 flex items-center gap-2'
        }, 
          isRunningAssignment ? 
          React.createElement('span', null, '‚è≥ Running...') :
          React.createElement('span', null, 'üöÄ Run Assignment')
        ),
        React.createElement('button', {
          onClick: testRule,
          disabled: testingRule,
          className: 'bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 disabled:bg-gray-400'
        }, testingRule ? 'Testing...' : 'üß™ Test Rules'),
        React.createElement('button', {
          onClick: () => setShowForm(true),
          className: 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700'
        }, '+ Add New Rule')
      )
    ),

    // Stats
    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4' },
      React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow p-4' },
        React.createElement('div', { className: 'text-2xl font-bold text-blue-600' }, rules.length),
        React.createElement('div', { className: 'text-sm text-gray-600' }, 'Total Rules')
      ),
      React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow p-4' },
        React.createElement('div', { className: 'text-2xl font-bold text-green-600' }, rules.filter(r => r.is_active).length),
        React.createElement('div', { className: 'text-sm text-gray-600' }, 'Active Rules')
      ),
      React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow p-4' },
        React.createElement('div', { className: 'text-2xl font-bold text-orange-600' }, 
          rules.reduce((sum, r) => sum + (r.assignees?.length || 0), 0)
        ),
        React.createElement('div', { className: 'text-sm text-gray-600' }, 'Total Assignees')
      )
    ),

    // Rules List
    React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow' },
      React.createElement('div', { className: 'px-6 py-4 border-b border-gray-200 dark:border-gray-700' },
        React.createElement('h2', { className: 'text-lg font-semibold text-gray-900 dark:text-white' }, 'Assignment Rules')
      ),
      React.createElement('div', { className: 'divide-y divide-gray-200 dark:divide-gray-700' },
        rules.length === 0 ? 
        React.createElement('div', { className: 'p-8 text-center text-gray-500' },
          React.createElement('div', { className: 'text-4xl mb-2' }, '‚öôÔ∏è'),
          React.createElement('p', { className: 'mb-4' }, 'No assignment rules configured'),
          React.createElement('button', {
            onClick: () => setShowForm(true),
            className: 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700'
          }, 'Create First Rule')
        ) :
        rules.map(rule => 
          React.createElement('div', { 
            key: rule.id, 
            className: 'p-6 hover:bg-gray-50 dark:hover:bg-gray-700' 
          },
            React.createElement('div', { className: 'flex items-start justify-between' },
              React.createElement('div', { className: 'flex-1' },
                React.createElement('div', { className: 'flex items-center space-x-3 mb-2' },
                  React.createElement('h3', { className: 'text-lg font-medium text-gray-900 dark:text-white' }, rule.name),
                  React.createElement('span', { 
                    className: `px-2 py-1 rounded-full text-xs font-medium ${
                      rule.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                    }` 
                  }, rule.is_active ? 'Active' : 'Inactive'),
                  React.createElement('span', { 
                    className: 'px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium' 
                  }, `Priority: ${rule.priority}`)
                ),
                React.createElement('p', { className: 'text-gray-600 dark:text-gray-400 mb-3' }, rule.description),
                React.createElement('div', { className: 'text-sm text-gray-500 space-y-1' },
                  React.createElement('div', null, `Conditions: ${formatConditions(rule.conditions)}`),
                  React.createElement('div', null, `Strategy: ${rule.assignment_strategy}`),
                  React.createElement('div', null, `Assignees: ${rule.assignees?.length || 0}`)
                )
              ),
              React.createElement('div', { className: 'flex items-center space-x-2' },
                React.createElement('button', {
                  onClick: () => toggleRule(rule.id, rule.is_active),
                  className: `px-3 py-1 rounded text-sm font-medium ${
                    rule.is_active 
                      ? 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200' 
                      : 'bg-green-100 text-green-800 hover:bg-green-200'
                  }`
                }, rule.is_active ? 'Disable' : 'Enable'),
                React.createElement('button', {
                  onClick: () => editRule(rule),
                  className: 'px-3 py-1 bg-blue-100 text-blue-800 rounded text-sm font-medium hover:bg-blue-200'
                }, 'Edit'),
                React.createElement('button', {
                  onClick: () => deleteRule(rule.id),
                  className: 'px-3 py-1 bg-red-100 text-red-800 rounded text-sm font-medium hover:bg-red-200'
                }, 'Delete')
              )
            )
          )
        )
      )
    ),

    // Form Modal (simplified)
    showForm && React.createElement('div', { 
      className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4',
      onClick: resetForm
    },
      React.createElement('div', { 
        className: 'bg-white dark:bg-gray-800 rounded-lg max-w-4xl w-full p-6 max-h-screen overflow-y-auto',
        onClick: (e) => e.stopPropagation()
      },
        React.createElement('div', { className: 'flex justify-between items-center mb-6' },
          React.createElement('h2', { className: 'text-2xl font-bold text-gray-900 dark:text-white' }, 
            editingRule ? 'Edit Assignment Rule' : 'Create Assignment Rule'
          ),
          React.createElement('button', {
            onClick: resetForm,
            className: 'text-gray-500 hover:text-gray-700 text-2xl'
          }, '‚úï')
        ),

        React.createElement('form', { onSubmit: handleSubmit, className: 'space-y-6' },
          // Basic Info
          React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
            React.createElement('div', null,
              React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Rule Name *'),
              React.createElement('input', {
                type: 'text',
                value: ruleFormData.name,
                onChange: (e) => setRuleFormData({...ruleFormData, name: e.target.value}),
                className: 'w-full p-2 border border-gray-300 rounded text-sm',
                required: true
              })
            ),
            React.createElement('div', null,
              React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Priority'),
              React.createElement('input', {
                type: 'number',
                value: ruleFormData.priority,
                onChange: (e) => setRuleFormData({...ruleFormData, priority: parseInt(e.target.value)}),
                className: 'w-full p-2 border border-gray-300 rounded text-sm',
                min: 1
              })
            )
          ),

          // Description
          React.createElement('div', null,
            React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Description'),
            React.createElement('textarea', {
              value: ruleFormData.description,
              onChange: (e) => setRuleFormData({...ruleFormData, description: e.target.value}),
              className: 'w-full p-2 border border-gray-300 rounded text-sm',
              rows: 3
            })
          ),

          // Form Actions
          React.createElement('div', { className: 'flex justify-end space-x-3 pt-6 border-t' },
            React.createElement('button', {
              type: 'button',
              onClick: resetForm,
              className: 'px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50'
            }, 'Cancel'),
            React.createElement('button', {
              type: 'submit',
              className: 'px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700'
            }, editingRule ? 'Update Rule' : 'Create Rule')
          )
        )
      )
    )
  );
});

// Set display name for debugging
AssignmentRulesManager.displayName = 'AssignmentRulesManager';

// ULTRA-FIX: Add display name for debugging
AssignmentRulesManager.displayName = 'AssignmentRulesManager';

const refreshAssignmentRules = async () => {
try {
// This will clear any cached assignment data and reload fresh rules
await apiCall('/assignment-rules/refresh', 'POST');
} catch (error) {
console.log('Assignment rules refresh failed (non-critical):', error);
// Non-critical - rules will still work
}
}; 

// Communication Form Component
const CommunicationForm = ({ onSubmit, onCancel }) => {
const [formData, setFormData] = React.useState({
communication_type: 'call',
direction: 'outbound',
subject: '',
content: '',
duration_minutes: '',
outcome: '',
temperature: 'warm'
});

const handleSubmit = (e) => {
e.preventDefault();
if (!formData.subject && !formData.content) {
alert('Please provide a subject or content');
return;
}

onSubmit({
...formData,
duration_minutes: formData.duration_minutes ? parseInt(formData.duration_minutes) : null
});
};



return React.createElement('form', { onSubmit: handleSubmit, className: 'space-y-4' },
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Type'),
React.createElement('select', {
value: formData.communication_type,
onChange: (e) => setFormData(prev => ({ ...prev, communication_type: e.target.value })),
className: 'w-full p-2 border border-gray-300 rounded text-sm'
},
React.createElement('option', { value: 'call' }, 'üìû Phone Call'),
React.createElement('option', { value: 'email' }, 'üìß Email'),
React.createElement('option', { value: 'whatsapp' }, 'üí¨ WhatsApp'),
React.createElement('option', { value: 'meeting' }, 'ü§ù Meeting')
)
),

React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Direction'),
React.createElement('select', {
value: formData.direction,
onChange: (e) => setFormData(prev => ({ ...prev, direction: e.target.value })),
className: 'w-full p-2 border border-gray-300 rounded text-sm'
},
React.createElement('option', { value: 'outbound' }, 'üì§ Outbound'),
React.createElement('option', { value: 'inbound' }, 'üì• Inbound')
)
)
),

React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Subject'),
React.createElement('input', {
type: 'text',
value: formData.subject,
onChange: (e) => setFormData(prev => ({ ...prev, subject: e.target.value })),
className: 'w-full p-2 border border-gray-300 rounded text-sm',
placeholder: 'Brief summary...'
})
),

React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Details'),
React.createElement('textarea', {
value: formData.content,
onChange: (e) => setFormData(prev => ({ ...prev, content: e.target.value })),
className: 'w-full p-2 border border-gray-300 rounded text-sm',
rows: 3,
placeholder: 'Detailed notes...'
})
),

React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Outcome'),
React.createElement('select', {
value: formData.outcome,
onChange: (e) => setFormData(prev => ({ ...prev, outcome: e.target.value })),
className: 'w-full p-2 border border-gray-300 rounded text-sm'
},
React.createElement('option', { value: '' }, 'Select outcome...'),
React.createElement('option', { value: 'interested' }, '‚úÖ Interested'),
React.createElement('option', { value: 'not_interested' }, '‚ùå Not Interested'),
React.createElement('option', { value: 'follow_up' }, 'üîÑ Follow Up Required')
)
),

formData.communication_type === 'call' && React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Duration (min)'),
React.createElement('input', {
type: 'number',
value: formData.duration_minutes,
onChange: (e) => setFormData(prev => ({ ...prev, duration_minutes: e.target.value })),
className: 'w-full p-2 border border-gray-300 rounded text-sm',
placeholder: '15'
})
),

React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Temperature'),
React.createElement('select', {
value: formData.temperature,
onChange: (e) => setFormData(prev => ({ ...prev, temperature: e.target.value })),
className: 'w-full p-2 border border-gray-300 rounded text-sm'
},
React.createElement('option', { value: 'hot' }, 'üî• Hot'),
React.createElement('option', { value: 'warm' }, 'üå°Ô∏è Warm'),
React.createElement('option', { value: 'cold' }, '‚ùÑÔ∏è Cold')
)
)
),

React.createElement('div', { className: 'flex gap-2 justify-end' },
React.createElement('button', {
type: 'button',
onClick: onCancel,
className: 'px-4 py-2 text-gray-600 hover:text-gray-800'
}, 'Cancel'),
React.createElement('button', {
type: 'submit',
className: 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700'
}, 'Log Communication')
)
);
};



// ===== END OF COMMUNICATION COMPONENTS =====

// Enhanced sidebar with user access control
const renderSidebar = () => {
const menuItems = [
{ id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
{ id: 'leads', label: 'Leads', icon: 'üë•' },
{ id: 'inventory', label: 'Inventory', icon: 'üé´' },
{ id: 'orders', label: 'Orders', icon: 'üìã' },
{ id: 'delivery', label: 'Delivery', icon: 'üöö' },
{ id: 'finance', label: 'Financials', icon: 'üí∞' },
{ id: 'stadiums', label: 'Stadiums', icon: 'üèüÔ∏è' },
{ id: 'sports-calendar', label: 'Sports Calendar', icon: 'üìÖ' }, // ADD THIS LINE
{ id: 'reminders', label: 'Reminders', icon: 'üîî' },
{ id: 'myactions', label: 'My Actions', icon: 'üìå' },
{ id: 'assignment-rules', label: 'Assignment Rules', icon: '‚öôÔ∏è' }

];

return React.createElement('div', { className: 'w-64 bg-white shadow-lg' },
React.createElement('div', { className: 'p-4' },
React.createElement('div', { className: 'flex items-center space-x-3' },
React.createElement('div', { className: 'w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center' },
React.createElement('span', { className: 'text-white' }, 'üèÜ')
),
React.createElement('h2', { className: 'text-xl font-bold text-gray-900 dark:text-white' }, 'FanToPark CRM')
),
user && React.createElement('div', { className: 'mt-4 p-3 bg-blue-50 rounded-lg' },
React.createElement('div', { className: 'text-sm font-medium text-blue-900' }, user.name),
React.createElement('div', { className: 'text-xs text-blue-600' }, USER_ROLES[user.role]?.label || user.role),
React.createElement('div', { className: 'text-xs text-blue-500' }, user.department)
)
),
React.createElement('nav', { className: 'mt-8' },
menuItems.filter(item => canAccessTab(item.id)).map(item =>
React.createElement('button', {
key: item.id,
onClick: () => setActiveTab(item.id),
className: 'w-full flex items-center px-4 py-3 text-left hover:bg-gray-50 ' + (activeTab === item.id ? 'bg-blue-50 border-r-2 border-blue-600 text-blue-600' : 'text-gray-700')
},
React.createElement('span', { className: 'mr-3' }, item.icon),
item.label
)
),
// User Management - only for users with permission
hasPermission('users', 'read') && React.createElement('button', {
onClick: openUserManagement,
className: 'w-full flex items-center px-4 py-3 text-left hover:bg-gray-50 text-gray-700'
},
React.createElement('span', { className: 'mr-3' }, 'üë§'),
'User Management'
),
// Role Management - only for super admin
user && user.role === 'super_admin' && React.createElement('button', {
onClick: () => setActiveTab('roles'),
className: 'w-full flex items-center px-4 py-3 text-left hover:bg-gray-50 text-gray-700'
},
React.createElement('span', { className: 'mr-3' }, 'üõ°Ô∏è'),
'Role Management'
)
),
React.createElement('div', { className: 'mt-auto p-4' },
React.createElement('button', {
onClick: handleLogout,
className: 'w-full flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded overflow-hidden'
},
React.createElement('span', { className: 'mr-3' }, 'üö™'),
'Logout'
)
)
);
};



const renderDashboardContent = () => {
return React.createElement('div', { className: 'space-y-6' },
// Filters for pie charts (removed duplicate welcome header)
React.createElement('div', { className: 'bg-white p-4 rounded-lg shadow mb-6' },
React.createElement('div', { className: 'flex items-center space-x-4' },
React.createElement('label', { className: 'font-medium' }, 'View by:'),
React.createElement('select', {
className: 'px-3 py-2 border rounded-md',
value: dashboardFilter,
onChange: (e) => {
setDashboardFilter(e.target.value);
setSelectedSalesPerson('');
setSelectedEvent('');
}
},
React.createElement('option', { value: 'overall' }, 'Overall'),
React.createElement('option', { value: 'salesPerson' }, 'Sales Person'),
React.createElement('option', { value: 'event' }, 'Event')
),

dashboardFilter === 'salesPerson' && React.createElement('select', {
className: 'px-3 py-2 border rounded-md',
value: selectedSalesPerson,
onChange: (e) => setSelectedSalesPerson(e.target.value)
},
React.createElement('option', { value: '' }, 'Select Sales Person'),
salesPeople.map(sp => 
React.createElement('option', { key: sp.id, value: sp.email }, sp.name)
)
),

dashboardFilter === 'event' && React.createElement('select', {
className: 'px-3 py-2 border rounded-md',
value: selectedEvent,
onChange: (e) => setSelectedEvent(e.target.value)
},
React.createElement('option', { value: '' }, 'Select Event'),
events.map(event => 
React.createElement('option', { key: event, value: event }, event)
)
)
)
),

// Pie Charts Section - Top Half with FIXED HEIGHT
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-6 mb-8' },
React.createElement('div', { className: 'bg-white p-6 rounded-lg shadow' },
React.createElement('h3', { className: 'text-lg font-medium mb-4' }, 'Lead Split'),
React.createElement('div', { style: { height: '200px', position: 'relative' } },
React.createElement('canvas', { id: 'leadSplitChart' })
)
),
React.createElement('div', { className: 'bg-white p-6 rounded-lg shadow' },
React.createElement('h3', { className: 'text-lg font-medium mb-4' }, 'Lead Temperature (Count)'),
React.createElement('div', { style: { height: '200px', position: 'relative' } },
React.createElement('canvas', { id: 'tempCountChart' })
)
),
React.createElement('div', { className: 'bg-white p-6 rounded-lg shadow' },
React.createElement('h3', { className: 'text-lg font-medium mb-4' }, 'Lead Temperature (Value)'),
React.createElement('div', { style: { height: '200px', position: 'relative' } },
React.createElement('canvas', { id: 'tempValueChart' })
)
)
),

// Recent Leads and Quick Actions - Bottom Half
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },
// Recent Leads
React.createElement('div', { className: 'bg-white rounded-lg shadow border p-6' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-4' }, 'Recent Leads'),
React.createElement('div', { className: 'space-y-4' },
leads.slice(0, 5).length > 0 ? 
leads.slice(0, 5).map(lead => 
React.createElement('div', { 
key: lead.id, 
className: 'flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 cursor-pointer',
onClick: () => {
setCurrentLead(lead);
setShowLeadDetail(true);
}
},
React.createElement('div', null,
React.createElement('p', { className: 'font-medium' }, lead.name),
React.createElement('p', { className: 'text-sm text-gray-600' }, 
`${lead.source || 'No source'} ‚Ä¢ ‚Çπ${lead.potential_value || 0}`
),
lead.assigned_to && React.createElement('p', { 
className: 'text-xs text-gray-500' 
}, `Assigned to: ${getUserDisplayName(lead.assigned_to, users)}`)
),
React.createElement('span', { 
className: 'px-2 py-1 text-xs rounded ' + 
(lead.status === 'qualified' ? 'bg-green-100 text-green-800' :
lead.status === 'hot' ? 'bg-red-100 text-red-800' :
lead.status === 'warm' ? 'bg-yellow-100 text-yellow-800' :
lead.status === 'cold' ? 'bg-blue-100 text-blue-800' :
'bg-gray-100 text-gray-800')
}, lead.status?.charAt(0).toUpperCase() + lead.status?.slice(1) || 'Unknown')
)
) : 
React.createElement('p', { className: 'text-gray-500 text-center py-8' }, 'No leads found')
)
),

// Quick Actions
// Quick Actions
React.createElement('div', { className: 'bg-white rounded-lg shadow border p-6' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-4' }, 'Quick Actions'),
React.createElement('div', { className: 'space-y-3' },
hasPermission('leads', 'write') && React.createElement('button', {
onClick: () => openAddForm('lead'),
className: 'w-full flex items-center px-4 py-3 text-blue-600 border border-blue-600 rounded-lg hover:bg-blue-50 transition-colors'
},
React.createElement('span', { className: 'mr-3' }, '+'),
'Add New Lead'
),

hasPermission('inventory', 'write') && React.createElement('button', {
onClick: openAddInventoryForm,
className: 'w-full flex items-center px-4 py-3 text-purple-600 border border-purple-600 rounded-lg hover:bg-purple-50 transition-colors'
},
React.createElement('span', { className: 'mr-3' }, '+'),
'Add Event to Inventory'
)
)
)
)
);
};




// I'll continue with the rest of the rendering functions but with permission checks integrated
// For brevity, I'm including the main structure. The full implementation would include all the original functions
// with permission checks added throughout.


const renderMyActionsContent = () => {

const totalOverdueAmount = myReceivables.reduce((sum, rec) => sum + (rec.amount || 0), 0);
const hasActions = myLeads.length > 0 || myOrders.length > 0 || myDeliveries.length > 0;

return React.createElement('div', { className: 'space-y-6' },
React.createElement('div', { className: 'flex justify-between items-center' },
React.createElement('h1', { className: 'text-3xl font-bold text-gray-900 dark:text-white' }, 'My Actions'),
React.createElement('button', {
onClick: fetchMyActions,
className: 'text-blue-600 hover:text-blue-700 flex items-center gap-2'
}, 
React.createElement('span', null, '‚Üª'),
'Refresh'
)
),

// Overdue Receivables Alert
myReceivables.length > 0 && React.createElement('div', { 
className: 'bg-red-50 border-2 border-red-200 rounded-lg p-4 animate-pulse' 
},
React.createElement('div', { className: 'flex items-center justify-between' },
React.createElement('div', { className: 'flex items-center' },
React.createElement('span', { className: 'text-2xl mr-3' }, '‚ö†Ô∏è'),
React.createElement('div', null,
React.createElement('h3', { className: 'text-lg font-semibold text-red-800' }, 
(myReceivables.length) + ' Overdue Receivables'
),
React.createElement('p', { className: 'text-red-600' }, 
'Total Amount Due: ‚Çπ' + (totalOverdueAmount.toLocaleString())
)
)
),
React.createElement('button', {
onClick: () => setActiveTab('finance'),
className: 'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700'
}, 'View Receivables')
)
),

// User Info
React.createElement('div', { className: 'bg-gray-50 dark:bg-gray-900 rounded-lg p-4' },
React.createElement('p', { className: 'text-sm text-gray-600 dark:text-gray-400' }, 
'Logged in as: ' + (user?.name) + ' (' + (user?.email) + ') - ' + (user?.role?.replace(/_/g, ' ').toUpperCase())
)
),

loading ? React.createElement('div', { className: 'text-center py-8' }, 'Loading...') :
!hasActions ? React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow p-8 text-center' },
React.createElement('p', { className: 'text-gray-500 text-lg' }, 'No pending actions at the moment.'),
React.createElement('p', { className: 'text-gray-400 mt-2' }, 'Actions will appear here when:'),
React.createElement('ul', { className: 'mt-4 text-sm text-gray-600 space-y-1' },
React.createElement('li', null, '‚Ä¢ Leads are assigned to you'),
React.createElement('li', null, '‚Ä¢ Orders need your approval (Finance)'),
React.createElement('li', null, '‚Ä¢ Orders need delivery (Supply)'),
React.createElement('li', null, '‚Ä¢ Deliveries are assigned to you')
)
) : React.createElement('div', { className: 'space-y-6' },

// My Leads Section
myLeads.length > 0 && React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow' },
React.createElement('div', { className: 'p-4 border-b' },
React.createElement('h2', { className: 'text-xl font-semibold flex items-center gap-2' },
React.createElement('span', { className: 'text-blue-600' }, 'üìã'),
'My Leads (' + (myLeads.length) + ')'
)
),
React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-900' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Contact'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Company'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Event'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Status'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Actions')
)
),
React.createElement('tbody', { className: 'divide-y divide-gray-200' },
myLeads.map(lead => {
const status = LEAD_STATUSES[lead.status] || { label: lead.status, color: 'bg-gray-100 text-gray-800' };
return React.createElement('tr', { key: lead.id, className: 'hover:bg-gray-50' },
React.createElement('td', { className: 'px-4 py-3' },
React.createElement('div', null,
React.createElement('div', { className: 'font-medium text-gray-900' }, lead.name),
React.createElement('div', { className: 'text-sm text-gray-500' }, lead.email)
)
),
React.createElement('td', { className: 'px-4 py-3 text-sm' }, lead.company || '-'),
React.createElement('td', { className: 'px-4 py-3 text-sm' }, lead.lead_for_event || '-'),
React.createElement('td', { className: 'px-4 py-3' },
React.createElement('span', { 
className: 'px-2 py-1 text-xs rounded-full ' + (status.color)
}, status.label)
),
React.createElement('td', { className: 'px-4 py-3' },
React.createElement('button', {
onClick: () => viewLeadDetails(lead),
className: 'text-blue-600 hover:text-blue-800 text-sm'
}, 'View Details')
)
);
})
)
)
)
),

// My Orders Section  
myOrders.length > 0 && React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow' },
React.createElement('div', { className: 'p-4 border-b' },
React.createElement('h2', { className: 'text-xl font-semibold flex items-center gap-2' },
React.createElement('span', { className: 'text-green-600' }, 'üì¶'),
'My Orders (' + (myOrders.length) + ')'
)
),
React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-900' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Order ID'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Customer'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Event'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Amount'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Status'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Actions')
)
),
React.createElement('tbody', { className: 'divide-y divide-gray-200' },
myOrders.map(order => 
React.createElement('tr', { key: order.id, className: 'hover:bg-gray-50' },
React.createElement('td', { className: 'px-4 py-3 font-medium' }, '#' + (order.id)),
React.createElement('td', { className: 'px-4 py-3' },
React.createElement('div', null,
React.createElement('div', { className: 'font-medium' }, order.customer_name),
React.createElement('div', { className: 'text-sm text-gray-500' }, order.customer_email)
)
),
React.createElement('td', { className: 'px-4 py-3 text-sm' }, order.event_name || '-'),
React.createElement('td', { className: 'px-4 py-3 font-medium' }, '‚Çπ' + ((order.total_amount || 0).toLocaleString())),
React.createElement('td', { className: 'px-4 py-3' },
React.createElement('span', { 
className: `px-2 py-1 text-xs rounded-full ${
order.status === 'pending_approval' ? 'bg-yellow-100 text-yellow-800' :
order.status === 'approved' ? 'bg-green-100 text-green-800' :
'bg-gray-100 text-gray-800'
}`
}, order.status.replace(/_/g, ' ').toUpperCase())
),
React.createElement('td', { className: 'px-4 py-3' },
user.role === 'finance_manager' && order.status === 'pending_approval' ?
React.createElement('button', {
onClick: () => approveOrder(order.id),
className: 'bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700'
}, 'Approve') :
React.createElement('button', {
onClick: () => viewOrderDetails(order),
className: 'text-blue-600 hover:text-blue-800 text-sm'
}, 'View Details')
)
)
)
)
)
)
),
// Add this new section after the existing "My Leads" section
(user.role === 'supply_manager' || user.role === 'supply_sales_service_manager') && 
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow mb-6' },
React.createElement('div', { className: 'p-6' },
React.createElement('div', { className: 'flex items-center justify-between mb-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 dark:text-white flex items-center' },
React.createElement('span', { className: 'text-purple-500 mr-2' }, 'üìã'),
'My Quote Requested (',
myQuoteRequested.length,
')'
)
),
myQuoteRequested.length === 0 ? 
React.createElement('p', { className: 'text-gray-500 dark:text-gray-400 text-center py-8' }, 
'No quote requests assigned to you'
) :
React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'min-w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-700' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider' }, 'Lead'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider' }, 'Company'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider' }, 'Temperature'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider' }, 'Value'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider' }, 'Original Assignee'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider' }, 'Quote Date'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider' }, 'Actions')
)
),
React.createElement('tbody', { className: 'bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700' },
myQuoteRequested.map(lead => 
React.createElement('tr', { key: lead.id, className: 'hover:bg-gray-50 dark:hover:bg-gray-700' },
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', null,
React.createElement('div', { className: 'text-sm font-medium text-gray-900 dark:text-white' }, lead.name),
React.createElement('div', { className: 'text-sm text-gray-500 dark:text-gray-400' }, lead.email)
)
),
React.createElement('td', { className: 'px-6 py-4 text-sm text-gray-900 dark:text-white' }, lead.company || '-'),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('span', { 
className: `px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
getDisplayTemperature(lead) === 'hot' ? 'bg-red-100 text-red-800' :
getDisplayTemperature(lead) === 'warm' ? 'bg-orange-100 text-orange-800' :
getDisplayTemperature(lead) === 'cold' ? 'bg-blue-100 text-blue-800' :
'bg-gray-100 text-gray-800'
}`
}, 
getDisplayTemperature(lead)?.toUpperCase() || 'N/A'
)
),
React.createElement('td', { className: 'px-6 py-4 text-sm text-gray-900 dark:text-white' }, 
lead.potential_value ? '‚Çπ' + lead.potential_value.toLocaleString() : '-'
),
React.createElement('td', { className: 'px-6 py-4 text-sm text-gray-900 dark:text-white' }, 
getUserDisplayName(lead.assigned_to, users)
),
React.createElement('td', { className: 'px-6 py-4 text-sm text-gray-500 dark:text-gray-400' }, 
lead.quote_requested_date ? new Date(lead.quote_requested_date).toLocaleDateString() : '-'
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'flex space-x-2' },
React.createElement('button', {
onClick: () => {
setCurrentLead(lead);
setShowLeadDetail(true);
},
className: 'text-blue-600 hover:text-blue-800 text-sm'
}, 'View Details'),
React.createElement('button', {
onClick: () => handleLeadProgression(lead),
className: 'text-purple-600 hover:text-purple-800 text-sm'
}, 'Progress')
)
)
)
)
)
)
)
)
),

// My Deliveries Section
myDeliveries.length > 0 && React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow' },
React.createElement('div', { className: 'p-4 border-b' },
React.createElement('h2', { className: 'text-xl font-semibold flex items-center gap-2' },
React.createElement('span', { className: 'text-purple-600' }, 'üöö'),
'My Deliveries (' + (myDeliveries.length) + ')'
)
),
React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-900' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Delivery ID'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Order ID'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Customer'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Delivery Date'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Status'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Actions')
)
),
React.createElement('tbody', { className: 'divide-y divide-gray-200' },
myDeliveries.map(delivery => 
React.createElement('tr', { key: delivery.id, className: 'hover:bg-gray-50' },
React.createElement('td', { className: 'px-4 py-3 font-medium' }, '#' + (delivery.id)),
React.createElement('td', { className: 'px-4 py-3' }, '#' + (delivery.order_id)),
React.createElement('td', { className: 'px-4 py-3 text-sm' }, delivery.customer_name || '-'),
React.createElement('td', { className: 'px-4 py-3 text-sm' }, 
delivery.scheduled_date ? new Date(delivery.scheduled_date).toLocaleDateString() : '-'
),
React.createElement('td', { className: 'px-4 py-3' },
React.createElement('span', { 
className: `px-2 py-1 text-xs rounded-full ${
delivery.status === 'delivered' ? 'bg-green-100 text-green-800' :
delivery.status === 'in_transit' ? 'bg-blue-100 text-blue-800' :
'bg-yellow-100 text-yellow-800'
}`
}, delivery.status.replace(/_/g, ' ').toUpperCase())
),
React.createElement('td', { className: 'px-4 py-3' },
React.createElement('button', {
onClick: () => updateDeliveryStatus(delivery.id),
className: 'text-blue-600 hover:text-blue-800 text-sm'
}, 'Update Status')
)
)
)
)
)
)
)
)
);
};



const updateDeliveryStatus = (deliveryId) => {
// Implement delivery status update
alert('Delivery status update coming soon!');
};



const approveOrder = async (orderId) => {
if (confirm('Are you sure you want to approve this order?')) {
try {
await apiCall('/orders/' + (orderId), {
method: 'PUT',
body: JSON.stringify({ status: 'approved' })
});
alert('Order approved successfully!');
fetchMyActions();
} catch (error) {
alert('Failed to approve order: ' + error.message);
}
}
};



const viewOrderDetails = (order) => {
setCurrentOrderDetail(order);
setShowOrderDetail(true);
};



const viewLeadDetails = (lead) => {
setCurrentLead(lead);
setShowLeadDetail(true);
};

// FIXED: Add this BEFORE the renderContent function to create a stable AssignmentRulesTab
const AssignmentRulesTab = React.useMemo(() => {
  return hasPermission('leads', 'assign') ? 
    React.createElement(AssignmentRulesManager, { 
      key: 'assignment-rules-stable',
      currentUser: user 
    }) :
    React.createElement('div', { className: 'text-center py-12' },
      React.createElement('p', { className: 'text-red-500 text-lg' }, 
        'Access Denied: You do not have permission to manage assignment rules.'
      )
    );
}, [user]); // Only recreate when user changes

const renderContent = () => {
  if (loading && activeTab !== 'leads') {
    return React.createElement('div', { className: 'flex items-center justify-center h-64' },
      React.createElement('div', { className: 'text-gray-500' }, 'Loading...')
    );
  }

  // Handle individual tabs with original logic preserved
  switch (activeTab) {
    case 'dashboard':
      return renderDashboardContent();

    case 'leads':
      return hasPermission('leads', 'read') ? renderLeadsContent() : 
        React.createElement('div', { className: 'text-center py-12' },
          React.createElement('p', { className: 'text-red-500 text-lg' }, 
            'Access Denied: You do not have permission to view leads.'
          )
        );

    case 'inventory':
      return hasPermission('inventory', 'read') ? renderInventoryContent() : 
        React.createElement('div', { className: 'text-center py-12' },
          React.createElement('p', { className: 'text-red-500 text-lg' }, 
            'Access Denied: You do not have permission to view inventory.'
          )
        );

    case 'orders':
      return hasPermission('orders', 'read') ? renderOrdersContent() : 
        React.createElement('div', { className: 'text-center py-12' },
          React.createElement('p', { className: 'text-red-500 text-lg' }, 
            'Access Denied: You do not have permission to view orders.'
          )
        );

    case 'finance':
      return hasPermission('finance', 'read') ? renderFinancials() : 
        React.createElement('div', { className: 'text-center py-12' },
          React.createElement('p', { className: 'text-red-500 text-lg' }, 
            'Access Denied: You do not have permission to view financials.'
          )
        );

    case 'assignment-rules':
      // FIXED: Return the stable memoized component
      return AssignmentRulesTab;

    case 'delivery':
      return hasPermission('delivery', 'read') ? renderDeliveryContent() : 
        React.createElement('div', { className: 'text-center py-12' },
          React.createElement('p', { className: 'text-red-500 text-lg' }, 
            'Access Denied: You do not have permission to view delivery.'
          )
        );

    case 'users':
      return hasPermission('users', 'read') ? renderUserManagement() : 
        React.createElement('div', { className: 'text-center py-12' },
          React.createElement('p', { className: 'text-red-500 text-lg' }, 
            'Access Denied: You do not have permission to view users.'
          )
        );

    case 'stadiums':
      return hasPermission('stadiums', 'read') ? renderStadiumsContent() : 
        React.createElement('div', { className: 'text-center py-12' },
          React.createElement('p', { className: 'text-red-500 text-lg' }, 'Access Denied: You do not have permission to view stadiums.')
        );

    case 'reminders':
      return hasPermission('leads', 'read') ? renderRemindersContent() : 
        React.createElement('div', { className: 'text-center py-12' },
          React.createElement('p', { className: 'text-red-500 text-lg' }, 
            'Access Denied: You do not have permission to view reminders.'
          )
        );

    case 'myactions':
      return renderMyActionsContent();

    case 'sports-calendar':
      return renderSportsCalendarContent();

    case 'roles':
      // PRESERVED: Your complete existing roles logic
      if (user?.role === 'super_admin' && !rolesInitialized) {
        setRolesInitialized(true);
        apiCall('/roles').then(response => {
          setRoles(response.data || []);
        }).catch(error => {
          console.error('Failed to fetch roles:', error);
          setRolesInitialized(false); // Allow retry on error
        });
      }

      return user?.role === 'super_admin' ? React.createElement('div', { className: 'space-y-6' },
        React.createElement('div', { className: 'flex justify-between items-center' },
          React.createElement('h1', { className: 'text-3xl font-bold text-gray-900 dark:text-white' }, 'Role Management'),
          React.createElement('button', {
            onClick: () => {
              setShowRoleForm(true);
              setEditingRole(null);
              roleFormData = {
                name: '',
                label: '',
                description: '',
                permissions: {
                  dashboard: { read: false, write: false, delete: false, manage_users: false },
                  leads: { read: false, write: false, delete: false, assign: false, progress: false },
                  inventory: { read: false, write: false, delete: false, allocate: false },
                  orders: { read: false, write: false, delete: false, approve: false, assign: false },
                  finance: { read: false, write: false, delete: false, approve: false },
                  delivery: { read: false, write: false, delete: false },
                  users: { read: false, write: false, delete: false, manage_roles: false }
                }
              };
            },
            className: 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700'
          }, '+ Add New Role')
        ),

        // Show initialize button if no roles
        roles.length === 0 && React.createElement('div', { className: 'bg-yellow-50 border border-yellow-200 rounded-lg p-4' },
          React.createElement('p', { className: 'text-yellow-800' }, 'No roles found. Initialize default roles to get started.'),
          React.createElement('button', {
            onClick: async () => {
              try {
                const response = await apiCall('/roles/initialize', { method: 'POST', body: JSON.stringify({}) });
                console.log('Default roles initialized successfully');
                setRoles(response.data || []);
              } catch (error) {
                console.error('Failed to initialize roles:', error);
                console.log('Failed to initialize default roles');
              }
            },
            className: 'mt-2 bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700'
          }, 'Initialize Default Roles')
        ),

        // Display roles
        React.createElement('div', { className: 'grid gap-4' },
          roles.map(role => React.createElement('div', {
            key: role.id,
            className: 'bg-white dark:bg-gray-800 rounded-lg shadow p-6'
          },
            React.createElement('div', { className: 'flex justify-between items-start' },
              React.createElement('div', null,
                React.createElement('h3', { className: 'text-xl font-semibold text-gray-900 dark:text-white' }, 
                  role.label,
                  role.is_system && React.createElement('span', { 
                    className: 'ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded' 
                  }, 'System')
                ),
                React.createElement('p', { className: 'text-sm text-gray-500 dark:text-gray-400' }, 'Name: ' + (role.name)),
                React.createElement('p', { className: 'text-gray-600 dark:text-gray-300 mt-1' }, role.description),
                React.createElement('p', { className: 'text-xs text-gray-500 mt-2' }, 'Users with this role: ' + (role.user_count || 0))
              ),
              React.createElement('div', { className: 'flex gap-2' },
                !role.is_system && React.createElement('button', {
                  onClick: () => {
                    setEditingRole(role);
                    setRoleFormData(JSON.parse(JSON.stringify(role)));
                    setShowRoleForm(true);
                  },
                  className: 'text-blue-600 hover:text-blue-800'
                }, 'Edit'),
                !role.is_system && React.createElement('button', {
                  onClick: async () => {
                    if (!confirm('Are you sure you want to delete this role?')) return;
                    try {
                      await apiCall('/roles/' + (role.id), { method: 'DELETE' });
                      alert('Role deleted successfully!');
                      roles = roles.filter(r => r._id !== role.id);
                    } catch (error) {
                      console.error('Error deleting role:', error);
                      alert('Error: ' + (error.message || 'Failed to delete role'));
                    }
                  },
                  className: 'text-red-600 hover:text-red-800'
                }, 'Delete')
              )
            ),
            // Permission display
            React.createElement('div', { className: 'mt-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4' },
              Object.entries(role.permissions || {}).map(([module, perms]) =>
                React.createElement('div', { key: module, className: 'text-sm' },
                  React.createElement('div', { className: 'font-medium text-gray-700 dark:text-gray-300 capitalize' }, module),
                  React.createElement('div', { className: 'text-xs text-gray-500 dark:text-gray-400' },
                    Object.entries(perms)
                      .filter(([_, value]) => value === true)
                      .map(([perm, _]) => perm)
                      .join(', ') || 'No permissions'
                  )
                )
              )
            )
          ))
        ),

        // Role Form Modal
        showRoleForm && React.createElement('div', {
          className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
          onClick: (e) => {
            if (e.target === e.currentTarget) {
              setShowRoleForm(false);
              setActiveTab('roles');
            }
          }
        },
          React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl max-h-[90vh] overflow-y-auto' },
            React.createElement('h2', { className: 'text-2xl font-bold mb-4' }, 
              editingRole ? 'Edit Role' : 'Create New Role'
            ),
            React.createElement('form', { 
              onSubmit: async (e) => {
                e.preventDefault();
                try {
                  if (editingRole) {
                    await apiCall('/roles/' + (editingRole.id), { method: 'PUT', body: JSON.stringify(roleFormData) });
                    console.log('Role updated successfully');
                  } else {
                    await apiCall('/roles', { method: 'POST', body: JSON.stringify(roleFormData) });
                    console.log('Role created successfully');
                  }

                  // Refresh roles
                  const response = await apiCall('/roles');
                  setRoles(response.data || []);
                  setShowRoleForm(false);
                  setEditingRole(null);

                } catch (error) {
                  console.error('Error saving role:', error);
                  showNotification(error.message || 'Failed to save role', 'error');
                }
              }
            },
              React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-6' },
                React.createElement('div', null,
                  React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Role Name'),
                  React.createElement('input', {
                    type: 'text',
                    value: roleFormData.name,
                    onChange: (e) => {
                      setRoleFormData(prev => ({
                        ...prev,
                        name: e.target.value
                      }));
                    },
                    className: 'w-full border rounded px-3 py-2',
                    required: true,
                    disabled: editingRole?.is_system
                  })
                ),
                React.createElement('div', null,
                  React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Display Label'),
                  React.createElement('input', {
                    type: 'text',
                    value: roleFormData.label,
                    onChange: (e) => {
                      setRoleFormData(prev => ({
                        ...prev,
                        label: e.target.value
                      }));
                    },
                    className: 'w-full border rounded px-3 py-2',
                    required: true
                  })
                ),
                React.createElement('div', { className: 'md:col-span-2' },
                  React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Description'),
                  React.createElement('textarea', {
                    value: roleFormData.description,
                    onChange: (e) => {
                      setRoleFormData(prev => ({
                        ...prev,
                        description: e.target.value
                      }));
                    },
                    className: 'w-full border rounded px-3 py-2',
                    rows: 2
                  })
                )
              ),
              // Permissions section
              React.createElement('div', { className: 'mb-6' },
                React.createElement('h3', { className: 'text-lg font-semibold mb-4' }, 'Permissions'),
                React.createElement('div', { className: 'space-y-4' },
                  Object.entries(roleFormData.permissions).map(([module, perms]) =>
                    React.createElement('div', { key: module, className: 'border rounded-lg p-4' },
                      React.createElement('h4', { className: 'font-medium capitalize mb-2' }, module),
                      React.createElement('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4' },
                        Object.entries(perms).map(([perm, value]) =>
                          React.createElement('label', {
                            key: perm,
                            className: 'flex items-center space-x-2'
                          },
                            React.createElement('input', {
                              type: 'checkbox',
                              checked: value,
                              onChange: (e) => {
                                setRoleFormData(prev => ({
                                  ...prev,
                                  permissions: {
                                    ...prev.permissions,
                                    [module]: {
                                      ...prev.permissions[module],
                                      [perm]: e.target.checked
                                    }
                                  }
                                }));
                              },
                              disabled: editingRole?.is_system && module === 'users' && perm === 'manage_roles'
                            }),
                            React.createElement('span', { className: 'text-sm capitalize' }, 
                              perm.replace(/_/g, ' ')
                            )
                          )
                        )
                      )
                    )
                  )
                )
              ),
              React.createElement('div', { className: 'flex justify-end gap-2' },
                React.createElement('button', {
                  type: 'button',
                  onClick: () => {
                    setShowRoleForm(false);
                    setEditingRole(null);
                  },
                  className: 'px-4 py-2 border rounded hover:bg-gray-100'
                }, 'Cancel'),
                React.createElement('button', {
                  type: 'submit',
                  className: 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700'
                }, editingRole ? 'Update Role' : 'Create Role')
              )
            )
          )
        )
      ) : 
      React.createElement('div', { className: 'text-center py-12' },
        React.createElement('p', { className: 'text-red-500 text-lg' }, 'Access Denied: Only super admins can manage roles.')
      );

    default:
      return renderDashboardContent();
  }
};



// Login screen
if (!isLoggedIn) {
return React.createElement('div', { className: 'min-h-screen bg-gray-100 flex items-center justify-center'},
React.createElement('div', { className: 'max-w-md w-full bg-white rounded-lg shadow-md p-6' },
React.createElement('div', { className: 'text-center mb-8' },
React.createElement('div', { className: 'w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center mx-auto mb-4' },
React.createElement('span', { className: 'text-white text-xl' }, 'ÔøΩÔøΩ')
),
React.createElement('h2', { className: 'text-2xl font-bold text-gray-900' }, 'FanToPark CRM'),
React.createElement('p', { className: 'text-gray-600' }, 'Sign in to your account')
),
React.createElement('form', { onSubmit: handleLogin },
React.createElement('div', { className: 'mb-4' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Email'),
React.createElement('input', {
type: 'email',
value: email,
onChange: (e) => setEmail(e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true
})
),
React.createElement('div', { className: 'mb-6' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Password'),
React.createElement('input', {
type: 'password',
autoComplete: 'current-password',
value: password,
onChange: (e) => setPassword(e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true
})
),
React.createElement('button', {
type: 'submit',
disabled: loading,
className: 'w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50'
}, loading ? 'Signing in...' : 'Sign In')
),
React.createElement('div', { className: 'mt-6 text-sm text-gray-600' },
React.createElement('p', { className: 'font-medium mb-2' }, 'Demo Accounts:'),
React.createElement('div', { className: 'space-y-1 text-xs' },
React.createElement('p', null, React.createElement('strong', null, 'Super Admin:'), ' admin@fantopark.com / admin123'),
React.createElement('p', null, React.createElement('strong', null, 'Sales Manager:'), ' varun@fantopark.com / sales123'),
React.createElement('p', null, React.createElement('strong', null, 'Sales Executive:'), ' pratik@fantopark.com / sales123'),
React.createElement('p', null, React.createElement('strong', null, 'Supply Manager:'), ' akshay@fantopark.com / supply123'),
React.createElement('p', null, React.createElement('strong', null, 'Finance Manager:'), ' finance@fantopark.com / finance123')
)
)
)
);
}

// [Include all the missing rendering functions with permission checks]

// Form fields remain the same
const leadFormFields = [
{ name: 'name', label: 'Contact Name', type: 'text', required: true, section: 'basic' },
{ name: 'email', label: 'Email', type: 'email', required: true, section: 'basic' },
{ name: 'phone', label: 'Phone', type: 'tel', required: true, section: 'basic' },
{ name: 'company', label: 'Company', type: 'text', section: 'basic' },
{ name: 'business_type', label: 'Business Type', type: 'select', options: ['B2C', 'B2B'], required: true, section: 'basic' },
{ name: 'source', label: 'Source of Lead', type: 'select', options: [
'Facebook', 'Instagram', 'LinkedIn', 'Friends and Family', 'Through Champion', 
'Website', 'Existing Client', 'Contacted on Social Media', 'Middlemen', 
'Wealth Management Firm', 'Media Agency', 'Concierge Desk', 
'Travel Partner', 'Travel OTA'
], required: true, section: 'source' },
{ name: 'date_of_enquiry', label: 'Date of Enquiry', type: 'date', required: true, section: 'source' },
{ name: 'first_touch_base_done_by', label: 'First Touch Base Done By', type: 'text', required: true, section: 'source' },
{ name: 'city_of_residence', label: 'City of Residence', type: 'text', required: true, section: 'location' },
{ name: 'country_of_residence', label: 'Country of Residence', type: 'select', options: [
'India', 'United States', 'United Kingdom', 'Australia', 'Canada', 'Singapore', 
'UAE', 'Saudi Arabia', 'Germany', 'France', 'Italy', 'Spain', 'Netherlands', 
'Switzerland', 'Japan', 'South Korea', 'Other'
], required: true, section: 'location' },
{ name: 'lead_for_event', label: 'Lead for Event', type: 'inventory_select', required: true, section: 'event' },
{ name: 'number_of_people', label: 'Number of People Going', type: 'number', required: true, min: 1, section: 'event' },
{ name: 'has_valid_passport', label: 'Has Valid Passport', type: 'select', options: ['Yes', 'No', 'Not Sure'], section: 'travel' },
{ name: 'visa_available', label: 'Visa Available', type: 'select', options: ['Yes', 'No', 'Not Required', 'In Process'], section: 'travel' },
{ name: 'attended_sporting_event_before', label: 'Attended Sporting Event Before', type: 'select', options: ['Yes', 'No'], required: true, section: 'experience' },
{ name: 'annual_income_bracket', label: 'Annual Income Bracket', type: 'select', options: [
'Below ‚Çπ5 Lakhs', '‚Çπ5-10 Lakhs', '‚Çπ10-25 Lakhs', '‚Çπ25-50 Lakhs', 
'‚Çπ50 Lakhs - ‚Çπ1 Crore', '‚Çπ1-2 Crores', '‚Çπ2-5 Crores', 'Above ‚Çπ5 Crores'
], required: true, section: 'financial' },
{ name: 'status', label: 'Lead Status', type: 'select', options: Object.keys(LEAD_STATUSES), section: 'sales', editOnly: true },
{ name: 'assigned_to', label: 'Assigned To', type: 'select', options: [...(users || []).filter(u => ['sales_executive', 'sales_manager'].includes(u.role)), ...(users || []).filter(u => ['supply_executive', 'supply_sales_service_manager'].includes(u.role))], section: 'sales', editOnly: true},
{ name: 'last_quoted_price', label: 'Last Quoted Price (‚Çπ)', type: 'number', section: 'sales', editOnly: true },
{ name: 'potential_value', label: 'Potential Value (‚Çπ)', type: 'number', section: 'business' },
{ name: 'notes', label: 'Additional Notes', type: 'textarea', section: 'business' }
];

// Enhanced Event Form Fields based on Excel structure
const eventFormFields = [
  // Core Event Information
  { name: 'event_name', label: 'Event Name', type: 'text', required: true, section: 'basic' },
  { name: 'event_type', label: 'Event Type', type: 'select', options: ['Sport', 'Concert', 'Conference', 'Exhibition', 'Other'], required: true, section: 'basic' },
  { name: 'sport_type', label: 'Sport Type', type: 'select', options: ['Cricket', 'Football', 'Tennis', 'Basketball', 'Golf', 'Formula 1', 'Marathon', 'Boxing', 'Wrestling', 'Hockey', 'Badminton', 'Other'], required: true, section: 'basic' },
  { name: 'geography', label: 'Geography/Location', type: 'select', options: ['India', 'UAE - Dubai', 'UAE - Abu Dhabi', 'UK', 'USA', 'Australia', 'South Africa', 'New Zealand', 'Other'], required: true, section: 'basic' },
  
  // Date and Time Information
  { name: 'start_date', label: 'Start Date', type: 'date', required: true, section: 'datetime' },
  { name: 'end_date', label: 'End Date', type: 'date', required: false, section: 'datetime' },
  { name: 'start_time', label: 'Start Time', type: 'time', required: false, section: 'datetime' },
  { name: 'end_time', label: 'End Time', type: 'time', required: false, section: 'datetime' },
  
  // Venue Information
  { name: 'venue', label: 'Venue', type: 'text', required: true, section: 'venue' },
  { name: 'venue_capacity', label: 'Venue Capacity', type: 'number', required: false, section: 'venue' },
  { name: 'venue_address', label: 'Venue Address', type: 'textarea', required: false, section: 'venue' },
  
  // Ticketing Information
  { name: 'official_ticketing_partners', label: 'Official Ticketing Partners', type: 'textarea', required: false, section: 'ticketing' },
  { name: 'primary_source', label: 'Primary Source', type: 'text', required: false, section: 'ticketing' },
  { name: 'secondary_source', label: 'Secondary Source', type: 'text', required: false, section: 'ticketing' },
  { name: 'ticket_available', label: 'Tickets Available for Sale', type: 'checkbox', required: false, section: 'ticketing' },
  
  // Priority and Status
  { name: 'priority', label: 'Priority', type: 'select', options: ['P1', 'P2', 'P3'], required: true, section: 'status' },
  { name: 'status', label: 'Status', type: 'select', options: ['upcoming', 'live', 'completed', 'cancelled', 'postponed'], required: true, section: 'status' },
  { name: 'sold_out_potential', label: 'Sold Out Potential', type: 'select', options: ['High', 'Medium', 'Low', 'No'], required: false, section: 'status' },
  
  // Additional Information
  { name: 'remarks', label: 'Remarks/Description', type: 'textarea', required: false, section: 'additional' },
  { name: 'fantopark_package', label: 'FanToPark Package Details', type: 'textarea', required: false, section: 'additional' }
];  

const inventoryFormFields = [
{ name: 'event_name', label: 'Event Name', type: 'text', required: true },
{ name: 'event_date', label: 'Event Date', type: 'date', required: true },
{ name: 'event_type', label: 'Event Type', type: 'select', options: ['IPL', 'India Cricket + ICC', 'Football', 'Tennis', 'F1', 'Miscellaneous'], required: true },
{ name: 'sports', label: 'Sports Category', type: 'select', options: ['Cricket', 'Football', 'Tennis', 'Formula 1', 'Olympics', 'Basketball', 'Badminton', 'Hockey', 'Golf', 'Wrestling'], required: true },
{ name: 'venue', label: 'Venue', type: 'select', options: 'dynamic', required: true },
{ name: 'day_of_match', label: 'Day of Match (for Test/Multi-day)', type: 'select', options: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Not Applicable'], required: false },
{ name: 'category_of_ticket', label: 'Category of Ticket', type: 'select', options: ['VIP', 'Premium', 'Gold', 'Silver', 'Bronze', 'General', 'Corporate Box', 'Hospitality'], required: true },
{ name: 'stand', label: 'Stand/Section', type: 'text', required: false, placeholder: 'e.g., North Stand, East Pavilion' },
{ name: 'total_tickets', label: 'Total Tickets', type: 'number', required: true },
{ name: 'available_tickets', label: 'Available Tickets', type: 'number', required: true },
{ name: 'mrp_of_ticket', label: 'MRP of Ticket (‚Çπ)', type: 'number', required: true },
{ name: 'buying_price', label: 'Buying Price (‚Çπ)', type: 'number', required: true },
{ name: 'selling_price', label: 'Selling Price (‚Çπ)', type: 'number', required: true },
{ name: 'inclusions', label: 'Inclusions', type: 'textarea', required: false, placeholder: 'e.g., Food, Beverages, Parking, Merchandise, Meet & Greet' },
{ name: 'booking_person', label: 'Booking Person (Who Purchased)', type: 'text', required: true, placeholder: 'Name of person/company who purchased inventory' },
{ name: 'procurement_type', label: 'Procurement Type', type: 'select', options: ['pre_inventory', 'on_demand', 'partnership', 'direct_booking'], required: true },
{ name: 'notes', label: 'Additional Notes', type: 'textarea', required: false, placeholder: 'Any special conditions, restrictions, or notes' },

// Payment Information Fields
{ name: 'paymentStatus', label: 'Payment Status', type: 'select', options: ['paid', 'pending'], required: true },
{ name: 'supplierName', label: 'Supplier Name', type: 'text', required: false },
{ name: 'supplierInvoice', label: 'Supplier Invoice #', type: 'text', required: false },
{ name: 'purchasePrice', label: 'Purchase Price (per ticket)', type: 'number', required: false },
{ name: 'totalPurchaseAmount', label: 'Total Purchase Amount', type: 'number', required: false },
{ name: 'amountPaid', label: 'Amount Paid', type: 'number', required: false },
{ name: 'paymentDueDate', label: 'Payment Due Date', type: 'date', required: false }
];

const orderFormFields = [
{ name: 'client_name', label: 'Client Name', type: 'text', required: true },
{ name: 'client_email', label: 'Client Email', type: 'email', required: true },
{ name: 'client_phone', label: 'Client Phone', type: 'tel', required: true },
{ name: 'event_name', label: 'Event Name', type: 'text', required: true },
{ name: 'event_date', label: 'Event Date', type: 'date', required: true },
{ name: 'tickets_allocated', label: 'Number of Tickets', type: 'number', required: true },
{ name: 'ticket_category', label: 'Ticket Category', type: 'select', options: ['VIP', 'Premium', 'Gold', 'Silver', 'Bronze', 'General'], required: true },
{ name: 'price_per_ticket', label: 'Price per Ticket (‚Çπ)', type: 'number', required: true },
{ name: 'total_amount', label: 'Total Amount (‚Çπ)', type: 'number', required: true },
{ name: 'payment_method', label: 'Payment Method', type: 'select', options: ['Bank Transfer', 'UPI', 'Credit Card', 'Debit Card', 'Cheque', 'Cash'], required: true },
{ name: 'transaction_id', label: 'Transaction ID', type: 'text', required: true },
{ name: 'allocation_notes', label: 'Order Notes', type: 'textarea' }
];

// Enhanced allocation handling with permission check
// Enhanced allocation handling with permission check
const handleAllocation = async (e) => {
e.preventDefault();
if (!hasPermission('inventory', 'allocate')) {
alert('You do not have permission to allocate inventory');
return;
}

setLoading(true);

try {
// FIX: Don't use parseInt for lead ID comparison
const selectedLead = leads.find(lead => lead.id === allocationData.lead_id);

if (!selectedLead) {
throw new Error('Lead not found');
}

// Define the validation function
const isConvertedOrLater = (status) => {
const postConvertedStages = ['converted', 'payment', 'payment_post_service', 'payment_received'];
return postConvertedStages.includes(status);
};



// Use it in the validation
if (!isConvertedOrLater(selectedLead.status)) {
throw new Error('Lead must be in converted status or later to allocate inventory');
}

if (allocationData.tickets_allocated > currentInventory.available_tickets) {
throw new Error('Not enough tickets available');
}

// Call the fixed backend endpoint
const response = await apiCall(`/inventory/${currentInventory.id}/allocate`, {
method: 'POST',
body: JSON.stringify({
lead_id: allocationData.lead_id,
tickets_allocated: parseInt(allocationData.tickets_allocated),
allocation_date: allocationData.allocation_date,
notes: allocationData.notes
})
});

if (response.error) {
throw new Error(response.error);
}

// Update local inventory state
setInventory(prev => 
prev.map(item => 
item.id === currentInventory.id 
? { ...item, available_tickets: response.remaining_tickets }
: item
)
);

// Close the allocation form and show success
setShowAllocationForm(false);
alert('Inventory allocated successfully!');

} catch (error) {
console.error('Allocation error:', error);
alert('Error: ' + error.message);
} finally {
setLoading(false);
}
};



// Function to open allocation management
const openAllocationManagement = async (inventoryItem) => {
try {
setLoading(true);
setAllocationManagementInventory(inventoryItem);

// Fetch allocations for this inventory
const response = await apiCall(`/inventory/${inventoryItem.id}/allocations`);

if (response.error) {
throw new Error(response.error);
}

setCurrentAllocations(response.data.allocations);
setShowAllocationManagement(true);

} catch (error) {
console.error('Error fetching allocations:', error);
alert('Error fetching allocations: ' + error.message);
} finally {
setLoading(false);
}
};



// Function to unallocate tickets
const handleUnallocate = async (allocationId, ticketsToReturn) => {
if (!confirm(`Are you sure you want to unallocate ${ticketsToReturn} tickets?`)) {
return;
}

try {
setLoading(true);

const response = await apiCall(`/inventory/${allocationManagementInventory.id}/allocations/${allocationId}`, {
method: 'DELETE'
});

if (response.error) {
throw new Error(response.error);
}

// Refresh allocations
await openAllocationManagement(allocationManagementInventory);

// Update inventory in main list
setInventory(prev => 
prev.map(item => 
item.id === allocationManagementInventory.id 
? { ...item, available_tickets: response.new_available_tickets }
: item
)
);

alert(`Successfully unallocated ${ticketsToReturn} tickets`);

} catch (error) {
console.error('Error unallocating tickets:', error);
alert('Error unallocating tickets: ' + error.message);
} finally {
setLoading(false);
}
};



// ADD this enhanced order approval function
const handleEnhancedOrderApproval = async (orderId, action, notes = '') => {
if (!hasPermission('orders', 'approve')) {
alert('You do not have permission to approve orders');
return;
}

setLoading(true);

try {
const newStatus = action === 'approve' ? 'approved' : 'rejected';

setOrders(prev => 
prev.map(order => {
if (order.id === orderId) {
const updatedOrder = { 
...order, 
status: newStatus, 
approved_date: new Date().toISOString().split('T')[0],
approval_notes: notes,
approved_by: user.name
};



// Generate GST invoice if approved
if (action === 'approve' && order.requires_gst_invoice) {
const invoiceNumber = 'STTS/INV/' + (new Date().getFullYear()) + '/' + (String(Date.now()).slice(-6));

const newInvoice = {
id: Date.now(),
invoice_number: invoiceNumber,
order_id: orderId,
order_number: order.order_number,
client_name: order.legal_name || order.client_name,
client_email: order.client_email,

// GST Details
gstin: order.gstin,
legal_name: order.legal_name,
category_of_sale: order.category_of_sale,
type_of_sale: order.type_of_sale,
registered_address: order.registered_address,
indian_state: order.indian_state,
is_outside_india: order.is_outside_india,

// Invoice calculation
invoice_items: order.invoice_items,
base_amount: order.base_amount,
gst_calculation: order.gst_calculation,
total_tax: order.total_tax,
final_amount: order.final_amount,

invoice_date: new Date().toISOString().split('T')[0],
due_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
status: 'generated',
generated_by: user.name
};



setInvoices(prev => [...prev, newInvoice]);
updatedOrder.invoice_id = newInvoice.id;
updatedOrder.invoice_number = invoiceNumber;
}

return updatedOrder;
}
return order;
})
);

setLoading(false);
alert(action === 'approve' 
? 'Order approved successfully! GST Invoice has been generated.' 
: 'Order rejected successfully.'
);
} catch (error) {
setLoading(false);
alert('Failed to update order status');
}
};



// ADD this GST invoice preview function
const openInvoicePreview = (invoice) => {
setCurrentInvoice(invoice);
setShowInvoicePreview(true);
};



// Enhanced GST and TCS Calculation Preview Function
const renderEnhancedGSTCalculationPreview = () => {
  // ADD: Calculate invoiceTotal first
  const invoiceTotal = paymentData.invoice_items?.reduce((sum, item) => 
    sum + ((item.quantity || 0) * (item.rate || 0)), 0
  ) || 0;
  
  const baseAmount = getBaseAmount(paymentData);
  const calculation = calculateGSTAndTCS(baseAmount, paymentData);
  const isIntraState = paymentData.indian_state === 'Haryana' && !paymentData.is_outside_india;
  const advanceAmount = parseFloat(paymentData.advance_amount) || 0;
  const isReceivablePayment = paymentData.from_receivable || paymentData.payment_post_service;

  // CALCULATE: Final amount with custom TCS rate
  const finalAmount = baseAmount + calculation.gst.total + 
    (calculation.tcs.applicable ? (baseAmount * (paymentData.tcs_rate || calculation.tcs.rate)) / 100 : 0);

  return React.createElement('div', { className: 'mb-6 p-4 bg-gray-50 rounded-lg' },
    React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-4' }, 
      'üßÆ Enhanced Tax Calculation Preview'
    ),
    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },

      // Left Column - Basic Amounts
      React.createElement('div', { className: 'space-y-3' },
        React.createElement('h4', { className: 'font-medium text-gray-700 border-b pb-2' }, 'Base Amounts'),
        React.createElement('div', { className: 'space-y-2 text-sm' },
          React.createElement('div', { className: 'flex justify-between' },
            React.createElement('span', null, 'Invoice Total:'),
            React.createElement('span', { className: 'font-medium' }, 
              (paymentData.payment_currency || 'INR'), ' ', invoiceTotal.toFixed(2)
            )
          ),
          paymentData.type_of_sale === 'Service Fee' && 
          React.createElement('div', { className: 'flex justify-between border-t pt-2' },
            React.createElement('span', null, 'Service Fee:'),
            React.createElement('span', { className: 'font-medium' }, 
              (paymentData.payment_currency || 'INR'), ' ', (parseFloat(paymentData.service_fee_amount) || 0).toFixed(2)
            )
          ),
          React.createElement('div', { className: 'flex justify-between font-medium border-t pt-2' },
            React.createElement('span', null, 'Taxable Amount:'),
            React.createElement('span', null, 
              (paymentData.payment_currency || 'INR'), ' ', baseAmount.toFixed(2)
            )
          )
        )
      ),

      // Right Column - Tax Breakdown
      React.createElement('div', { className: 'space-y-3' },
        React.createElement('h4', { className: 'font-medium text-gray-700 border-b pb-2' }, 'Tax Breakdown'),
        React.createElement('div', { className: 'space-y-2 text-sm' },

          // GST Section
          calculation.gst.applicable ? [
            isIntraState ? [
              React.createElement('div', { key: 'cgst', className: 'flex justify-between' },
                React.createElement('span', null, `CGST (${calculation.gst.rate/2}%):`),
                React.createElement('span', { className: 'font-medium' }, 
                  (paymentData.payment_currency || 'INR'), ' ', calculation.gst.cgst.toFixed(2)
                )
              ),
              React.createElement('div', { key: 'sgst', className: 'flex justify-between' },
                React.createElement('span', null, `SGST (${calculation.gst.rate/2}%):`),
                React.createElement('span', { className: 'font-medium' }, 
                  (paymentData.payment_currency || 'INR'), ' ', calculation.gst.sgst.toFixed(2)
                )
              )
            ] : React.createElement('div', { key: 'igst', className: 'flex justify-between' },
              React.createElement('span', null, `IGST (${calculation.gst.rate}%):`),
              React.createElement('span', { className: 'font-medium' }, 
                (paymentData.payment_currency || 'INR'), ' ', calculation.gst.igst.toFixed(2)
              )
            )
          ] : React.createElement('div', { key: 'no-gst', className: 'flex justify-between text-gray-500' },
            React.createElement('span', null, 'GST:'),
            React.createElement('span', null, 'Not Applicable')
          ),

          // TCS Section with dynamic rate
          calculation.tcs.applicable ? 
          React.createElement('div', { className: 'flex justify-between text-yellow-700' },
            React.createElement('span', null, `TCS (${paymentData.tcs_rate || calculation.tcs.rate}%):`),
            React.createElement('span', { className: 'font-medium' }, 
              paymentData.payment_currency || 'INR', ' ', 
              ((baseAmount * (paymentData.tcs_rate || calculation.tcs.rate)) / 100).toFixed(2)
            )
          ) : React.createElement('div', { className: 'flex justify-between text-gray-500' },
            React.createElement('span', null, 'TCS:'),
            React.createElement('span', null, 'Not Applicable')
          ),

          // Final Amount with custom TCS rate
          React.createElement('div', { className: 'flex justify-between text-lg font-bold border-t pt-2 mt-2' },
            React.createElement('span', null, 'Final Amount:'),
            React.createElement('span', null, 
              paymentData.payment_currency || 'INR', ' ', finalAmount.toFixed(2)
            )
          ),

          // Payment Information
          !isReceivablePayment && React.createElement('div', { className: 'flex justify-between border-t pt-2' },
            React.createElement('span', { className: 'font-semibold' }, 'Advance Received:'),
            React.createElement('span', { className: 'font-semibold text-blue-600' }, 
              (paymentData.payment_currency || 'INR'), ' ', advanceAmount.toFixed(2)
            )
          ),
          !isReceivablePayment && React.createElement('div', { className: 'flex justify-between' },
            React.createElement('span', { className: 'font-bold' }, 'Balance Due:'),
            React.createElement('span', { className: 'font-bold text-orange-600' }, 
              (paymentData.payment_currency || 'INR'), ' ', (finalAmount - advanceAmount).toFixed(2)
            )
          ),
          isReceivablePayment && React.createElement('div', { className: 'flex justify-between border-t pt-2' },
            React.createElement('span', { className: 'font-bold' }, 'Payment Being Collected:'),
            React.createElement('span', { className: 'font-bold text-green-600' }, 
              (paymentData.payment_currency || 'INR'), ' ', advanceAmount.toFixed(2)
            )
          )
        )
      )
    )
  );
}; 

const renderGSTInvoicePreview = () => {
if (!showInvoicePreview || !currentInvoice) return null;

const invoice = currentInvoice;
const isIntraState = invoice.indian_state === 'Haryana' && !invoice.is_outside_india;

// FIX 1: Calculate baseAmount FIRST before using it anywhere
const baseAmount = getBaseAmount(invoice);

// FIX 2: Use the stored calculation from the invoice, or recalculate if needed
let calculation;
if (invoice.gst_calculation && invoice.tcs_calculation) {
// Use the stored calculation from the order
calculation = {
gst: {
applicable: invoice.gst_calculation.applicable || (invoice.gst_calculation.total > 0),
rate: invoice.gst_rate || invoice.gst_calculation.rate || 5,
cgst: invoice.gst_calculation.cgst || 0,
sgst: invoice.gst_calculation.sgst || 0,
igst: invoice.gst_calculation.igst || 0,
total: invoice.gst_calculation.total || invoice.total_tax || 0
},
tcs: {
    applicable: invoice.tcs_calculation.applicable || false,
    rate: invoice.tcs_rate || invoice.tcs_calculation.rate || 5, // Use stored rate
    amount: invoice.tcs_calculation.amount || 0
},
finalAmount: invoice.final_amount || (baseAmount + (invoice.total_tax || 0))
};


} else {
// Fallback: recalculate using the function
calculation = calculateGSTAndTCS(baseAmount, invoice);
}

const gstRate = calculation.gst.rate;

// Calculate GST amounts (use stored values if available, otherwise calculate)
const gstAmount = calculation.gst.total;
const cgstAmount = calculation.gst.cgst;
const sgstAmount = calculation.gst.sgst; 
const igstAmount = calculation.gst.igst;
const tcsAmount = calculation.tcs.amount;

// Update invoice with calculated values (ensure they're set)
invoice.gst_calculation = calculation.gst;
invoice.tcs_calculation = calculation.tcs;
invoice.total_tax = gstAmount;
invoice.final_amount = calculation.finalAmount;

return React.createElement('div', {
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-backdrop',
onClick: (e) => e.target === e.currentTarget && closeForm()
},
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg w-full max-w-6xl max-h-[95vh] overflow-y-auto' },
React.createElement('div', { className: 'sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center action-buttons' },
React.createElement('h2', { className: 'text-2xl font-bold text-gray-900' }, 
'GST Invoice: ' + (invoice.invoice_number)
),
React.createElement('div', { className: 'flex space-x-2' },
React.createElement('button', {
onClick: () => {
// Create a new window for printing
const printWindow = window.open('', '_blank');

// Get the invoice content
const invoiceContent = document.querySelector('.invoice-preview').innerHTML;

// Create a complete HTML document for printing
const printDocument = `
<!DOCTYPE html>
<html>
<head>
<title>Invoice - ${invoice.invoice_number}</title>
<style>
${document.querySelector('style').innerHTML}
body {
margin: 0;
padding: 20px;
background: white;
}
.invoice-preview {
max-width: 210mm;
margin: 0 auto;
}
@media print {
body {
margin: 0;
padding: 0;
}
.invoice-preview {
margin: 0;
border: none;
}
}

/* Invoice Styles - Updated to match invoice module */
.invoice-preview {
background: white;
border: 2px solid #000;
font-family: Arial, sans-serif;
font-size: 10px;
line-height: 1.2;
margin: 0 auto;
max-width: 210mm;
height: fit-content;
padding: 8mm;
box-sizing: border-box;
display: block;
overflow: hidden;
}
.invoice-header-row {
display: grid;
grid-template-columns: 300px 1fr auto;
padding: 10px 8px;
border-bottom: 2px solid #000;
align-items: center;
margin-bottom: 10px;
background: #f8f9fa;
}
.company-logo {
width: 210px;
height: 150px;
margin: 0;
}
.company-logo img {
max-width: 210px;
max-height: 150px;
object-fit: contain;
}
.invoice-title {
text-align: right;
font-size: 16px;
font-weight: bold;
padding-top: 10px;
color: #2c3e50;
}
.invoice-meta {
display: grid;
grid-template-columns: 1fr 1fr;
padding: 8px;
border-bottom: 1px solid #000;
font-size: 10px;
margin-bottom: 10px;
background: #f8f9fa;
}
.customer-section {
padding: 10px 8px;
border-bottom: 1px solid #000;
margin-bottom: 12px;
background: #f8f9fa;
}
.customer-title {
font-weight: bold;
margin-bottom: 4px;
font-size: 10px;
}
.invoice-table {
width: 100%;
border-collapse: collapse;
font-size: 10px;
margin-bottom: 12px;
}
.invoice-table th {
background: #2c3e50;
color: white;
padding: 6px 4px;
text-align: left;
border: 1px solid #000;
font-weight: bold;
font-size: 10px;
}
.invoice-table td {
padding: 6px 4px;
border: 1px solid #000;
text-align: left;
background: white;
}
.totals-table {
width: 100%;
border-collapse: collapse;
font-size: 10px;
margin-bottom: 12px;
}
.totals-table td {
padding: 4px;
border: 1px solid #000;
}
.bank-details {
display: grid;
grid-template-columns: 1fr 1fr;
padding: 10px 8px;
border: 2px solid #2c3e50;
font-size: 9px;
gap: 10px;
background: #f8f9fa;
margin-top: 10px;
}
.bank-info h4 {
margin-bottom: 6px;
font-size: 10px;
color: #2c3e50;
border-bottom: 1px solid #2c3e50;
padding-bottom: 2px;
}
.bank-info div {
margin-bottom: 2px;
line-height: 1.1;
}
.payment-qr {
text-align: center;
}
.payment-qr img {
width: 120px;
height: 120px;
border: 2px solid #ddd;
padding: 5px;
background: white;
}
.invoice-footer {
margin-top: 10px;
text-align: center;
font-size: 8px;
color: #666;
}
.company-info-section {
background: white;
padding: 8px;
border: 1px solid #ddd;
border-radius: 3px;
margin-bottom: 8px;
}
.company-info-section h4 {
color: #2c3e50;
margin-bottom: 6px;
border-bottom: 1px solid #2c3e50;
padding-bottom: 2px;
text-align: center;
font-size: 9px;
}
.additional-info {
font-size: 9px;
color: #666;
margin-top: 2px;
font-style: italic;
}
@media print {
body { background: white; padding: 0; margin: 0; }
.invoice-preview { border: none; box-shadow: none; margin: 0; padding: 5mm; }
.modal-backdrop { display: none; }
.sticky { position: relative !important; }
@page { margin: 10mm; size: A4; }
}
</style>
</head>
<body>
<div class="invoice-preview">
${invoiceContent}
</div>
</body>
</html>`;

// Write the content to the new window
printWindow.document.write(printDocument);
printWindow.document.close();

// Wait for content to load, then print
printWindow.onload = function() {
printWindow.print();
// Close the window after printing
printWindow.onafterprint = function() {
printWindow.close();
};


};


},
className: 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700'
}, 'üñ®Ô∏è Print'),
React.createElement('button', {
onClick: closeForm,
className: 'text-gray-400 hover:text-gray-600 text-2xl'
}, '‚úï')
)
),

// Enhanced GST Invoice Preview Content
React.createElement('div', { className: 'invoice-preview p-6' },
// Header with logo
React.createElement('div', { className: 'invoice-header-row' },
React.createElement('div', { style: { textAlign: 'left' } },
React.createElement('div', { className: 'company-logo' },
React.createElement('img', {
src: 'images/logo.png',
alt: 'FanToPark Logo',
style: { maxWidth: '100%', maxHeight: '100%', objectFit: 'contain' }
})
)
),
React.createElement('div', { style: { textAlign: 'center' }},
// Empty space for balance
),
React.createElement('div', { className: 'invoice-title' }, 'Tax Invoice')
),

// Invoice Meta Information
React.createElement('div', { className: 'invoice-meta' },
React.createElement('div', null,
React.createElement('div', null, 
React.createElement('strong', null, 'Date:'), ' ',
new Date(invoice.invoice_date || invoice.created_date || Date.now()).toLocaleDateString('en-GB', {
day: '2-digit',
month: 'short',
year: 'numeric'
})
),
React.createElement('div', null, 
React.createElement('strong', null, 'Invoice No:'), ' ', invoice.invoice_number
),
React.createElement('div', null, 
React.createElement('strong', null, 'POS:'), ' ', invoice.indian_state || 'Haryana'
)
),
React.createElement('div', { style: { textAlign: 'right' }},
React.createElement('div', null, 
React.createElement('strong', null, 'Transaction Type:'), ' ', invoice.category_of_sale
),
React.createElement('div', null, 
React.createElement('strong', null, 'Sale Type:'), ' ', invoice.type_of_sale,
invoice.type_of_sale === 'Service Fee' && 
React.createElement('span', { style: { fontSize: '8px', color: '#dc2626', marginLeft: '4px' }}, '(18% GST)')
)
)
),

// Customer Section
React.createElement('div', { className: 'customer-section' },
React.createElement('div', { className: 'customer-title' }, 
'Customer Name: ', invoice.legal_name || invoice.client_name
),
React.createElement('div', null, 
React.createElement('strong', null, 'Address:'), ' ', invoice.registered_address
),
React.createElement('div', null, 
React.createElement('strong', null, 'GSTIN:'), ' ', invoice.gstin || 'N/A',
' | ',
React.createElement('strong', null, 'PAN:'), ' ', invoice.pan || 'N/A'
)
),

// Enhanced Items Table with Multi-Row Support and Additional Info
React.createElement('table', { className: 'invoice-table' },
React.createElement('thead', null,
React.createElement('tr', null,
React.createElement('th', null, 'Particulars'),
React.createElement('th', { style: { textAlign: 'center' }}, 'Qty.'),
React.createElement('th', { style: { textAlign: 'center' }}, 'Rate (INR)'),
React.createElement('th', { style: { textAlign: 'right' }}, 'Value (INR)')
)
),
React.createElement('tbody', null,
// Enhanced: Multiple invoice items with additional info support
invoice.invoice_items?.map((item, index) =>
React.createElement('tr', { key: index },
React.createElement('td', null, 
React.createElement('div', null,
// Main description
React.createElement('div', null, item.description),
// NEW: Additional info in brackets (like your example)
item.additional_info && 
React.createElement('div', { 
className: 'additional-info',
style: { fontSize: '9px', color: '#666', marginTop: '2px', fontStyle: 'italic' } 
}, '(' + item.additional_info + ')')
)
),
React.createElement('td', { style: { textAlign: 'center' }}, item.quantity),
React.createElement('td', { style: { textAlign: 'center' }}, formatCurrency(item.rate)),
React.createElement('td', { style: { textAlign: 'right' }}, formatCurrency(item.quantity * item.rate))
)
),
// Service Charge row for Service Fee type (when base amount > 0)
invoice.type_of_sale === 'Service Fee' && invoice.base_amount > 0 && React.createElement('tr', null,
React.createElement('td', { colSpan: 3, style: { textAlign: 'right', fontWeight: 'bold' }}, 'Service Charge'),
React.createElement('td', { style: { textAlign: 'right', fontWeight: 'bold' }}, formatCurrency(invoice.base_amount))
)
)
),

// FIX 3: Enhanced Tax Table with better calculation handling
React.createElement('table', { className: 'totals-table' },
React.createElement('tr', null,
React.createElement('td', { style: { width: '60%' }}),
React.createElement('td', { style: { textAlign: 'center', fontWeight: 'bold', width: '20%' }}, 'Rate'),
React.createElement('td', { style: { textAlign: 'right', fontWeight: 'bold', width: '20%' }}, `Value (${invoice.payment_currency || 'INR'})`)
),
(() => {
const taxRows = [];

// FIX 4: GST Rows - ensure they show when GST is applicable
if (calculation.gst.applicable && calculation.gst.total > 0) {
if (isIntraState) {
// CGST Row
taxRows.push(
React.createElement('tr', { key: 'cgst' },
React.createElement('td', null, invoice.type_of_sale === 'Service Fee' ? 'CGST on Service Charge' : 'CGST'),
React.createElement('td', { style: { textAlign: 'center' }}, (calculation.gst.rate/2).toFixed(2) + '%'),
React.createElement('td', { style: { textAlign: 'right' }}, formatCurrency(calculation.gst.cgst))
)
);
// SGST Row
taxRows.push(
React.createElement('tr', { key: 'sgst' },
React.createElement('td', null, invoice.type_of_sale === 'Service Fee' ? 'SGST on Service Charge' : 'SGST'),
React.createElement('td', { style: { textAlign: 'center' }}, (calculation.gst.rate/2).toFixed(2) + '%'),
React.createElement('td', { style: { textAlign: 'right' }}, formatCurrency(calculation.gst.sgst))
)
);
} else {
// IGST Row
taxRows.push(
React.createElement('tr', { key: 'igst' },
React.createElement('td', null, invoice.type_of_sale === 'Service Fee' ? 'IGST on Service Charge' : 'IGST'),
React.createElement('td', { style: { textAlign: 'center' }}, calculation.gst.rate.toFixed(2) + '%'),
React.createElement('td', { style: { textAlign: 'right' }}, formatCurrency(calculation.gst.igst))
)
);
}
}

// TCS Row - Use stored rate from invoice
if (calculation.tcs.applicable && calculation.tcs.amount > 0) {
    taxRows.push(
        React.createElement('tr', { key: 'tcs' },
            React.createElement('td', null, `TCS (${calculation.tcs.rate}%)`), // Show actual rate
            React.createElement('td', { style: { textAlign: 'center' }}, calculation.tcs.rate.toFixed(2) + '%'),
            React.createElement('td', { style: { textAlign: 'right' }}, formatCurrency(calculation.tcs.amount))
        )
    );
} else {
    taxRows.push(
        React.createElement('tr', { key: 'tcs' },
            React.createElement('td', null, 'TCS'),
            React.createElement('td', { style: { textAlign: 'center' }}, '0.00%'),
            React.createElement('td', { style: { textAlign: 'right' }}, '-')
        )
    );
}

// Grand Total Row
taxRows.push(
React.createElement('tr', { key: 'grand-total', style: { fontWeight: 'bold' }},
React.createElement('td', null, 'Grand Total'),
React.createElement('td', null),
React.createElement('td', { style: { textAlign: 'right' }}, formatCurrency(calculation.finalAmount))
)
);

// Round-off Row
taxRows.push(
React.createElement('tr', { key: 'round-off' },
React.createElement('td', null, 'Round-off'),
React.createElement('td', null),
React.createElement('td', { style: { textAlign: 'right' }}, '-')
)
);

// Final Invoice Value Row
taxRows.push(
React.createElement('tr', { key: 'invoice-value', style: { fontWeight: 'bold' }},
React.createElement('td', null, 'Invoice Value'),
React.createElement('td', null),
React.createElement('td', { style: { textAlign: 'right' }}, formatCurrency(calculation.finalAmount))
)
);

return taxRows;
})()
),

// Bank Details with QR Code (existing)
React.createElement('div', { className: 'bank-details' },
React.createElement('div', { className: 'bank-info' },
React.createElement('h4', null, 'Payment Information'),
React.createElement('div', null, React.createElement('strong', null, 'Bank Name:'), ' Kotak Mahindra Bank Ltd.'),
React.createElement('div', null, React.createElement('strong', null, 'Account Name:'), ' F2P Sports Private Limited'),
React.createElement('div', null, React.createElement('strong', null, 'Account Number:'), ' 3750501346'),
React.createElement('div', null, React.createElement('strong', null, 'IFSC Code:'), ' KKBK0000298'),
React.createElement('div', null, React.createElement('strong', null, 'Bank Address:'), ' Shop No. 2 & 3, Vatika Business Park, Sohna Road, Badshahpur, Gurgaon, 122002, Haryana, India')
),
React.createElement('div', { className: 'bank-info', style: { display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' }},
React.createElement('h4', { style: { marginBottom: '10px' }}, 'Scan to Pay'),
React.createElement('img', {
src: 'images/qr.png',
alt: 'Payment QR Code',
style: { width: '120px', height: '120px', objectFit: 'contain', border: '1px solid #ddd' }
}),
React.createElement('div', { style: { marginTop: '5px', textAlign: 'center', fontSize: '8px' }}, 'Scan QR code for payment')
)
),

// Company Information Footer (existing)
React.createElement('div', { className: 'invoice-footer' },
React.createElement('div', { className: 'company-info-section', style: { background: 'white', padding: '8px', border: '1px solid #ddd', borderRadius: '3px', marginBottom: '8px' } },
React.createElement('h4', { style: { color: '#2c3e50', marginBottom: '6px', borderBottom: '1px solid #2c3e50', paddingBottom: '2px', textAlign: 'center', fontSize: '9px' }}, 'F2P SPORTS PRIVATE LIMITED'),
React.createElement('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }},
React.createElement('div', { style: { fontSize: '8px', lineHeight: '1.1' }},
React.createElement('div', null, React.createElement('strong', null, 'Regd. Office:'), ' D 104, Pioneer Urban Square, Sector 62, Gurgaon 122102, Haryana, India'),
React.createElement('div', { style: { marginTop: '3px' }}, React.createElement('strong', null, 'Email:'), ' sales@fantopark.com'),
React.createElement('div', null, React.createElement('strong', null, 'Mobile:'), ' +91 9934463729')
),
React.createElement('div', { style: { fontSize: '8px', lineHeight: '1.1' }},
React.createElement('div', null, React.createElement('strong', null, 'CIN:'), ' U52291HR2024PTC127089'),
React.createElement('div', null, React.createElement('strong', null, 'GST:'), ' 06AAGCF1773L1ZE'),
React.createElement('div', null, React.createElement('strong', null, 'PAN:'), ' AAGCF1773L'),
React.createElement('div', null, React.createElement('strong', null, 'HSN Code:'), ' 998554'),
React.createElement('div', null, React.createElement('strong', null, 'UDYAM Reg. No.:'), ' UDYAM-HR-05-0130233'),
React.createElement('div', null, React.createElement('strong', null, 'Category:'), ' Micro')
)
)
),
React.createElement('div', { style: { textAlign: 'center', borderTop: '1px solid #2c3e50', paddingTop: '4px' }},
React.createElement('p', { style: { fontWeight: 'bold', marginBottom: '2px', fontSize: '9px' }}, 'Thank you for your business!'),
React.createElement('p', { style: { fontSize: '8px' }}, 'For any queries, please contact us at sales@fantopark.com')
)
)
)
));
};



// Order approval with permission check
// REPLACE your existing handleOrderApproval function with this:
// MERGED handleOrderApproval function - includes both GST invoice and receivables creation
const handleOrderApproval = async (orderId, action) => {
if (!hasPermission('orders', 'approve')) {
alert('You do not have permission to approve orders');
return;
}

setLoading(true);

try {
const order = orders.find(o => o.id === orderId);
console.log('Approving order:', order);

// If rejecting, ask for notes
let notes = '';
if (action === 'reject') {
notes = prompt('Please provide rejection reason:');
if (!notes) {
setLoading(false);
return;
}
}

const newStatus = action === 'approve' ? 'approved' : 'rejected';
let invoiceNumber = null;
let invoiceId = null;

// Generate GST invoice if approved
if (action === 'approve' && (order.requires_gst_invoice || order.gstin)) {
invoiceNumber = 'STTS/INV/' + (new Date().getFullYear()) + '/' + (String(Date.now()).slice(-6));
invoiceId = Date.now();

const newInvoice = {
id: invoiceId,
invoice_number: invoiceNumber,
order_id: orderId,
order_number: order.order_number,
client_name: order.legal_name || order.client_name,
client_email: order.client_email,

// GST Details
gstin: order.gstin,
legal_name: order.legal_name,
category_of_sale: order.category_of_sale,
type_of_sale: order.type_of_sale,
registered_address: order.registered_address,
indian_state: order.indian_state,
is_outside_india: order.is_outside_india,

// Invoice calculation
invoice_items: order.invoice_items,
base_amount: order.base_amount,
gst_calculation: order.gst_calculation,
total_tax: order.total_tax,
final_amount: order.final_amount || order.total_amount,

invoice_date: new Date().toISOString().split('T')[0],
due_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
status: 'generated',
generated_by: user.name
};



setInvoices(prev => [...prev, newInvoice]);
}

// Update order in backend with all necessary fields including invoice info
const updateData = {
status: newStatus,
approved_date: new Date().toISOString(),
approval_notes: notes,
approved_by: user.name,
payment_status: order.payment_status || 'pending'
};



// Add invoice fields if invoice was generated
if (invoiceNumber && invoiceId) {
updateData.invoice_number = invoiceNumber;
updateData.invoice_id = invoiceId;
}

// Send update to backend
await apiCall('/orders/' + orderId, {
method: 'PUT',
body: JSON.stringify(updateData)
});

// CREATE RECEIVABLES FOR PARTIAL/POST-SERVICE PAYMENTS
if (action === 'approve') {
console.log('Order approved, checking if receivable needed...');
console.log('Order type:', order.order_type);
console.log('Payment status:', order.payment_status);

// Check if it's a post-service payment or partial payment
const isPostService = order.order_type === 'payment_post_service' || 
order.lead_status === 'payment_post_service';
const isPartialPayment = order.payment_status === 'partial' || 
(order.amount_paid && order.amount_paid < order.total_amount);

console.log('Is post service:', isPostService);
console.log('Is partial payment:', isPartialPayment);

if (isPostService || isPartialPayment) {
// Calculate pending amount
const paidAmount = parseFloat(order.amount_paid || 0);
const totalAmount = parseFloat(order.total_amount || order.final_amount || 0);
const pendingAmount = totalAmount - paidAmount;

console.log('Total amount:', totalAmount);
console.log('Paid amount:', paidAmount);
console.log('Pending amount:', pendingAmount);

if (pendingAmount > 0) {
// Create receivable entry
const receivableData = {
order_id: orderId,
order_number: order.order_number,
client_name: order.client_name || order.lead_name,
client_email: order.client_email,
client_phone: order.client_phone,
invoice_number: invoiceNumber || order.invoice_number || 'INV-' + orderId,
expected_amount: pendingAmount,
amount_paid: paidAmount,
balance_amount: pendingAmount,
due_date: order.expected_payment_date || 
new Date(Date.now() + 30*24*60*60*1000).toISOString(),
payment_terms: order.payment_terms || 'Net 30',
assigned_to: order.assigned_to || order.created_by,
status: 'pending',
created_date: new Date().toISOString(),
created_by: user.name,
is_post_service: isPostService,
event_date: order.event_date,
event_name: order.event_name
};



console.log('Creating receivable with data:', receivableData);

try {
const receivableResponse = await apiCall('/receivables', {
method: 'POST',
body: JSON.stringify(receivableData)
});
console.log('Receivable created successfully:', receivableResponse);

// Update local receivables state if it exists
if (typeof setReceivables === 'function') {
setReceivables(prev => [...prev, receivableResponse.data || receivableResponse]);
}
} catch (error) {
console.error('Failed to create receivable:', error);
alert('Order approved but failed to create receivable. Please create it manually.');
}
}
}
}

// Update local state
setOrders(prev => 
prev.map(o => o.id === orderId ? { ...o, ...updateData } : o)
);

// Refresh financial data if user has permission
if (hasPermission('finance', 'read')) {
await fetchFinancialData();
}

setLoading(false);

// Custom alert message based on what happened
let alertMessage = action === 'approve' ? 'Order approved successfully!' : 'Order rejected successfully.';
if (action === 'approve' && invoiceNumber) {
alertMessage += ' GST Invoice has been generated.';
}
alert(alertMessage);

} catch (error) {
console.error('Order approval error:', error);
setLoading(false);
alert('Failed to update order status');
}
};



// 1. Delete Receivable Function
const deleteReceivable = async (receivableId) => {
if (!window.confirm('Are you sure you want to delete this receivable? This action cannot be undone.')) {
return;
}

try {
setLoading(true);

const response = await apiCall(`/receivables/${receivableId}`, {
method: 'DELETE'
});

// Update local state - remove the deleted receivable
setReceivables(prev => prev.filter(r => r.id !== receivableId));

// Update analytics by recalculating totals
await fetchData(); // This will refresh all data including analytics

alert('Receivable deleted successfully!');

} catch (error) {
console.error('Error deleting receivable:', error);
alert('Failed to delete receivable: ' + error.message);
} finally {
setLoading(false);
}
};



// 2. Delete Payable Function  
const deletePayable = async (payableId) => {
if (!window.confirm('Are you sure you want to delete this payable? This action cannot be undone.')) {
return;
}

try {
setLoading(true);

const response = await apiCall(`/payables/${payableId}`, {
method: 'DELETE'
});

// Update financialData state instead of separate payables state
setFinancialData(prev => ({
...prev,
payables: prev.payables ? prev.payables.filter(p => p.id !== payableId) : []
}));

// Update analytics by recalculating totals
await fetchData(); // This will refresh all data including analytics

alert('Payable deleted successfully!');

} catch (error) {
console.error('Error deleting payable:', error);
alert('Failed to delete payable: ' + error.message);
} finally {
setLoading(false);
}
};



const handleFormSubmit = async (e) => {
e.preventDefault();
setLoading(true);

try {
if (showEditForm) {
// Update lead via API
const response = await apiCall('/leads/' + (currentLead.id), {
method: 'PUT',
body: JSON.stringify(formData)
});
setLeads(prev => prev.map(lead => 
lead.id === currentLead.id ? response.data : lead
));

// ‚úÖ ADD: Refresh assignment rules after lead update
if (window.refreshAssignmentRules && typeof window.refreshAssignmentRules === 'function') {
try {
await window.refreshAssignmentRules();
console.log('‚úÖ Assignment rules refreshed after lead update');
} catch (refreshError) {
console.log('‚ö†Ô∏è Assignment rules refresh failed (non-critical):', refreshError);
}
}

alert('Lead updated successfully!');

} else if (showEditInventoryForm) {
// Add debug logging
console.log('=== FRONTEND INVENTORY UPDATE DEBUG (Regular Form) ===');
console.log('Inventory ID being updated:', currentInventory.id);
console.log('Complete form data being sent:', formData);
console.log('Payment fields specifically:', {
totalPurchaseAmount: formData.totalPurchaseAmount,
amountPaid: formData.amountPaid,
paymentStatus: formData.paymentStatus,
supplierName: formData.supplierName,
supplierInvoice: formData.supplierInvoice
});

// Update inventory via API
const response = await apiCall('/inventory/' + (currentInventory.id), {
method: 'PUT',
body: JSON.stringify(formData)
});

console.log('Backend response:', response);

setInventory(prev => prev.map(item => 
item.id === currentInventory.id ? response.data : item
));
alert('Inventory updated successfully!');
} else {
// Create new items
switch (currentForm) {
case 'lead':
const leadResponse = await apiCall('/leads', {
method: 'POST',
body: JSON.stringify({
...formData,
status: 'unassigned',
created_by: user.name,
created_date: new Date().toISOString()
})
});
setLeads(prev => [...prev, leadResponse.data]);

// ‚úÖ ADD: Refresh assignment rules after new lead creation
if (window.refreshAssignmentRules && typeof window.refreshAssignmentRules === 'function') {
try {
await window.refreshAssignmentRules();
console.log('‚úÖ Assignment rules refreshed after lead creation');
} catch (refreshError) {
console.log('‚ö†Ô∏è Assignment rules refresh failed (non-critical):', refreshError);
}
}

alert('Lead added successfully!');
break;

case 'inventory':
console.log('Sending inventory data:', formData);
const invResponse = await apiCall('/inventory', {
method: 'POST',
body: JSON.stringify({
...formData,
created_by: user.name,
created_date: new Date().toISOString()
})
});
console.log("Inventory API Response:", invResponse);
setInventory(prev => [...prev, invResponse.data]);
alert('Inventory added successfully!');

// Create payable entry if payment is pending or partial
if (formData.paymentStatus === 'pending' || formData.paymentStatus === 'partial') {
try {
const pendingAmount = parseFloat(formData.totalPurchaseAmount || 0) - parseFloat(formData.amountPaid || 0);

if (pendingAmount > 0) {
const payableData = {
supplierName: formData.supplierName || 'Unknown Supplier',
invoiceNumber: formData.supplierInvoice || 'INV-' + (Date.now()),
amount: pendingAmount,
dueDate: formData.paymentDueDate || new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0], // 30 days from now
description: 'Inventory purchase: ' + (formData.event_name || 'Event') + ' - ' + (formData.category_of_ticket || 'Tickets'),
inventoryId: invResponse.data?.id || invResponse.id,
status: 'pending'
};



console.log('Creating payable for inventory:', payableData);

const payableResponse = await apiCall('/finance/payables', {
method: 'POST',
body: JSON.stringify(payableData)
});

console.log('Payable created:', payableResponse);
}
} catch (payableError) {
console.error('Failed to create payable:', payableError);
// Don't show error to user - payable creation is secondary
}
}
break;

case 'order':
console.log('Creating order with data:', JSON.stringify(orderData, null, 2));
console.log('Key fields:', {
event_name: orderData.event_name,
tickets_allocated: orderData.tickets_allocated,
ticket_category: orderData.ticket_category,
total_amount: orderData.total_amount
});
const orderResponse = await apiCall('/orders', {
method: 'POST',
body: JSON.stringify({
...formData,
order_number: 'ORD-' + (Date.now()),
status: 'pending_approval',
requires_gst_invoice: true,
total_amount: formData.tickets_allocated * formData.price_per_ticket,
created_by: user.name,
created_date: new Date().toISOString()
})
});
setOrders(prev => [...prev, orderResponse]);
alert('Order created successfully!');
break;
}
}

closeForm();
} catch (error) {
alert('Operation failed: ' + error.message);
} finally {
setLoading(false);
}
};



const handleDeleteLead = async (leadId) => {
if (!confirm('Are you sure you want to delete this lead?')) return;

try {
await apiCall('/leads/' + (leadId), { method: 'DELETE' });
setLeads(prev => prev.filter(lead => lead.id !== leadId));

// ‚úÖ ADD: Refresh assignment rules after lead deletion
if (window.refreshAssignmentRules && typeof window.refreshAssignmentRules === 'function') {
try {
await window.refreshAssignmentRules();
console.log('‚úÖ Assignment rules refreshed after lead deletion');
} catch (refreshError) {
console.log('‚ö†Ô∏è Assignment rules refresh failed (non-critical):', refreshError);
}
}

alert('Lead deleted successfully!');
} catch (error) {
alert('Failed to delete lead: ' + error.message);
}
};

const togglePremiumStatus = async (leadId, isPremium) => {
  try {
    setLoading(true);
    
    const response = await apiCall(`/leads/${leadId}`, {
      method: 'PUT',
      body: JSON.stringify({ is_premium: isPremium })
    });
    
    // Update the leads list
    setLeads(prev => prev.map(lead => 
      lead.id === leadId ? { ...lead, is_premium: isPremium } : lead
    ));
    
    // Update currentLead if viewing the lead details
    if (showLeadDetail && currentLead?.id === leadId) {
      setCurrentLead(prev => ({ ...prev, is_premium: isPremium }));
    }
    
    console.log(`‚úÖ Lead ${leadId} premium status updated to ${isPremium}`);
    
  } catch (error) {
    console.error('Error updating premium status:', error);
    alert('Failed to update premium status: ' + error.message);
  } finally {
    setLoading(false);
  }
};

const handleDeleteInventory = async (inventoryId) => {
if (!confirm('Are you sure you want to delete this event?')) return;

try {
await apiCall('/inventory/' + (inventoryId), { method: 'DELETE' });
setInventory(prev => prev.filter(item => item.id !== inventoryId));
alert('Event deleted successfully!');
} catch (error) {
alert('Failed to delete event: ' + error.message);
}
};



// Assignment with permission check
const handleAssignLead = async (e) => {
e.preventDefault();

console.log('\nüîç === ASSIGNMENT DEBUGGING START ===');
console.log('1. Form Data:', formData);
console.log('3. Current dropdown value (assigned_to):', formData.assigned_to);

// Check what type of value we have
if (formData.assigned_to) {
if (formData.assigned_to.includes('@')) {
console.log('‚úÖ Value contains @ - appears to be an email');
} else {
console.log('‚ùå Value does NOT contain @ - appears to be a name');
}
}
setLoading(true);

try {
const response = await apiCall('/leads/' + (currentLead.id), {
method: 'PUT',
body: JSON.stringify({
status: 'assigned',
assigned_to: formData.assigned_to,
assignment_date: new Date().toISOString()
})
});

setLeads(prev => prev.map(lead => 
lead.id === currentLead.id ? response.data : lead
));

// Update currentLead if viewing the assigned lead
if (showLeadDetail && currentLead?.id === response.data.id) {
setCurrentLead(response.data);
}

// ‚úÖ ADD: Refresh assignment rules after lead assignment
if (window.refreshAssignmentRules && typeof window.refreshAssignmentRules === 'function') {
try {
await window.refreshAssignmentRules();
console.log('‚úÖ Assignment rules refreshed after lead assignment');
} catch (refreshError) {
console.log('‚ö†Ô∏è Assignment rules refresh failed (non-critical):', refreshError);
}
}

alert('Lead assigned successfully!');
closeForm();
} catch (error) {
alert('Assignment failed: ' + error.message);
} finally {
setLoading(false);
}
};



// Payment submission with permission check
const handlePaymentSubmit = async (e) => {
e.preventDefault();

// ADD THESE DEBUG LINES
console.log('=== PAYMENT SUBMIT DEBUG ===');
console.log('Full paymentData:', paymentData);
console.log('GST Certificate:', paymentData.gst_certificate);
console.log('PAN Card:', paymentData.pan_card);

if (!hasPermission('leads', 'write')) {
alert('You do not have permission to manage payments');
return;
}

setLoading(true);

try {
await new Promise(resolve => setTimeout(resolve, 1000));

// Check if this is a post-service payment
if (paymentData.payment_post_service && paymentData.receivable_id) {
// Update receivable status
setReceivables(prev => 
prev.map(r => 
r.id === paymentData.receivable_id 
? { ...r, status: 'paid', paid_date: new Date().toISOString().split('T')[0] }
: r
)
);

// Update order payment status
const order = orders.find(o => o.lead_id === currentLead.id && o.payment_type === 'post_service');
if (order) {
setOrders(prev => 
prev.map(o => 
o.id === order.id 
? { ...o, payment_received: true, payment_date: new Date().toISOString().split('T')[0] }
: o
)
);
}
}

// FIXED: Use helper function and correct GST calculation
const baseAmount = getBaseAmount(paymentData);
const isIntraState = paymentData.indian_state === 'Haryana' && !paymentData.is_outside_india;

// FIXED: Use the correct calculateGSTAndTCS function
const calculation = calculateGSTAndTCS(baseAmount, paymentData);
const totalTax = calculation.gst.total;
const finalAmount = calculation.finalAmount;

// Update lead with payment details
const updatedLead = {
...currentLead,
payment_details: {
...paymentData,
advance_amount: parseFloat(paymentData.advance_amount) || 0,
base_amount: baseAmount,
gst_calculation: calculation.gst,
tcs_calculation: calculation.tcs,
total_tax: totalTax,
final_amount: finalAmount
},
payment_received_date: new Date().toISOString().split('T')[0]
};



// Update local state with payment details
setLeads(prev => 
prev.map(lead => 
lead.id === currentLead.id ? updatedLead : lead
)
);

console.log('=== REACHED ORDER CREATION SECTION ===');

// Check if order already exists for this lead
const existingOrder = orders.find(order => 
order.lead_id === currentLead.id && 
order.status !== 'rejected'
);

if (existingOrder) {
// UPDATE existing order
console.log('Updating order with GST details:', {
gstin: paymentData.gstin,
legal_name: paymentData.legal_name,
registered_address: paymentData.registered_address,
category_of_sale: paymentData.category_of_sale,
type_of_sale: paymentData.type_of_sale,
indian_state: paymentData.indian_state
});

// FIXED: Correct API call format
const updateResponse = await apiCall(`/orders/${existingOrder.id}`, {
method: 'PUT',
body: JSON.stringify({
// Start with existing order data
...existingOrder,

// Payment fields (will override existing)
payment_amount: paymentData.advance_amount,
payment_method: paymentData.payment_method,
transaction_id: paymentData.transaction_id,
payment_date: paymentData.payment_date,
payment_proof: paymentData.payment_proof,
payment_status: 'paid',

// Amount fields
amount: paymentData.advance_amount,
total_amount: existingOrder.total_amount || existingOrder.final_amount,
final_amount: existingOrder.final_amount || existingOrder.total_amount,

// GST fields - IMPORTANT: These will override existing values
legal_name: paymentData.legal_name || existingOrder.legal_name,
gstin: paymentData.gstin || existingOrder.gstin,
registered_address: paymentData.registered_address || existingOrder.registered_address,
category_of_sale: paymentData.category_of_sale || existingOrder.category_of_sale,
type_of_sale: paymentData.type_of_sale || existingOrder.type_of_sale,
indian_state: paymentData.indian_state || existingOrder.indian_state,
is_outside_india: paymentData.is_outside_india || existingOrder.is_outside_india,
gst_certificate: paymentData.gst_certificate || existingOrder.gst_certificate,
pan_card: paymentData.pan_card || existingOrder.pan_card,

// Invoice details
invoice_items: paymentData.invoice_items || existingOrder.invoice_items,
base_amount: baseAmount,
gst_calculation: calculation.gst,
tcs_calculation: calculation.tcs,
total_tax: totalTax,
final_amount: finalAmount,
gst_rate: calculation.gst.rate,
service_fee_amount: paymentData.service_fee_amount || existingOrder.service_fee_amount,

// Clear post-service fields if this was a post-service order
expected_amount: null,
expected_payment_date: null,
order_type: 'standard',

// Metadata
notes: paymentData.notes || existingOrder.notes,
updated_date: new Date().toISOString(),
updated_by: user.name
})
});

console.log('Order update response:', updateResponse);

// FIXED: Handle response structure properly
const updatedOrderData = updateResponse.data || updateResponse;
setOrders(prev => prev.map(o => 
o.id === existingOrder.id ? {...o, ...updatedOrderData} : o
));

// IMPORTANT: Update lead status for payment_post_service to payment_received
if (paymentData.payment_post_service) {
await updateLeadStatus(currentLead.id, 'payment_received');
}

// Update lead status if this is payment collection after service
if (paymentData.payment_post_service || currentLead.status === 'payment_post_service') {
await updateLeadStatus(currentLead.id, 'payment_received');
}

// Handle receivable updates/deletion if payment is from receivables
if (paymentData.from_receivable && paymentData.receivable_id) {
console.log('Processing receivable payment...');
console.log('Receivable ID:', paymentData.receivable_id);
console.log('Original receivable amount:', paymentData.receivable_amount);

// For receivable payments, the advance_amount field contains the actual payment amount
const paidAmount = parseFloat(paymentData.advance_amount) || 0;
const receivableAmount = parseFloat(paymentData.receivable_amount) || 0;

console.log('Payment being collected:', paidAmount);
console.log('Original receivable amount:', receivableAmount);
console.log('Calculated invoice amount with GST:', finalAmount);

if (paidAmount >= receivableAmount) {
// Full payment - delete the receivable
try {
await apiCall(`/receivables/${paymentData.receivable_id}`, {
method: 'DELETE'
});

// Remove from local state
if (typeof setReceivables === 'function') {
setReceivables(prev => prev.filter(r => r.id !== paymentData.receivable_id));
}
console.log('Receivable deleted after full payment');
} catch (error) {
console.error('Failed to delete receivable:', error);
}
} else {
// Partial payment - ask user what to do
const remainingAmount = receivableAmount - paidAmount;
const userChoice = confirm(
`You are receiving only partial payment of ‚Çπ${paidAmount.toFixed(2)} out of ‚Çπ${receivableAmount.toFixed(2)} (inclusive of GST).\n\n` +
`Remaining balance: ‚Çπ${remainingAmount.toFixed(2)}\n\n` +
`Click OK to update this receivable with the balance payment.\n` +
`Click Cancel to mark this receivable as closed and update the order value.`
);

if (userChoice) {
// Update receivable with remaining amount
try {
await apiCall(`/receivables/${paymentData.receivable_id}`, {
method: 'PUT',
body: JSON.stringify({
balance_amount: remainingAmount,
amount: remainingAmount,
expected_amount: remainingAmount,
partial_payment_received: paidAmount,
last_payment_date: new Date().toISOString(),
updated_date: new Date().toISOString()
})
});

// Update local state
if (typeof setReceivables === 'function') {
setReceivables(prev => prev.map(r => 
r.id === paymentData.receivable_id 
? { ...r, balance_amount: remainingAmount, amount: remainingAmount }
: r
));
}
alert(`Receivable updated with remaining balance of ‚Çπ${remainingAmount.toFixed(2)}`);
} catch (error) {
console.error('Failed to update receivable:', error);
alert('Failed to update receivable with remaining balance');
}
} else {
// Close receivable and update order total
try {
// Delete the receivable
await apiCall(`/receivables/${paymentData.receivable_id}`, {
method: 'DELETE'
});

// FIXED: Use existingOrder.id instead of undefined existingOrderId
await apiCall(`/orders/${existingOrder.id}`, {
method: 'PUT',
body: JSON.stringify({
total_amount: paidAmount,
original_amount: receivableAmount,
amount_adjusted: true,
adjustment_reason: 'Partial payment accepted',
updated_date: new Date().toISOString()
})
});

// Update local states
if (typeof setReceivables === 'function') {
setReceivables(prev => prev.filter(r => r.id !== paymentData.receivable_id));
}
setOrders(prev => prev.map(o => 
o.id === existingOrder.id 
? { ...o, total_amount: paidAmount, amount_adjusted: true }
: o
));

alert(`Receivable closed. Order value updated to ‚Çπ${paidAmount.toFixed(2)}`);
} catch (error) {
console.error('Failed to close receivable:', error);
alert('Failed to close receivable');
}
}
}
}

// FIXED: Refresh orders data to ensure updated order shows correctly
try {
console.log('Refreshing orders after update...');
const freshOrdersResponse = await apiCall('/orders');
const freshOrders = freshOrdersResponse.data || freshOrdersResponse || [];
setOrders(freshOrders);
console.log('Orders refreshed after update:', freshOrders.length);
} catch (refreshError) {
console.error('Failed to refresh orders after update:', refreshError);
}

setLoading(false);
alert(paymentData.payment_post_service 
? 'Payment collected successfully! Invoice can now be generated.' 
: 'Payment updated successfully!'
);
closeForm();
return; // Exit here, don't create new order
}

// ENHANCED: Create NEW order after successful payment
const orderData = {
order_number: 'ORD-' + (Date.now()),
lead_id: currentLead.id,
lead_name: currentLead.name,
client_name: currentLead.name,
lead_email: currentLead.email,
client_email: currentLead.email,
lead_phone: currentLead.phone,
client_phone: currentLead.phone,
legal_name: paymentData.legal_name || currentLead.legal_name,
gstin: paymentData.gstin,
registered_address: paymentData.registered_address,
category_of_sale: paymentData.category_of_sale,
type_of_sale: paymentData.type_of_sale,
indian_state: paymentData.indian_state,
is_outside_india: paymentData.is_outside_india || false,
payment_amount: paymentData.advance_amount,
payment_method: paymentData.payment_method,
transaction_id: paymentData.transaction_id,
payment_date: paymentData.payment_date,
payment_proof: paymentData.payment_proof,
notes: paymentData.notes,
gst_rate: calculation.gst.rate,
service_fee_amount: paymentData.service_fee_amount,
invoice_items: paymentData.invoice_items,
status: 'pending_approval',
requires_gst_invoice: true,

// Add the missing fields by extracting from invoice items
event_name: paymentData.invoice_items?.[0]?.description || currentLead?.lead_for_event || 'General Event',
event_date: paymentData.payment_date || new Date().toISOString().split('T')[0],
tickets_allocated: parseInt(paymentData.invoice_items?.[0]?.quantity) || 1,
ticket_category: paymentData.category_of_sale || 'General',
price_per_ticket: paymentData.invoice_items?.[0]?.rate || 0,
total_amount: baseAmount,
base_amount: baseAmount,
gst_calculation: calculation.gst,
tcs_calculation: calculation.tcs,
total_tax: totalTax,
final_amount: finalAmount,

// CRITICAL: Add required fields that might be missing
created_date: new Date().toISOString(),
created_at: new Date().toISOString(),
created_by: user.name || user.email || 'System',
payment_currency: paymentData.payment_currency || 'INR',
payment_status: 'paid',
order_type: 'standard'
};



console.log('=== ENHANCED ORDER CREATION DEBUG ===');
console.log('Order data to create:', JSON.stringify(orderData, null, 2));
console.log('Order data size:', JSON.stringify(orderData).length, 'characters');

let orderResponse;
try {
console.log('=== CREATING ORDER WITH FIXED API CALL ===');

// FIXED: Use correct apiCall format
orderResponse = await apiCall('/orders', {
method: 'POST',
body: JSON.stringify(orderData)
});

console.log('=== ORDER CREATION RESPONSE ===');
console.log('Response:', orderResponse);
console.log('Response type:', typeof orderResponse);
console.log('Response keys:', Object.keys(orderResponse || {}));

// CRITICAL CHECK: Validate this is actually a created order, not a list
if (Array.isArray(orderResponse)) {
console.error('‚ùå API RETURNED ARRAY INSTEAD OF CREATED ORDER');
console.error('This means the POST request was treated as GET');
throw new Error('API returned orders list instead of creating new order. Check backend routes.');
}

if (orderResponse && Array.isArray(orderResponse.data)) {
console.error('‚ùå API RETURNED ORDERS LIST INSTEAD OF CREATED ORDER');
console.error('Response data is array of length:', orderResponse.data.length);
throw new Error('API returned existing orders list instead of creating new order. Backend routing issue.');
}

// Check if we got a valid order back
const createdOrder = orderResponse.data || orderResponse;
if (!createdOrder || (!createdOrder.id && !createdOrder.order_number)) {
console.error('‚ùå INVALID ORDER RESPONSE');
console.error('Expected: order object with id or order_number');
console.error('Received:', createdOrder);
throw new Error('Server did not return a valid created order');
}

console.log('‚úÖ ORDER CREATED SUCCESSFULLY');
console.log('Created order ID:', createdOrder.id);
console.log('Created order number:', createdOrder.order_number);
console.log('Created order status:', createdOrder.status);

} catch (error) {
console.error('=== ORDER CREATION FAILED ===');
console.error('Error type:', error.constructor.name);
console.error('Error message:', error.message);
console.error('Full error:', error);

// Specific error messages for common issues
if (error.message.includes('orders list')) {
alert('‚ùå Backend Issue: The API is returning existing orders instead of creating a new one.\n\nThis indicates a problem with your backend routing for POST /orders.\n\nPlease check your backend orders.js route file.');
} else {
alert(`‚ùå Order creation failed: ${error.message}\n\nCheck console for full details.`);
}

setLoading(false);
return;
}

console.log('=== VERIFYING ORDER IN BACKEND ===');

// Wait a moment then verify
await new Promise(resolve => setTimeout(resolve, 2000));

try {
console.log('Verifying order was actually saved...');

// FIXED: Use correct apiCall format for verification
const verifyResponse = await apiCall('/orders');
const allOrders = verifyResponse.data || verifyResponse;

console.log('Total orders in backend after creation:', allOrders.length);
console.log('Previous count was: 3');

if (allOrders.length > 3) {
console.log('‚úÖ ORDER COUNT INCREASED - SUCCESS!');

// Find our new order
const newOrder = allOrders.find(o => 
o.lead_id === currentLead.id || 
o.order_number === orderData.order_number
);

if (newOrder) {
console.log('‚úÖ FOUND OUR NEW ORDER:', newOrder.id);
console.log('New order details:', newOrder);
}

// Update local state with all fresh orders
setOrders(allOrders);
console.log('‚úÖ LOCAL STATE UPDATED');

} else {
console.error('‚ùå ORDER COUNT DID NOT INCREASE');
console.error('Expected more than 3 orders, got:', allOrders.length);
alert('‚ö†Ô∏è Order creation may have failed. The order count did not increase.');
}

} catch (verifyError) {
console.error('Failed to verify order creation:', verifyError);

// Fallback: try using apiCall for refresh
try {
const fallbackResponse = await apiCall('/orders');
const fallbackOrders = fallbackResponse.data || fallbackResponse || [];
setOrders(fallbackOrders);
console.log('Fallback refresh completed, orders:', fallbackOrders.length);
} catch (fallbackError) {
console.error('Fallback refresh also failed:', fallbackError);
}
}

// Update lead status
await updateLeadStatus(currentLead.id, 'payment_received');

setLoading(false);
alert(paymentData.payment_post_service 
? 'Payment collected successfully! Invoice can now be generated.' 
: 'Payment details submitted successfully! Order created and sent for finance approval.'
);
closeForm();

// Enhanced page refresh trigger
setTimeout(() => {
if (activeTab === 'orders') {
console.log('Triggering orders page refresh...');
// Force re-render of orders page
setActiveTab('dashboard');
setTimeout(() => setActiveTab('orders'), 100);
}

// Additional verification
setTimeout(() => {
console.log('=== FINAL VERIFICATION ===');
console.log('Orders in state after 3 seconds:', orders.length);
if (window.debugOrders) {
console.log('Running final API check...');
window.debugOrders().then(apiOrders => {
console.log('Final API check shows:', apiOrders.length, 'orders');
if (apiOrders.length > orders.length) {
console.log('‚ö†Ô∏è API has more orders than local state - refreshing...');
setOrders(apiOrders);
}
});
}
}, 3000);
}, 1000);

} catch (error) {
console.error('=== PAYMENT SUBMISSION ERROR ===');
console.error('Payment submission error:', error);
setLoading(false);
alert('Payment submission failed: ' + (error.message || 'Unknown error'));
}
};



// Generic form renderer with all sections
const renderForm = () => {
if (!showAddForm && !showEditForm) return null;

const isEdit = showEditForm;
const title = isEdit ? 'Edit Lead' : 'Create New Lead';

return React.createElement('div', {
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4',
onClick: (e) => {
if (e.target === e.currentTarget) {
closeForm();
}
}
},
React.createElement('div', {
className: 'bg-white rounded-lg w-full max-w-4xl max-h-[95vh] overflow-hidden',
onClick: (e) => e.stopPropagation()
},
// Header
React.createElement('div', { className: 'bg-blue-600 text-white p-6' },
React.createElement('div', { className: 'flex justify-between items-center' },
React.createElement('h2', { className: 'text-2xl font-bold' }, title),
React.createElement('button', {
onClick: closeForm,
className: 'text-white hover:text-gray-200 text-2xl font-bold'
}, '√ó')
)
),

// Form Content
React.createElement('div', { className: 'p-6 overflow-y-auto max-h-[calc(95vh-140px)]' },

// Client Detection Alert (New Feature)
showClientSuggestion && clientSuggestion && React.createElement('div', { 
className: 'mb-6 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg'
},
React.createElement('div', { className: 'flex items-start' },
React.createElement('div', { className: 'flex-shrink-0' },
React.createElement('span', { className: 'text-2xl' }, '‚ö†Ô∏è')
),
React.createElement('div', { className: 'ml-3 flex-1' },
React.createElement('h3', { className: 'text-lg font-medium text-yellow-800 mb-2' }, 
'üîç Existing Client Detected!'
),
React.createElement('div', { className: 'text-sm text-yellow-700 mb-3' },
React.createElement('p', { className: 'mb-2' }, 
`This phone number belongs to an existing client with ${clientSuggestion.client_history.length} previous lead(s).`
),
React.createElement('p', { className: 'font-medium' }, 
clientSuggestion.suggested_reason
)
),

// Client History Preview
React.createElement('div', { className: 'bg-white rounded-lg p-3 mb-3 border border-yellow-200' },
React.createElement('h4', { className: 'font-medium text-gray-900 mb-2' }, 
'üìã Previous Leads:'
),
React.createElement('div', { className: 'space-y-2' },
clientSuggestion.client_history.slice(0, 2).map((lead, index) =>
React.createElement('div', { 
key: index, 
className: 'flex justify-between text-sm border-b border-gray-100 pb-1'
},
React.createElement('span', null, 
  `${lead.lead_for_event || 'General'} - ${lead.status}`
),
React.createElement('span', { className: 'text-gray-500' }, 
  new Date(lead.date_of_enquiry || lead.created_date).toLocaleDateString()
)
)
),
clientSuggestion.client_history.length > 2 && 
React.createElement('div', { className: 'text-xs text-gray-500 italic' },
`+${clientSuggestion.client_history.length - 2} more leads`
)
)
),

// Events Interested
clientSuggestion.events_interested && clientSuggestion.events_interested.length > 0 &&
React.createElement('div', { className: 'mb-3' },
React.createElement('span', { className: 'text-sm font-medium text-yellow-800' }, 
'üé´ Previously interested in: '
),
React.createElement('span', { className: 'text-sm text-yellow-700' }, 
clientSuggestion.events_interested.join(', ')
)
),

// Action Buttons
React.createElement('div', { className: 'flex space-x-3' },
React.createElement('button', {
onClick: applyClientSuggestion,
className: 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium'
}, '‚úì Use Suggested Assignment'),
React.createElement('button', {
onClick: () => setShowClientSuggestion(false),
className: 'bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium'
}, 'Continue Anyway'),
React.createElement('button', {
onClick: () => {
setShowClientSuggestion(false);
// Open client detail for this client
fetchClients().then(() => {
const client = clients.find(c => 
  c.leads.some(l => l.phone === formData.phone)
);
if (client) {
  setSelectedClient(client);
  setShowClientDetail(true);
  closeForm();
}
});
},
className: 'bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium'
}, 'üëÅÔ∏è View Client Details')
)
)
)
),

// Phone Check Loading Indicator
phoneCheckLoading && React.createElement('div', { 
className: 'mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3 text-center'
},
React.createElement('div', { className: 'flex items-center justify-center' },
React.createElement('div', { className: 'animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2' }),
React.createElement('span', { className: 'text-sm text-blue-700' }, 'Checking for existing client...')
)
),

// Complete Form Fields (All Your Original Fields + Smart Detection)
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },

// Basic Information Section
React.createElement('div', { className: 'space-y-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 border-b pb-2' }, 
'üë§ Basic Information'
),

// Name Field
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Contact Name *'
),
React.createElement('input', {
type: 'text',
value: formData.name || '',
onChange: (e) => setFormData(prev => ({ ...prev, name: e.target.value })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
required: true,
placeholder: 'Enter full name'
})
),

// Email Field
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Email *'
),
React.createElement('input', {
type: 'email',
value: formData.email || '',
onChange: (e) => setFormData(prev => ({ ...prev, email: e.target.value })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
required: true,
placeholder: 'Enter email address'
})
),

// Phone Field with Smart Detection (Enhanced)
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Phone *',
phoneCheckLoading && React.createElement('span', { className: 'ml-2 text-blue-600' }, 'üîç')
),
React.createElement('input', {
type: 'tel',
value: formData.phone || '',
onChange: (e) => {
const value = e.target.value;
// Update form data immediately for responsive typing
setFormData(prev => ({ ...prev, phone: value }));

// Clear existing timeout
if (phoneCheckTimeout) {
clearTimeout(phoneCheckTimeout);
}

// Only check for clients if phone has enough digits
if (value && value.length >= 10) {
// Set new timeout for phone check (debounce)
const newTimeout = setTimeout(() => {
checkPhoneForClient(value);
}, 1000); // Check after 1 second of no typing

setPhoneCheckTimeout(newTimeout);
} else {
// Clear suggestions if phone is too short
setClientSuggestion(null);
setShowClientSuggestion(false);
}
},
className: `w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${
showClientSuggestion ? 'border-yellow-400 bg-yellow-50' : ''
}`,
required: true,
placeholder: 'Enter phone number'
}),
React.createElement('div', { className: 'text-xs text-gray-500 mt-1' }, 
'Phone numbers help detect existing clients and suggest smart assignments'
)
),

// Company Field
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Company'
),
React.createElement('input', {
type: 'text',
value: formData.company || '',
onChange: (e) => setFormData(prev => ({ ...prev, company: e.target.value })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
placeholder: 'Enter company name'
})
),

// Business Type
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Business Type *'
),
React.createElement('select', {
value: formData.business_type || 'B2C',
onChange: (e) => setFormData(prev => ({ ...prev, business_type: e.target.value })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
required: true
},
React.createElement('option', { value: 'B2C' }, 'B2C (Business to Consumer)'),
React.createElement('option', { value: 'B2B' }, 'B2B (Business to Business)')
)
)
),

// Source & Initial Contact Section
React.createElement('div', { className: 'space-y-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 border-b pb-2' }, 
'üì± Source & Initial Contact'
),

// Source Field - Extended Options
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Source of Lead *'
),
React.createElement('select', {
value: formData.source || '',
onChange: (e) => setFormData(prev => ({ ...prev, source: e.target.value })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
required: true
},
React.createElement('option', { value: '' }, 'Select source'),
['Facebook', 'Instagram', 'LinkedIn', 'Friends and Family', 'Through Champion', 
'Website', 'Existing Client', 'Contacted on Social Media', 'Middlemen', 
'Wealth Management Firm', 'Media Agency', 'Concierge Desk', 
'Travel Partner', 'Travel OTA', 'WhatsApp', 'Email Campaign', 'Cold Call', 'Exhibition', 'Other'].map(source =>
React.createElement('option', { key: source, value: source }, source)
)
)
),

// Date of Enquiry
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Date of Enquiry *'
),
React.createElement('input', {
type: 'date',
value: formData.date_of_enquiry || '',
onChange: (e) => setFormData(prev => ({ ...prev, date_of_enquiry: e.target.value })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
required: true
})
),

// First Touch Base Done By
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'First Touch Base Done By'
),
React.createElement('input', {
type: 'text',
value: formData.first_touch_base_done_by || '',
onChange: (e) => setFormData(prev => ({ ...prev, first_touch_base_done_by: e.target.value })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
placeholder: 'Who made first contact'
})
),

// Assignment Field (Enhanced with Client Suggestion)
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Assign To',
clientSuggestion && React.createElement('span', { className: 'ml-2 text-blue-600 text-xs' }, 
'(Suggested based on client history)'
)
),
React.createElement('select', {
value: formData.assigned_to || '',
onChange: (e) => setFormData(prev => ({ ...prev, assigned_to: e.target.value })),
className: `w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${
clientSuggestion && formData.assigned_to === clientSuggestion.suggested_assigned_to ? 'bg-blue-50 border-blue-400' : ''
}`
},
React.createElement('option', { value: '' }, 'Select sales person'),
users.filter(u => u.role && ['sales_executive', 'sales_manager', 'admin', 'super_admin'].includes(u.role))
.map(user =>
React.createElement('option', { 
key: user.email, 
value: user.email,
selected: clientSuggestion && user.email === clientSuggestion.suggested_assigned_to
}, user.name || user.email)
)
),
clientSuggestion && formData.assigned_to === clientSuggestion.suggested_assigned_to &&
React.createElement('div', { className: 'text-xs text-blue-600 mt-1' }, 
'‚úì Smart suggestion applied - keeping client with same sales person'
)
)
)
),

// Location Information Section
React.createElement('div', { className: 'mt-6' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 border-b pb-2 mb-4' }, 
'üìç Location Information'
),
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'City of Residence'
),
React.createElement('input', {
type: 'text',
value: formData.city_of_residence || '',
onChange: (e) => setFormData(prev => ({ ...prev, city_of_residence: e.target.value })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
placeholder: 'Enter city'
})
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Country of Residence'
),
React.createElement('input', {
type: 'text',
value: formData.country_of_residence || 'India',
onChange: (e) => setFormData(prev => ({ ...prev, country_of_residence: e.target.value })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
})
)
)
),

// Event & Travel Details Section
React.createElement('div', { className: 'mt-6' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 border-b pb-2 mb-4' }, 
'üé´ Event & Travel Details'
),
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
// Event Field
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Lead for Event'
),
React.createElement('select', {
value: formData.lead_for_event || '',
onChange: (e) => setFormData(prev => ({ ...prev, lead_for_event: e.target.value })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
},
React.createElement('option', { value: '' }, 'Select an event'),
// Get events from inventory dynamically
inventory && inventory.length > 0 ? 
Array.from(new Set(inventory.map(item => item.event_name).filter(Boolean))).sort().map(event =>
React.createElement('option', { key: event, value: event }, event)
) :
// Fallback events if inventory not loaded
events && events.length > 0 ? events.map(event =>
React.createElement('option', { key: event, value: event }, event)
) : [
React.createElement('option', { key: 'general', value: 'General Inquiry' }, 'General Inquiry'),
React.createElement('option', { key: 'cricket', value: 'Cricket Events' }, 'Cricket Events'),
React.createElement('option', { key: 'football', value: 'Football Events' }, 'Football Events'),
React.createElement('option', { key: 'tennis', value: 'Tennis Events' }, 'Tennis Events')
]
)
),

// Number of People
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Number of People'
),
React.createElement('input', {
type: 'number',
min: '1',
value: formData.number_of_people || 1,
onChange: (e) => setFormData(prev => ({ ...prev, number_of_people: parseInt(e.target.value) || 1 })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
})
),

// Has Valid Passport
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Has Valid Passport'
),
React.createElement('select', {
value: formData.has_valid_passport || 'Not Sure',
onChange: (e) => setFormData(prev => ({ ...prev, has_valid_passport: e.target.value })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
},
React.createElement('option', { value: 'Yes' }, 'Yes'),
React.createElement('option', { value: 'No' }, 'No'),
React.createElement('option', { value: 'Not Sure' }, 'Not Sure')
)
),

// Visa Available
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Visa Available'
),
React.createElement('select', {
value: formData.visa_available || 'Not Required',
onChange: (e) => setFormData(prev => ({ ...prev, visa_available: e.target.value })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
},
React.createElement('option', { value: 'Required' }, 'Required'),
React.createElement('option', { value: 'Not Required' }, 'Not Required'),
React.createElement('option', { value: 'Processing' }, 'Processing'),
React.createElement('option', { value: 'In Process' }, 'In Process'),
React.createElement('option', { value: 'Not Sure' }, 'Not Sure')
)
)
)
),

// Experience & Background Section
React.createElement('div', { className: 'mt-6' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 border-b pb-2 mb-4' }, 
'üèÜ Experience & Background'
),
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Attended Sporting Event Before'
),
React.createElement('select', {
value: formData.attended_sporting_event_before || 'No',
onChange: (e) => setFormData(prev => ({ ...prev, attended_sporting_event_before: e.target.value })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
},
React.createElement('option', { value: 'Yes' }, 'Yes'),
React.createElement('option', { value: 'No' }, 'No')
)
)
)
),

// Business & Financial Information Section  
React.createElement('div', { className: 'mt-6' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 border-b pb-2 mb-4' }, 
'üí∞ Business & Financial Information'
),
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Annual Income Bracket'
),
React.createElement('select', {
value: formData.annual_income_bracket || '',
onChange: (e) => setFormData(prev => ({ ...prev, annual_income_bracket: e.target.value })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
},
React.createElement('option', { value: '' }, 'Select income bracket'),
React.createElement('option', { value: '‚Çπ5-10 Lakhs' }, '‚Çπ5-10 Lakhs'),
React.createElement('option', { value: '‚Çπ10-25 Lakhs' }, '‚Çπ10-25 Lakhs'),
React.createElement('option', { value: '‚Çπ25-50 Lakhs' }, '‚Çπ25-50 Lakhs'),
React.createElement('option', { value: '‚Çπ50 Lakhs - ‚Çπ1 Crore' }, '‚Çπ50 Lakhs - ‚Çπ1 Crore'),
React.createElement('option', { value: '‚Çπ1-2 Crores' }, '‚Çπ1-2 Crores'),
React.createElement('option', { value: '‚Çπ2-5 Crores' }, '‚Çπ2-5 Crores'),
React.createElement('option', { value: 'Above ‚Çπ5 Crores' }, 'Above ‚Çπ5 Crores'),
React.createElement('option', { value: 'Prefer not to say' }, 'Prefer not to say')
)
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Potential Value (‚Çπ)'
),
React.createElement('input', {
type: 'number',
min: '0',
value: formData.potential_value || 0,
onChange: (e) => setFormData(prev => ({ ...prev, potential_value: parseInt(e.target.value) || 0 })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
placeholder: 'Estimated deal value'
})
)
)
),

// Sales Information Section
React.createElement('div', { className: 'mt-6' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 border-b pb-2 mb-4' }, 
'üíº Sales Information'
),
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Status'
),
React.createElement('select', {
value: formData.status || 'unassigned',
onChange: (e) => setFormData(prev => ({ ...prev, status: e.target.value })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
},
// Initial Contact Statuses
React.createElement('option', { value: 'unassigned' }, 'Unassigned'),
React.createElement('option', { value: 'assigned' }, 'Assigned'),
React.createElement('option', { value: 'contacted' }, 'Contacted'),
React.createElement('option', { value: 'attempt_1' }, 'Attempt 1'),
React.createElement('option', { value: 'attempt_2' }, 'Attempt 2'),
React.createElement('option', { value: 'attempt_3' }, 'Attempt 3'),

// Qualification Statuses
React.createElement('option', { value: 'qualified' }, 'Qualified'),
React.createElement('option', { value: 'junk' }, 'Junk'),

// Temperature Statuses
React.createElement('option', { value: 'hot' }, 'Hot'),
React.createElement('option', { value: 'warm' }, 'Warm'),
React.createElement('option', { value: 'cold' }, 'Cold'),

// Sales Process Statuses
React.createElement('option', { value: 'quote_requested' }, 'Quote Requested'),
React.createElement('option', { value: 'converted' }, 'Converted'),
React.createElement('option', { value: 'dropped' }, 'Dropped'),

// Payment Statuses
React.createElement('option', { value: 'payment' }, 'Payment'),
React.createElement('option', { value: 'payment_post_service' }, 'Payment Post Service'),
React.createElement('option', { value: 'payment_received' }, 'Payment Received')
)
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Last Quoted Price (‚Çπ)'
),
React.createElement('input', {
type: 'number',
min: '0',
value: formData.last_quoted_price || 0,
onChange: (e) => setFormData(prev => ({ ...prev, last_quoted_price: parseInt(e.target.value) || 0 })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
placeholder: 'Last quoted amount'
})
)
)
),

// Notes Section
React.createElement('div', { className: 'mt-6' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Notes'
),
React.createElement('textarea', {
value: formData.notes || '',
onChange: (e) => setFormData(prev => ({ ...prev, notes: e.target.value })),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
rows: 3,
placeholder: 'Add any additional notes or comments...'
})
)
),

// Footer with Action Buttons
React.createElement('div', { className: 'bg-gray-50 px-6 py-4 flex justify-between items-center border-t' },
React.createElement('div', { className: 'text-sm text-gray-600' },
showClientSuggestion ? 
'‚ö†Ô∏è This phone number belongs to an existing client' :
'‚ú® Smart client detection active'
),
React.createElement('div', { className: 'flex space-x-3' },
React.createElement('button', {
onClick: closeForm,
className: 'px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50'
}, 'Cancel'),
React.createElement('button', {
onClick: handleFormSubmit,
disabled: loading || !formData.name || !formData.email,
className: 'px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed'
}, loading ? 'Saving...' : (isEdit ? 'Update Lead' : 'Create Lead'))
)
)
)
);
};



// Client Detail Modal Component - Shows complete client timeline and relationship history
// Add this component to your frontend

// First, add this function with your other modal rendering functions (around line 2000-3000)
const renderClientDetailModal = () => {
if (!showClientDetail || !selectedClient) return null;

const primaryLead = selectedClient.leads[0];
const sortedLeads = selectedClient.leads.sort((a, b) => 
new Date(a.date_of_enquiry || a.created_date) - new Date(b.date_of_enquiry || b.created_date)
);

return React.createElement('div', {
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50',
onClick: (e) => {
if (e.target === e.currentTarget) {
setShowClientDetail(false);
setSelectedClient(null);
}
}
},
React.createElement('div', {
className: 'bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden',
onClick: (e) => e.stopPropagation()
},
// Modal Header
React.createElement('div', { className: 'bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6' },
React.createElement('div', { className: 'flex justify-between items-start' },
React.createElement('div', null,
React.createElement('h2', { className: 'text-2xl font-bold mb-2' }, 
'üë• Client Profile: ' + primaryLead.name
),
React.createElement('div', { className: 'flex flex-wrap gap-4 text-blue-100' },
React.createElement('span', null, 'üìû ' + primaryLead.phone),
React.createElement('span', null, 'üìß ' + primaryLead.email),
React.createElement('span', null, 'üè¢ ' + (primaryLead.company || 'No Company')),
React.createElement('span', null, 'üìç ' + (primaryLead.city_of_residence || 'Unknown') + ', ' + (primaryLead.country_of_residence || 'Unknown'))
)
),
React.createElement('button', {
onClick: () => {
setShowClientDetail(false);
setSelectedClient(null);
},
className: 'text-white hover:text-gray-200 text-2xl font-bold'
}, '√ó')
)
),

// Modal Content
React.createElement('div', { className: 'p-6 overflow-y-auto max-h-[calc(90vh-140px)]' },

// Client Summary Cards
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-4 gap-4 mb-6' },
React.createElement('div', { className: 'bg-blue-50 border border-blue-200 rounded-lg p-4 text-center' },
React.createElement('div', { className: 'text-2xl font-bold text-blue-900' }, selectedClient.total_leads),
React.createElement('div', { className: 'text-sm text-blue-700' }, 'Total Leads'),
React.createElement('div', { className: 'text-xs text-blue-600 mt-1' }, 
selectedClient.total_leads > 1 ? 'Multi-lead client' : 'Single lead client'
)
),
React.createElement('div', { className: 'bg-green-50 border border-green-200 rounded-lg p-4 text-center' },
React.createElement('div', { className: 'text-2xl font-bold text-green-900' }, 
selectedClient.events.length
),
React.createElement('div', { className: 'text-sm text-green-700' }, 'Events Interested'),
React.createElement('div', { className: 'text-xs text-green-600 mt-1' }, 
selectedClient.events.slice(0, 2).join(', ') || 'None specified'
)
),
React.createElement('div', { className: 'bg-purple-50 border border-purple-200 rounded-lg p-4 text-center' },
React.createElement('div', { className: 'text-2xl font-bold text-purple-900' }, 
'‚Çπ' + (selectedClient.total_value || 0).toLocaleString()
),
React.createElement('div', { className: 'text-sm text-purple-700' }, 'Total Value'),
React.createElement('div', { className: 'text-xs text-purple-600 mt-1' }, 
'Across all leads'
)
),
React.createElement('div', { className: 'bg-orange-50 border border-orange-200 rounded-lg p-4 text-center' },
React.createElement('div', { className: 'text-2xl font-bold text-orange-900' }, 
Math.ceil((new Date() - new Date(selectedClient.first_contact)) / (1000 * 60 * 60 * 24))
),
React.createElement('div', { className: 'text-sm text-orange-700' }, 'Days as Client'),
React.createElement('div', { className: 'text-xs text-orange-600 mt-1' }, 
'Since first contact'
)
)
),

// Client Relationship Info
React.createElement('div', { className: 'bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3 flex items-center' },
React.createElement('span', { className: 'mr-2' }, 'üîó'),
'Client Relationship Summary'
),
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700' }, 'Assigned To'),
React.createElement('div', { className: 'mt-1 text-sm text-gray-900' }, 
selectedClient.assigned_to ? getUserDisplayName(selectedClient.assigned_to, users) : 'Unassigned'
)
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700' }, 'Client Status'),
React.createElement('span', { 
className: `inline-flex mt-1 px-2 py-1 text-xs rounded-full ${
selectedClient.status === 'converted' ? 'bg-green-100 text-green-800' :
selectedClient.status === 'dropped' ? 'bg-red-100 text-red-800' :
'bg-yellow-100 text-yellow-800'
}`
}, selectedClient.status || 'Active')
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700' }, 'Last Activity'),
React.createElement('div', { className: 'mt-1 text-sm text-gray-900' }, 
new Date(selectedClient.last_activity).toLocaleDateString()
)
)
)
),

// Lead Timeline Section
React.createElement('div', { className: 'mb-6' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-4 flex items-center' },
React.createElement('span', { className: 'mr-2' }, 'üìã'),
'Complete Lead Timeline (' + sortedLeads.length + ' leads)'
),

// Timeline Container
React.createElement('div', { className: 'space-y-4' },
sortedLeads.map((lead, index) => {
const status = LEAD_STATUSES[lead.status] || { label: lead.status, color: 'bg-gray-100 text-gray-800' };
const isLatest = index === sortedLeads.length - 1;

return React.createElement('div', { 
key: lead.id, 
className: `relative ${isLatest ? 'ring-2 ring-blue-200' : ''} bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow`
},
// Timeline Connector (except for last item)
index < sortedLeads.length - 1 && React.createElement('div', {
className: 'absolute left-8 -bottom-4 w-0.5 h-8 bg-gray-300'
}),

// Lead Content
React.createElement('div', { className: 'flex items-start space-x-4' },
// Timeline Dot
React.createElement('div', { 
className: `flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold ${
isLatest ? 'bg-blue-600' : 'bg-gray-400'
}`
}, index + 1),

// Lead Details
React.createElement('div', { className: 'flex-grow' },
React.createElement('div', { className: 'flex justify-between items-start mb-2' },
React.createElement('div', null,
  React.createElement('h4', { 
      className: `font-medium text-gray-900 ${isLatest ? 'text-blue-900' : ''}`
  }, 
      'Lead #' + (index + 1) + (isLatest ? ' (Latest)' : ''),
      lead.lead_for_event && React.createElement('span', { className: 'ml-2 text-sm text-gray-600' }, 
          '‚Üí ' + lead.lead_for_event
      )
  ),
  React.createElement('div', { className: 'text-sm text-gray-600 mt-1' },
      'Created: ' + new Date(lead.date_of_enquiry || lead.created_date).toLocaleDateString(),
      lead.updated_date && lead.updated_date !== lead.created_date && 
      React.createElement('span', { className: 'ml-3' }, 
          'Updated: ' + new Date(lead.updated_date).toLocaleDateString()
      )
  )
),
React.createElement('div', { className: 'flex items-center space-x-2' },
  React.createElement('span', {
      className: 'px-2 py-1 text-xs rounded-full ' + status.color
  }, status.label),
  isLatest && React.createElement('span', {
      className: 'px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800'
  }, 'Current')
)
),

// Lead Details Grid
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4 mt-3' },
React.createElement('div', null,
  React.createElement('label', { className: 'block text-xs font-medium text-gray-500' }, 'Event & People'),
  React.createElement('div', { className: 'text-sm text-gray-900' }, 
      (lead.lead_for_event || 'Not specified'),
      lead.number_of_people && React.createElement('span', { className: 'text-gray-600 ml-2' }, 
          '(' + lead.number_of_people + ' people)'
      )
  )
),
React.createElement('div', null,
  React.createElement('label', { className: 'block text-xs font-medium text-gray-500' }, 'Source & Type'),
  React.createElement('div', { className: 'text-sm text-gray-900' }, 
      (lead.source || 'Unknown') + ' ‚Ä¢ ' + (lead.business_type || 'B2C')
  )
),
React.createElement('div', null,
  React.createElement('label', { className: 'block text-xs font-medium text-gray-500' }, 'Value'),
  React.createElement('div', { className: 'text-sm text-gray-900' }, 
      lead.potential_value ? '‚Çπ' + lead.potential_value.toLocaleString() : 'Not specified',
      lead.last_quoted_price && React.createElement('div', { className: 'text-xs text-green-600' }, 
          'Quoted: ‚Çπ' + lead.last_quoted_price.toLocaleString()
      )
  )
)
),

// Notes Section (if exists)
lead.notes && React.createElement('div', { className: 'mt-3 p-3 bg-gray-50 rounded-md' },
React.createElement('label', { className: 'block text-xs font-medium text-gray-500 mb-1' }, 'Notes'),
React.createElement('div', { className: 'text-sm text-gray-700' }, lead.notes)
),

// Action Buttons for this lead
React.createElement('div', { className: 'mt-3 flex space-x-2' },
React.createElement('button', {
  onClick: () => {
      setShowClientDetail(false);
      setSelectedClient(null);
      openLeadDetail(lead);
  },
  className: 'text-xs text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded border'
}, 'üëÅÔ∏è View Details'),
hasPermission('leads', 'write') && React.createElement('button', {
  onClick: () => {
      setShowClientDetail(false);
      setSelectedClient(null);
      openEditForm(lead);
  },
  className: 'text-xs text-green-600 hover:text-green-800 bg-green-50 hover:bg-green-100 px-2 py-1 rounded border'
}, '‚úèÔ∏è Edit Lead'),
hasPermission('leads', 'progress') && React.createElement('button', {
  onClick: () => {
      setShowClientDetail(false);
      setSelectedClient(null);
      if (lead.status === 'unassigned' && !lead.assigned_to) {
          openAssignForm(lead);
      } else {
          handleLeadProgression(lead);
      }
  },
  className: 'text-xs text-purple-600 hover:text-purple-800 bg-purple-50 hover:bg-purple-100 px-2 py-1 rounded border'
}, '‚Üí Progress')
)
)
)
);
})
)
),

// Client Actions Section
React.createElement('div', { className: 'bg-gray-50 border border-gray-200 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3 flex items-center' },
React.createElement('span', { className: 'mr-2' }, '‚ö°'),
'Client Actions'
),
React.createElement('div', { className: 'flex flex-wrap gap-3' },
hasPermission('leads', 'write') && React.createElement('button', {
onClick: () => {
setShowClientDetail(false);
setSelectedClient(null);
// Pre-fill lead form with client data
setFormData({
name: primaryLead.name,
email: primaryLead.email,
phone: primaryLead.phone,
company: primaryLead.company || '',
business_type: primaryLead.business_type || 'B2C',
source: '',
date_of_enquiry: (() => {
const now = new Date();
const year = now.getFullYear();
const month = String(now.getMonth() + 1).padStart(2, '0');
const day = String(now.getDate()).padStart(2, '0');
return `${year}-${month}-${day}`;
})(),
first_touch_base_done_by: '',
city_of_residence: primaryLead.city_of_residence || '',
country_of_residence: primaryLead.country_of_residence || 'India',
lead_for_event: '',
number_of_people: 1,
has_valid_passport: primaryLead.has_valid_passport || 'Not Sure',
visa_available: primaryLead.visa_available || 'Not Required',
attended_sporting_event_before: primaryLead.attended_sporting_event_before || 'No',
annual_income_bracket: primaryLead.annual_income_bracket || '',
potential_value: 0,
status: 'unassigned',
assigned_to: selectedClient.assigned_to || '',
last_quoted_price: 0,
notes: ''
});
setShowLeadForm(true);
},
className: 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2'
}, 
React.createElement('span', null, '+'),
'Add New Lead for this Client'
),
hasPermission('leads', 'assign') && selectedClient.total_leads > 1 && React.createElement('button', {
onClick: () => {
// Bulk reassign functionality - placeholder for now
if (confirm(`Reassign all ${selectedClient.total_leads} leads for this client to a new sales person?`)) {
alert(`Bulk reassign for ${selectedClient.total_leads} leads coming in next update!`);
}
},
className: 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2'
}, 
React.createElement('span', null, 'üë•'),
'Bulk Reassign All Leads'
),
React.createElement('button', {
onClick: () => setViewMode('leads'),
className: 'bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2'
}, 
React.createElement('span', null, 'üìã'),
'Switch to Lead View'
),
React.createElement('button', {
onClick: () => {
setShowClientDetail(false);
setSelectedClient(null);
},
className: 'bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium'
}, 'Close')
)
)
)
)
);
};



// Add this to your main render function where you have other modals (around line 4000-5000)
// Add this line in your main return statement where you have other modals like:
// showLeadDetail && renderLeadDetailModal(),
// showLeadForm && renderLeadFormModal(),
// Add this line:
// showClientDetail && renderClientDetailModal(),

// Enhanced Lead Detail View with permission-based actions
const renderLeadDetail = () => {
if (!showLeadDetail || !currentLead) return null;

const status = LEAD_STATUSES[currentLead.status] || { label: currentLead.status, color: 'bg-gray-100 text-gray-800', next: [] };
const nextActions = status.next || [];

return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
onClick: (e) => e.target === e.currentTarget && closeForm()
},
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg w-full max-w-6xl max-h-[95vh] overflow-y-auto' },
React.createElement('div', { className: 'sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center' },
React.createElement('div', null,
React.createElement('h2', { className: 'text-2xl font-bold text-gray-900' }, currentLead.name),
React.createElement('div', { className: 'flex items-center mt-2 space-x-4' },
React.createElement('span', {
className: 'px-3 py-1 text-sm rounded-full ' + (status.color)
}, status.label),
currentLead.assigned_to && React.createElement('span', { className: 'text-sm text-blue-600' }, 
'Assigned to: ' + getUserDisplayName(currentLead.assigned_to, users)
),
// Show auto-assignment info if available
currentLead.auto_assigned && React.createElement('span', { className: 'text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded' }, 
'ü§ñ Auto-assigned'
)
)
),
React.createElement('button', {
onClick: closeForm,
className: 'text-gray-400 hover:text-gray-600 text-2xl'
}, '‚úï')
),

React.createElement('div', { className: 'p-6' },
React.createElement('div', { className: 'mb-6 flex flex-wrap gap-2' },
hasPermission('leads', 'write') && React.createElement('button', { 
className: 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700',
onClick: () => {
closeForm();
setTimeout(() => openEditForm(currentLead), 100);
}
}, '‚úèÔ∏è Edit Lead'),
hasPermission('leads', 'assign') && !currentLead.assigned_to && currentLead.status === 'unassigned' &&
React.createElement('button', { 
className: 'bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700',
onClick: () => {
closeForm();
setTimeout(() => openAssignForm(currentLead), 100);
}
}, 'üë§ Assign'),
hasPermission('leads', 'progress') && nextActions.length > 0 && React.createElement('button', {
className: 'bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700',
onClick: () => {
handleLeadProgression(currentLead);
}
}, '‚Üí Progress Lead'),
hasPermission('leads', 'write') && currentLead.status === 'converted' &&
React.createElement('button', { 
className: 'bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700',
onClick: () => {
closeForm();
setTimeout(() => openPaymentForm(currentLead), 100);
}
}, 'üí≥ Collect Payment')
),

// Auto-assignment details section (NEW)
currentLead.auto_assigned && React.createElement('div', { className: 'mb-6 bg-purple-50 border border-purple-200 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-purple-900 mb-3 flex items-center gap-2' },
React.createElement('span', null, 'ü§ñ'),
'Auto-Assignment Details'
),
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4 text-sm' },
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-purple-700' }, 'Rule Used: '),
React.createElement('span', { className: 'text-purple-900' }, currentLead.assignment_rule_used || 'N/A')
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-purple-700' }, 'Reason: '),
React.createElement('span', { className: 'text-purple-900' }, currentLead.assignment_reason || 'N/A')
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-purple-700' }, 'Assigned To: '),
React.createElement('span', { className: 'text-purple-900' }, getUserDisplayName(currentLead.assigned_to, users) || currentLead.assigned_to)
),
currentLead.assignment_date && React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-purple-700' }, 'Assignment Date: '),
React.createElement('span', { className: 'text-purple-900' }, 
new Date(currentLead.assignment_date).toLocaleDateString()
)
)
)
),

React.createElement('div', { className: 'grid grid-cols-1 lg:grid-cols-2 gap-6' },
React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 'üìû Contact Information'),
React.createElement('div', { className: 'space-y-2' },
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Name: '),
React.createElement('span', { className: 'text-gray-900' }, currentLead.name)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Email: '),
React.createElement('a', { 
href: 'mailto:' + (currentLead.email),
className: 'text-blue-600 hover:underline' 
}, currentLead.email)
),
currentLead.phone && React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Phone: '),
React.createElement('a', { 
href: 'tel:' + (currentLead.phone),
className: 'text-blue-600 hover:underline' 
}, currentLead.phone)
),
currentLead.company && React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Company: '),
React.createElement('span', { className: 'text-gray-900' }, currentLead.company)
)
)
),

React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 'üé´ Event Interest'),
React.createElement('div', { className: 'space-y-2' },
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Event: '),
React.createElement('span', { className: 'text-gray-900' }, currentLead.lead_for_event || 'Not specified')
),
currentLead.number_of_people && React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Group Size: '),
React.createElement('span', { className: 'text-gray-900' }, currentLead.number_of_people + ' people')
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Location: '),
React.createElement('span', { className: 'text-gray-900' }, 
(currentLead.city_of_residence) + ', ' + (currentLead.country_of_residence)
)
)
)
),

hasPermission('finance', 'read') && React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 'üí∞ Financial Details'),
React.createElement('div', { className: 'space-y-2' },
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Potential Value: '),
React.createElement('span', { className: 'text-green-600 font-semibold' }, 
'‚Çπ' + (currentLead.potential_value || 0).toLocaleString()
)
),
currentLead.last_quoted_price && React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Last Quote: '),
React.createElement('span', { className: 'text-blue-600 font-semibold' }, 
'‚Çπ' + currentLead.last_quoted_price.toLocaleString()
)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Income Bracket: '),
React.createElement('span', { className: 'text-gray-900' }, 
currentLead.annual_income_bracket || 'Not specified'
)
)
)
),

React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 'üìä Lead Source'),
React.createElement('div', { className: 'space-y-2' },
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Source: '),
React.createElement('span', { className: 'text-gray-900' }, currentLead.source || 'Not specified')
),
currentLead.first_touch_base_done_by && React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'First Contact By: '),
React.createElement('span', { className: 'text-gray-900' }, currentLead.first_touch_base_done_by)
),
currentLead.date_of_enquiry && React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Enquiry Date: '),
React.createElement('span', { className: 'text-gray-900' }, 
new Date(currentLead.date_of_enquiry).toLocaleDateString()
)
)
)
)
),

currentLead.payment_details && React.createElement('div', { className: 'mt-6 bg-green-50 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 'üí≥ Payment Details'),
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Method: '),
React.createElement('span', { className: 'text-gray-900' }, currentLead.payment_details.payment_method)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Amount: '),
React.createElement('span', { className: 'text-green-600 font-semibold' }, 
'‚Çπ' + (currentLead.payment_details.payment_amount || 0).toLocaleString()
)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Transaction ID: '),
React.createElement('span', { className: 'text-gray-900' }, currentLead.payment_details.transaction_id)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Date: '),
React.createElement('span', { className: 'text-gray-900' }, 
new Date(currentLead.payment_details.payment_date).toLocaleDateString()
)
)
)
),

currentLead.notes && React.createElement('div', { className: 'mt-6 bg-yellow-50 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 'üìù Notes'),
React.createElement('p', { className: 'text-gray-900 whitespace-pre-wrap' }, currentLead.notes)
),

currentLead.status === 'pickup_later' && React.createElement('div', { 
className: 'mt-6 bg-indigo-50 border border-indigo-200 rounded-lg p-4' 
},
React.createElement('h3', { 
className: 'text-lg font-semibold text-indigo-800 mb-3 flex items-center' 
}, 
React.createElement('span', { className: 'mr-2' }, '‚è∞'),
'Pick Up Later Information'
),

currentLead.next_follow_up_date && 
React.createElement('div', { className: 'mb-3' },
React.createElement('p', { className: 'text-sm font-medium text-indigo-700 mb-1' }, 'üìÖ Follow-up Date:'),
React.createElement('p', { className: 'text-indigo-900 font-semibold' },
new Date(currentLead.next_follow_up_date).toLocaleString()
)
),

currentLead.follow_up_notes && 
React.createElement('div', { className: 'mb-3' },
React.createElement('p', { className: 'text-sm font-medium text-indigo-700 mb-1' }, 'üìù Follow-up Notes:'),
React.createElement('p', { className: 'text-indigo-900 whitespace-pre-wrap' }, currentLead.follow_up_notes)
),

currentLead.previous_status && 
React.createElement('div', { className: 'mb-3' },
React.createElement('p', { className: 'text-sm font-medium text-indigo-700 mb-1' }, '‚Ü©Ô∏è Previous Status:'),
React.createElement('span', { 
className: `inline-block px-2 py-1 text-xs rounded-full ${LEAD_STATUSES[currentLead.previous_status]?.color || 'bg-gray-100 text-gray-800'}`
}, LEAD_STATUSES[currentLead.previous_status]?.label || currentLead.previous_status)
),

React.createElement('button', {
onClick: () => {
const confirmReactivate = confirm('Reactivate this lead? It will return to: ' + (LEAD_STATUSES[currentLead.previous_status]?.label || 'contacted'));
if (confirmReactivate) {
const targetStatus = currentLead.previous_status || 'contacted';
updateLeadStatus(currentLead.id, targetStatus);
}
},
className: 'mt-2 px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 flex items-center'
}, 
React.createElement('span', { className: 'mr-2' }, 'üîÑ'),
'Reactivate Lead'
)
),                    

// üìû **NEW: COMMUNICATION TIMELINE** - This is the main addition!
React.createElement(CommunicationTimeline, {
leadId: currentLead.id,
leadName: currentLead.name
})
)
)
);
};



const renderInventoryDetail = () => {
if (!showInventoryDetail || !currentInventoryDetail) return null;

const item = currentInventoryDetail;
const daysUntilEvent = Math.ceil((new Date(item.event_date) - new Date()) / (1000 * 60 * 60 * 24));
const marginAmount = (item.selling_price || 0) - (item.buying_price || 0);
const marginPercentage = item.buying_price > 0 ? ((marginAmount / item.selling_price) * 100) : 0;

// Status based on availability
const getAvailabilityStatus = () => {
if (item.available_tickets <= 0) return { label: 'Sold Out', color: 'bg-red-100 text-red-800' };
if (item.available_tickets === item.total_tickets) return { label: 'Available', color: 'bg-green-100 text-green-800' };
if (item.available_tickets > 5) return { label: 'Limited', color: 'bg-yellow-100 text-yellow-800' };
return { label: 'Nearly Sold', color: 'bg-orange-100 text-orange-800' };
};



const availabilityStatus = getAvailabilityStatus();

return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
onClick: (e) => e.target === e.currentTarget && closeInventoryDetail()
},
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg w-full max-w-5xl max-h-[95vh] overflow-y-auto' },
React.createElement('div', { className: 'sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center' },
React.createElement('div', null,
React.createElement('h2', { className: 'text-2xl font-bold text-gray-900' }, item.event_name),
React.createElement('div', { className: 'flex items-center mt-2 space-x-4' },
React.createElement('span', {
className: `px-3 py-1 text-sm rounded-full ${availabilityStatus.color}`
}, availabilityStatus.label),
React.createElement('span', { className: 'text-sm text-gray-600' }, 
`${item.available_tickets}/${item.total_tickets} tickets available`
),
daysUntilEvent >= 0 && React.createElement('span', { 
className: `text-sm px-2 py-1 rounded ${daysUntilEvent <= 7 ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`
}, `${daysUntilEvent} days until event`)
)
),
React.createElement('button', {
onClick: closeInventoryDetail,
className: 'text-gray-400 hover:text-gray-600 text-2xl'
}, '‚úï')
),

React.createElement('div', { className: 'p-6' },
// Action Buttons
React.createElement('div', { className: 'mb-6 flex flex-wrap gap-2' },
hasPermission('inventory', 'write') && React.createElement('button', { 
className: 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700',
onClick: () => {
closeInventoryDetail();
setTimeout(() => openEditInventoryForm(item), 100);
}
}, '‚úèÔ∏è Edit Inventory'),
hasPermission('inventory', 'write') && React.createElement('button', { 
className: 'bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700',
onClick: () => {
closeInventoryDetail();
setTimeout(() => handleCopyInventory(item), 100);
}
}, 'üìã Copy Inventory'),
hasPermission('inventory', 'allocate') && item.available_tickets > 0 && React.createElement('button', { 
className: 'bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700',
onClick: () => {
closeInventoryDetail();
setTimeout(() => openAllocationForm(item), 100);
}
}, 'üé´ Allocate Tickets'),
hasPermission('inventory', 'read') && React.createElement('button', { 
className: 'bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700',
onClick: () => {
closeInventoryDetail();
setTimeout(() => openAllocationManagement(item), 100);
}
}, 'üëÅÔ∏è View Allocations')
),

// Main Content Grid
React.createElement('div', { className: 'grid grid-cols-1 lg:grid-cols-2 gap-6' },
// Event Information
React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 'üé™ Event Information'),
React.createElement('div', { className: 'space-y-2' },
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Event Type: '),
React.createElement('span', { className: 'text-gray-900' }, item.event_type || 'Not specified')
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Sports: '),
React.createElement('span', { className: 'text-gray-900' }, item.sports || 'Not specified')
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Venue: '),
React.createElement('span', { className: 'text-gray-900' }, item.venue || 'Not specified')
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Event Date: '),
React.createElement('span', { className: 'text-gray-900' }, new Date(item.event_date).toLocaleDateString('en-US', { 
weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
}))
),
item.day_of_match && item.day_of_match !== 'Not Applicable' && React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Day of Match: '),
React.createElement('span', { className: 'text-gray-900' }, item.day_of_match)
),
item.stand && React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Stand/Section: '),
React.createElement('span', { className: 'text-gray-900' }, item.stand)
)
)
),

// Ticket Information
React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 'üé´ Ticket Information'),
React.createElement('div', { className: 'space-y-2' },
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Category: '),
React.createElement('span', { className: 'text-gray-900' }, item.category_of_ticket || 'Not specified')
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Total Tickets: '),
React.createElement('span', { className: 'text-gray-900 font-bold' }, item.total_tickets?.toLocaleString() || '0')
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Available: '),
React.createElement('span', { className: `font-bold ${item.available_tickets > 5 ? 'text-green-600' : 'text-red-600'}` }, 
item.available_tickets?.toLocaleString() || '0'
)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Allocated: '),
React.createElement('span', { className: 'text-gray-900 font-bold' }, 
((item.total_tickets || 0) - (item.available_tickets || 0)).toLocaleString()
)
),
item.inclusions && React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Inclusions: '),
React.createElement('span', { className: 'text-gray-900' }, item.inclusions)
)
)
),

// Financial Information
hasPermission('finance', 'read') && React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 'üí∞ Financial Information'),
React.createElement('div', { className: 'space-y-2' },
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'MRP per Ticket: '),
React.createElement('span', { className: 'text-gray-900' }, '‚Çπ' + (item.mrp_of_ticket?.toLocaleString() || '0'))
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Buying Price: '),
React.createElement('span', { className: 'text-gray-900' }, '‚Çπ' + (item.buying_price?.toLocaleString() || '0'))
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Selling Price: '),
React.createElement('span', { className: 'text-gray-900' }, '‚Çπ' + (item.selling_price?.toLocaleString() || '0'))
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Margin per Ticket: '),
React.createElement('span', { className: `font-bold ${marginAmount > 0 ? 'text-green-600' : 'text-red-600'}` }, 
'‚Çπ' + marginAmount.toLocaleString() + ` (${marginPercentage.toFixed(1)}%)`
)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Total Revenue Potential: '),
React.createElement('span', { className: 'text-gray-900 font-bold' }, 
'‚Çπ' + ((item.selling_price || 0) * (item.total_tickets || 0)).toLocaleString()
)
)
)
),

// Procurement Information
React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 'üì¶ Procurement Information'),
React.createElement('div', { className: 'space-y-2' },
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Booking Person: '),
React.createElement('span', { className: 'text-gray-900' }, item.booking_person || 'Not specified')
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Procurement Type: '),
React.createElement('span', { className: 'px-2 py-1 text-xs rounded bg-blue-100 text-blue-800' }, 
(item.procurement_type || 'not_specified').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())
)
),
item.supplierName && React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Supplier: '),
React.createElement('span', { className: 'text-gray-900' }, item.supplierName)
),
item.paymentStatus && React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Payment Status: '),
React.createElement('span', { 
className: `px-2 py-1 text-xs rounded ${item.paymentStatus === 'paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`
}, (item.paymentStatus || 'unknown').charAt(0).toUpperCase() + (item.paymentStatus || 'unknown').slice(1))
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Created: '),
React.createElement('span', { className: 'text-gray-900' }, 
new Date(item.created_date || Date.now()).toLocaleDateString('en-US', { 
year: 'numeric', month: 'short', day: 'numeric' 
})
)
),
item.created_by && React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Created By: '),
React.createElement('span', { className: 'text-gray-900' }, item.created_by)
)
)
)
),

// Notes Section (Full Width)
item.notes && React.createElement('div', { className: 'mt-6 bg-gray-50 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 'üìù Notes'),
React.createElement('p', { className: 'text-gray-900 whitespace-pre-wrap' }, item.notes)
)
)
)
);
};





// Assign form with permission checks
const renderAssignForm = () => {
if (!showAssignForm || !currentLead) return null;

const teamMembers = formData.assigned_team === 'supply' ? (users || []).filter(u => ['supply_executive', 'supply_sales_service_manager'].includes(u.role)) : (users || []).filter(u => ['sales_executive', 'sales_manager'].includes(u.role));

return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
onClick: (e) => e.target === e.currentTarget && closeForm()
},
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md' },
React.createElement('div', { className: 'flex justify-between items-center mb-6' },
React.createElement('h2', { className: 'text-xl font-bold text-gray-900 dark:text-white' }, 
'Assign Lead: ' + (currentLead.name)
),
React.createElement('button', {
onClick: closeForm,
className: 'text-gray-400 hover:text-gray-600 text-2xl'
}, '‚úï')
),
React.createElement('form', { onSubmit: handleAssignLead },
React.createElement('div', { className: 'mb-4' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 
'Team'
),
React.createElement('select', {
value: formData.assigned_team || 'sales',
onChange: (e) => handleInputChange('assigned_team', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true
},
React.createElement('option', { value: 'sales' }, 'Sales Team'),
React.createElement('option', { value: 'supply' }, 'Supply Team')
)
),
React.createElement('div', { className: 'mb-6' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 
'Assign To'
),
React.createElement('select', {
value: formData.assigned_to || '',
onChange: (e) => handleInputChange('assigned_to', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true
},
React.createElement('option', { value: '' }, 'Select Team Member'),
teamMembers.map(user =>
React.createElement('option', { key: user.id, value: user.email }, user.name)
)
)
),
React.createElement('div', { className: 'flex space-x-4' },
React.createElement('button', {
type: 'button',
onClick: closeForm,
className: 'flex-1 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50'
}, 'Cancel'),
React.createElement('button', {
type: 'submit',
disabled: loading,
className: 'flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50'
}, loading ? 'Assigning...' : 'Assign')
)
)
)
);
};



// Payment form
// REPLACE your existing renderPaymentForm function with this:
const renderPaymentForm = () => {
return renderEnhancedPaymentForm();
};



const renderPaymentPostServiceForm = () => {
if (!showPaymentPostServiceForm || !currentLead) return null;

return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
onClick: (e) => e.target === e.currentTarget && closeForm()
},
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[95vh] overflow-y-auto' },
React.createElement('div', { className: 'flex justify-between items-center mb-6' },
React.createElement('h2', { className: 'text-xl font-bold text-gray-900 dark:text-white' }, 
'Payment Post Service: ' + (currentLead.name)
),
React.createElement('button', {
onClick: closeForm,
className: 'text-gray-400 hover:text-gray-600 text-2xl'
}, '‚úï')
),

React.createElement('div', { className: 'mb-4 p-4 bg-purple-50 rounded-lg' },
React.createElement('p', { className: 'text-sm text-purple-800' }, 
'üìÖ This option allows service delivery before payment collection. The order will require approval and payment will be tracked as receivable.'
)
),

React.createElement('form', { onSubmit: handlePaymentPostServiceSubmit },
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-6' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Expected Payment Amount (‚Çπ) - Inclusive of GST *'),
React.createElement('input', {
type: 'number',
value: paymentPostServiceData.expected_amount || '',
onChange: (e) => handlePaymentPostServiceInputChange('expected_amount', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true,
min: 0
})
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Expected Payment Date *'),
React.createElement('input', {
type: 'date',
value: paymentPostServiceData.expected_payment_date || '',
onChange: (e) => handlePaymentPostServiceInputChange('expected_payment_date', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true,
min: new Date().toISOString().split('T')[0]
})
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Service Date *'),
React.createElement('input', {
type: 'date',
value: paymentPostServiceData.service_date || '',
onChange: (e) => handlePaymentPostServiceInputChange('service_date', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true
})
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Payment Terms'),
React.createElement('select', {
value: paymentPostServiceData.payment_terms || '30 days',
onChange: (e) => handlePaymentPostServiceInputChange('payment_terms', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500'
},
React.createElement('option', { value: '7 days' }, '7 days'),
React.createElement('option', { value: '15 days' }, '15 days'),
React.createElement('option', { value: '30 days' }, '30 days'),
React.createElement('option', { value: '45 days' }, '45 days'),
React.createElement('option', { value: '60 days' }, '60 days'),
React.createElement('option', { value: 'custom' }, 'Custom')
)
)
),

React.createElement('div', { className: 'mb-4' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Service Details *'),
React.createElement('textarea', {
value: paymentPostServiceData.service_details || '',
onChange: (e) => handlePaymentPostServiceInputChange('service_details', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
rows: 3,
required: true,
placeholder: 'Describe the service to be delivered'
})
),

React.createElement('div', { className: 'mb-4' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Send Payment Reminder'),
React.createElement('div', { className: 'flex items-center space-x-4' },
React.createElement('select', {
value: paymentPostServiceData.reminder_days || '7',
onChange: (e) => handlePaymentPostServiceInputChange('reminder_days', e.target.value),
className: 'px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500'
},
React.createElement('option', { value: '3' }, '3 days before'),
React.createElement('option', { value: '7' }, '7 days before'),
React.createElement('option', { value: '14' }, '14 days before'),
React.createElement('option', { value: '30' }, '30 days before')
),
React.createElement('span', { className: 'text-sm text-gray-600 dark:text-gray-400' }, 'payment due date')
)
),

React.createElement('div', { className: 'mb-6' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Additional Notes'),
React.createElement('textarea', {
value: paymentPostServiceData.notes || '',
onChange: (e) => handlePaymentPostServiceInputChange('notes', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
rows: 3,
placeholder: 'Any additional notes or special conditions'
})
),

React.createElement('div', { className: 'flex space-x-4 pt-4 border-t' },
React.createElement('button', {
type: 'button',
onClick: closeForm,
className: 'flex-1 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50'
}, 'Cancel'),
React.createElement('button', {
type: 'submit',
disabled: loading,
className: 'flex-1 bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 disabled:opacity-50'
}, loading ? 'Creating...' : 'Create Payment Post Service Order')
)
)
)
);
};



// ADD this new enhanced payment form function
const renderEnhancedPaymentForm = () => {
if (!showPaymentForm || !currentLead) return null;

return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
onClick: (e) => e.target === e.currentTarget && closeForm()
},
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-5xl max-h-[95vh] overflow-y-auto' },
React.createElement('div', { className: 'flex justify-between items-center mb-6' },
React.createElement('h2', { className: 'text-xl font-bold text-gray-900 dark:text-white' }, 
'Payment Collection: ' + (currentLead.name)
),
React.createElement('button', {
onClick: closeForm,
className: 'text-gray-400 hover:text-gray-600 text-2xl'
}, '‚úï')
),
React.createElement('form', { onSubmit: handlePaymentSubmit },

// NEW: Enhanced Customer Classification Section
React.createElement('div', { className: 'mb-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-4' }, 
'üåç Customer & Event Classification'
),
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4' },

// Customer Type
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Customer Type *'
),
React.createElement('select', {
value: paymentData.customer_type || 'indian',
onChange: (e) => handlePaymentInputChange('customer_type', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500',
required: true
},
React.createElement('option', { value: 'indian' }, 'Indian'),
React.createElement('option', { value: 'nri' }, 'NRI (Non-Resident Indian)'),
React.createElement('option', { value: 'foreigner' }, 'Foreigner')
)
),

// Event Location
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Event Location *'
),
React.createElement('select', {
value: paymentData.event_location || 'india',
onChange: (e) => handlePaymentInputChange('event_location', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500',
required: true
},
React.createElement('option', { value: 'india' }, 'India'),
React.createElement('option', { value: 'outside_india' }, 'Outside India')
)
),

// Payment Currency
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Payment Currency *'
),
React.createElement('select', {
value: paymentData.payment_currency || 'INR',
onChange: (e) => handlePaymentInputChange('payment_currency', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500',
required: true
},
React.createElement('option', { value: 'INR' }, 'INR (Indian Rupees)'),
React.createElement('option', { value: 'USD' }, 'USD (US Dollars)'),
React.createElement('option', { value: 'EUR' }, 'EUR (Euros)'),
React.createElement('option', { value: 'GBP' }, 'GBP (British Pounds)')
)
)
),

// Tax Applicability Info
React.createElement('div', { className: 'mt-4 p-3 bg-white rounded border border-indigo-300' },
React.createElement('h4', { className: 'text-sm font-medium text-indigo-800 mb-2' }, 
'üìä Tax Applicability Preview'
),
(() => {
const invoiceTotal = paymentData.invoice_items?.reduce((sum, item) => 
sum + ((item.quantity || 0) * (item.rate || 0)), 0
) || 0;

const baseAmount = paymentData.type_of_sale === 'Service Fee' 
? (parseFloat(paymentData.service_fee_amount) || 0)
: invoiceTotal;

const calculation = calculateGSTAndTCS(baseAmount, paymentData);

return React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4 text-sm' },
React.createElement('div', null,
React.createElement('div', { className: 'flex items-center gap-2' },
React.createElement('span', null, 'GST:'),
React.createElement('span', { 
className: `px-2 py-1 rounded text-xs ${calculation.gst.applicable ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`
}, calculation.gst.applicable ? `${calculation.gst.rate}% Applicable` : 'Not Applicable')
),
React.createElement('div', { className: 'text-xs text-gray-600 mt-1' },
(() => {
const isIndian = paymentData.customer_type === 'indian';
const isCorporate = paymentData.category_of_sale === 'Corporate';
const isOutsideIndia = paymentData.event_location === 'outside_india';
const isINRPayment = paymentData.payment_currency === 'INR';
const isServiceFee = paymentData.type_of_sale === 'Service Fee';

if (isServiceFee) {
return 'Service Fee: Always 18% GST';
} else if (isIndian) {
return isCorporate ? 'Tour Package - Domestic B2B: 18%' : 'Tour Package - Domestic B2C: 5%';
} else {
if (!isOutsideIndia) {
return 'Tour Package - International in India: 5%';
} else {
return isINRPayment ? 'Tour Package - International outside India (INR): 5%' : 'Tour Package - International outside India (Foreign): No GST';
}
}
})()
)
),
React.createElement('div', null,
React.createElement('div', { className: 'flex items-center gap-2' },
React.createElement('span', null, 'TCS:'),
React.createElement('span', { 
className: `px-2 py-1 rounded text-xs ${calculation.tcs.applicable ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}`
}, calculation.tcs.applicable ? `${calculation.tcs.rate}% Applicable` : 'Not Applicable')
),
React.createElement('div', { className: 'text-xs text-gray-600 mt-1' },
(() => {
const isIndian = paymentData.customer_type === 'indian';
const isOutsideIndia = paymentData.event_location === 'outside_india';
const isINRPayment = paymentData.payment_currency === 'INR';

if (!isOutsideIndia) {
return 'Event in India: No TCS';
} else {
if (isIndian) {
return 'Indian client, event outside India: TCS applies';
} else {
return isINRPayment ? 'International client, event outside India (INR): TCS applies' : 'International client, event outside India (Foreign): No TCS';
}
}
})()
)
)
);
})()
)
),

// ADD THIS: TCS Rate Selection Dropdown as a SEPARATE section
(() => {
  const invoiceTotal = paymentData.invoice_items?.reduce((sum, item) => 
    sum + ((item.quantity || 0) * (item.rate || 0)), 0
  ) || 0;
  
  const baseAmount = paymentData.type_of_sale === 'Service Fee' 
    ? (parseFloat(paymentData.service_fee_amount) || 0)
    : invoiceTotal;
    
  const calculation = calculateGSTAndTCS(baseAmount, paymentData);
  
  return calculation.tcs.applicable && React.createElement('div', { className: 'mt-4 p-3 bg-orange-50 rounded border border-orange-200' },
    React.createElement('h4', { className: 'text-sm font-medium text-orange-800 mb-3' }, 
      'üéØ TCS Rate Selection'
    ),
    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
      React.createElement('div', null,
        React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
          'TCS Rate *'
        ),
        React.createElement('select', {
          value: paymentData.tcs_rate || 5,
          onChange: (e) => handlePaymentInputChange('tcs_rate', parseFloat(e.target.value)),
          className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500'
        },
          React.createElement('option', { value: 5 }, '5% - Standard Rate'),
          React.createElement('option', { value: 20 }, '20% - Higher Income Bracket')
        )
      ),
      React.createElement('div', { className: 'flex items-center p-3 bg-orange-100 rounded' },
        React.createElement('div', null,
          React.createElement('div', { className: 'text-sm font-medium text-orange-800' }, 
            `TCS Amount: ‚Çπ${((baseAmount * (paymentData.tcs_rate || 5)) / 100).toFixed(2)}`
          ),
          React.createElement('div', { className: 'text-xs text-orange-700 mt-1' }, 
            'Rate depends on individual income level - select appropriate rate'
          )
        )
      )
    )
  );
})(),  

// Payment Details Section (PRESERVED EXACTLY)
React.createElement('div', { className: 'mb-6 p-4 bg-blue-50 rounded-lg' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-4' }, 'üí≥ Payment Details'),
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Payment Method *'),
React.createElement('select', {
value: paymentData.payment_method || '',
onChange: (e) => handlePaymentInputChange('payment_method', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true
},
React.createElement('option', { value: '' }, 'Select Payment Method'),
['Bank Transfer', 'UPI', 'Credit Card', 'Debit Card', 'Cheque', 'Cash', 'Online Payment'].map(method =>
React.createElement('option', { key: method, value: method }, method)
)
)
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
paymentData.from_receivable ? 'Payment Amount (‚Çπ) *' : 'Advance Amount (‚Çπ) *'
),
React.createElement('input', {
type: 'number',
value: paymentData.advance_amount || '',
onChange: (e) => handlePaymentInputChange('advance_amount', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true,
placeholder: paymentData.from_receivable ? 'Enter payment amount for receivable' : 'Enter advance amount received'
})
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Transaction ID *'),
React.createElement('input', {
type: 'text',
value: paymentData.transaction_id || '',
onChange: (e) => handlePaymentInputChange('transaction_id', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true,
placeholder: 'Enter transaction/reference ID'
})
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Payment Date *'),
React.createElement('input', {
type: 'date',
value: paymentData.payment_date || '',
onChange: (e) => handlePaymentInputChange('payment_date', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true
})
)
)
),

// GST and Legal Details Section (PRESERVED WITH ENHANCEMENTS)
React.createElement('div', { className: 'mb-6 p-4 bg-green-50 rounded-lg' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-4' }, 'üìã GST & Legal Details'),
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'GSTIN'),
React.createElement('input', {
type: 'text',
value: paymentData.gstin || '',
onChange: (e) => handlePaymentInputChange('gstin', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
placeholder: 'Enter GST Number (if applicable)'
})
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Legal Name *'),
React.createElement('input', {
type: 'text',
value: paymentData.legal_name || currentLead.name,
onChange: (e) => handlePaymentInputChange('legal_name', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true,
placeholder: 'Legal name for invoice'
})
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Category of Sale *'),
React.createElement('select', {
value: paymentData.category_of_sale || 'Retail',
onChange: (e) => handlePaymentInputChange('category_of_sale', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true
},
React.createElement('option', { value: 'Retail' }, 'Retail (B2C)'),
React.createElement('option', { value: 'Corporate' }, 'Corporate (B2B)')
)
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Type of Sale *'),
React.createElement('select', {
value: paymentData.type_of_sale || 'Tour',
onChange: (e) => handlePaymentInputChange('type_of_sale', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true
},
React.createElement('option', { value: 'Tour' }, 'Tour Package'),
React.createElement('option', { value: 'Service Fee' }, 'Service Fee'),
React.createElement('option', { value: 'Other' }, 'Other Services')
),
React.createElement('div', { className: 'text-xs text-gray-500 mt-1' },
paymentData.type_of_sale === 'Service Fee' 
? '‚ö†Ô∏è Service fees always attract 18% GST regardless of customer type or location'
: 'Tour packages have variable GST rates based on customer classification'
)
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'GST Rate'),
React.createElement('input', {
type: 'text',
value: (() => {
if (paymentData.type_of_sale === 'Service Fee') return '18% (Fixed)';
const calculation = calculateGSTAndTCS(0, paymentData);
return calculation.gst.applicable ? `${calculation.gst.rate}% (Dynamic)` : 'Not Applicable';
})(),
className: 'w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100',
disabled: true
})
)
),
React.createElement('div', { className: 'mt-4' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Registered Address *'),
React.createElement('textarea', {
value: paymentData.registered_address || '',
onChange: (e) => handlePaymentInputChange('registered_address', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
rows: 2,
required: true,
placeholder: 'Complete registered address'
})
),
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4 mt-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'State/Location *'),
React.createElement('select', {
value: paymentData.indian_state || 'Haryana',
onChange: (e) => handlePaymentInputChange('indian_state', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true
},
INDIAN_STATES.map(state =>
React.createElement('option', { key: state, value: state }, state)
),
React.createElement('option', { value: 'Outside India' }, 'Outside India')
)
),
React.createElement('div', null,
React.createElement('label', { className: 'flex items-center mt-6' },
React.createElement('input', {
type: 'checkbox',
checked: paymentData.is_outside_india || false,
onChange: (e) => handlePaymentInputChange('is_outside_india', e.target.checked),
className: 'mr-2'
}),
React.createElement('span', { className: 'text-sm font-medium text-gray-700' }, 'Customer is outside India')
)
)
)
),

// Document Upload Section (PRESERVED EXACTLY)
React.createElement('div', { className: 'mb-6 p-4 bg-yellow-50 rounded-lg' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-4' }, 'üìé Document Upload'),
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'GST Certificate'),
React.createElement('input', {
type: 'file',
accept: '.pdf,.jpg,.jpeg,.png',
onChange: async (e) => {
const file = e.target.files[0];
if (file) {
if (file.size > 5 * 1024 * 1024) {
alert('File size must be less than 5MB');
e.target.value = '';
return;
}

setLoading(true);
try {
const uploadResult = await uploadFileToGCS(file, 'gst');
handlePaymentInputChange('gst_certificate', uploadResult);
alert('GST Certificate uploaded successfully!');
} catch (error) {
alert('Failed to upload GST Certificate: ' + error.message);
e.target.value = '';
}
setLoading(false);
}
},
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
disabled: loading
}),
paymentData.gst_certificate && React.createElement('div', { className: 'mt-2' },
React.createElement('span', { className: 'text-sm text-green-600' }, 
'‚úì Uploaded: ' + paymentData.gst_certificate.originalName
),
React.createElement('button', {
type: 'button',
className: 'ml-2 text-xs text-red-600 hover:underline',
onClick: () => {
handlePaymentInputChange('gst_certificate', null);
alert('GST Certificate removed');
}
}, 'Remove')
)
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'PAN Card'),
React.createElement('input', {
type: 'file',
accept: '.pdf,.jpg,.jpeg,.png',
onChange: async (e) => {
const file = e.target.files[0];
if (file) {
console.log('=== FILE UPLOAD START ===');
console.log('Uploading file:', file.name);
if (file.size > 5 * 1024 * 1024) {
alert('File size must be less than 5MB');
e.target.value = '';
return;
}

setLoading(true);
try {
const uploadResult = await uploadFileToGCS(file, 'pan');
console.log('Upload result:', uploadResult);
handlePaymentInputChange('pan_card', uploadResult);
console.log('Payment data after update:', paymentData);
alert('PAN Card uploaded successfully!');
} catch (error) {
alert('Failed to upload PAN Card: ' + error.message);
e.target.value = '';
}
setLoading(false);
}
},
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
disabled: loading
}),
paymentData.pan_card && React.createElement('div', { className: 'mt-2' },
React.createElement('span', { className: 'text-sm text-green-600' }, 
'‚úì Uploaded: ' + paymentData.pan_card.originalName
),
React.createElement('button', {
type: 'button',
className: 'ml-2 text-xs text-red-600 hover:underline',
onClick: () => {
handlePaymentInputChange('pan_card', null);
alert('PAN Card removed');
}
}, 'Remove')
)
)
)
),

// ENHANCED: Invoice Items Section with Multi-Row Support
React.createElement('div', { className: 'mb-6 p-4 bg-purple-50 rounded-lg border border-purple-200' },
React.createElement('div', { className: 'flex justify-between items-center mb-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-800' }, 
'üìã Invoice Items'
),
React.createElement('button', {
type: 'button',
onClick: addInvoiceItem,
className: 'px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700 flex items-center gap-1'
}, 
React.createElement('span', null, '+'),
'Add Item'
)
),

// Invoice Items List
React.createElement('div', { className: 'space-y-4' },
(paymentData.invoice_items || []).map((item, index) =>
React.createElement('div', { 
key: index, 
className: 'border border-gray-200 rounded-lg p-4 bg-white'
},
// Item Header with Remove Button
React.createElement('div', { className: 'flex justify-between items-center mb-3' },
React.createElement('h4', { className: 'font-medium text-gray-700' }, 
`Item ${index + 1}`
),
paymentData.invoice_items.length > 1 && 
React.createElement('button', {
type: 'button',
onClick: () => removeInvoiceItem(index),
className: 'text-red-600 hover:text-red-800 text-sm px-2 py-1 rounded border border-red-300 hover:bg-red-50'
}, 'üóëÔ∏è Remove')
),

// Item Fields Grid
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-4 gap-4' },

// Description Field (spans 2 columns)
React.createElement('div', { className: 'md:col-span-2' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Event/Service Description *'
),
React.createElement('input', {
type: 'text',
value: item.description || '',
onChange: (e) => {
const newItems = JSON.parse(JSON.stringify(paymentData.invoice_items || []));
newItems[index].description = e.target.value;
handlePaymentInputChange('invoice_items', newItems);
},
className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500',
required: true,
placeholder: 'e.g., Match Tickets (RCB vs RR- 24th April, 2025)'
})
),

// Quantity Field
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Quantity *'
),
React.createElement('input', {
type: 'number',
value: item.quantity || '',
onChange: (e) => {
const newItems = JSON.parse(JSON.stringify(paymentData.invoice_items || []));
newItems[index].quantity = parseFloat(e.target.value) || 0;
handlePaymentInputChange('invoice_items', newItems);
},
className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500',
required: true,
min: 0,
step: 1
})
),

// Rate Field
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Rate (‚Çπ) *'
),
React.createElement('input', {
type: 'number',
value: item.rate || '',
onChange: (e) => {
const newItems = JSON.parse(JSON.stringify(paymentData.invoice_items || []));
newItems[index].rate = parseFloat(e.target.value) || 0;
handlePaymentInputChange('invoice_items', newItems);
},
className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500',
required: true,
min: 0,
step: 0.01
})
)
),

// NEW: Additional Info Field (Full Width)
React.createElement('div', { className: 'mt-3' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Additional Info (Optional)',
React.createElement('span', { className: 'text-xs text-gray-500 ml-2' }, 
'Will appear in brackets below event description on invoice'
)
),
React.createElement('input', {
type: 'text',
value: item.additional_info || '',
onChange: (e) => {
const newItems = JSON.parse(JSON.stringify(paymentData.invoice_items || []));
newItems[index].additional_info = e.target.value;
handlePaymentInputChange('invoice_items', newItems);
},
className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500',
placeholder: 'e.g., Qatar Airways Rahul Dravid Platinum Lounge- VIP'
})
),

// Item Total Display
React.createElement('div', { className: 'mt-3 flex justify-end' },
React.createElement('div', { className: 'text-sm font-medium text-gray-700 bg-gray-100 px-3 py-2 rounded' },
'Item Total: ‚Çπ', ((item.quantity || 0) * (item.rate || 0)).toFixed(2)
)
)
)
)
),

// Invoice Summary
React.createElement('div', { className: 'mt-4 p-3 bg-purple-100 rounded border-t-2 border-purple-500' },
React.createElement('div', { className: 'flex justify-between text-lg font-semibold' },
React.createElement('span', null, 'Invoice Subtotal:'),
React.createElement('span', null, 
'‚Çπ', (paymentData.invoice_items?.reduce((sum, item) => 
sum + ((item.quantity || 0) * (item.rate || 0)), 0
) || 0).toFixed(2)
)
)
)
),

// Service Fee Section (PRESERVED EXACTLY)
paymentData.type_of_sale === 'Service Fee' && 
React.createElement('div', { className: 'mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-4' }, 
'üíº Service Fee Details'
),
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
'Service Fee Amount (‚Çπ) *'
),
React.createElement('input', {
type: 'number',
value: paymentData.service_fee_amount || '',
onChange: (e) => handlePaymentInputChange('service_fee_amount', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500',
required: paymentData.type_of_sale === 'Service Fee',
min: 0,
step: 0.01,
placeholder: 'Enter service fee amount'
})
),
React.createElement('div', { className: 'flex items-center p-3 bg-yellow-100 rounded border border-yellow-300' },
React.createElement('div', null,
React.createElement('div', { className: 'text-sm font-medium text-yellow-800' }, 
'üè∑Ô∏è GST Rate: 18% (Fixed)'
),
React.createElement('div', { className: 'text-xs text-yellow-700 mt-1' }, 
'Service fees always attract 18% GST regardless of other settings'
)
)
)
)
),

// ENHANCED: Tax Calculation Preview with TCS Support
React.createElement('div', { className: 'mb-6 p-4 bg-gray-50 rounded-lg' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-4' }, 'üßÆ Enhanced Tax Calculation Preview'),
(() => {
const invoiceTotal = paymentData.invoice_items?.reduce((sum, item) => 
sum + ((item.quantity || 0) * (item.rate || 0)), 0
) || 0;

const baseAmount = paymentData.type_of_sale === 'Service Fee' 
? (parseFloat(paymentData.service_fee_amount) || 0)
: invoiceTotal;

// Enhanced calculation with TCS support
const calculation = calculateGSTAndTCS(baseAmount, paymentData);
const isIntraState = paymentData.indian_state === 'Haryana' && !paymentData.is_outside_india;
const advanceAmount = parseFloat(paymentData.advance_amount) || 0;
const isReceivablePayment = paymentData.from_receivable || paymentData.payment_post_service;

return React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },

// Left Column - Basic Amounts
React.createElement('div', { className: 'space-y-3' },
React.createElement('h4', { className: 'font-medium text-gray-700 border-b pb-2' }, 'Base Amounts'),
React.createElement('div', { className: 'space-y-2 text-sm' },
React.createElement('div', { className: 'flex justify-between' },
React.createElement('span', null, 'Invoice Total:'),
React.createElement('span', { className: 'font-medium' }, 
paymentData.payment_currency || 'INR', ' ', invoiceTotal.toFixed(2)
)
),
paymentData.type_of_sale === 'Service Fee' && 
React.createElement('div', { className: 'flex justify-between border-t pt-2' },
React.createElement('span', null, 'Service Fee:'),
React.createElement('span', { className: 'font-medium' }, 
paymentData.payment_currency || 'INR', ' ', (parseFloat(paymentData.service_fee_amount) || 0).toFixed(2)
)
),
React.createElement('div', { className: 'flex justify-between font-medium border-t pt-2' },
React.createElement('span', null, 'Taxable Amount:'),
React.createElement('span', null, 
paymentData.payment_currency || 'INR', ' ', baseAmount.toFixed(2)
)
)
)
),

// Right Column - Tax Breakdown
React.createElement('div', { className: 'space-y-3' },
React.createElement('h4', { className: 'font-medium text-gray-700 border-b pb-2' }, 'Tax Breakdown'),
React.createElement('div', { className: 'space-y-2 text-sm' },

// GST Section
calculation.gst.applicable ? [
isIntraState ? [
React.createElement('div', { key: 'cgst', className: 'flex justify-between' },
React.createElement('span', null, `CGST (${calculation.gst.rate/2}%):`),
React.createElement('span', { className: 'font-medium' }, 
paymentData.payment_currency || 'INR', ' ', calculation.gst.cgst.toFixed(2)
)
),
React.createElement('div', { key: 'sgst', className: 'flex justify-between' },
React.createElement('span', null, `SGST (${calculation.gst.rate/2}%):`),
React.createElement('span', { className: 'font-medium' }, 
paymentData.payment_currency || 'INR', ' ', calculation.gst.sgst.toFixed(2)
)
)
] : React.createElement('div', { key: 'igst', className: 'flex justify-between' },
React.createElement('span', null, `IGST (${calculation.gst.rate}%):`),
React.createElement('span', { className: 'font-medium' }, 
paymentData.payment_currency || 'INR', ' ', calculation.gst.igst.toFixed(2)
)
)
] : React.createElement('div', { key: 'no-gst', className: 'flex justify-between text-gray-500' },
React.createElement('span', null, 'GST:'),
React.createElement('span', null, 'Not Applicable')
),

// TCS Section
calculation.tcs.applicable ? 
React.createElement('div', { className: 'flex justify-between text-yellow-700' },
React.createElement('span', null, `TCS (${calculation.tcs.rate}%):`),
React.createElement('span', { className: 'font-medium' }, 
paymentData.payment_currency || 'INR', ' ', calculation.tcs.amount.toFixed(2)
)
) : React.createElement('div', { className: 'flex justify-between text-gray-500' },
React.createElement('span', null, 'TCS:'),
React.createElement('span', null, 'Not Applicable')
),

// Final Amount
React.createElement('div', { className: 'flex justify-between border-t pt-2 font-semibold text-base text-green-700' },
React.createElement('span', null, 'Final Amount:'),
React.createElement('span', null, 
paymentData.payment_currency || 'INR', ' ', calculation.finalAmount.toFixed(2)
)
),

// Payment Information (PRESERVED)
!isReceivablePayment && React.createElement('div', { className: 'flex justify-between border-t pt-2' },
React.createElement('span', { className: 'font-semibold' }, 'Advance Received:'),
React.createElement('span', { className: 'font-semibold text-blue-600' }, 
paymentData.payment_currency || 'INR', ' ', advanceAmount.toFixed(2)
)
),
!isReceivablePayment && React.createElement('div', { className: 'flex justify-between' },
React.createElement('span', { className: 'font-bold' }, 'Balance Due:'),
React.createElement('span', { className: 'font-bold text-orange-600' }, 
paymentData.payment_currency || 'INR', ' ', (calculation.finalAmount - advanceAmount).toFixed(2)
)
),
isReceivablePayment && React.createElement('div', { className: 'flex justify-between border-t pt-2' },
React.createElement('span', { className: 'font-bold' }, 'Payment Being Collected:'),
React.createElement('span', { className: 'font-bold text-green-600' }, 
paymentData.payment_currency || 'INR', ' ', advanceAmount.toFixed(2)
)
)
)
)
);
})(),
),

// Additional Notes (PRESERVED EXACTLY)
React.createElement('div', { className: 'mb-6' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Additional Notes'),
React.createElement('textarea', {
value: paymentData.notes || '',
onChange: (e) => handlePaymentInputChange('notes', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
rows: 3,
placeholder: 'Any additional payment details or notes'
})
),

// Submit Buttons (PRESERVED EXACTLY)
React.createElement('div', { className: 'flex space-x-4 pt-4 border-t' },
React.createElement('button', {
type: 'button',
onClick: closeForm,
className: 'flex-1 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50'
}, 'Cancel'),
React.createElement('button', {
type: 'submit',
disabled: loading,
className: 'flex-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 disabled:opacity-50'
}, loading ? 'Processing...' : 'Submit Payment & Create Order')
)
)
)
);
};



// Allocation form
const renderAllocationForm = () => {
if (!showAllocationForm || !currentInventory) return null;

const convertedLeads = leads.filter(lead => 
['converted', 'payment', 'payment_post_service', 'payment_received'].includes(lead.status)
);

return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
onClick: (e) => e.target === e.currentTarget && closeForm()
},
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md' },
React.createElement('div', { className: 'flex justify-between items-center mb-6' },
React.createElement('h2', { className: 'text-xl font-bold text-gray-900 dark:text-white' }, 
'Allocate: ' + (currentInventory.event_name)
),
React.createElement('button', {
onClick: closeForm,
className: 'text-gray-400 hover:text-gray-600 text-2xl'
}, '‚úï')
),
React.createElement('div', { className: 'mb-4 p-3 bg-blue-50 rounded' },
React.createElement('p', { className: 'text-sm text-blue-800' }, 
'Available Tickets: ' + (currentInventory.available_tickets)
),
React.createElement('p', { className: 'text-sm text-blue-800' }, 
'Price per Ticket: ‚Çπ' + (currentInventory.selling_price?.toLocaleString())
)
),
React.createElement('form', { onSubmit: handleAllocation },
React.createElement('div', { className: 'mb-4' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 
'Select Lead (Converted or Later) *'
),
React.createElement('select', {
value: allocationData.lead_id || '',
onChange: (e) => handleAllocationInputChange('lead_id', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true
},
React.createElement('option', { value: '' }, 'Select Lead'),
convertedLeads.map(lead =>
React.createElement('option', { key: lead.id, value: lead.id }, 
(lead.name) + ' - ' + (lead.number_of_people) + ' people'
)
)
)
),
React.createElement('div', { className: 'mb-4' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 
'Tickets to Allocate *'
),
React.createElement('input', {
type: 'number',
value: allocationData.tickets_allocated || '',
onChange: (e) => handleAllocationInputChange('tickets_allocated', parseInt(e.target.value)),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: true,
min: 1,
max: currentInventory.available_tickets
})
),
React.createElement('div', { className: 'mb-6' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 
'Allocation Notes'
),
React.createElement('textarea', {
value: allocationData.notes || '',
onChange: (e) => handleAllocationInputChange('notes', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
rows: 3,
placeholder: 'Any special notes for this allocation'
})
),
React.createElement('div', { className: 'flex space-x-4' },
React.createElement('button', {
type: 'button',
onClick: closeForm,
className: 'flex-1 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50'
}, 'Cancel'),
React.createElement('button', {
type: 'submit',
disabled: loading,
className: 'flex-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 disabled:opacity-50'
}, loading ? 'Allocating...' : 'Allocate & Create Order')
)
)
)
);
};



const renderBulkAssignModal = () => {
if (!showBulkAssignModal) return null;

const unassignedLeads = leads.filter(lead => !lead.assigned_to || lead.assigned_to === '' || lead.status === 'unassigned');
const salesUsers = users.filter(u => 
['sales_executive', 'sales_manager', 'supply_executive', 'supply_sales_service_manager'].includes(u.role) && 
u.status === 'active'
);

const handleCheckboxChange = (leadId, userEmail, isChecked) => {
setBulkAssignSelections(prev => {
const newSelections = { ...prev };
if (isChecked) {
newSelections[leadId] = userEmail;
} else {
delete newSelections[leadId];
}
return newSelections;
});
};



return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
onClick: (e) => e.target === e.currentTarget && setShowBulkAssignModal(false)
},
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-7xl max-h-[90vh] overflow-hidden' },
React.createElement('div', { className: 'flex justify-between items-center mb-6' },
React.createElement('h2', { className: 'text-2xl font-bold text-gray-900' }, `Bulk Assign Leads (${unassignedLeads.length} unassigned)`),
React.createElement('button', {
onClick: () => setShowBulkAssignModal(false),
className: 'text-gray-400 hover:text-gray-600 text-2xl'
}, '‚úï')
),

React.createElement('div', { className: 'overflow-auto max-h-96' },
React.createElement('table', { className: 'w-full border-collapse' },
React.createElement('thead', { className: 'bg-gray-50 sticky top-0' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border' }, 'Lead Details'),
React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border' }, 'Business Info'),
...salesUsers.map(user =>
React.createElement('th', { 
key: user.email, 
className: 'px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase border min-w-24'
}, user.name)
)
)
),
React.createElement('tbody', null,
unassignedLeads.map(lead =>
React.createElement('tr', { key: lead.id, className: 'hover:bg-gray-50' },
React.createElement('td', { className: 'px-4 py-3 border' },
React.createElement('div', { className: 'text-sm font-medium text-gray-900' }, lead.name),
React.createElement('div', { className: 'text-sm text-gray-500' }, lead.email),
React.createElement('div', { className: 'text-xs text-gray-400' }, lead.phone),
React.createElement('div', { className: 'text-xs text-blue-600' }, 
lead.date_of_enquiry ? new Date(lead.date_of_enquiry).toLocaleDateString() : ''
)
),
React.createElement('td', { className: 'px-4 py-3 border' },
React.createElement('div', { className: 'text-sm text-gray-900' }, lead.company || 'N/A'),
React.createElement('div', { className: 'text-xs text-gray-500' }, lead.business_type || 'N/A'),
React.createElement('div', { className: 'text-xs text-gray-600' }, lead.lead_for_event || 'N/A'),
React.createElement('div', { className: 'text-xs text-green-600' }, 
lead.potential_value ? `‚Çπ${parseFloat(lead.potential_value).toLocaleString()}` : 'N/A'
)
),
...salesUsers.map(user =>
React.createElement('td', { 
key: `${lead.id}-${user.email}`, 
className: 'px-3 py-3 text-center border'
},
React.createElement('input', {
type: 'checkbox',
checked: bulkAssignSelections[lead.id] === user.email,
onChange: (e) => handleCheckboxChange(lead.id, user.email, e.target.checked),
className: 'w-4 h-4 text-blue-600 rounded focus:ring-blue-500'
})
)
)
)
)
)
)
),

React.createElement('div', { className: 'flex justify-between items-center mt-6 pt-4 border-t' },
React.createElement('div', { className: 'text-sm text-gray-600' },
`${Object.keys(bulkAssignSelections).length} leads selected for assignment`
),
React.createElement('div', { className: 'flex space-x-4' },
React.createElement('button', {
onClick: () => setShowBulkAssignModal(false),
className: 'px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50'
}, 'Cancel'),
React.createElement('button', {
onClick: handleBulkAssignSubmit,
disabled: bulkAssignLoading || Object.keys(bulkAssignSelections).length === 0,
className: 'px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50'
}, bulkAssignLoading ? 'Assigning...' : `Assign ${Object.keys(bulkAssignSelections).length} Leads`)
)
)
)
);
};



// Allocation Management Modal
const renderAllocationManagement = () => {
if (!showAllocationManagement || !allocationManagementInventory) return null;

return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50'
},
React.createElement('div', { 
className: 'bg-white p-6 rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto'
},
React.createElement('div', { className: 'flex justify-between items-center mb-4' },
React.createElement('h2', { className: 'text-xl font-bold' }, 
'Allocations for ' + allocationManagementInventory.event_name
),
React.createElement('button', {
onClick: () => setShowAllocationManagement(false),
className: 'text-gray-500 hover:text-gray-700'
}, '‚úï')
),

React.createElement('div', { className: 'mb-4 p-4 bg-gray-50 rounded' },
React.createElement('h3', { className: 'font-semibold' }, 'Inventory Details'),
React.createElement('p', null, 'Total Tickets: ' + (allocationManagementInventory.total_tickets || 'N/A')),
React.createElement('p', null, 'Available Tickets: ' + (allocationManagementInventory.available_tickets || 0)),
React.createElement('p', null, 'Allocated Tickets: ' + ((allocationManagementInventory.total_tickets || 0) - (allocationManagementInventory.available_tickets || 0)))
),

currentAllocations.length === 0 ? 
React.createElement('div', { className: 'text-center py-8 text-gray-500' },
'No allocations found for this inventory item.'
) :
React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'min-w-full bg-white border border-gray-300' },
React.createElement('thead', { className: 'bg-gray-50' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-4 py-2 border text-left' }, 'Lead Name'),
React.createElement('th', { className: 'px-4 py-2 border text-left' }, 'Email'),
React.createElement('th', { className: 'px-4 py-2 border text-left' }, 'Tickets Allocated'),
React.createElement('th', { className: 'px-4 py-2 border text-left' }, 'Allocation Date'),
React.createElement('th', { className: 'px-4 py-2 border text-left' }, 'Notes'),
React.createElement('th', { className: 'px-4 py-2 border text-left' }, 'Actions')
)
),
React.createElement('tbody', null,
currentAllocations.map(allocation =>
React.createElement('tr', { key: allocation.id, className: 'hover:bg-gray-50' },
React.createElement('td', { className: 'px-4 py-2 border' },
allocation.lead_details ? allocation.lead_details.name : (allocation.lead_name || 'Unknown')
),
React.createElement('td', { className: 'px-4 py-2 border' },
allocation.lead_details ? allocation.lead_details.email : (allocation.lead_email || 'N/A')
),
React.createElement('td', { className: 'px-4 py-2 border' }, allocation.tickets_allocated),
React.createElement('td', { className: 'px-4 py-2 border' },
new Date(allocation.allocation_date).toLocaleDateString()
),
React.createElement('td', { className: 'px-4 py-2 border' }, allocation.notes || 'No notes'),
React.createElement('td', { className: 'px-4 py-2 border' },
React.createElement('button', {
onClick: () => handleUnallocate(allocation.id, allocation.tickets_allocated),
className: 'bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600',
disabled: loading
}, 'Unallocate')
)
)
)
)
)
),

React.createElement('div', { className: 'mt-6 flex justify-between' },
React.createElement('button', {
onClick: () => openAllocationForm(allocationManagementInventory),
className: 'bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600',
disabled: allocationManagementInventory.available_tickets <= 0
}, 'Add New Allocation'),
React.createElement('button', {
onClick: () => setShowAllocationManagement(false),
className: 'bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600'
}, 'Close')
)
)
);
};



const renderStadiumForm = () => {
if (!showStadiumForm) return null;

return React.createElement('div', {
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50'
},
React.createElement('div', {
className: 'bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto'
},
React.createElement('div', { className: 'flex justify-between items-center mb-6' },
React.createElement('h2', { className: 'text-xl font-bold text-gray-900 dark:text-white' },
editingStadium ? `Edit Stadium: ${editingStadium.name}` : 'Add New Stadium'
),
React.createElement('button', {
onClick: closeStadiumForm,
className: 'text-gray-400 hover:text-gray-600 text-2xl'
}, '‚úï')
),

React.createElement('form', { onSubmit: handleStadiumFormSubmit },
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
stadiumFormFields.map(field =>
React.createElement('div', {
key: field.name,
className: field.type === 'textarea' ? 'md:col-span-2' : ''
},
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1' },
field.label + (field.required ? ' *' : '')
),
field.type === 'select' ?
React.createElement('select', {
value: stadiumFormData[field.name] || '',
onChange: (e) => handleStadiumInputChange(field.name, e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: field.required
},
React.createElement('option', { value: '' }, `Select ${field.label}`),
field.options.map(option =>
React.createElement('option', { key: option, value: option }, option)
)
) :
field.type === 'textarea' ?
React.createElement('textarea', {
value: stadiumFormData[field.name] || '',
onChange: (e) => handleStadiumInputChange(field.name, e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
rows: 3,
placeholder: field.placeholder,
required: field.required
}) :
React.createElement('input', {
type: field.type,
value: stadiumFormData[field.name] || '',
onChange: (e) => handleStadiumInputChange(field.name, e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: field.required,
placeholder: field.placeholder,
min: field.type === 'number' ? 0 : undefined
})
)
)
),

React.createElement('div', { className: 'flex space-x-4 mt-6 pt-4 border-t border-gray-200' },
React.createElement('button', {
type: 'button',
onClick: closeStadiumForm,
className: 'flex-1 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 dark:border-gray-600 dark:hover:bg-gray-700'
}, 'Cancel'),
React.createElement('button', {
type: 'submit',
disabled: loading,
className: 'flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50'
}, loading ? 'Saving...' : (editingStadium ? 'Update Stadium' : 'Add Stadium'))
)
)
)
);
};



const populateDefaultStadiums = async () => {
if (!confirm('This will add popular stadiums to your database. Continue?')) return;

const defaultStadiums = [
// Cricket Stadiums - India
{ 
name: 'Wankhede Stadium', 
city: 'Mumbai', 
state: 'Maharashtra', 
country: 'India', 
sport_type: 'Cricket', 
capacity: 33000, 
opened_year: 1974,
nickname: 'Home of Indian Cricket',
notes: 'Famous for hosting Cricket World Cup finals'
},
{ 
name: 'Eden Gardens', 
city: 'Kolkata', 
state: 'West Bengal', 
country: 'India', 
sport_type: 'Cricket', 
capacity: 66000, 
opened_year: 1864,
nickname: 'Cricket\'s Colosseum',
notes: 'One of the oldest and largest cricket stadiums'
},
{ 
name: 'M. Chinnaswamy Stadium', 
city: 'Bangalore', 
state: 'Karnataka', 
country: 'India', 
sport_type: 'Cricket', 
capacity: 40000, 
opened_year: 1969,
notes: 'Known for high-scoring matches and IPL games'
},
{ 
name: 'Feroz Shah Kotla Ground', 
city: 'Delhi', 
state: 'Delhi', 
country: 'India', 
sport_type: 'Cricket', 
capacity: 41000, 
opened_year: 1883,
notes: 'One of the oldest cricket grounds in India'
},
{ 
name: 'MA Chidambaram Stadium', 
city: 'Chennai', 
state: 'Tamil Nadu', 
country: 'India', 
sport_type: 'Cricket', 
capacity: 50000, 
opened_year: 1916,
nickname: 'Chepauk Stadium',
notes: 'Known for its spinning pitches'
},
{ 
name: 'Narendra Modi Stadium', 
city: 'Ahmedabad', 
state: 'Gujarat', 
country: 'India', 
sport_type: 'Cricket', 
capacity: 132000, 
opened_year: 2020,
nickname: 'Motera Stadium',
notes: 'World\'s largest cricket stadium'
},

// Cricket Stadiums - International
{ 
name: 'Lord\'s Cricket Ground', 
city: 'London', 
country: 'United Kingdom', 
sport_type: 'Cricket', 
capacity: 31000, 
opened_year: 1814, 
nickname: 'Home of Cricket',
notes: 'Most famous cricket ground in the world'
},
{ 
name: 'Melbourne Cricket Ground', 
city: 'Melbourne', 
state: 'Victoria',
country: 'Australia', 
sport_type: 'Cricket', 
capacity: 100024, 
opened_year: 1853, 
nickname: 'MCG',
notes: 'Largest cricket stadium in the Southern Hemisphere'
},
{ 
name: 'The Oval', 
city: 'London', 
country: 'United Kingdom', 
sport_type: 'Cricket', 
capacity: 23500, 
opened_year: 1845,
notes: 'Famous for hosting the final Test of English summer'
},
{ 
name: 'Sydney Cricket Ground', 
city: 'Sydney', 
state: 'New South Wales',
country: 'Australia', 
sport_type: 'Cricket', 
capacity: 48000, 
opened_year: 1848, 
nickname: 'SCG',
notes: 'Hosts New Year Test matches'
},

// Football Stadiums - International
{ 
name: 'Camp Nou', 
city: 'Barcelona', 
country: 'Spain', 
sport_type: 'Football', 
capacity: 99354, 
opened_year: 1957,
notes: 'Home of FC Barcelona, largest stadium in Europe'
},
{ 
name: 'Wembley Stadium', 
city: 'London', 
country: 'United Kingdom', 
sport_type: 'Football', 
capacity: 90000, 
opened_year: 2007,
nickname: 'The Home of Football',
notes: 'England national team home, hosts FA Cup finals'
},
{ 
name: 'Old Trafford', 
city: 'Manchester', 
country: 'United Kingdom', 
sport_type: 'Football', 
capacity: 74140, 
opened_year: 1910, 
nickname: 'Theatre of Dreams',
notes: 'Home of Manchester United'
},
{ 
name: 'Santiago Bernab√©u', 
city: 'Madrid', 
country: 'Spain', 
sport_type: 'Football', 
capacity: 81044, 
opened_year: 1947,
notes: 'Home of Real Madrid, hosts Champions League finals'
},
{ 
name: 'Allianz Arena', 
city: 'Munich', 
country: 'Germany', 
sport_type: 'Football', 
capacity: 75000, 
opened_year: 2005,
notes: 'Famous for its color-changing exterior'
},

// Multi-Sport & Other Venues
{ 
name: 'Madison Square Garden', 
city: 'New York', 
state: 'New York',
country: 'United States', 
sport_type: 'Multi-Sport', 
capacity: 20000, 
opened_year: 1968, 
nickname: 'The Garden',
notes: 'Famous for basketball, hockey, and concerts'
},
{ 
name: 'Maracan√£ Stadium', 
city: 'Rio de Janeiro', 
country: 'Brazil', 
sport_type: 'Football', 
capacity: 78838, 
opened_year: 1950,
notes: 'Hosted 2014 FIFA World Cup final'
},
{ 
name: 'Wimbledon', 
city: 'London', 
country: 'United Kingdom', 
sport_type: 'Tennis', 
capacity: 15000, 
opened_year: 1877,
nickname: 'All England Club',
notes: 'Most prestigious tennis tournament venue'
}
];

try {
setLoading(true);
console.log(`üèüÔ∏è Adding ${defaultStadiums.length} popular stadiums...`);

const response = await apiCall('/stadiums/bulk', {
method: 'POST',
body: JSON.stringify({ stadiums: defaultStadiums })
});

// Refresh stadiums list
await fetchStadiums();

alert(`‚úÖ Successfully added ${response.success || defaultStadiums.length} popular stadiums!${response.errors > 0 ? ` (${response.errors} duplicates skipped)` : ''}`);

} catch (error) {
console.error('‚ùå Error adding default stadiums:', error);
alert('‚ùå Error adding stadiums: ' + error.message);
} finally {
setLoading(false);
}
}; 

// New inventory form specifically for payables integration
// Updated renderInventoryForm function (replace the entire function)

const renderInventoryForm = () => {
if (!showInventoryForm || !editingInventory) return null;

// Check if opened from payables (payment context)
const isFromPayables = editingInventory._payableContext?.fromPayables;
const payableAmount = editingInventory._payableContext?.payableAmount || 0;

const title = isFromPayables 
? 'üí∞ Update Payment Status - ' + (editingInventory.event_name || 'Event')
: (editingInventory.id ? 'Edit Event - ' + (editingInventory.event_name || 'Event') : 'Add New Event');

return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
onClick: (e) => e.target === e.currentTarget && closeInventoryForm()
},
React.createElement('div', { 
className: 'bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-4xl max-h-screen overflow-y-auto'
},
React.createElement('div', { className: 'flex justify-between items-center mb-6' },
React.createElement('h2', { className: 'text-xl font-bold text-gray-900 dark:text-white' }, title),
React.createElement('button', {
onClick: closeInventoryForm,
className: 'text-gray-400 hover:text-gray-600 text-2xl'
}, '‚úï')
),

React.createElement('form', { onSubmit: handleInventoryFormSubmit },
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' },
inventoryFormFields.map(field =>
React.createElement('div', { 
key: field.name,
className: field.type === 'textarea' ? 'md:col-span-2 lg:col-span-3' : ''
},
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
field.label + (field.required ? ' *' : '')
),
React.createElement('div', {
className: isFromPayables && ['totalPurchaseAmount', 'amountPaid', 'paymentStatus'].includes(field.name) 
? 'ring-2 ring-blue-500 rounded-lg p-1' : ''
},
field.type === 'select' ?
React.createElement('select', {
value: formData[field.name] || '',
onChange: (e) => handleFormDataChange(field.name, e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: field.required
},
React.createElement('option', { value: '' }, 'Select ' + field.label),
// Handle dynamic options for venue (stadiums)
field.name === 'venue' ? 
stadiums.map(stadium => 
React.createElement('option', { 
key: stadium.id, 
value: stadium.name 
}, `${stadium.name} - ${stadium.city}`)
) :
// Regular static options for other fields
(field.options && field.options !== 'dynamic' ? field.options : []).map(option =>
React.createElement('option', { key: option, value: option }, 
(typeof option === 'string' ? option.charAt(0).toUpperCase() + option.slice(1) : option).replace('_', ' ')
)
)
) :
field.type === 'textarea' ?
React.createElement('textarea', {
value: formData[field.name] || '',
onChange: (e) => handleFormDataChange(field.name, e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
rows: 3,
required: field.required,
placeholder: field.placeholder || ''
}) :
React.createElement('input', {
type: field.type,
value: formData[field.name] || '',
onChange: (e) => handleFormDataChange(field.name, e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: field.required,
placeholder: field.placeholder || '',
min: field.min || undefined
})
)
)
)
),
React.createElement('div', { className: 'flex space-x-4 mt-8 pt-6 border-t border-gray-200' },
React.createElement('button', {
type: 'button',
onClick: closeInventoryForm,
className: 'flex-1 px-6 py-3 border border-gray-300 rounded-md hover:bg-gray-50 font-medium'
}, 'Cancel'),
React.createElement('button', {
type: 'submit',
disabled: loading,
className: 'flex-1 bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 disabled:opacity-50 font-medium'
}, loading ? (editingInventory.id ? 'Updating...' : 'Creating...') : (isFromPayables ? 'Update Payment' : (editingInventory.id ? 'Save Changes' : 'Create Event')))
)
)
)
);
}; 


const renderRemindersContent = () => {
return React.createElement('div', { className: 'space-y-6' },
// Header with actions
React.createElement('div', { className: 'flex justify-between items-center' },
React.createElement('h1', { className: 'text-3xl font-bold text-gray-900 dark:text-white' }, 'Reminders'),
React.createElement('div', { className: 'flex gap-3' },
React.createElement('button', {
onClick: () => setShowReminderDashboard(true),
className: 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2'
}, 
React.createElement('span', null, 'üîî'),
'Open Reminder Dashboard'
),
React.createElement('button', {
onClick: () => fetchReminders(),
className: 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700'
}, 'üîÑ Refresh')
)
),

// Quick stats
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-4 gap-4' },
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg p-6 shadow' },
React.createElement('div', { className: 'text-3xl font-bold text-blue-600' }, reminderStats.total),
React.createElement('div', { className: 'text-sm text-gray-600 dark:text-gray-400' }, 'Total Reminders')
),
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg p-6 shadow' },
React.createElement('div', { className: 'text-3xl font-bold text-red-600' }, reminderStats.overdue),
React.createElement('div', { className: 'text-sm text-gray-600 dark:text-gray-400' }, 'Overdue')
),
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg p-6 shadow' },
React.createElement('div', { className: 'text-3xl font-bold text-orange-600' }, reminderStats.due_today),
React.createElement('div', { className: 'text-sm text-gray-600 dark:text-gray-400' }, 'Due Today')
),
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg p-6 shadow' },
React.createElement('div', { className: 'text-3xl font-bold text-green-600' }, reminderStats.pending),
React.createElement('div', { className: 'text-sm text-gray-600 dark:text-gray-400' }, 'Pending')
)
),

// Reminders table
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow' },
React.createElement('div', { className: 'px-6 py-4 border-b border-gray-200 dark:border-gray-700' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 dark:text-white' }, 'All Reminders')
),
React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-700' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Title'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Due Date'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Status'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Priority'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Assigned To'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Actions')
)
),
React.createElement('tbody', { className: 'bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700' },
reminders.length > 0 ? reminders.map(reminder => {
const isOverdue = new Date(reminder.due_date) < new Date() && reminder.status === 'pending';
const lead = leads.find(l => l.id === reminder.lead_id);

return React.createElement('tr', { 
key: reminder.id,
className: isOverdue ? 'bg-red-50 dark:bg-red-900/20' : ''
},
React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap' },
React.createElement('div', null,
React.createElement('div', { className: 'text-sm font-medium text-gray-900 dark:text-white' }, reminder.title),
React.createElement('div', { className: 'text-sm text-gray-500' }, reminder.description),
reminder.auto_generated && React.createElement('span', { 
className: 'inline-flex items-center px-2 py-1 rounded-full text-xs bg-purple-100 text-purple-800 mt-1' 
}, 'Auto-generated')
)
),
React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap' },
React.createElement('div', { className: 'text-sm text-gray-900 dark:text-white' }, 
new Date(reminder.due_date).toLocaleDateString()
),
React.createElement('div', { 
className: `text-xs ${isOverdue ? 'text-red-600 font-semibold' : 'text-gray-500'}` 
}, 
isOverdue ? 'OVERDUE' : formatRelativeTime(reminder.due_date)
)
),
React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap' },
React.createElement('span', { 
className: `inline-flex items-center px-2 py-1 rounded-full text-xs ${
reminder.status === 'pending' ? (isOverdue ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800') :
reminder.status === 'completed' ? 'bg-green-100 text-green-800' :
reminder.status === 'snoozed' ? 'bg-blue-100 text-blue-800' :
'bg-gray-100 text-gray-800'
}`
}, reminder.status.toUpperCase())
),
React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap' },
React.createElement('span', { 
className: `inline-flex items-center px-2 py-1 rounded-full text-xs ${
reminder.priority === 'urgent' ? 'bg-red-100 text-red-800' :
reminder.priority === 'high' ? 'bg-orange-100 text-orange-800' :
reminder.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' :
'bg-green-100 text-green-800'
}`
}, reminder.priority.toUpperCase())
),
React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white' },
reminder.assigned_to
),
React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm font-medium' },
React.createElement('div', { className: 'flex space-x-2' },
reminder.status === 'pending' && React.createElement('button', {
onClick: () => completeReminder(reminder.id, 'Completed'),
className: 'text-green-600 hover:text-green-900'
}, '‚úì Complete'),
reminder.status === 'pending' && React.createElement('button', {
onClick: () => snoozeReminder(reminder.id, 24),
className: 'text-blue-600 hover:text-blue-900'
}, '‚è∞ Snooze'),
React.createElement('button', {
onClick: () => deleteReminder(reminder.id),
className: 'text-red-600 hover:text-red-900'
}, 'üóëÔ∏è Delete'),
lead && React.createElement('button', {
onClick: () => {
setCurrentLead(lead);
setShowEditForm(true);
setActiveTab('leads');
},
className: 'text-indigo-600 hover:text-indigo-900'
}, 'üë§ View Lead')
)
)
);
}) : React.createElement('tr', null,
React.createElement('td', { 
colSpan: 6, 
className: 'px-6 py-4 text-center text-gray-500 dark:text-gray-400' 
}, 'No reminders found')
)
)
)
)
)
);
};



// Close inventory form
const closeInventoryForm = () => {
setShowInventoryForm(false);
setEditingInventory(null);
setFormData({});
};



// Handle inventory form submission (specifically for payables integration)
const handleInventoryFormSubmit = async (e) => {
e.preventDefault();

try {
setLoading(true);

// Enhanced debug logging
console.log('=== FRONTEND INVENTORY SUBMISSION DEBUG ===');
console.log('Inventory ID:', editingInventory.id);
console.log('Complete form data being sent:', formData);
console.log('Payment fields specifically:', {
totalPurchaseAmount: formData.totalPurchaseAmount,
amountPaid: formData.amountPaid,
paymentStatus: formData.paymentStatus,
supplierName: formData.supplierName,
supplierInvoice: formData.supplierInvoice
});
console.log('Is from payables?', editingInventory._payableContext?.fromPayables);
console.log('Payable amount:', editingInventory._payableContext?.payableAmount);

if (editingInventory.id === null || editingInventory.id === undefined) {
// CREATE NEW INVENTORY
console.log('Creating new inventory item...');

const response = await apiCall('/inventory', {
method: 'POST',
body: JSON.stringify({
...formData,
created_by: user.name || 'Unknown User',
created_date: new Date().toISOString()
})
});

console.log('Backend response:', response);

if (response.error) {
throw new Error(response.error);
}

// Add to local state
setInventory(prev => [...prev, response.data]);

alert('Inventory created successfully!');

} else {
// UPDATE EXISTING INVENTORY (your original code)
console.log('Updating existing inventory...');

const response = await apiCall(`/inventory/${editingInventory.id}`, {
method: 'PUT',
body: JSON.stringify(formData)
});

console.log('Backend response:', response);

if (response.error) {
throw new Error(response.error);
}

// Update local state
setInventory(prev => prev.map(item => 
item.id === editingInventory.id ? { ...item, ...formData } : item
));

// Refresh financial data to show updated payables
await fetchFinancialData();

alert('Inventory updated successfully! Payables have been synced automatically.');
}

closeInventoryForm();

} catch (error) {
console.error('Error with inventory:', error);
alert('Error saving inventory: ' + error.message);
} finally {
setLoading(false);
}
};



// Enhanced leads content with permission checks
// Enhanced renderLeadsContent function with Client Toggle - PRESERVES ALL YOUR EXISTING FEATURES
// This adds the client toggle while keeping your existing advanced filtering, sorting, and functionality

const renderLeadsContent = () => {
// YOUR EXISTING FILTERING LOGIC - UNCHANGED
const filteredLeads = leads.filter(lead => {
// Search filter
const matchesSearch = searchQuery === '' || 
lead.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
lead.email.toLowerCase().includes(searchQuery.toLowerCase()) ||
(lead.company && lead.company.toLowerCase().includes(searchQuery.toLowerCase())) ||
(lead.phone && lead.phone.includes(searchQuery));

// Updated status filter - support both old single filter and new multi-select
let matchesStatus = true;

if (selectedStatusFilters.length > 0) {
// Use new multi-select filter
matchesStatus = selectedStatusFilters.includes(lead.status);
} else if (statusFilter !== 'all') {
// Fallback to old single filter for backward compatibility
matchesStatus = lead.status === statusFilter;
}

// Source filter (YOUR EXISTING)
const matchesSource = leadsSourceFilter === 'all' || lead.source === leadsSourceFilter;

// Business type filter (YOUR EXISTING)
const matchesBusinessType = leadsBusinessTypeFilter === 'all' || lead.business_type === leadsBusinessTypeFilter;

// Event filter (YOUR EXISTING)
const matchesEvent = leadsEventFilter === 'all' || lead.lead_for_event === leadsEventFilter;

return matchesSearch && matchesStatus && matchesSource && matchesBusinessType && matchesEvent;
});

// YOUR EXISTING SORTING LOGIC - UNCHANGED
const sortedLeads = filteredLeads.sort((a, b) => {
let aValue, bValue;

switch (leadsSortField) {
case 'date_of_enquiry':
aValue = new Date(a.date_of_enquiry || a.created_date);
bValue = new Date(b.date_of_enquiry || b.created_date);
break;
case 'name':
aValue = a.name.toLowerCase();
bValue = b.name.toLowerCase();
break;
case 'potential_value':
aValue = parseFloat(a.potential_value) || 0;
bValue = parseFloat(b.potential_value) || 0;
break;
case 'company':
aValue = (a.company || '').toLowerCase();
bValue = (b.company || '').toLowerCase();
break;
default:
aValue = new Date(a.date_of_enquiry || a.created_date);
bValue = new Date(b.date_of_enquiry || b.created_date);
}

if (leadsSortDirection === 'asc') {
return aValue > bValue ? 1 : -1;
} else {
return aValue < bValue ? 1 : -1;
}
});

// YOUR EXISTING PAGINATION LOGIC - UNCHANGED
const indexOfLastItem = currentLeadsPage * itemsPerPage;
const indexOfFirstItem = indexOfLastItem - itemsPerPage;
const currentLeads = sortedLeads.slice(indexOfFirstItem, indexOfLastItem);
const totalPages = Math.ceil(sortedLeads.length / itemsPerPage);

// YOUR EXISTING UNASSIGNED LEADS LOGIC - UNCHANGED
const unassignedLeads = sortedLeads.filter(lead => !lead.assigned_to || lead.assigned_to === '' || lead.status === 'unassigned');

return React.createElement('div', { className: 'space-y-6' },

// NEW: View Mode Toggle Section (only addition to your existing structure)
React.createElement('div', { className: 'bg-white rounded-lg shadow-sm border p-4' },
React.createElement('div', { className: 'flex items-center justify-between mb-4' },
React.createElement('h2', { className: 'text-2xl font-bold text-gray-900' }, 'Lead & Client Management'),

// Toggle Buttons
React.createElement('div', { className: 'flex bg-gray-100 rounded-lg p-1' },
React.createElement('button', {
onClick: () => setViewMode('leads'),
className: `px-4 py-2 rounded-md text-sm font-medium transition-colors ${
viewMode === 'leads' 
? 'bg-blue-600 text-white shadow-sm' 
: 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'
}`
}, 
React.createElement('span', { className: 'mr-2' }, 'üìã'),
`Lead View (${leads.length})`
),
React.createElement('button', {
onClick: () => setViewMode('clients'),
className: `px-4 py-2 rounded-md text-sm font-medium transition-colors ml-1 ${
viewMode === 'clients' 
? 'bg-blue-600 text-white shadow-sm' 
: 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'
}`
}, 
React.createElement('span', { className: 'mr-2' }, 'üë•'),
`Client View (${clients.length})`
)
)
),

// Mode Description
React.createElement('p', { className: 'text-sm text-gray-600' },
viewMode === 'leads' 
? 'Individual lead management - Create, assign, and track each lead separately with advanced filtering'
: 'Client-based view - See all leads grouped by phone number for complete client history and relationships'
)
),

// Conditional Content Based on View Mode
viewMode === 'leads' ? 
// YOUR EXISTING LEAD VIEW CONTENT - COMPLETELY UNCHANGED
React.createElement('div', { className: 'space-y-6' },
// YOUR EXISTING HEADER WITH BUTTONS - UNCHANGED
React.createElement('div', { className: 'flex justify-between items-center' },
React.createElement('h1', { className: 'text-3xl font-bold text-gray-900 dark:text-white' }, 'Lead Management'),
React.createElement('div', { className: 'flex gap-2' },
hasPermission('leads', 'write') && React.createElement('button', { 
className: 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700',
onClick: () => openAddForm('lead')
}, '+ Add New Lead'),

// YOUR EXISTING BULK ASSIGN BUTTON - UNCHANGED
hasPermission('leads', 'assign') && unassignedLeads.length > 0 && React.createElement('button', {
onClick: () => setShowBulkAssignModal(true),
className: 'bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2'
}, 
React.createElement('span', null, 'üë•'),
`Bulk Assign (${unassignedLeads.length})`
),

// YOUR EXISTING CSV UPLOAD BUTTON - UNCHANGED
React.createElement('button', {
onClick: () => {
setCSVUploadType('leads');
setShowCSVUploadModal(true);
},
className: 'bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded flex items-center gap-2'
}, 
React.createElement('svg', {
className: 'w-5 h-5',
fill: 'none',
stroke: 'currentColor',
viewBox: '0 0 24 24'
},
React.createElement('path', {
strokeLinecap: 'round',
strokeLinejoin: 'round',
strokeWidth: 2,
d: 'M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12'
})
),
'Upload CSV'
)
)
),

// YOUR EXISTING ENHANCED FILTERS SECTION - COMPLETELY UNCHANGED
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow border p-4' },
React.createElement('h2', { className: 'text-lg font-semibold text-gray-900 dark:text-white mb-4' }, 'Filters & Search'),
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4' },
// YOUR EXISTING SEARCH INPUT - UNCHANGED
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Search'),
React.createElement('input', {
type: 'text',
placeholder: 'Name, email, company...',
value: searchQuery,
onChange: (e) => {
setSearchQuery(e.target.value);
setCurrentLeadsPage(1);
},
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
})
),

// YOUR EXISTING MULTI-SELECT STATUS FILTER - COMPLETELY UNCHANGED
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Status'),
React.createElement('div', { className: 'relative', ref: statusDropdownRef },
React.createElement('button', {
onClick: () => setShowStatusFilterDropdown(!showStatusFilterDropdown),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white flex items-center justify-between text-left'
},
React.createElement('span', { className: 'truncate' }, getStatusFilterDisplayText()),
React.createElement('svg', {
className: `w-5 h-5 transition-transform ${showStatusFilterDropdown ? 'rotate-180' : ''}`,
fill: 'none',
stroke: 'currentColor',
viewBox: '0 0 24 24'
},
React.createElement('path', {
strokeLinecap: 'round',
strokeLinejoin: 'round',
strokeWidth: 2,
d: 'M19 9l-7 7-7-7'
})
)
),

// YOUR EXISTING STATUS DROPDOWN - COMPLETELY UNCHANGED
showStatusFilterDropdown && React.createElement('div', {
className: 'absolute z-10 w-80 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-80 overflow-y-auto'
},
// YOUR EXISTING SELECT/DESELECT ALL CONTROLS - UNCHANGED
React.createElement('div', { className: 'border-b border-gray-200 p-3 bg-gray-50' },
React.createElement('div', { className: 'flex justify-between' },
React.createElement('button', {
  onClick: handleSelectAllStatuses,
  className: 'text-sm text-blue-600 hover:text-blue-800 font-medium'
}, selectedStatusFilters.length === Object.keys(LEAD_STATUSES).length ? 'Deselect All' : 'Select All'),
React.createElement('button', {
  onClick: handleClearAllStatuses,
  className: 'text-sm text-red-600 hover:text-red-800 font-medium'
}, 'Clear All')
)
),

// YOUR EXISTING STATUS OPTIONS GROUPED - COMPLETELY UNCHANGED
React.createElement('div', { className: 'py-1' },
// Initial Contact Group
React.createElement('div', { className: 'px-3 py-2 bg-gray-100 text-xs font-semibold text-gray-700 uppercase' }, 'Initial Contact'),
['unassigned', 'assigned', 'contacted', 'attempt_1', 'attempt_2', 'attempt_3'].map(status =>
LEAD_STATUSES[status] && React.createElement('label', {
  key: status,
  className: 'flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer'
},
  React.createElement('input', {
      type: 'checkbox',
      checked: selectedStatusFilters.includes(status),
      onChange: () => handleStatusFilterToggle(status),
      className: 'mr-3 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500'
  }),
  React.createElement('span', {
      className: `px-2 py-1 rounded-full text-xs font-medium mr-2 ${LEAD_STATUSES[status].color}`
  }, LEAD_STATUSES[status].label)
)
),

// Qualification Group
React.createElement('div', { className: 'px-3 py-2 bg-gray-100 text-xs font-semibold text-gray-700 uppercase' }, 'Qualification'),
['qualified', 'junk'].map(status =>
LEAD_STATUSES[status] && React.createElement('label', {
  key: status,
  className: 'flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer'
},
  React.createElement('input', {
      type: 'checkbox',
      checked: selectedStatusFilters.includes(status),
      onChange: () => handleStatusFilterToggle(status),
      className: 'mr-3 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500'
  }),
  React.createElement('span', {
      className: `px-2 py-1 rounded-full text-xs font-medium mr-2 ${LEAD_STATUSES[status].color}`
  }, LEAD_STATUSES[status].label)
)
),

// Temperature Group
React.createElement('div', { className: 'px-3 py-2 bg-gray-100 text-xs font-semibold text-gray-700 uppercase' }, 'Temperature'),
['hot', 'warm', 'cold'].map(status =>
LEAD_STATUSES[status] && React.createElement('label', {
  key: status,
  className: 'flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer'
},
  React.createElement('input', {
      type: 'checkbox',
      checked: selectedStatusFilters.includes(status),
      onChange: () => handleStatusFilterToggle(status),
      className: 'mr-3 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500'
  }),
  React.createElement('span', {
      className: `px-2 py-1 rounded-full text-xs font-medium mr-2 ${LEAD_STATUSES[status].color}`
  }, LEAD_STATUSES[status].label)
)
),

// Sales Process Group
React.createElement('div', { className: 'px-3 py-2 bg-gray-100 text-xs font-semibold text-gray-700 uppercase' }, 'Sales Process'),
['quote_requested', 'converted', 'dropped'].map(status =>
LEAD_STATUSES[status] && React.createElement('label', {
  key: status,
  className: 'flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer'
},
  React.createElement('input', {
      type: 'checkbox',
      checked: selectedStatusFilters.includes(status),
      onChange: () => handleStatusFilterToggle(status),
      className: 'mr-3 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500'
  }),
  React.createElement('span', {
      className: `px-2 py-1 rounded-full text-xs font-medium mr-2 ${LEAD_STATUSES[status].color}`
  }, LEAD_STATUSES[status].label)
)
),

// Payment Group
React.createElement('div', { className: 'px-3 py-2 bg-gray-100 text-xs font-semibold text-gray-700 uppercase' }, 'Payment'),
['payment', 'payment_post_service', 'payment_received'].map(status =>
LEAD_STATUSES[status] && React.createElement('label', {
  key: status,
  className: 'flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer'
},
  React.createElement('input', {
      type: 'checkbox',
      checked: selectedStatusFilters.includes(status),
      onChange: () => handleStatusFilterToggle(status),
      className: 'mr-3 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500'
  }),
  React.createElement('span', {
      className: `px-2 py-1 rounded-full text-xs font-medium mr-2 ${LEAD_STATUSES[status].color}`
  }, LEAD_STATUSES[status].label)
)
)
)
)
),

// YOUR EXISTING FILTER INDICATOR - UNCHANGED
selectedStatusFilters.length > 0 && React.createElement('div', {
className: 'mt-1 text-xs text-blue-600 font-medium'
}, `Filtering by ${selectedStatusFilters.length} status${selectedStatusFilters.length !== 1 ? 'es' : ''}`)
),

// YOUR EXISTING SOURCE FILTER - COMPLETELY UNCHANGED
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Source'),
React.createElement('select', {
value: leadsSourceFilter,
onChange: (e) => {
setLeadsSourceFilter(e.target.value);
setCurrentLeadsPage(1);
},
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
},
React.createElement('option', { value: 'all' }, 'All Sources'),
...Array.from(new Set(leads.map(lead => lead.source).filter(Boolean))).sort().map(source =>
React.createElement('option', { key: source, value: source }, source)
)
)
),

// YOUR EXISTING BUSINESS TYPE FILTER - COMPLETELY UNCHANGED
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Business Type'),
React.createElement('select', {
value: leadsBusinessTypeFilter,
onChange: (e) => {
setLeadsBusinessTypeFilter(e.target.value);
setCurrentLeadsPage(1);
},
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
},
React.createElement('option', { value: 'all' }, 'All Business Types'),
...Array.from(new Set(leads.map(lead => lead.business_type).filter(Boolean))).sort().map(type =>
React.createElement('option', { key: type, value: type }, type)
)
)
),

// YOUR EXISTING EVENT FILTER - COMPLETELY UNCHANGED
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Event'),
React.createElement('select', {
value: leadsEventFilter,
onChange: (e) => {
setLeadsEventFilter(e.target.value);
setCurrentLeadsPage(1);
},
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
},
React.createElement('option', { value: 'all' }, 'All Events'),
...Array.from(new Set(leads.map(lead => lead.lead_for_event).filter(Boolean))).sort().map(event =>
React.createElement('option', { key: event, value: event }, event)
)
)
),

// YOUR EXISTING SORT CONTROLS - COMPLETELY UNCHANGED
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Sort By'),
React.createElement('div', { className: 'flex gap-2' },
React.createElement('select', {
value: leadsSortField,
onChange: (e) => {
setLeadsSortField(e.target.value);
setCurrentLeadsPage(1);
},
className: 'flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
},
React.createElement('option', { value: 'date_of_enquiry' }, 'Date'),
React.createElement('option', { value: 'name' }, 'Name'),
React.createElement('option', { value: 'potential_value' }, 'Value'),
React.createElement('option', { value: 'company' }, 'Company')
),
React.createElement('button', {
onClick: () => {
setLeadsSortDirection(leadsSortDirection === 'asc' ? 'desc' : 'asc');
setCurrentLeadsPage(1);
},
className: 'px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 focus:ring-2 focus:ring-blue-500',
title: leadsSortDirection === 'asc' ? 'Sort Descending' : 'Sort Ascending'
}, leadsSortDirection === 'asc' ? '‚Üë' : '‚Üì')
)
)
),

// YOUR EXISTING FILTER STATUS SUMMARY - COMPLETELY UNCHANGED
React.createElement('div', { className: 'mt-4 flex justify-between items-center' },
React.createElement('span', { className: 'text-sm text-gray-600' },
`Showing ${sortedLeads.length} of ${leads.length} leads`
),
(searchQuery !== '' || selectedStatusFilters.length > 0 || statusFilter !== 'all' || leadsSourceFilter !== 'all' || 
leadsBusinessTypeFilter !== 'all' || leadsEventFilter !== 'all') &&
React.createElement('button', {
onClick: () => {
setSearchQuery('');
setStatusFilter('all');
setSelectedStatusFilters([]);
setLeadsSourceFilter('all');
setLeadsBusinessTypeFilter('all');
setLeadsEventFilter('all');
setCurrentLeadsPage(1);
},
className: 'text-sm text-blue-600 hover:text-blue-800 underline'
}, 'Clear All Filters')
)
),

// YOUR EXISTING WORKFLOW HINT - COMPLETELY UNCHANGED
React.createElement('div', { className: 'bg-blue-50 border border-blue-200 rounded-lg p-4' },
React.createElement('div', { className: 'flex items-center text-sm text-blue-800' },
React.createElement('span', { className: 'mr-2 text-lg' }, 'üí°'),
React.createElement('span', { className: 'font-medium mr-2' }, 'Lead Workflow:'),
React.createElement('span', null, 'Unassigned ‚Üí Assigned ‚Üí Contacted ‚Üí Qualified/Junk ‚Üí Hot/Warm/Cold ‚Üí Converted/Dropped ‚Üí Payment'),
React.createElement('span', { className: 'ml-4 font-mono bg-white px-2 py-1 rounded border' }, '‚Üí'),
React.createElement('span', { className: 'ml-1' }, 'Click arrow to progress leads')
)
),

// YOUR EXISTING TABLE - COMPLETELY UNCHANGED
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow border' },
filteredLeads.length > 0 ? React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-900' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Contact'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Event'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Assignment'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Status'),
hasPermission('finance', 'read') && React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Value'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Actions')
)
),
React.createElement('tbody', { className: 'bg-white divide-y divide-gray-200' },
currentLeads.map(lead => {
const status = LEAD_STATUSES[lead.status] || { label: lead.status, color: 'bg-gray-100 text-gray-800', next: [] };

return React.createElement('tr', { key: lead.id, className: `hover:bg-gray-50 ${lead.is_premium ? 'bg-gradient-to-r from-yellow-100 to-yellow-50 border-l-4 border-yellow-400' : ''}` },
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { 
  className: 'cursor-pointer hover:text-blue-600',
  onClick: () => openLeadDetail(lead)
},
React.createElement('div', { className: `text-sm font-medium ${lead.is_premium ? 'text-yellow-800' : 'text-gray-900'} hover:text-blue-600 flex items-center gap-2` }, 
  lead.is_premium && React.createElement('span', { className: 'text-yellow-500' }, 'üëë'),
  lead.name,
  lead.is_premium && React.createElement('span', { className: 'px-2 py-1 text-xs bg-yellow-200 text-yellow-800 rounded-full font-semibold' }, 'PREMIUM')
),
  React.createElement('div', { className: 'text-sm text-gray-500' }, lead.email),
  lead.company && React.createElement('div', { className: 'text-xs text-gray-400' }, lead.company),
React.createElement('div', { className: 'flex items-center justify-between mt-1' },
  React.createElement('div', { className: 'text-xs text-blue-600' }, 'üëÅÔ∏è Click to view details'),
  React.createElement('button', {
    onClick: (e) => {
      e.stopPropagation();
      togglePremiumStatus(lead.id, !lead.is_premium);
    },
    className: `text-sm px-2 py-1 rounded ${
      lead.is_premium 
        ? 'text-yellow-600 hover:text-yellow-800 bg-yellow-100 hover:bg-yellow-200' 
        : 'text-gray-400 hover:text-yellow-600 bg-gray-100 hover:bg-yellow-100'
    }`,
    title: lead.is_premium ? 'Remove Premium Status' : 'Mark as Premium'
  }, 
    lead.is_premium ? '‚≠ê' : '‚òÜ'
  )
)
)
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'text-sm text-gray-900' }, 
  lead.lead_for_event || 'Not specified'
),
lead.number_of_people && React.createElement('div', { className: 'text-xs text-gray-500' }, 
  lead.number_of_people + ' people'
),
React.createElement('div', { className: 'text-xs text-gray-500' }, 
  (lead.city_of_residence) + ', ' + (lead.country_of_residence || 'Unknown')
)
),
React.createElement('td', { className: 'px-6 py-4' },
lead.assigned_to ? React.createElement('div', null,
  React.createElement('div', { className: 'text-sm font-medium text-blue-600' }, getUserDisplayName(lead.assigned_to, users)),
  React.createElement('div', { className: 'text-xs text-gray-500' }, 
      lead.assigned_team === 'supply' ? 'Supply Team' : 'Sales Team'
  )
) : React.createElement('span', { className: 'text-sm text-gray-400' }, 'Unassigned')
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('span', {
  className: 'px-2 py-1 text-xs rounded ' + (status.color)
}, status.label),
lead.status === 'rejected' && lead.rejection_reason && React.createElement('div', {
  className: 'mt-1 text-xs text-red-600 italic'
}, 'Reason: ' + (lead.rejection_reason))
),
hasPermission('finance', 'read') && React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'text-sm font-medium text-gray-900' }, 
  '‚Çπ' + (lead.potential_value || 0).toLocaleString()
),
lead.last_quoted_price && React.createElement('div', { className: 'text-xs text-green-600' }, 
  'Quoted: ‚Çπ' + lead.last_quoted_price.toLocaleString()
)
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'flex flex-wrap gap-1' },
  hasPermission('leads', 'write') && React.createElement('button', { 
      className: 'text-blue-600 hover:text-blue-900 text-xs px-2 py-1 rounded border border-blue-200 hover:bg-blue-50',
      onClick: () => openEditForm(lead)
  }, '‚úèÔ∏è'),
  hasPermission('leads', 'assign') && !lead.assigned_to && lead.status === 'unassigned' &&
      React.createElement('button', { 
          className: 'text-green-600 hover:text-green-900 text-xs px-2 py-1 rounded border border-green-200 hover:bg-green-50',
          onClick: () => openAssignForm(lead)
      }, 'üë§'),
  hasPermission('leads', 'progress') && React.createElement('button', {
      className: 'text-purple-600 hover:text-purple-900 text-xs px-2 py-1 rounded border border-purple-200 hover:bg-purple-50',
      onClick: () => {
          // If lead is unassigned and not assigned to anyone, open assign form
          if (lead.status === 'unassigned' && !lead.assigned_to) {
              openAssignForm(lead);
          } else {
              // Otherwise proceed with normal progression
              handleLeadProgression(lead);
          }
      },
      disabled: loading,
      title: lead.status === 'unassigned' && !lead.assigned_to 
          ? 'Assign lead' 
          : `Progress lead to next stage`
  }, loading ? '...' : '‚Üí'),
  hasPermission('leads', 'write') && lead.status === 'converted' &&
      React.createElement('button', { 
          className: 'text-green-600 hover:text-green-900 text-xs px-2 py-1 rounded border border-green-200 hover:bg-green-50',
          onClick: () => openPaymentForm(lead)
      }, 'üí≥'),
  hasPermission('leads', 'delete') && React.createElement('button', { 
      className: 'text-red-600 hover:text-red-900 text-xs px-2 py-1 rounded border border-red-200 hover:bg-red-50',
      onClick: () => handleDelete('leads', lead.id, lead.name),
      disabled: loading
  }, 'üóëÔ∏è')
)
)
);
})
)
),
// YOUR EXISTING PAGINATION - COMPLETELY UNCHANGED
sortedLeads.length > itemsPerPage && React.createElement('div', { className: 'flex justify-between items-center px-6 py-3 bg-gray-50 border-t' },
React.createElement('div', { className: 'text-sm text-gray-700' },
'Showing ' + (indexOfFirstItem + 1) + ' to ' + (Math.min(indexOfLastItem, sortedLeads.length)) + ' of ' + (sortedLeads.length) + ' leads'
),
React.createElement('div', { className: 'flex space-x-2' },
React.createElement('button', {
onClick: () => setCurrentLeadsPage(prev => Math.max(prev - 1, 1)),
disabled: currentLeadsPage === 1,
className: 'px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50'
}, 'Previous'),
React.createElement('span', { className: 'px-3 py-1' }, 'Page ' + (currentLeadsPage) + ' of ' + (totalPages)),
React.createElement('button', {
onClick: () => setCurrentLeadsPage(prev => Math.min(prev + 1, totalPages)),
disabled: currentLeadsPage === totalPages,
className: 'px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50'
}, 'Next')
)
)
) : React.createElement('div', { className: 'p-6 text-center text-gray-500' }, 
sortedLeads.length === 0 && leads.length > 0 ? 
'No leads match your current filters.' : 
'No leads found. Add your first lead!'
)
)
) :
// NEW: Client View Content
renderClientViewContent()
);
};



// NEW: Client View Content Function
const renderClientViewContent = () => {
if (clientsLoading) {
return React.createElement('div', { className: 'text-center py-12' },
React.createElement('div', { className: 'text-gray-500' }, 'Loading clients...')
);
}

if (clients.length === 0) {
return React.createElement('div', { className: 'bg-white rounded-lg shadow-sm border p-8 text-center' },
React.createElement('div', { className: 'text-gray-500 text-lg mb-2' }, 'No clients found'),
React.createElement('p', { className: 'text-gray-400' }, 'Clients will appear here when you have leads with phone numbers'),
React.createElement('div', { className: 'mt-4' },
React.createElement('button', {
onClick: () => setViewMode('leads'),
className: 'text-blue-600 hover:text-blue-800 underline'
}, 'Go to Lead View to create leads')
)
);
}

return React.createElement('div', { className: 'space-y-6' },

// Client Statistics Summary
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-4 gap-4' },
React.createElement('div', { className: 'bg-blue-50 border border-blue-200 rounded-lg p-4' },
React.createElement('div', { className: 'text-2xl font-bold text-blue-900' }, clients.length),
React.createElement('div', { className: 'text-sm text-blue-700' }, 'Total Clients')
),
React.createElement('div', { className: 'bg-green-50 border border-green-200 rounded-lg p-4' },
React.createElement('div', { className: 'text-2xl font-bold text-green-900' }, 
clients.filter(c => c.total_leads > 1).length
),
React.createElement('div', { className: 'text-sm text-green-700' }, 'Multi-Lead Clients')
),
React.createElement('div', { className: 'bg-purple-50 border border-purple-200 rounded-lg p-4' },
React.createElement('div', { className: 'text-2xl font-bold text-purple-900' }, 
clients.reduce((sum, c) => sum + c.total_leads, 0)
),
React.createElement('div', { className: 'text-sm text-purple-700' }, 'Total Leads')
),
React.createElement('div', { className: 'bg-orange-50 border border-orange-200 rounded-lg p-4' },
React.createElement('div', { className: 'text-2xl font-bold text-orange-900' }, 
'‚Çπ' + clients.reduce((sum, c) => sum + (parseFloat(c.total_value) || 0), 0).toLocaleString()
),
React.createElement('div', { className: 'text-sm text-orange-700' }, 'Total Client Value')
)
),

// Client Table
React.createElement('div', { className: 'bg-white rounded-lg shadow-sm border overflow-hidden' },
React.createElement('div', { className: 'px-6 py-4 border-b border-gray-200 bg-gray-50' },
React.createElement('h3', { className: 'text-lg font-medium text-gray-900' }, 'Clients Overview'),
React.createElement('p', { className: 'text-sm text-gray-600 mt-1' }, 
'Leads grouped by phone number - Click to see complete client timeline'
)
),
React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Client'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Leads'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Events'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Assigned To'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Status'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Value'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Actions')
)
),
React.createElement('tbody', { className: 'bg-white divide-y divide-gray-200' },
clients.map(client => {
const primaryLead = client.leads[0];
return React.createElement('tr', { key: client.client_id, className: 'hover:bg-gray-50' },
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { 
className: 'cursor-pointer hover:text-blue-600',
onClick: () => {
setSelectedClient(client);
setShowClientDetail(true);
}
},
React.createElement('div', { className: 'text-sm font-medium text-gray-900 hover:text-blue-600' }, 
primaryLead.name
),
React.createElement('div', { className: 'text-sm text-gray-500' }, primaryLead.phone),
React.createElement('div', { className: 'text-xs text-gray-400' }, 
`First contact: ${new Date(client.first_contact).toLocaleDateString()}`
)
)
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'flex items-center' },
React.createElement('span', { 
className: `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
  client.total_leads > 1 ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'
}`
}, 
client.total_leads,
client.total_leads > 1 && React.createElement('span', { className: 'ml-1' }, 'üîó')
)
)
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'text-sm text-gray-900' },
client.events.length > 0 ? client.events.slice(0, 2).join(', ') : '-'
),
client.events.length > 2 && React.createElement('div', { className: 'text-xs text-gray-500' },
`+${client.events.length - 2} more`
)
),
React.createElement('td', { className: 'px-6 py-4 text-sm text-gray-900' },
client.assigned_to || 'Unassigned'
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('span', { 
className: `px-2 py-1 text-xs rounded-full ${
client.status === 'converted' ? 'bg-green-100 text-green-800' :
client.status === 'dropped' ? 'bg-red-100 text-red-800' :
'bg-yellow-100 text-yellow-800'
}`
}, client.status || 'active')
),
React.createElement('td', { className: 'px-6 py-4 text-sm text-gray-900' },
client.total_value ? `‚Çπ${(parseFloat(client.total_value) || 0).toLocaleString()}` : '-'
),
React.createElement('td', { className: 'px-6 py-4 text-sm font-medium space-x-2' },
React.createElement('button', {
onClick: () => {
setSelectedClient(client);
setShowClientDetail(true);
},
className: 'text-blue-600 hover:text-blue-900'
}, 'View Timeline'),
hasPermission('leads', 'assign') && client.total_leads > 1 &&
React.createElement('button', {
onClick: () => {
// Bulk reassign functionality - will implement in next phase
alert(`Bulk reassign for ${client.total_leads} leads coming in next update!`);
},
className: 'text-green-600 hover:text-green-900 ml-2'
}, 'Reassign All')
)
);
})
)
)
)
)
);
};




const handleEditOrderSubmit = async (e) => {
e.preventDefault();
setLoading(true);

try {
// Prepare update data
const updateData = {
...orderEditData,
updated_date: new Date().toISOString(),
updated_by: user.name
};



// Clear rejection fields if status is not rejected
if (orderEditData.status !== 'rejected') {
updateData.rejection_reason = null;
updateData.rejected_date = null;
updateData.rejected_by = null;
} else if (orderEditData.status === 'rejected' && orderEditData.rejection_reason) {
// Set rejection metadata if status is rejected
updateData.rejected_date = new Date().toISOString();
updateData.rejected_by = user.name;
}

const response = await apiCall('/orders/' + (currentOrderForEdit.id), {
method: 'PUT',
body: JSON.stringify(updateData)
});

// Update local state
setOrders(prev => prev.map(order => 
order.id === currentOrderForEdit.id 
? { ...order, ...updateData }
: order
));

setShowEditOrderForm(false);
alert('Order updated successfully!');
} catch (error) {
console.error('Error updating order:', error);
alert('Failed to update order');
} finally {
setLoading(false);
}
};



const renderEditOrderForm = () => {
if (!showEditOrderForm || !currentOrderForEdit) return null;

return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
onClick: (e) => e.target === e.currentTarget && setShowEditOrderForm(false)
},
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[95vh] overflow-y-auto' },
React.createElement('h2', { className: 'text-xl font-bold mb-4' }, 'Edit Order'),
React.createElement('form', { onSubmit: handleEditOrderSubmit },
React.createElement('div', { className: 'mb-4' },
React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 'Order Number'),
React.createElement('input', {
type: 'text',
value: orderEditData.order_number || '',
disabled: true,
className: 'w-full px-3 py-2 border rounded-md bg-gray-100'
})
),
React.createElement('div', { className: 'mb-4' },
React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 'Client Name'),
React.createElement('input', {
type: 'text',
value: orderEditData.client_name || '',
disabled: true,
className: 'w-full px-3 py-2 border rounded-md bg-gray-100'
})
),
React.createElement('div', { className: 'mb-4' },
React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 'Assigned To'),
React.createElement('select', {
value: orderEditData.assigned_to || '',
onChange: (e) => setOrderEditData(prev => ({ ...prev, assigned_to: e.target.value })),
className: 'w-full px-3 py-2 border rounded-md',
required: true
},
React.createElement('option', { value: '' }, 'Select Assignee'),
...(users || []).filter(u => ['supply_executive', 'supply_sales_service_manager'].includes(u.role)).map(user =>
React.createElement('option', { key: user.id || user.email, value: user.email }, user.name)
)
)
),
React.createElement('div', { className: 'mb-4' },
React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 'Status'),
React.createElement('select', {
value: orderEditData.status || '',
onChange: (e) => setOrderEditData(prev => ({ ...prev, status: e.target.value })),
className: 'w-full px-3 py-2 border rounded-md'
},
Object.keys(ORDER_STATUSES).map(status =>
React.createElement('option', { key: status, value: status }, 
ORDER_STATUSES[status].label
)
)
)
),
React.createElement('div', { className: 'mb-4' },
React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 'Rejection Reason'),
React.createElement('textarea', {
value: orderEditData.rejection_reason || '',
onChange: (e) => setOrderEditData(prev => ({ ...prev, rejection_reason: e.target.value })),
className: 'w-full px-3 py-2 border rounded-md',
rows: 3,
placeholder: orderEditData.status === 'rejected' ? 'Please provide a reason for rejection' : 'Add rejection reason if applicable',
required: orderEditData.status === 'rejected'
})
),
React.createElement('div', { className: 'flex justify-end gap-2' },
React.createElement('button', {
type: 'button',
onClick: () => setShowEditOrderForm(false),
className: 'px-4 py-2 border rounded-md hover:bg-gray-50 dark:hover:bg-gray-700'
}, 'Cancel'),
React.createElement('button', {
type: 'submit',
disabled: loading,
className: 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50'
}, loading ? 'Updating...' : 'Update Order')
)
)
)
);
};




// Render order assignment modal
const renderOrderAssignModal = () => {
if (!showOrderAssignModal || !orderToAssign) return null;

return React.createElement('div', {
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
onClick: (e) => {
if (e.target === e.currentTarget) {
setShowOrderAssignModal(false);
setOrderToAssign(null);
}
}
},
React.createElement('div', { className: 'bg-white rounded-lg p-6 w-96' },
React.createElement('h3', { className: 'text-lg font-bold mb-4' }, 
'Assign Order #' + (orderToAssign.id)
),
React.createElement('div', { className: 'mb-4' },
React.createElement('p', { className: 'text-sm text-gray-600' }, 
'Client: ' + (orderToAssign.client_name)
),
React.createElement('p', { className: 'text-sm text-gray-600' }, 
'Event: ' + (orderToAssign.event_name)
)
),
React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 
'Assign to Supply Team Member'
),
React.createElement('select', {
className: 'w-full px-3 py-2 border rounded-md mb-4',
onChange: (e) => {
if (e.target.value) {
assignOrderToService(orderToAssign.id, e.target.value);
setShowOrderAssignModal(false);
setOrderToAssign(null);
}
}
},
React.createElement('option', { value: '' }, 'Select Team Member'),
(users || []).filter(u => ['supply_executive', 'supply_sales_service_manager'].includes(u.role)).map(user =>
React.createElement('option', { 
key: user.id || user.email, 
value: user.email 
}, user.name)
)
),
React.createElement('button', {
onClick: () => {
setShowOrderAssignModal(false);
setOrderToAssign(null);
},
className: 'px-4 py-2 text-gray-600 hover:text-gray-800'
}, 'Cancel')
)
);
};




const renderOrderDetail = () => {
if (!showOrderDetail || !currentOrderDetail) return null;

return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
onClick: (e) => e.target === e.currentTarget && setShowOrderDetail(false)
},
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg w-full max-w-4xl max-h-[95vh] overflow-y-auto' },
React.createElement('div', { className: 'sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center' },
React.createElement('h2', { className: 'text-2xl font-bold text-gray-900' }, 
'Order Details: ' + (currentOrderDetail.order_number)
),
React.createElement('button', {
onClick: () => setShowOrderDetail(false),
className: 'text-gray-400 hover:text-gray-600 text-2xl'
}, '‚úï')
),

React.createElement('div', { className: 'p-6 space-y-6' },
// Client Details
React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 'üë§ Client Information'),
React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Legal Name: '),
React.createElement('span', { className: 'text-gray-900' }, currentOrderDetail.legal_name || currentOrderDetail.client_name)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Email: '),
React.createElement('span', { className: 'text-gray-900' }, currentOrderDetail.client_email)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Phone: '),
React.createElement('span', { className: 'text-gray-900' }, currentOrderDetail.client_phone)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'GSTIN: '),
React.createElement('span', { className: 'text-gray-900' }, currentOrderDetail.gstin || 'Not Provided')
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Category: '),
React.createElement('span', { className: 'text-gray-900' }, currentOrderDetail.category_of_sale || 'B2C')
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'State: '),
React.createElement('span', { className: 'text-gray-900' }, currentOrderDetail.indian_state || 'Haryana')
)
),
currentOrderDetail.registered_address && React.createElement('div', { className: 'mt-3' },
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Address: '),
React.createElement('span', { className: 'text-gray-900' }, currentOrderDetail.registered_address)
)
),

// Order Details
React.createElement('div', { className: 'bg-blue-50 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 'üìã Order Information'),
React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Event: '),
React.createElement('span', { className: 'text-gray-900' }, currentOrderDetail.event_name)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Event Date: '),
React.createElement('span', { className: 'text-gray-900' }, 
new Date(currentOrderDetail.event_date).toLocaleDateString()
)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Tickets: '),
React.createElement('span', { className: 'text-gray-900' }, 
(currentOrderDetail.tickets_allocated) + ' - ' + (currentOrderDetail.ticket_category)
)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Status: '),
React.createElement('span', {
className: `px-2 py-1 text-xs rounded ${
ORDER_STATUSES[currentOrderDetail.status]?.color || 'bg-gray-100 text-gray-800'
}`
}, ORDER_STATUSES[currentOrderDetail.status]?.label || currentOrderDetail.status)
)
)
),

// Financial Details
React.createElement('div', { className: 'bg-green-50 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 'üí∞ Financial Details'),
React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Total Amount: '),
React.createElement('span', { className: 'text-gray-900 font-semibold' }, 
'‚Çπ' + formatCurrency(currentOrderDetail.final_amount || currentOrderDetail.total_amount || 0)
)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Advance Received: '),
React.createElement('span', { className: 'text-green-600 font-semibold' }, 
'‚Çπ' + formatCurrency(currentOrderDetail.advance_amount || 0)
)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Balance Due: '),
React.createElement('span', { className: 'text-orange-600 font-semibold' }, 
'‚Çπ' + formatCurrency((currentOrderDetail.final_amount || currentOrderDetail.total_amount || 0) - (currentOrderDetail.advance_amount || 0))
)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Total Tax: '),
React.createElement('span', { className: 'text-gray-900' }, 
'‚Çπ' + formatCurrency(currentOrderDetail.total_tax || 0)
)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Payment Method: '),
React.createElement('span', { className: 'text-gray-900' }, currentOrderDetail.payment_method)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Transaction ID: '),
React.createElement('span', { className: 'text-gray-900' }, currentOrderDetail.transaction_id)
)
)
),

// Documents Section
React.createElement('div', { className: 'bg-yellow-50 rounded-lg p-4' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 'üìé Uploaded Documents'),
React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'GST Certificate: '),
currentOrderDetail.gst_certificate 
? React.createElement('div', { className: 'mt-1' },
React.createElement('button', {
className: 'text-blue-600 hover:underline',
onClick: () => {
window.open(currentOrderDetail.gst_certificate.publicUrl, '_blank');
}
}, 'üìÑ View ' + (currentOrderDetail.gst_certificate.originalName)),
currentOrderDetail.gst_certificate.uploadedAt && React.createElement('div', { className: 'text-xs text-gray-500 mt-1' },
'Uploaded: ' + new Date(currentOrderDetail.gst_certificate.uploadedAt).toLocaleString()
)
)
: React.createElement('span', { className: 'text-gray-500' }, 'Not uploaded')
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'PAN Card: '),
currentOrderDetail.pan_card 
? React.createElement('div', { className: 'mt-1' },
React.createElement('button', {
className: 'text-blue-600 hover:underline',
onClick: () => {
window.open(currentOrderDetail.pan_card.publicUrl, '_blank');
}
}, 'üìÑ View ' + (currentOrderDetail.pan_card.originalName)),
currentOrderDetail.pan_card.uploadedAt && React.createElement('div', { className: 'text-xs text-gray-500 mt-1' },
'Uploaded: ' + new Date(currentOrderDetail.pan_card.uploadedAt).toLocaleString()
)
)
: React.createElement('span', { className: 'text-gray-500' }, 'Not uploaded')
)
)
),

// Approval Actions
hasPermission('orders', 'approve') && currentOrderDetail.status === 'pending_approval' && 
React.createElement('div', { className: 'flex space-x-4 pt-4 border-t' },
React.createElement('button', {
className: 'flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700',
onClick: () => {
setShowOrderDetail(false);
handleOrderApproval(currentOrderDetail.id, 'approve');
}
}, '‚úÖ Approve Order'),
React.createElement('button', {
className: 'flex-1 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700',
onClick: () => {
setShowOrderDetail(false);
handleOrderApproval(currentOrderDetail.id, 'reject');
}
}, '‚ùå Reject Order')
)
)
)
);
};




const renderStadiumsContent = () => {
// Filter and sort stadiums
const filteredStadiums = stadiums.filter(stadium => {
const matchesSearch = stadiumSearchQuery === '' || 
stadium.name.toLowerCase().includes(stadiumSearchQuery.toLowerCase()) ||
stadium.city.toLowerCase().includes(stadiumSearchQuery.toLowerCase()) ||
stadium.country.toLowerCase().includes(stadiumSearchQuery.toLowerCase());

const matchesSport = stadiumSportFilter === 'all' || stadium.sport_type === stadiumSportFilter;

return matchesSearch && matchesSport;
});

const sortedStadiums = filteredStadiums.sort((a, b) => {
let aValue = a[stadiumSortField] || '';
let bValue = b[stadiumSortField] || '';

if (typeof aValue === 'string') {
aValue = aValue.toLowerCase();
bValue = bValue.toLowerCase();
}

if (stadiumSortDirection === 'asc') {
return aValue > bValue ? 1 : -1;
} else {
return aValue < bValue ? 1 : -1;
}
});

return React.createElement('div', { className: 'space-y-6' },
// Header
React.createElement('div', { className: 'flex justify-between items-center' },
React.createElement('h1', { className: 'text-3xl font-bold text-gray-900 dark:text-white' }, 'Stadium Management'),
React.createElement('div', { className: 'flex gap-2' },
hasPermission('admin', 'write') && React.createElement('button', {
onClick: () => openStadiumForm(),
className: 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700'
}, '+ Add Stadium'),

React.createElement('button', {
onClick: populateDefaultStadiums,
className: 'bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700'
}, 'üèüÔ∏è Add Popular Stadiums')
)
),

// Stats Cards
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-4 gap-4' },
React.createElement('div', { className: 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow border' },
React.createElement('h3', { className: 'text-sm font-medium text-gray-500' }, 'Total Stadiums'),
React.createElement('p', { className: 'text-2xl font-bold text-blue-600' }, stadiums.length)
),
React.createElement('div', { className: 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow border' },
React.createElement('h3', { className: 'text-sm font-medium text-gray-500' }, 'Cricket Stadiums'),
React.createElement('p', { className: 'text-2xl font-bold text-green-600' }, 
stadiums.filter(s => s.sport_type === 'Cricket').length
)
),
React.createElement('div', { className: 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow border' },
React.createElement('h3', { className: 'text-sm font-medium text-gray-500' }, 'Football Stadiums'),
React.createElement('p', { className: 'text-2xl font-bold text-orange-600' }, 
stadiums.filter(s => s.sport_type === 'Football').length
)
),
React.createElement('div', { className: 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow border' },
React.createElement('h3', { className: 'text-sm font-medium text-gray-500' }, 'Countries'),
React.createElement('p', { className: 'text-2xl font-bold text-purple-600' }, 
new Set(stadiums.map(s => s.country)).size
)
)
),

// Filters
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow border p-4' },
React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-4 gap-4' },
// Search
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Search'),
React.createElement('input', {
type: 'text',
placeholder: 'Search stadiums...',
value: stadiumSearchQuery,
onChange: (e) => setStadiumSearchQuery(e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
})
),

// Sport filter
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Sport'),
React.createElement('select', {
value: stadiumSportFilter,
onChange: (e) => setStadiumSportFilter(e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
},
React.createElement('option', { value: 'all' }, 'All Sports'),
['Cricket', 'Football', 'Basketball', 'Tennis', 'Hockey', 'Formula 1', 'Multi-Sport', 'Other'].map(sport =>
React.createElement('option', { key: sport, value: sport }, sport)
)
)
),

// Sort field
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Sort By'),
React.createElement('select', {
value: stadiumSortField,
onChange: (e) => setStadiumSortField(e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
},
React.createElement('option', { value: 'name' }, 'Name'),
React.createElement('option', { value: 'city' }, 'City'),
React.createElement('option', { value: 'country' }, 'Country'),
React.createElement('option', { value: 'sport_type' }, 'Sport'),
React.createElement('option', { value: 'capacity' }, 'Capacity')
)
),

// Sort direction
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Order'),
React.createElement('button', {
onClick: () => setStadiumSortDirection(prev => prev === 'asc' ? 'desc' : 'asc'),
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 focus:ring-2 focus:ring-blue-500',
title: stadiumSortDirection === 'asc' ? 'Sort Descending' : 'Sort Ascending'
}, stadiumSortDirection === 'asc' ? '‚Üë Ascending' : '‚Üì Descending')
)
),

React.createElement('div', { className: 'mt-4 text-sm text-gray-600' },
`Showing ${sortedStadiums.length} of ${stadiums.length} stadiums`
)
),

// Stadiums Table
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow border' },
sortedStadiums.length > 0 ? React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-900' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Stadium'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Location'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Sport'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Capacity'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Actions')
)
),
React.createElement('tbody', { className: 'bg-white dark:bg-gray-700 divide-y divide-gray-200' },
sortedStadiums.map(stadium =>
React.createElement('tr', { key: stadium.id, className: 'hover:bg-gray-50 dark:hover:bg-gray-600' },
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', null,
React.createElement('div', { className: 'text-sm font-medium text-gray-900 dark:text-white' }, stadium.name),
stadium.nickname && React.createElement('div', { className: 'text-xs text-gray-500 dark:text-gray-400' }, `"${stadium.nickname}"`),
stadium.opened_year && React.createElement('div', { className: 'text-xs text-gray-400' }, `Est. ${stadium.opened_year}`)
)
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'text-sm text-gray-900 dark:text-white' }, 
`${stadium.city}${stadium.state ? ', ' + stadium.state : ''}`
),
React.createElement('div', { className: 'text-xs text-gray-500 dark:text-gray-400' }, stadium.country)
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('span', {
className: `px-2 py-1 text-xs rounded-full ${
stadium.sport_type === 'Cricket' ? 'bg-green-100 text-green-800' :
stadium.sport_type === 'Football' ? 'bg-blue-100 text-blue-800' :
stadium.sport_type === 'Multi-Sport' ? 'bg-purple-100 text-purple-800' :
'bg-gray-100 text-gray-800'
}`
}, stadium.sport_type)
),
React.createElement('td', { className: 'px-6 py-4 text-sm text-gray-900 dark:text-white' },
stadium.capacity ? stadium.capacity.toLocaleString() : 'N/A'
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'flex gap-2' },
hasPermission('admin', 'write') && React.createElement('button', {
onClick: () => openStadiumForm(stadium),
className: 'text-blue-600 hover:text-blue-900 text-sm px-2 py-1 rounded border border-blue-200 hover:bg-blue-50'
}, '‚úèÔ∏è'),
hasPermission('admin', 'delete') && React.createElement('button', {
onClick: () => handleDeleteStadium(stadium.id, stadium.name),
className: 'text-red-600 hover:text-red-900 text-sm px-2 py-1 rounded border border-red-200 hover:bg-red-50'
}, 'üóëÔ∏è'),
stadium.website && React.createElement('a', {
href: stadium.website,
target: '_blank',
className: 'text-green-600 hover:text-green-900 text-sm px-2 py-1 rounded border border-green-200 hover:bg-green-50'
}, 'üåê')
)
)
)
)
)
)
) : React.createElement('div', { className: 'p-8 text-center text-gray-500' },
React.createElement('p', { className: 'text-lg mb-4' }, 'No stadiums found'),
React.createElement('button', {
onClick: populateDefaultStadiums,
className: 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700'
}, 'Add Popular Stadiums to Get Started')
)
)
);
};



// 1. ESPN API ENDPOINTS AND FETCH FUNCTIONS
const SOFASCORE_API_BASE = "https://api.sofascore.com/api/v1";

// ESPN API fetch function with error handling
const fetchSofaScoreData = async (endpoint) => {
try {
const response = await fetch(endpoint, {
method: 'GET',
headers: {
'Accept': 'application/json',
'Content-Type': 'application/json'
}
});

if (!response.ok) {
throw new Error(`SofaScore API error: ${response.status}`);
}

const data = await response.json();
return data;
} catch (error) {
console.error('SofaScore API fetch error:', error);
return null;
}
};



// Fetch events from multiple sports leagues
const fetchAllEvents = async () => {
  try {
    console.log("Fetching all events from backend...");
    const response = await fetch(`${API_URL}/events`, {
      method: "GET",
      headers: { "Authorization": `Bearer ${localStorage.getItem("crm_auth_token")}` }
    });
    if (response.ok) {
      const result = await response.json();
      if (result.success && result.data) {
        const transformedEvents = result.data.map(event => ({
          id: event.id, title: event.event_name, date: event.start_date,
          time: event.start_time || "", venue: event.venue || "",
          category: event.sport_type || "", status: event.status || "upcoming",
          ...event
        }));
        setSportsEvents(transformedEvents);
      }
    }
  } catch (error) { console.error("Error fetching events:", error); }
};



const fetchSofaScoreEvents = async () => {
try {
setLoading(true);

// Define sports endpoints for different leagues
const sportsEndpoints = [
{
name: "Premier League",
endpoint: `${SOFASCORE_API_BASE}/unique-tournament/17/season/52186/events/last/0`,
category: "football"
},
{
name: "Champions League",
endpoint: `${SOFASCORE_API_BASE}/unique-tournament/7/season/52162/events/last/0`,
category: "football"
},
{
name: "NBA",
endpoint: `${SOFASCORE_API_BASE}/unique-tournament/132/season/58766/events/last/0`,
category: "basketball"
}
];

const allEvents = [];

// Fetch events from each sport
for (const sport of sportsEndpoints) {
const data = await fetchSofaScoreData(sport.endpoint);

if (data && data.events) {
const processedEvents = data.events.map(event => ({
id: `sofascore_${event.id}`,
title: `${event.name || event.shortName}`,
date: new Date(event.date).toISOString().split('T')[0],
time: new Date(event.date).toLocaleTimeString('en-US', { 
hour: '2-digit', 
minute: '2-digit',
hour12: false 
}),
venue: event.competitions?.[0]?.venue?.fullName || 'TBD',
category: sport.category,
description: `${sport.name} - ${event.status?.type?.description || 'Scheduled'}`,
ticket_available: true,
fantopark_package: generateFanToParkPackage(event, sport.name),
status: getEventStatus(event.status?.type?.name),
espn_data: {
league: sport.name,
competitors: event.competitions?.[0]?.competitors?.map(comp => ({
name: comp.team?.displayName,
logo: comp.team?.logo,
record: comp.records?.[0]?.summary
})) || [],
broadcasts: event.competitions?.[0]?.broadcasts || [],
odds: event.competitions?.[0]?.odds || []
}
}));

allEvents.push(...processedEvents);
}
}

// Sort events by date
allEvents.sort((a, b) => new Date(a.date) - new Date(b.date));

// Update state with fetched events
setSportsEvents(allEvents);
setLoading(false);

return allEvents;

} catch (error) {
console.error('Error fetching ESPN events:', error);
setLoading(false);

// Fallback to some basic events if ESPN API fails
setSportsEvents([
{
id: 'fallback_001',
title: 'ESPN API Unavailable - Sample Event',
date: new Date().toISOString().split('T')[0],
time: '20:00',
venue: 'Various Stadiums',
category: 'multi-sport',
description: 'ESPN API is currently unavailable. This is a fallback event.',
ticket_available: false,
fantopark_package: 'Please check back later for live events',
status: 'upcoming'
}
]);

return [];
}
};



// Generate FanToPark package descriptions based on event type
const generateFanToParkPackage = (event, sportName) => {
const venue = event.competitions?.[0]?.venue?.fullName || 'Stadium';
const competitors = event.competitions?.[0]?.competitors;

let packagePrice = '‚Çπ15,000';
let packageType = 'Standard Package';

// Customize package based on sport and event importance
if (sportName.includes('Cricket') || sportName.includes('ICC')) {
packagePrice = '‚Çπ25,000';
packageType = 'Cricket Premium Package';
} else if (sportName.includes('Premier League')) {
packagePrice = '‚Çπ35,000';
packageType = 'Premier League VIP Package';
} else if (sportName.includes('NFL')) {
packagePrice = '‚Çπ45,000';
packageType = 'NFL Elite Package';
} else if (sportName.includes('NBA')) {
packagePrice = '‚Çπ30,000';
packageType = 'NBA Courtside Package';
}

const teamNames = competitors?.map(c => c.team?.displayName).join(' vs ') || 'Teams TBD';

return `${packageType}: ${packagePrice} - ${teamNames} at ${venue}, Premium seating, refreshments, and match commentary`;
};



// Convert ESPN event status to our status format
const getEventStatus = (espnStatus) => {
if (!espnStatus) return 'upcoming';

switch (espnStatus.toLowerCase()) {
case 'scheduled':
case 'pre':
return 'upcoming';
case 'in':
case 'live':
return 'live';
case 'final':
case 'completed':
return 'completed';
case 'postponed':
case 'canceled':
return 'cancelled';
default:
return 'upcoming';
}
}; 

const renderSportsCalendarContent = () => {
const filteredEvents = sportsEvents.filter(event => {
const eventDate = new Date(event.date || event.start_date);
const selectedMonth = selectedDate.getMonth();
const selectedYear = selectedDate.getFullYear();

// Apply filters
let passesFilter = true;

// Date filter for month view
if (calendarView === 'month') {
passesFilter = eventDate.getMonth() === selectedMonth && eventDate.getFullYear() === selectedYear;
}

// Geography filter
if (calendarFilters.geography && passesFilter) {
passesFilter = event.geography === calendarFilters.geography;
}

// Sport type filter
if (calendarFilters.sport_type && passesFilter) {
passesFilter = event.sport_type === calendarFilters.sport_type || event.category === calendarFilters.sport_type;
}

// Priority filter
if (calendarFilters.priority && passesFilter) {
passesFilter = event.priority === calendarFilters.priority;
}

return passesFilter;
});

return React.createElement('div', { className: 'space-y-6' },
// Header
React.createElement('div', { className: 'flex justify-between items-center' },
React.createElement('div', null,
React.createElement('h1', { className: 'text-3xl font-bold text-gray-900 dark:text-white' }, 'üìÖ Sports Calendar'),
React.createElement('p', { className: 'text-gray-600 dark:text-gray-400 mt-1' }, 'Manage your sporting events with advanced filters and Excel integration'),
React.createElement('div', { className: 'flex items-center gap-4 mt-3' },
React.createElement('span', { className: 'text-sm font-medium text-gray-700' }, 'Priority Legend:'),
React.createElement('div', { className: 'flex items-center gap-1' },
React.createElement('div', { className: 'w-3 h-3 bg-red-500 rounded' }),
React.createElement('span', { className: 'text-xs' }, 'P1 High')
),
React.createElement('div', { className: 'flex items-center gap-1' },
React.createElement('div', { className: 'w-3 h-3 bg-yellow-500 rounded' }),
React.createElement('span', { className: 'text-xs' }, 'P2 Medium')
),
React.createElement('div', { className: 'flex items-center gap-1' },
React.createElement('div', { className: 'w-3 h-3 bg-green-500 rounded' }),
React.createElement('span', { className: 'text-xs' }, 'P3 Low')
)
),
React.createElement('div', { className: 'flex items-center mt-2 text-sm' },
React.createElement('span', { 
className: `px-2 py-1 rounded-full text-xs ${sportsEvents.length > 0 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`
}, sportsEvents.length > 0 ? `${filteredEvents.length}/${sportsEvents.length} Events` : 'Loading Events...'),
React.createElement('button', {
onClick: fetchAllEvents,
disabled: loading,
className: 'ml-3 text-blue-600 hover:text-blue-800 text-sm underline disabled:opacity-50'
}, loading ? 'Refreshing...' : 'üîÑ Refresh Events')
)
),
React.createElement('div', { className: 'flex flex-wrap gap-2' },
React.createElement('button', {
onClick: () => setShowEventForm(true),
className: 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2'
}, 
React.createElement('span', null, '‚ûï'),
'Add Event'
),
React.createElement('button', {
onClick: exportEventsToExcel,
className: 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2'
}, 
React.createElement('span', null, 'üì•'),
'Export Excel'
),
React.createElement('button', {
onClick: () => setShowImportModal(true),
className: 'bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2'
}, 
React.createElement('span', null, 'üì§'),
'Import Excel'
)
)
),

// Calendar Filters
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4' },
  React.createElement('h3', { className: 'text-lg font-semibold mb-3' }, 'üîç Filters'),
  React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-4 gap-4' },
    // Geography Filter
    React.createElement('div', null,
      React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Geography'),
      React.createElement('select', {
        value: calendarFilters.geography || '',
        onChange: (e) => setCalendarFilters({...calendarFilters, geography: e.target.value}),
        className: 'w-full p-2 border border-gray-300 rounded-lg'
      },
        React.createElement('option', { value: '' }, 'All Locations'),
        React.createElement('option', { value: 'India' }, 'India'),
        React.createElement('option', { value: 'UAE - Dubai' }, 'UAE - Dubai'),
        React.createElement('option', { value: 'UAE - Abu Dhabi' }, 'UAE - Abu Dhabi'),
        React.createElement('option', { value: 'UK' }, 'UK'),
        React.createElement('option', { value: 'USA' }, 'USA'),
        React.createElement('option', { value: 'Australia' }, 'Australia')
      )
    ),
    // Sport Type Filter
    React.createElement('div', null,
      React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Sport Type'),
      React.createElement('select', {
        value: calendarFilters.sport_type || '',
        onChange: (e) => setCalendarFilters({...calendarFilters, sport_type: e.target.value}),
        className: 'w-full p-2 border border-gray-300 rounded-lg'
      },
        React.createElement('option', { value: '' }, 'All Sports'),
        React.createElement('option', { value: 'Cricket' }, 'Cricket'),
        React.createElement('option', { value: 'Football' }, 'Football'),
        React.createElement('option', { value: 'Tennis' }, 'Tennis'),
        React.createElement('option', { value: 'Golf' }, 'Golf'),
        React.createElement('option', { value: 'Formula 1' }, 'Formula 1'),
        React.createElement('option', { value: 'Basketball' }, 'Basketball')
      )
    ),
    // Priority Filter
    React.createElement('div', null,
      React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Priority'),
      React.createElement('select', {
        value: calendarFilters.priority || '',
        onChange: (e) => setCalendarFilters({...calendarFilters, priority: e.target.value}),
        className: 'w-full p-2 border border-gray-300 rounded-lg'
      },
        React.createElement('option', { value: '' }, 'All Priorities'),
        React.createElement('option', { value: 'P1' }, 'P1 - High'),
        React.createElement('option', { value: 'P2' }, 'P2 - Medium'),
        React.createElement('option', { value: 'P3' }, 'P3 - Low')
      )
    ),
    // Clear Filters Button
    React.createElement('div', { className: 'flex items-end' },
      React.createElement('button', {
        onClick: () => setCalendarFilters({}),
        className: 'w-full px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg'
      }, 'Clear Filters')
    )
  )
),
                           
// Calendar Controls
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow p-4' },
React.createElement('div', { className: 'flex justify-between items-center mb-4' },
React.createElement('div', { className: 'flex items-center space-x-4' },
React.createElement('button', {
onClick: () => {
const newDate = new Date(selectedDate);
newDate.setMonth(newDate.getMonth() - 1);
setSelectedDate(newDate);
},
className: 'p-2 hover:bg-gray-100 rounded'
}, '‚Üê'),
React.createElement('h2', { className: 'text-xl font-semibold' }, 
selectedDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
),
React.createElement('button', {
onClick: () => {
const newDate = new Date(selectedDate);
newDate.setMonth(newDate.getMonth() + 1);
setSelectedDate(newDate);
},
className: 'p-2 hover:bg-gray-100 rounded'
}, '‚Üí')
),
React.createElement('div', { className: 'flex space-x-2' },
['month', 'list'].map(view =>
React.createElement('button', {
key: view,
onClick: () => setCalendarView(view),
className: `px-3 py-1 rounded text-sm ${calendarView === view ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}`
}, view.charAt(0).toUpperCase() + view.slice(1))
)
)
)
),

// Events Display
calendarView === 'month' ? renderMonthView(filteredEvents) : renderListView(filteredEvents),

// Import Modal
renderImportModal()
);
};




// 5. CALENDAR VIEW FUNCTIONS
const renderMonthView = (events) => {
const today = new Date();
const year = selectedDate.getFullYear();
const month = selectedDate.getMonth();
const firstDay = new Date(year, month, 1);
const lastDay = new Date(year, month + 1, 0);
const daysInMonth = lastDay.getDate();
const startingDayOfWeek = firstDay.getDay();

const days = [];

// Empty cells for days before month starts
for (let i = 0; i < startingDayOfWeek; i++) {
days.push(React.createElement('div', { key: `empty-${i}`, className: 'p-2 h-24' }));
}

// Days of the month
for (let day = 1; day <= daysInMonth; day++) {
const currentDate = new Date(year, month, day);
const dayEvents = events.filter(event => {
const eventStartDate = new Date(event.date || event.start_date);
    const eventEndDate = event.end_date ? new Date(event.end_date) : eventStartDate;
return eventStartDate.getDate() <= day && (eventEndDate.getDate() >= day || !event.end_date);
});

const isToday = currentDate.toDateString() === today.toDateString();

days.push(
React.createElement('div', {
key: day,
className: `p-2 h-24 border border-gray-200 ${isToday ? 'bg-blue-50' : 'bg-white'} hover:bg-gray-50 cursor-pointer`,
onClick: () => {
if (dayEvents.length > 0) {
setCurrentEvent(dayEvents[0]);
setShowEventDetail(true);
}
}
},
React.createElement('div', { className: `text-sm font-medium ${isToday ? 'text-blue-600' : 'text-gray-900'}` }, day),
dayEvents.map(event =>
React.createElement('div', {
key: event.id,
className: `text-xs p-1 mt-1 rounded truncate ${
getPriorityStyles(event.priority)
}`
}, event.title)
)
)
);
}

return React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow' },
React.createElement('div', { className: 'grid grid-cols-7 gap-0 border-b' },
['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day =>
React.createElement('div', {
key: day,
className: 'p-3 text-center font-medium text-gray-600 bg-gray-50'
}, day)
)
),
React.createElement('div', { className: 'grid grid-cols-7 gap-0' }, days)
);
};



const renderListView = (events) => {
const sortedEvents = events.sort((a, b) => new Date(a.date) - new Date(b.date));

return React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow' },
React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-700' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Event'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Date & Time'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Venue'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'League'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Status'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Actions')
)
),
React.createElement('tbody', { className: 'divide-y divide-gray-200 dark:divide-gray-700' },
sortedEvents.length > 0 ? sortedEvents.map(event =>
React.createElement('tr', {
key: event.id,
className: 'hover:bg-gray-50 cursor-pointer',
onClick: () => {
setCurrentEvent(event);
setShowEventDetail(true);
}
},
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', null,
React.createElement('div', { className: 'font-medium text-gray-900' }, event.title),
React.createElement('div', { className: 'text-sm text-gray-500' }, event.description),
event.espn_data?.competitors && React.createElement('div', { className: 'flex items-center mt-1 space-x-2' },
...event.espn_data.competitors.slice(0, 2).map((comp, idx) =>
React.createElement('div', { 
key: idx,
className: 'flex items-center space-x-1 text-xs text-gray-600'
},
comp.logo && React.createElement('img', { 
src: comp.logo, 
alt: comp.name,
className: 'w-4 h-4'
}),
React.createElement('span', null, comp.name)
)
)
)
)
),
React.createElement('td', { className: 'px-6 py-4 text-sm text-gray-900' },
React.createElement('div', null, new Date(event.date).toLocaleDateString()),
React.createElement('div', { className: 'text-gray-500' }, event.time)
),
React.createElement('td', { className: 'px-6 py-4 text-sm text-gray-900' }, 
event.venue.length > 30 ? event.venue.substring(0, 30) + '...' : event.venue
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('span', {
className: `px-2 py-1 text-xs rounded-full ${
event.category === 'cricket' ? 'bg-green-100 text-green-800' :
event.category === 'football' ? 'bg-blue-100 text-blue-800' :
event.category === 'basketball' ? 'bg-orange-100 text-orange-800' :
event.category === 'baseball' ? 'bg-red-100 text-red-800' :
'bg-purple-100 text-purple-800'
}`
}, event.espn_data?.league || event.category.toUpperCase())
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('span', {
className: `px-2 py-1 text-xs rounded-full ${
event.status === 'live' ? 'bg-red-100 text-red-800 animate-pulse' :
event.status === 'upcoming' ? 'bg-yellow-100 text-yellow-800' :
event.status === 'completed' ? 'bg-gray-100 text-gray-800' :
'bg-red-100 text-red-800'
}`
}, event.status.toUpperCase())
),
React.createElement('td', { className: 'px-6 py-4 text-sm' },
React.createElement('button', {
onClick: (e) => {
e.stopPropagation();
setCurrentEvent(event);
setShowEventDetail(true);
},
className: 'text-blue-600 hover:text-blue-800'
}, 'View Details')
)
)
) : React.createElement('tr', null,
React.createElement('td', { 
colSpan: 6, 
className: 'px-6 py-8 text-center text-gray-500'
}, 
loading ? 'Loading ESPN events...' : 'No events found. Click "Refresh Events" to try again.'
)
)
)
)
)
);
};



// 6. EVENT DETAIL MODAL
const renderEventDetailModal = () => {
if (!showEventDetail || !currentEvent) return null;

return React.createElement('div', {
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4',
style: { backdropFilter: 'blur(4px)' },
onClick: (e) => {
if (e.target === e.currentTarget) setShowEventDetail(false);
}
},
React.createElement('div', {
className: 'bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-auto shadow-2xl',
onClick: (e) => e.stopPropagation()
},
React.createElement('div', {
className: `p-6 border-b ${getPriorityStyles(currentEvent.priority)}`
},
React.createElement('div', { className: 'flex justify-between items-start' },
React.createElement('div', { className: 'flex-1' },
React.createElement('div', { className: 'flex items-center gap-3 mb-2' },
React.createElement('h2', { className: 'text-2xl font-bold' },
currentEvent.event_name || currentEvent.title
),
React.createElement('span', {
className: `px-3 py-1 text-sm font-semibold rounded-full ${getPriorityBadgeColor(currentEvent.priority)}`
}, currentEvent.priority || 'N/A')
),
React.createElement('p', { className: 'text-sm opacity-75' },
`${currentEvent.sport_type || currentEvent.category || 'Event'} ‚Ä¢ ${currentEvent.geography || 'Location TBD'}`
)
),
React.createElement('button', {
onClick: () => setShowEventDetail(false),
className: 'text-gray-500 hover:text-gray-700 text-2xl p-2 rounded-lg hover:bg-gray-100'
}, '‚úï')
)
),
React.createElement('div', { className: 'p-6 grid md:grid-cols-2 gap-6' },
React.createElement('div', { className: 'space-y-6' },
React.createElement('div', null,
React.createElement('h3', { className: 'text-lg font-semibold mb-3 flex items-center' },
React.createElement('span', { className: 'mr-2' }, 'üìÖ'),
'Date & Time'
),
React.createElement('div', { className: 'space-y-2 text-sm bg-gray-50 p-4 rounded-lg' },
React.createElement('div', { className: 'flex justify-between' },
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Date:'),
React.createElement('span', { className: 'text-gray-900' },
new Date(currentEvent.start_date || currentEvent.date).toLocaleDateString()
)
),
React.createElement('div', { className: 'flex justify-between' },
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Time:'),
React.createElement('span', { className: 'text-gray-900 font-mono' },
currentEvent.start_time || currentEvent.time || 'TBD'
)
)
)
),
currentEvent.venue && React.createElement('div', null,
React.createElement('h3', { className: 'text-lg font-semibold mb-3 flex items-center' },
React.createElement('span', { className: 'mr-2' }, 'üèüÔ∏è'),
'Venue'
),
React.createElement('div', { className: 'bg-gray-50 p-4 rounded-lg' },
React.createElement('div', { className: 'font-medium text-gray-900' },
currentEvent.venue
)
)
),
React.createElement('div', null,
React.createElement('h3', { className: 'text-lg font-semibold mb-3 flex items-center' },
React.createElement('span', { className: 'mr-2' }, 'üìä'),
'Status & Priority'
),
React.createElement('div', { className: 'flex flex-wrap gap-2' },
React.createElement('span', {
className: `px-3 py-1 text-sm font-semibold rounded-full ${getPriorityBadgeColor(currentEvent.priority)}`
}, `Priority ${currentEvent.priority || 'N/A'}`),
React.createElement('span', {
className: `px-3 py-1 text-sm font-semibold rounded-full ${
currentEvent.status === 'live' ? 'bg-red-500 text-white animate-pulse' :
currentEvent.status === 'upcoming' ? 'bg-blue-500 text-white' :
currentEvent.status === 'completed' ? 'bg-gray-500 text-white' :
'bg-gray-400 text-white'
}`
}, (currentEvent.status || 'upcoming').toUpperCase())
)
)
),
React.createElement('div', { className: 'space-y-6' },
currentEvent.fantopark_package && React.createElement('div', null,
React.createElement('h3', { className: 'text-lg font-semibold mb-3 flex items-center' },
React.createElement('span', { className: 'mr-2' }, 'üì¶'),
'FanToPark Package'
),
React.createElement('div', { className: 'bg-blue-50 p-4 rounded-lg border border-blue-200' },
React.createElement('p', { className: 'text-blue-900 text-sm' },
currentEvent.fantopark_package
)
)
),
currentEvent.description && React.createElement('div', null,
React.createElement('h3', { className: 'text-lg font-semibold mb-3 flex items-center' },
React.createElement('span', { className: 'mr-2' }, 'üìù'),
'Description'
),
React.createElement('div', { className: 'bg-gray-50 p-4 rounded-lg' },
React.createElement('p', { className: 'text-gray-700 text-sm' },
currentEvent.description
)
)
)
)
),
React.createElement('div', { className: 'px-6 pb-6 flex flex-wrap gap-3' },
React.createElement('button', {
onClick: () => {
setEventFormData({
...currentEvent,
event_name: currentEvent.event_name || currentEvent.title,
start_date: currentEvent.start_date || currentEvent.date,
start_time: currentEvent.start_time || currentEvent.time,
venue: currentEvent.venue,
sport_type: currentEvent.sport_type || currentEvent.category,
priority: currentEvent.priority,
status: currentEvent.status,
description: currentEvent.description,
fantopark_package: currentEvent.fantopark_package
});
setShowEventDetail(false);
setShowEventForm(true);
},
className: 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors flex items-center gap-2'
},
React.createElement('span', null, '‚úèÔ∏è'),
'Edit Event'
),
React.createElement('button', {
onClick: () => {
console.log('Creating lead for event:', currentEvent.id);
},
className: 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition-colors flex items-center gap-2'
},
React.createElement('span', null, 'üéØ'),
'Create Lead'
),
React.createElement('button', {
onClick: () => setShowEventDetail(false),
className: 'px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium transition-colors'
}, 'Close')
)
)
);
};



// 7. EVENT FORM MODAL
const renderEventFormModal = () => {
  if (!showEventForm) return null;

 const handleEventSubmit = async (e) => {
  e.preventDefault();
  
  try {
    // Sanitize event data - remove undefined values completely
    const sanitizeData = (data) => {
      const sanitized = {};
      Object.keys(data).forEach(key => {
        const value = data[key];
        
        // Only include non-undefined, non-null values
        if (value !== undefined && value !== null) {
          // Convert empty strings to actual empty strings, not null
          if (typeof value === 'string') {
            sanitized[key] = value.trim();
          } else if (typeof value === 'number' && !isNaN(value)) {
            sanitized[key] = value;
          } else if (typeof value === 'boolean') {
            sanitized[key] = value;
          } else if (value !== '') {
            sanitized[key] = value;
          }
        }
        // Skip completely if undefined, null, or problematic
      });
      return sanitized;
    };

    // Build clean event data object
    const cleanEventData = {};
    
    // Required fields
    if (eventFormData.event_name && eventFormData.event_name.trim()) {
      cleanEventData.event_name = eventFormData.event_name.trim();
    }
    if (eventFormData.event_type && eventFormData.event_type.trim()) {
      cleanEventData.event_type = eventFormData.event_type.trim();
    }
    if (eventFormData.sport_type && eventFormData.sport_type.trim()) {
      cleanEventData.sport_type = eventFormData.sport_type.trim();
    }
    if (eventFormData.geography && eventFormData.geography.trim()) {
      cleanEventData.geography = eventFormData.geography.trim();
    }
    if (eventFormData.start_date && eventFormData.start_date.trim()) {
      cleanEventData.start_date = eventFormData.start_date.trim();
    }
    if (eventFormData.venue && eventFormData.venue.trim()) {
      cleanEventData.venue = eventFormData.venue.trim();
    }
    if (eventFormData.priority && eventFormData.priority.trim()) {
      cleanEventData.priority = eventFormData.priority.trim();
    }
    
    // Optional fields - only add if they have actual values
    if (eventFormData.end_date && eventFormData.end_date.trim()) {
      cleanEventData.end_date = eventFormData.end_date.trim();
    }
    if (eventFormData.start_time && eventFormData.start_time.trim()) {
      cleanEventData.start_time = eventFormData.start_time.trim();
    }
    if (eventFormData.end_time && eventFormData.end_time.trim()) {
      cleanEventData.end_time = eventFormData.end_time.trim();
    }
    if (eventFormData.venue_capacity && eventFormData.venue_capacity !== '') {
      const capacity = parseInt(eventFormData.venue_capacity);
      if (!isNaN(capacity)) {
        cleanEventData.venue_capacity = capacity;
      }
    }
    if (eventFormData.venue_address && eventFormData.venue_address.trim()) {
      cleanEventData.venue_address = eventFormData.venue_address.trim();
    }
    if (eventFormData.official_ticketing_partners && eventFormData.official_ticketing_partners.trim()) {
      cleanEventData.official_ticketing_partners = eventFormData.official_ticketing_partners.trim();
    }
    if (eventFormData.primary_source && eventFormData.primary_source.trim()) {
      cleanEventData.primary_source = eventFormData.primary_source.trim();
    }
    if (eventFormData.secondary_source && eventFormData.secondary_source.trim()) {
      cleanEventData.secondary_source = eventFormData.secondary_source.trim();
    }
    if (eventFormData.sold_out_potential && eventFormData.sold_out_potential.trim()) {
      cleanEventData.sold_out_potential = eventFormData.sold_out_potential.trim();
    }
    if (eventFormData.remarks && eventFormData.remarks.trim()) {
      cleanEventData.remarks = eventFormData.remarks.trim();
    }
    if (eventFormData.fantopark_package && eventFormData.fantopark_package.trim()) {
      cleanEventData.fantopark_package = eventFormData.fantopark_package.trim();
    }
    
    // Boolean field
    cleanEventData.ticket_available = Boolean(eventFormData.ticket_available);
    
    // Status with default
    cleanEventData.status = eventFormData.status && eventFormData.status.trim() ? eventFormData.status.trim() : 'upcoming';

    console.log('Sending clean event data:', cleanEventData); // Debug log

    const url = currentEvent ? `${API_URL}/events/${currentEvent.id}` : `${API_URL}/events`;
    const method = currentEvent ? 'PUT' : 'POST';
    
    const response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('crm_auth_token')}`
      },
      body: JSON.stringify(cleanEventData)
    });

    const result = await response.json();
    
    if (result.success) {
      // Refresh events list
      await fetchSportsEvents();
      setShowEventForm(false);
      setCurrentEvent(null);
      resetEventForm();
      alert(currentEvent ? 'Event updated successfully!' : 'Event created successfully!');
    } else {
      throw new Error(result.error || 'Failed to save event');
    }
  } catch (error) {
    console.error('Error saving event:', error);
    alert('Error saving event: ' + error.message);
  }
};





  const resetEventForm = () => {
    setEventFormData({
      event_name: '',
      event_type: '',
      sport_type: '',
      geography: '',
      start_date: '',
      end_date: '',
      start_time: '',
      end_time: '',
      venue: '',
      venue_capacity: '',
      venue_address: '',
      official_ticketing_partners: '',
      primary_source: '',
      secondary_source: '',
      ticket_available: false,
      priority: '',
      status: 'upcoming',
      sold_out_potential: '',
      remarks: '',
      fantopark_package: ''
    });
  };

  const renderFormSection = (sectionName, title) => {
    const sectionFields = eventFormFields.filter(field => field.section === sectionName);
    
    return React.createElement('div', { className: 'mb-6' },
      React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-3 border-b pb-2' }, title),
      React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
        ...sectionFields.map(field => {
          if (field.type === 'textarea') {
            return React.createElement('div', { key: field.name, className: 'md:col-span-2' },
              React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
                field.label + (field.required ? ' *' : '')
              ),
              React.createElement('textarea', {
                value: eventFormData[field.name] || '',
                onChange: (e) => setEventFormData({...eventFormData, [field.name]: e.target.value}),
                className: 'w-full p-2 border border-gray-300 rounded-lg',
                required: field.required,
                rows: 3,
                placeholder: field.placeholder || ''
              })
            );
          } else if (field.type === 'select') {
            return React.createElement('div', { key: field.name },
              React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
                field.label + (field.required ? ' *' : '')
              ),
              React.createElement('select', {
                value: eventFormData[field.name] || '',
                onChange: (e) => setEventFormData({...eventFormData, [field.name]: e.target.value}),
                className: 'w-full p-2 border border-gray-300 rounded-lg',
                required: field.required
              },
                React.createElement('option', { value: '' }, `Select ${field.label}`),
                ...field.options.map(option =>
                  React.createElement('option', { key: option, value: option }, option)
                )
              )
            );
          } else if (field.type === 'checkbox') {
            return React.createElement('div', { key: field.name, className: 'flex items-center' },
              React.createElement('input', {
                type: 'checkbox',
                checked: eventFormData[field.name] || false,
                onChange: (e) => setEventFormData({...eventFormData, [field.name]: e.target.checked}),
                className: 'mr-2',
                id: field.name
              }),
              React.createElement('label', { 
                htmlFor: field.name,
                className: 'text-sm font-medium text-gray-700' 
              }, field.label)
            );
          } else {
            return React.createElement('div', { key: field.name },
              React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 
                field.label + (field.required ? ' *' : '')
              ),
              React.createElement('input', {
                type: field.type,
                value: eventFormData[field.name] || '',
                onChange: (e) => setEventFormData({...eventFormData, [field.name]: e.target.value}),
                className: 'w-full p-2 border border-gray-300 rounded-lg',
                required: field.required,
                placeholder: field.placeholder || ''
              })
            );
          }
        })
      )
    );
  };

  return React.createElement('div', {
    className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
    onClick: () => setShowEventForm(false)
  },
    React.createElement('div', {
      className: 'bg-white dark:bg-gray-800 rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto',
      onClick: (e) => e.stopPropagation()
    },
      React.createElement('form', { onSubmit: handleEventSubmit, className: 'p-6' },
        React.createElement('div', { className: 'flex justify-between items-center mb-6' },
          React.createElement('h2', { className: 'text-2xl font-bold' }, 
            currentEvent ? 'Edit Event' : 'Add New Event'
          ),
          React.createElement('button', {
            type: 'button',
            onClick: () => setShowEventForm(false),
            className: 'text-gray-400 hover:text-gray-600 text-2xl'
          }, '‚úï')
        ),

        // Form sections
        renderFormSection('basic', 'üìÖ Basic Information'),
        renderFormSection('datetime', '‚è∞ Date & Time'),
        renderFormSection('venue', 'üèüÔ∏è Venue Details'),
        renderFormSection('ticketing', 'üé´ Ticketing Information'),
        renderFormSection('status', 'üìä Priority & Status'),
        renderFormSection('additional', 'üìù Additional Information'),

        // Form actions
        React.createElement('div', { className: 'flex justify-end space-x-3 mt-6 pt-6 border-t' },
          React.createElement('button', {
            type: 'button',
            onClick: () => setShowEventForm(false),
            className: 'px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50'
          }, 'Cancel'),
          React.createElement('button', {
            type: 'submit',
            className: 'px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium'
          }, currentEvent ? 'Update Event' : 'Create Event')
        )
      )
    )
  );
};



// Enhanced inventory content with permission checks
const renderInventoryContent = () => {
// ENHANCED FILTERING - includes event type filter
const filteredInventory = inventory.filter(item => {
const daysUntilEvent = getInventoryDueInDays(item.event_date);

// Event name filter
if (inventoryEventFilter !== 'all' && item.event_name !== inventoryEventFilter) {
return false;
}

// Event type filter (NEW)
if (inventoryEventTypeFilter !== 'all' && item.event_type !== inventoryEventTypeFilter) {
return false;
}

// Due date filter
switch (inventoryDueDateFilter) {
case '3days':
return daysUntilEvent >= 0 && daysUntilEvent <= 3;
case '7days':
return daysUntilEvent >= 0 && daysUntilEvent <= 7;
case '15days':
return daysUntilEvent >= 0 && daysUntilEvent <= 15;
case '30days':
return daysUntilEvent >= 0 && daysUntilEvent <= 30;
case 'all':
default:
return true;
}
});

// ENHANCED SORTING - works on ALL filtered data before pagination
const sortedInventory = filteredInventory.sort((a, b) => {
let aValue, bValue;

switch (inventorySortField) {
case 'event_date':
aValue = new Date(a.event_date);
bValue = new Date(b.event_date);
break;
case 'event_name':
aValue = a.event_name.toLowerCase();
bValue = b.event_name.toLowerCase();
break;
case 'event_type':
aValue = (a.event_type || '').toLowerCase();
bValue = (b.event_type || '').toLowerCase();
break;
case 'available_tickets':
aValue = parseInt(a.available_tickets) || 0;
bValue = parseInt(b.available_tickets) || 0;
break;
default:
aValue = new Date(a.event_date);
bValue = new Date(b.event_date);
}

if (inventorySortDirection === 'asc') {
return aValue > bValue ? 1 : -1;
} else {
return aValue < bValue ? 1 : -1;
}
});

// Pagination logic for inventory (applied AFTER filtering and sorting)
const indexOfLastInventory = currentInventoryPage * itemsPerPage;
const indexOfFirstInventory = indexOfLastInventory - itemsPerPage;
const currentInventoryItems = sortedInventory.slice(indexOfFirstInventory, indexOfLastInventory);
const totalInventoryPages = Math.ceil(sortedInventory.length / itemsPerPage);

return React.createElement('div', { className: 'space-y-6' },
React.createElement('div', { className: 'flex justify-between items-center' },
React.createElement('h1', { className: 'text-3xl font-bold text-gray-900 dark:text-white' }, 'Inventory Management'),
hasPermission('inventory', 'write') && React.createElement('button', { 
className: 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700',
onClick: openAddInventoryForm
}, '+ Add New Event'),
React.createElement('button', {
onClick: () => {
setCSVUploadType('inventory');
setShowCSVUploadModal(true);
},
className: 'bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded flex items-center gap-2'
}, 
React.createElement('svg', {
className: 'w-5 h-5',
fill: 'none',
stroke: 'currentColor',
viewBox: '0 0 24 24'
},
React.createElement('path', {
strokeLinecap: 'round',
strokeLinejoin: 'round',
strokeWidth: 2,
d: 'M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12'
})
),
'Upload CSV'
)
),

// ENHANCED FILTERS SECTION
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow border p-4 mb-4' },
React.createElement('div', { className: 'flex space-x-4' },
React.createElement('div', { className: 'flex-1' },
React.createElement('div', {
style: {
display: currentUser?.role === 'super_admin' ? 'block' : 'none',
backgroundColor: testMode ? '#fef2f2' : '#fef3c7',
border: testMode ? '2px solid #dc2626' : '2px solid #f59e0b',
borderRadius: '8px',
padding: '12px 24px',
margin: '16px',
textAlign: 'center'
}
},
React.createElement('strong', {
style: { fontSize: '16px', marginRight: '16px' }
}, 'üß™ Test Mode is ' + (testMode ? 'ACTIVE' : 'INACTIVE')),
React.createElement('button', {
onClick: () => {
const newValue = !testMode;
setTestMode(newValue);
localStorage.setItem('testMode', String(newValue));
window.location.reload();
},
style: {
padding: '6px 20px',
borderRadius: '6px',
border: 'none',
backgroundColor: testMode ? '#dc2626' : '#10b981',
color: 'white',
cursor: 'pointer',
fontWeight: 'bold',
fontSize: '14px'
}
}, testMode ? 'TURN OFF' : 'TURN ON')
),

React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Filter by Due Date'),
React.createElement('select', {
value: inventoryDueDateFilter,
onChange: (e) => {
setInventoryDueDateFilter(e.target.value);
setCurrentInventoryPage(1);
},
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
},
React.createElement('option', { value: 'all' }, 'All Inventory'),
React.createElement('option', { value: '3days' }, 'Due in 3 Days'),
React.createElement('option', { value: '7days' }, 'Due in 7 Days'),
React.createElement('option', { value: '15days' }, 'Due in 15 Days'),
React.createElement('option', { value: '30days' }, 'Due in 1 Month')
)
),

React.createElement('div', { className: 'flex-1' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Filter by Event'),
React.createElement('select', {
value: inventoryEventFilter,
onChange: (e) => {
setInventoryEventFilter(e.target.value);
setCurrentInventoryPage(1);
},
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
},
React.createElement('option', { value: 'all' }, 'All Events'),
// Fixed to use ALL inventory data, not just current page
...Array.from(new Set(inventory.map(item => item.event_name))).sort().map(event =>
React.createElement('option', { key: event, value: event }, event)
)
)
),

// NEW: Event Type Filter
React.createElement('div', { className: 'flex-1' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Filter by Event Type'),
React.createElement('select', {
value: inventoryEventTypeFilter,
onChange: (e) => {
setInventoryEventTypeFilter(e.target.value);
setCurrentInventoryPage(1);
},
className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
},
React.createElement('option', { value: 'all' }, 'All Event Types'),
...Array.from(new Set(inventory.map(item => item.event_type).filter(Boolean))).sort().map(eventType =>
React.createElement('option', { key: eventType, value: eventType }, 
eventType.charAt(0).toUpperCase() + eventType.slice(1)
)
)
)
),

// NEW: Sort Controls
React.createElement('div', { className: 'flex-1' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Sort By'),
React.createElement('div', { className: 'flex gap-2' },
React.createElement('select', {
value: inventorySortField,
onChange: (e) => {
setInventorySortField(e.target.value);
setCurrentInventoryPage(1);
},
className: 'flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
},
React.createElement('option', { value: 'event_date' }, 'Event Date'),
React.createElement('option', { value: 'event_name' }, 'Event Name'),
React.createElement('option', { value: 'event_type' }, 'Event Type'),
React.createElement('option', { value: 'available_tickets' }, 'Available Tickets')
),
React.createElement('button', {
onClick: () => {
setInventorySortDirection(inventorySortDirection === 'asc' ? 'desc' : 'asc');
setCurrentInventoryPage(1);
},
className: 'px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 focus:ring-2 focus:ring-blue-500',
title: inventorySortDirection === 'asc' ? 'Sort Descending' : 'Sort Ascending'
}, inventorySortDirection === 'asc' ? '‚Üë' : '‚Üì')
)
)
),

// Filter Status Summary
React.createElement('div', { className: 'mt-4 flex justify-between items-center' },
React.createElement('span', { className: 'text-sm text-gray-600' },
`Showing ${sortedInventory.length} of ${inventory.length} events`
),
(inventoryEventFilter !== 'all' || inventoryEventTypeFilter !== 'all' || inventoryDueDateFilter !== 'all') &&
React.createElement('button', {
onClick: () => {
setInventoryEventFilter('all');
setInventoryEventTypeFilter('all');
setInventoryDueDateFilter('all');
setCurrentInventoryPage(1);
},
className: 'text-sm text-blue-600 hover:text-blue-800 underline'
}, 'Clear All Filters')
)
),

// YOUR EXISTING TABLE - UNCHANGED
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow border' },
inventory.length > 0 ? 
React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-900' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Event'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Sports'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Category'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Date'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Available'),
hasPermission('finance', 'read') && React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Margin'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Actions')
)
),
React.createElement('tbody', { className: 'bg-white divide-y divide-gray-200' },
currentInventoryItems.map(item =>
React.createElement('tr', { key: item.id, className: 'hover:bg-gray-50' },
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { 
className: 'cursor-pointer hover:text-blue-600',
onClick: () => openInventoryDetail(item)
},
React.createElement('div', { className: 'text-sm font-medium text-gray-900 hover:text-blue-600' }, item.event_name),
React.createElement('div', { className: 'text-sm text-gray-500' }, item.venue),
React.createElement('div', { className: 'text-xs text-gray-400' }, 
new Date(item.event_date).toLocaleDateString('en-US', { 
year: 'numeric', month: 'short', day: 'numeric' 
})
),
React.createElement('div', { className: 'text-xs text-blue-600 mt-1' }, 'üëÅÔ∏è Click to view details')
)
),
React.createElement('td', { className: 'px-6 py-4 text-sm text-gray-900' }, item.sports || item.event_type),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('span', {
className: `px-2 py-1 text-xs rounded ${
(item.category_of_ticket === 'VIP' || item.category_of_ticket === 'Premium') ? 'bg-purple-100 text-purple-800' :
(item.category_of_ticket === 'Gold') ? 'bg-yellow-100 text-yellow-800' :
'bg-green-100 text-green-800'
}`
}, item.category_of_ticket || 'General'),
item.stand ? React.createElement('div', { className: 'text-xs text-gray-500 mt-1' }, item.stand) : null
),
React.createElement('td', { className: 'px-6 py-4 text-sm text-gray-900' }, new Date(item.event_date).toLocaleDateString()),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('span', {
className: `px-2 py-1 text-xs rounded ${
item.available_tickets > 20 ? 'bg-green-100 text-green-800' :
item.available_tickets > 5 ? 'bg-yellow-100 text-yellow-800' :
'bg-red-100 text-red-800'
}`
}, item.available_tickets + ' tickets')
),
hasPermission('finance', 'read') && React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'text-sm text-gray-900' }, 
(() => {
const buyingPrice = item.buying_price || 0;
const sellingPrice = item.selling_price || item.price_per_ticket || 0;
const marginAmount = sellingPrice - buyingPrice;

// Calculate margin percentage: (Selling Price - Buying Price) / Buying Price * 100
const marginPercentage = buyingPrice > 0 ? ((marginAmount / sellingPrice) * 100) : 0;

return '‚Çπ' + marginAmount.toLocaleString() + ' (' + marginPercentage.toFixed(1) + '%)';
})()
),
React.createElement('div', { className: 'text-xs text-gray-500' },
'Buy: ‚Çπ' + (item.buying_price || 0).toLocaleString() + 
' | Sell: ‚Çπ' + (item.selling_price || item.price_per_ticket || 0).toLocaleString()
)
),
React.createElement('td', { className: 'px-6 py-4 text-sm' },
React.createElement('div', { className: 'flex flex-wrap gap-1' },
hasPermission('inventory', 'write') && React.createElement('button', { 
className: 'text-blue-600 hover:text-blue-900 text-xs px-2 py-1 rounded border border-blue-200 hover:bg-blue-50',
onClick: () => openEditInventoryForm(item)
}, '‚úèÔ∏è Edit'),

hasPermission('inventory', 'write') && React.createElement('button', { 
className: 'text-indigo-600 hover:text-indigo-900 text-xs px-2 py-1 rounded border border-indigo-200 hover:bg-indigo-50',
onClick: () => handleCopyInventory(item),
title: 'Create a copy of this inventory item',
disabled: loading
}, loading ? '‚è≥' : 'üìã Copy'),

hasPermission('inventory', 'allocate') && item.available_tickets > 0 && React.createElement('button', { 
className: 'text-green-600 hover:text-green-900 text-xs px-2 py-1 rounded border border-green-200 hover:bg-green-50',
onClick: () => openAllocationForm(item)
}, 'üé´ Allocate'),
hasPermission('inventory', 'read') && React.createElement('button', { 
className: 'text-purple-600 hover:text-purple-900 text-xs px-2 py-1 rounded border border-purple-200 hover:bg-purple-50',
onClick: () => openAllocationManagement(item)
}, 'üëÅÔ∏è View Allocations'),
hasPermission('inventory', 'delete') && React.createElement('button', { 
className: 'text-red-600 hover:text-red-900 text-xs px-2 py-1 rounded border border-red-200 hover:bg-red-50',
onClick: () => handleDelete('inventory', item.id, item.event_name),
disabled: loading
}, loading ? 'Deleting...' : 'üóëÔ∏è Delete')
)
)
)
)
)
),
// Updated pagination controls
sortedInventory.length > itemsPerPage && React.createElement('div', { className: 'flex justify-between items-center px-6 py-3 bg-gray-50 border-t' },
React.createElement('div', { className: 'text-sm text-gray-700' },
'Showing ' + (indexOfFirstInventory + 1) + ' to ' + (Math.min(indexOfLastInventory, sortedInventory.length)) + ' of ' + (sortedInventory.length) + ' events'
),
React.createElement('div', { className: 'flex space-x-2' },
React.createElement('button', {
onClick: () => setCurrentInventoryPage(prev => Math.max(prev - 1, 1)),
disabled: currentInventoryPage === 1,
className: 'px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50'
}, 'Previous'),
React.createElement('span', { className: 'px-3 py-1' }, 'Page ' + (currentInventoryPage) + ' of ' + (totalInventoryPages)),
React.createElement('button', {
onClick: () => setCurrentInventoryPage(prev => Math.min(prev + 1, totalInventoryPages)),
disabled: currentInventoryPage === totalInventoryPages,
className: 'px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50'
}, 'Next')
)
)
) : React.createElement('div', { className: 'p-6 text-center text-gray-500' }, 'No events found. Add your first event!')
)
);
};



// Enhanced orders content with permission checks
const renderOrdersContent = () => {
console.log("All orders:", orders);
console.log("Orders with is_deleted:", orders.filter(o => o.is_deleted));
console.log("Orders with status deleted:", orders.filter(o => o.status === "deleted"));
return React.createElement('div', { className: 'space-y-6' },
React.createElement('div', { className: 'flex justify-between items-center' },
React.createElement('h1', { className: 'text-3xl font-bold text-gray-900 dark:text-white' }, 'Order Management'),
React.createElement('div', { className: 'flex space-x-2' },
hasPermission('orders', 'write') && React.createElement('button', { 
className: 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700',
onClick: () => openAddForm('order')
}, '+ Manual Order')
)
),

React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow border' },
orders.length > 0 ? React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-900' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Order#'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Client'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Event'),
hasPermission('finance', 'read') && React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Amount'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Status'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Assigned To'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Actions')
)
),
React.createElement('tbody', { className: 'bg-white divide-y divide-gray-200' },
orders.map(order => {
const status = ORDER_STATUSES[order.status] || { label: order.status, color: 'bg-gray-100 text-gray-800', next: [] };

// ENHANCED: Handle both old and new order formats
const orderNumber = order.order_number || order.id || 'N/A';
const clientName = order.client_name || order.lead_name || 'Unknown Client';
const clientEmail = order.client_email || order.lead_email || '';
const clientPhone = order.client_phone || order.lead_phone || '';

// ENHANCED: Handle event display for multi-item orders
const getEventDisplay = (order) => {
if (order.invoice_items && Array.isArray(order.invoice_items) && order.invoice_items.length > 0) {
// New multi-item format
const firstItem = order.invoice_items[0].description;
const itemCount = order.invoice_items.length;
return itemCount > 1 ? `${firstItem} (+${itemCount-1} more)` : firstItem;
} else {
// Old format
return order.event_name || 'No Event';
}
};



// ENHANCED: Handle amount display for new GST/TCS format
const getAmountDisplay = (order) => {
// Try different amount fields in order of preference
if (order.final_amount) return order.final_amount;
if (order.total_amount) return order.total_amount;
if (order.amount) return order.amount;
if (order.base_amount) return order.base_amount;
return 0;
};



// ENHANCED: Handle tickets display for both formats
const getTicketDisplay = (order) => {
if (order.invoice_items && Array.isArray(order.invoice_items)) {
// New format - sum quantities
const totalQuantity = order.invoice_items.reduce((sum, item) => sum + (item.quantity || 0), 0);
return `${totalQuantity} items - ${order.category_of_sale || 'Mixed'}`;
} else {
// Old format
return `${order.tickets_allocated || 0} tickets - ${order.ticket_category || ""}`;
}
};



return React.createElement('tr', { 
key: order.id, 
className: 'hover:bg-gray-50',
// ENHANCED: Highlight new format orders with subtle background
style: order.invoice_items ? { backgroundColor: '#fefbff' } : {}
},
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'text-sm font-medium text-gray-900' }, orderNumber),
React.createElement('div', { className: 'text-xs text-gray-500' }, 
new Date(order.created_date || order.created_at || Date.now()).toLocaleDateString()
),
// ENHANCED: Show format indicator
order.invoice_items && React.createElement('div', { className: 'text-xs text-blue-600 font-medium' }, 
'‚úì Multi-Item'
)
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'text-sm font-medium text-gray-900' }, clientName),
clientEmail && React.createElement('div', { className: 'text-xs text-gray-500' }, clientEmail),
clientPhone && React.createElement('div', { className: 'text-xs text-gray-500' }, clientPhone)
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'text-sm text-gray-900' }, getEventDisplay(order)),
React.createElement('div', { className: 'text-xs text-gray-500' }, getTicketDisplay(order)),
order.event_date && React.createElement('div', { className: 'text-xs text-blue-600' }, 
new Date(order.event_date).toLocaleDateString()
)
),
hasPermission('finance', 'read') && React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'text-sm font-medium text-gray-900' }, 
'‚Çπ' + getAmountDisplay(order).toLocaleString()
),
// ENHANCED: Show GST/TCS info for new format
order.gst_calculation && React.createElement('div', { className: 'text-xs text-green-600' }, 
`+GST: ‚Çπ${(order.gst_calculation.total || 0).toLocaleString()}`
),
order.tcs_calculation && order.tcs_calculation.applicable && React.createElement('div', { className: 'text-xs text-orange-600' }, 
`+TCS: ‚Çπ${(order.tcs_calculation.amount || 0).toLocaleString()}`
),
// PRESERVED: Original payment method display
order.payment_method && React.createElement('div', { className: 'text-xs text-green-600' }, 
'Paid via ' + order.payment_method
)
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('span', {
className: 'px-2 py-1 text-xs rounded ' + (status.color)
}, status.label)
),
React.createElement('td', { className: 'px-6 py-4' },
// PRESERVED: Original payment type logic
order.payment_type === 'post_service' ? (
order.payment_received ? 
React.createElement('span', { className: 'px-2 py-1 text-xs rounded bg-green-100 text-green-800' }, 'Received') :
React.createElement('span', { className: 'px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800' }, 'Pending')
) : React.createElement('span', { className: 'px-2 py-1 text-xs rounded bg-gray-100 text-gray-800' }, 'Prepaid')
),
React.createElement('td', { className: 'px-6 py-4' },
// PRESERVED: Original assignment logic
(() => {
// For pending approval orders
if (order.status === 'pending_approval') {
if (order.order_type === 'payment_post_service') {
return React.createElement('div', null,
React.createElement('div', { className: 'text-sm font-medium text-purple-600' }, 'Sales Head'),
React.createElement('div', { className: 'text-xs text-gray-500' }, 'Awaiting Approval')
);
} else {
return React.createElement('div', null,
React.createElement('div', { className: 'text-sm font-medium text-green-600' }, 'Finance Team'),
React.createElement('div', { className: 'text-xs text-gray-500' }, 'Awaiting Approval')
);
}
}

// For assigned orders
if (order.assigned_to) {
return React.createElement('div', null,
React.createElement('div', { className: 'text-sm font-medium text-blue-600' }, order.assigned_to),
React.createElement('div', { className: 'text-xs text-gray-500' }, 'Service Team')
);
}

// Default unassigned
return React.createElement('span', { className: 'text-sm text-gray-400' }, 'Unassigned');
})()
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'flex flex-wrap gap-1' },
// PRESERVED: View button - always visible for all orders
React.createElement('button', {
key: 'view',
className: 'text-blue-600 hover:text-blue-900 text-xs px-2 py-1 rounded border border-blue-200 hover:bg-blue-50',
onClick: () => openOrderDetail(order)
}, 'üëÅÔ∏è View'),

// PRESERVED: Finance approval buttons
hasPermission('orders', 'approve') && order.status === 'pending_approval' && [
// Show if this requires sales head approval
order.order_type === 'payment_post_service' && React.createElement('span', {
key: 'sales-head-label',
className: 'px-2 py-1 text-xs rounded bg-purple-100 text-purple-800'
}, 'Sales Head Approval'),
React.createElement('button', {
key: 'approve',
className: 'text-green-600 hover:text-green-900 text-xs px-2 py-1 rounded border border-green-200 hover:bg-green-50',
onClick: () => handleOrderApproval(order.id, 'approve'),
disabled: loading
}, '‚úÖ Approve'),
React.createElement('button', {
key: 'reject',
className: 'text-red-600 hover:text-red-900 text-xs px-2 py-1 rounded border border-red-200 hover:bg-red-50',
onClick: () => handleOrderApproval(order.id, 'reject'),
disabled: loading
}, '‚ùå Reject')
],

// PRESERVED: View Invoice button
order.invoice_number && React.createElement('button', {
key: 'view-invoice',
className: 'text-purple-600 hover:text-purple-900 text-xs px-2 py-1 rounded border border-purple-200 hover:bg-purple-50',
onClick: () => {
console.log('Looking for invoice for order:', order.id);

// ENHANCED: Better invoice reconstruction for new format
if (order.invoice_number) {
const reconstructedInvoice = {
id: order.invoice_id || order.id,
invoice_number: order.invoice_number,
order_id: order.id,
order_number: order.order_number,
client_name: order.legal_name || order.client_name,
client_email: order.client_email,
gstin: order.gstin,
legal_name: order.legal_name,
category_of_sale: order.category_of_sale,
type_of_sale: order.type_of_sale,
registered_address: order.registered_address,
indian_state: order.indian_state,
is_outside_india: order.is_outside_india,
// ENHANCED: Handle both old and new invoice formats
invoice_items: order.invoice_items || [{
description: order.event_name || 'Service',
quantity: order.tickets_allocated || 1,
rate: order.price_per_ticket || (order.total_amount || 0)
}],
base_amount: order.base_amount || order.total_amount || order.amount || 0,
gst_calculation: order.gst_calculation || {
applicable: false,
rate: 0,
cgst: 0,
sgst: 0,
igst: 0,
total: 0
},
tcs_calculation: order.tcs_calculation || {
applicable: false,
rate: 0,
amount: 0
},
total_tax: order.total_tax || 0,
final_amount: order.final_amount || order.total_amount || order.amount || 0,
invoice_date: order.approved_date || new Date().toISOString().split('T')[0],
due_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
status: 'generated',
generated_by: order.approved_by || 'System',
// ENHANCED: Add payment currency for new format
payment_currency: order.payment_currency || 'INR'
};


console.log('Reconstructed invoice:', reconstructedInvoice);
openInvoicePreview(reconstructedInvoice);
} else {
alert('Invoice not found for this order');
}
}
}, 'üìÑ View Invoice'),

// PRESERVED: Service assignment
hasPermission('orders', 'assign') && order.status === 'approved' && !order.assigned_to &&
React.createElement('button', {
className: 'text-blue-600 hover:text-blue-900 text-xs px-2 py-1 rounded border border-blue-200 hover:bg-blue-50',
onClick: () => {
setSelectedOrderForAssignment(order);
setShowOrderAssignmentModal(true);
},
disabled: loading
}, '‚Üí Assign'),

// PRESERVED: Complete order
hasPermission('orders', 'write') && order.status === 'service_assigned' && React.createElement('button', {
className: 'text-green-600 hover:text-green-900 text-xs px-2 py-1 rounded border border-green-200 hover:bg-green-50',
onClick: () => {
setOrders(prev => 
prev.map(o => 
o.id === order.id 
? { ...o, status: 'completed', completed_date: new Date().toISOString().split('T')[0] }
: o
)
);
alert('Order marked as completed!');
},
disabled: loading
}, '‚úÖ Complete'),

// PRESERVED: Edit button
hasPermission('orders', 'write') && React.createElement('button', {
className: 'text-purple-600 hover:text-purple-900 text-xs px-2 py-1 rounded border border-purple-200 hover:bg-purple-50',
onClick: () => openEditOrderForm(order)
}, '‚úèÔ∏è Edit'),

// PRESERVED: Delete button
hasPermission('orders', 'delete') && React.createElement('button', { 
className: 'text-red-600 hover:text-red-900 text-xs px-2 py-1 rounded border border-red-200 hover:bg-red-50',
onClick: () => handleDelete('orders', order.id, order.order_number),
disabled: loading
}, 'üóëÔ∏è Delete')
)
)
);
})
)
)
) : React.createElement('div', { className: 'p-6 text-center text-gray-500' }, 'No orders found.')
)
);
};



const renderDeliveryContent = () => {
const DELIVERY_STATUSES = {
pending: { label: 'Pending', color: 'bg-yellow-100 text-yellow-800' },
scheduled: { label: 'Scheduled', color: 'bg-blue-100 text-blue-800' },
in_transit: { label: 'In Transit', color: 'bg-purple-100 text-purple-800' },
delivered: { label: 'Delivered', color: 'bg-green-100 text-green-800' },
failed: { label: 'Failed', color: 'bg-red-100 text-red-800' }
};



return React.createElement('div', { className: 'space-y-6' },
React.createElement('div', { className: 'flex justify-between items-center' },
React.createElement('h1', { className: 'text-3xl font-bold text-gray-900 dark:text-white' }, 'Delivery Management'),
React.createElement('div', { className: 'text-sm text-gray-600 dark:text-gray-400' },
'Track and manage ticket deliveries'
)
),

React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg shadow border' },
deliveries.length > 0 ? React.createElement('div', { className: 'overflow-x-auto' },
React.createElement('table', { className: 'w-full' },
React.createElement('thead', { className: 'bg-gray-50 dark:bg-gray-900' },
React.createElement('tr', null,
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Delivery#'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Order Details'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Client'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Type'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Assigned To'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Status'),
React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase' }, 'Actions')
)
),
React.createElement('tbody', { className: 'bg-white divide-y divide-gray-200' },
deliveries.map(delivery => {
const status = DELIVERY_STATUSES[delivery.status] || { label: delivery.status, color: 'bg-gray-100 text-gray-800' };

return React.createElement('tr', { key: delivery.id, className: 'hover:bg-gray-50' },
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'text-sm font-medium text-gray-900' }, delivery.delivery_number),
React.createElement('div', { className: 'text-xs text-gray-500' }, 
new Date(delivery.created_date).toLocaleDateString()
)
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'text-sm text-gray-900' }, delivery.order_number),
React.createElement('div', { className: 'text-xs text-gray-500' }, delivery.event_name),
React.createElement('div', { className: 'text-xs text-blue-600' }, 
(delivery.tickets_count) + ' tickets'
)
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'text-sm font-medium text-gray-900' }, delivery.client_name),
React.createElement('div', { className: 'text-xs text-gray-500' }, delivery.client_phone)
),
React.createElement('td', { className: 'px-6 py-4' },
delivery.delivery_type ? React.createElement('span', {
className: `px-2 py-1 text-xs rounded ${
delivery.delivery_type === 'online' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'
}`
}, delivery.delivery_type.charAt(0).toUpperCase() + delivery.delivery_type.slice(1)) :
React.createElement('span', { className: 'text-xs text-gray-400' }, 'Not Set')
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'text-sm font-medium text-blue-600' }, delivery.assigned_to),
React.createElement('div', { className: 'text-xs text-gray-500' }, 'Supply Team')
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('span', {
className: 'px-2 py-1 text-xs rounded ' + (status.color)
}, status.label)
),
React.createElement('td', { className: 'px-6 py-4' },
React.createElement('div', { className: 'flex flex-wrap gap-1' },
hasPermission('delivery', 'write') && delivery.status === 'pending' && 
React.createElement('button', {
className: 'text-blue-600 hover:text-blue-900 text-xs px-2 py-1 rounded border border-blue-200 hover:bg-blue-50',
onClick: () => openDeliveryForm(delivery)
}, 'üìÖ Schedule'),
hasPermission('delivery', 'write') && 
React.createElement('button', {
className: 'text-red-600 hover:text-red-900 text-xs px-2 py-1 rounded border border-red-200 hover:bg-red-50',
onClick: () => deleteDelivery(delivery.id),
disabled: loading
}, 'üóëÔ∏è Delete'),
hasPermission('delivery', 'write') && delivery.status === 'scheduled' && 
React.createElement('button', {
className: 'text-purple-600 hover:text-purple-900 text-xs px-2 py-1 rounded border border-purple-200 hover:bg-purple-50',
onClick: () => {
setDeliveries(prev => 
prev.map(d => 
d.id === delivery.id 
? { ...d, status: 'in_transit' }
: d
)
);
alert('Delivery marked as in transit!');
}
}, 'üöö Start'),
hasPermission('delivery', 'write') && delivery.status === 'in_transit' && 
React.createElement('button', {
className: 'text-green-600 hover:text-green-900 text-xs px-2 py-1 rounded border border-green-200 hover:bg-green-50',
onClick: () => {
setDeliveries(prev => 
prev.map(d => 
d.id === delivery.id 
? { ...d, status: 'delivered', delivered_date: new Date().toISOString().split('T')[0] }
: d
)
);
alert('Delivery completed successfully!');
}
}, '‚úÖ Complete'),
delivery.status === 'scheduled' && delivery.delivery_type && 
React.createElement('button', {
className: 'text-gray-600 hover:text-gray-900 text-xs px-2 py-1 rounded border border-gray-200 hover:bg-gray-50',
onClick: () => {
let details = 'Delivery Type: ' + (delivery.delivery_type) + '\n';
if (delivery.delivery_type === 'online') {
details += 'Platform: ' + (delivery.online_platform) + '\n';
details += 'Link: ' + (delivery.online_link);
} else {
details += 'Delivery Location: ' + (delivery.delivery_location) + '\n';
details += 'Date: ' + (delivery.delivery_date) + ' ' + (delivery.delivery_time);
if (delivery.pickup_location) {
details += '\nPickup: ' + (delivery.pickup_location);
}
}
alert(details);
}
}, 'üëÅÔ∏è View Details')
)
)
);
})
)
)
) : React.createElement('div', { className: 'p-6 text-center text-gray-500' }, 
'No deliveries found. Deliveries will appear here when orders are assigned to supply team.'
)
)
);
};



const renderDeliveryForm = () => {
if (!showDeliveryForm || !currentDelivery) return null;

return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
onClick: (e) => e.target === e.currentTarget && closeForm()
},
React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[95vh] overflow-y-auto' },
React.createElement('div', { className: 'flex justify-between items-center mb-6' },
React.createElement('h2', { className: 'text-xl font-bold text-gray-900 dark:text-white' }, 
'Schedule Delivery: ' + (currentDelivery.order_number)
),
React.createElement('button', {
onClick: closeForm,
className: 'text-gray-400 hover:text-gray-600 text-2xl'
}, '‚úï')
),

// Order Details
React.createElement('div', { className: 'mb-6 p-4 bg-gray-50 rounded-lg' },
React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-3' }, 'üìã Order Details'),
React.createElement('div', { className: 'grid grid-cols-2 gap-4 text-sm' },
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Client: '),
React.createElement('span', { className: 'text-gray-900' }, currentDelivery.client_name)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Event: '),
React.createElement('span', { className: 'text-gray-900' }, currentDelivery.event_name)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Tickets: '),
React.createElement('span', { className: 'text-gray-900' }, currentDelivery.tickets_count)
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium text-gray-700' }, 'Event Date: '),
React.createElement('span', { className: 'text-gray-900' }, 
new Date(currentDelivery.event_date).toLocaleDateString()
)
)
)
),

React.createElement('form', { onSubmit: handleDeliverySubmit },
// Delivery Type Selection
React.createElement('div', { className: 'mb-6' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Delivery Type *'),
React.createElement('div', { className: 'flex space-x-4' },
React.createElement('label', { className: 'flex items-center' },
React.createElement('input', {
type: 'radio',
name: 'delivery_type',
value: 'online',
checked: deliveryFormData.delivery_type === 'online',
onChange: (e) => handleDeliveryInputChange('delivery_type', e.target.value),
className: 'mr-2'
}),
React.createElement('span', { className: 'text-sm' }, 'Online Delivery')
),
React.createElement('label', { className: 'flex items-center' },
React.createElement('input', {
type: 'radio',
name: 'delivery_type',
value: 'offline',
checked: deliveryFormData.delivery_type === 'offline',
onChange: (e) => handleDeliveryInputChange('delivery_type', e.target.value),
className: 'mr-2'
}),
React.createElement('span', { className: 'text-sm' }, 'Offline Delivery')
)
)
),

// Online Delivery Fields
deliveryFormData.delivery_type === 'online' && React.createElement('div', { className: 'mb-6 p-4 bg-blue-50 rounded-lg' },
React.createElement('h4', { className: 'text-md font-semibold text-gray-800 mb-3' }, 'üíª Online Delivery Details'),
React.createElement('div', { className: 'grid grid-cols-1 gap-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Platform *'),
React.createElement('select', {
value: deliveryFormData.online_platform || '',
onChange: (e) => handleDeliveryInputChange('online_platform', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: deliveryFormData.delivery_type === 'online'
},
React.createElement('option', { value: '' }, 'Select Platform'),
React.createElement('option', { value: 'email' }, 'Email'),
React.createElement('option', { value: 'whatsapp' }, 'WhatsApp'),
React.createElement('option', { value: 'portal' }, 'Client Portal'),
React.createElement('option', { value: 'other' }, 'Other')
)
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Delivery Link/Details'),
React.createElement('input', {
type: 'text',
value: deliveryFormData.online_link || '',
onChange: (e) => handleDeliveryInputChange('online_link', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
placeholder: 'Enter link or delivery details'
})
)
)
),

// Offline Delivery Fields
deliveryFormData.delivery_type === 'offline' && React.createElement('div', { className: 'mb-6 p-4 bg-green-50 rounded-lg' },
React.createElement('h4', { className: 'text-md font-semibold text-gray-800 mb-3' }, 'üöö Offline Delivery Details'),
React.createElement('div', { className: 'grid grid-cols-1 gap-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Pickup Location (Optional)'),
React.createElement('textarea', {
value: deliveryFormData.pickup_location || '',
onChange: (e) => handleDeliveryInputChange('pickup_location', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
rows: 2,
placeholder: 'Enter pickup location if tickets need to be collected'
})
),
React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Pickup Date'),
React.createElement('input', {
type: 'date',
value: deliveryFormData.pickup_date || '',
onChange: (e) => handleDeliveryInputChange('pickup_date', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500'
})
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Pickup Time'),
React.createElement('input', {
type: 'time',
value: deliveryFormData.pickup_time || '',
onChange: (e) => handleDeliveryInputChange('pickup_time', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500'
})
)
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Delivery Location *'),
React.createElement('textarea', {
value: deliveryFormData.delivery_location || '',
onChange: (e) => handleDeliveryInputChange('delivery_location', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
rows: 2,
placeholder: 'Enter delivery address',
required: deliveryFormData.delivery_type === 'offline'
})
),
React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Delivery Date *'),
React.createElement('input', {
type: 'date',
value: deliveryFormData.delivery_date || '',
onChange: (e) => handleDeliveryInputChange('delivery_date', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
required: deliveryFormData.delivery_type === 'offline'
})
),
React.createElement('div', null,
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Delivery Time'),
React.createElement('input', {
type: 'time',
value: deliveryFormData.delivery_time || '',
onChange: (e) => handleDeliveryInputChange('delivery_time', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500'
})
)
)
)
),

// Common Fields
React.createElement('div', { className: 'mb-6' },
React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Delivery Notes'),
React.createElement('textarea', {
value: deliveryFormData.delivery_notes || '',
onChange: (e) => handleDeliveryInputChange('delivery_notes', e.target.value),
className: 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500',
rows: 3,
placeholder: 'Any special instructions or notes'
})
),

React.createElement('div', { className: 'flex space-x-4 pt-4 border-t' },
React.createElement('button', {
type: 'button',
onClick: closeForm,
className: 'flex-1 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50'
}, 'Cancel'),
React.createElement('button', {
type: 'submit',
disabled: loading,
className: 'flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50'
}, loading ? 'Scheduling...' : 'Schedule Delivery')
)
)
)
);
};


// FIXED: CSVUploadModal with proper preview flow handling
const CSVUploadModal = ({ isOpen, onClose, type }) => {
const [file, setFile] = useState(null);
const [uploading, setUploading] = useState(false);
const [uploadResult, setUploadResult] = useState(null);
const [proceedAfterPreview, setProceedAfterPreview] = useState(false); // NEW: Track if we should proceed after preview

// Enhanced file validation for both CSV and Excel (keeping your existing logic)
const handleFileChange = (e) => {
const selectedFile = e.target.files[0];
const allowedTypes = [
'text/csv',
'application/vnd.ms-excel',
'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
];

const isValidFile = allowedTypes.includes(selectedFile.type) || 
selectedFile.name.endsWith('.csv') || 
selectedFile.name.endsWith('.xlsx') || 
selectedFile.name.endsWith('.xls');

if (selectedFile && isValidFile) {
setFile(selectedFile);
window.currentUploadFile = selectedFile; // Store globally for preview flow
setUploadResult(null); // Clear previous results
setProceedAfterPreview(false); // Reset proceed flag
} else {
alert('Please select a valid CSV or Excel file (.csv, .xlsx, .xls)');
}
};



// NEW: Preview function for smart client detection (only for leads)
const handlePreview = async () => {
if (!file) {
alert('Please select a file first');
return;
}

setPreviewLoading(true);
const formData = new FormData();
formData.append('file', file);

try {
const response = await fetch(`${API_URL}/upload/leads/csv/preview`, {
method: 'POST',
headers: {
'Authorization': authToken ? 'Bearer ' + authToken : undefined
},
body: formData
});

const result = await response.json();
if (response.ok) {
setUploadPreview(result);
setShowPreview(true);
} else {
alert('Preview failed: ' + (result.error || 'Unknown error'));
}
} catch (error) {
alert('Preview error: ' + error.message);
} finally {
setPreviewLoading(false);
}
};



// Enhanced upload function (updated from your existing one)
const handleUpload = async () => {
if (!file) {
alert('Please select a file first');
return;
}

setUploading(true);
const formData = new FormData();
formData.append('file', file);

try {
const response = await fetch(`${API_URL}/upload/${type}/csv`, {
method: 'POST',
headers: {
'Authorization': authToken ? 'Bearer ' + authToken : undefined
},
body: formData
});

const result = await response.json();
if (response.ok) {
setUploadResult(result);

// NEW: Handle smart client detection results
if (result.clientDetectionResults && result.clientDetectionResults.length > 0) {
setClientDetectionResults(result.clientDetectionResults);
setShowClientDetectionResults(true);
}

// Refresh data (keeping your existing logic)
if (type === 'leads') {
const leadsData = await apiCall('/leads');
setLeads(leadsData.data || []);
} else if (type === 'inventory') {
const inventoryData = await apiCall('/inventory');
setInventory(inventoryData.data || []);
}

// NEW: Show enhanced success message
showEnhancedUploadSummary(result);

} else {
alert('Upload failed: ' + (result.error || 'Unknown error'));
}
} catch (error) {
alert('Upload error: ' + error.message);
} finally {
setUploading(false);
}
};



// NEW: Function to handle proceed from preview
const handleProceedFromPreview = () => {
setShowPreview(false);
setProceedAfterPreview(true);
// Trigger upload after a small delay to ensure state is updated
setTimeout(() => {
handleUpload();
}, 100);
};



// NEW: Enhanced upload summary function
const showEnhancedUploadSummary = (result) => {
let message = `üéâ Upload completed!\n\n`;
message += `‚úÖ Successfully imported: ${result.successCount} ${type}\n`;

if (result.errorCount > 0) {
message += `‚ùå Failed: ${result.errorCount} ${type}\n`;
}

// Smart client detection summary (only for leads)
if (type === 'leads' && result.clientDetectionCount > 0) {
message += `\nüîç Smart Client Detection:\n`;
message += `üìû Existing clients found: ${result.clientDetectionCount}\n`;
message += `üë§ New clients: ${result.summary?.new_clients || 0}\n`;
}

if (type === 'leads' && result.autoAssignmentCount > 0) {
message += `\nüéØ Auto-assignments: ${result.autoAssignmentCount}\n`;
}

if (type === 'leads' && result.clientAssignmentCount > 0) {
message += `üìã Client-based assignments: ${result.clientAssignmentCount}\n`;
}

if (type === 'leads' && result.summary) {
message += `\nüìä Assignment Summary:\n`;
message += `‚Ä¢ Auto-assigned: ${result.summary.auto_assigned}\n`;
message += `‚Ä¢ Client-assigned: ${result.summary.client_assigned}\n`;
message += `‚Ä¢ Manually assigned: ${result.summary.manually_assigned}\n`;
message += `‚Ä¢ Unassigned: ${result.summary.unassigned}\n`;
}

alert(message);
};



// Download sample CSV (keeping your existing function exactly as is)
const downloadSampleCSV = () => {
let csvContent = '';
let filename = '';

if (type === 'leads') {
csvContent = `Name,Email,Phone,Company,Business Type,Source,Date of Enquiry,First Touch Base Done By,City of Residence,Country of Residence,Lead for Event,Number of People,Has Valid Passport,Visa Available,Attended Sporting Event Before,Annual Income Bracket,Potential Value,Status,Assigned To,Last Quoted Price,Notes
John Doe,john@example.com,+919876543210,ABC Corp,B2C,Facebook,2025-01-15,Sales Team,Mumbai,India,IPL 2025,2,Yes,Not Required,No,‚Çπ25-50 Lakhs,500000,unassigned,,0,Interested in VIP tickets
Jane Smith,jane@example.com,+919876543211,XYZ Ltd,B2B,WhatsApp,2025-01-16,Marketing Team,Delhi,India,FIFA World Cup 2026,4,Not Sure,Required,Yes,‚Çπ50 Lakhs - ‚Çπ1 Crore,1000000,unassigned,,0,Family trip planned`;
filename = 'sample_leads.csv';
} else if (type === 'inventory') {
csvContent = `Event Name,Event Date,Event Type,Sports,Venue,Day of Match,Category of Ticket,Price per Ticket,Number of Tickets,Total Value of Tickets,Currency,Base Amount INR,GST 18%,Selling Price per Ticket,Payment Due Date,Supplier Name,Ticket Source,Status,Allocated to Order,Notes
IPL 2025 Final,2025-05-28,cricket,Cricket,Wankhede Stadium,Not Applicable,VIP,15000,10,150000,INR,150000,27000,17700,2025-04-15,Ticket Master,Primary,available,,Premium seats
FIFA World Cup 2026,2026-06-15,football,Football,MetLife Stadium,Not Applicable,Premium,25000,20,500000,USD,2000000,360000,118000,2026-03-01,FIFA Official,Primary,available,,Group stage match`;
filename = 'sample_inventory.csv';
}

const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
const link = document.createElement('a');
link.href = URL.createObjectURL(blob);
link.download = filename;
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
};



// Download Excel functions (keeping your existing functions exactly as is)
const downloadSampleExcel = async () => {
try {
console.log('Downloading Excel with fixed validation...');

const response = await fetch(`${API_URL}/upload/leads/sample-excel-fixed`, {
method: 'GET',
headers: {
'Authorization': `Bearer ${authToken}`
}
});

if (!response.ok) {
throw new Error(`HTTP error! status: ${response.status}`);
}

const blob = await response.blob();
const url = window.URL.createObjectURL(blob);

const link = document.createElement('a');
link.href = url;
link.download = 'leads_with_fixed_validation.xlsx';
document.body.appendChild(link);
link.click();
document.body.removeChild(link);

window.URL.revokeObjectURL(url);
alert('‚úÖ Excel file with improved validation downloaded successfully!');

} catch (error) {
console.error('Error downloading Excel:', error);
alert('‚ùå Failed to download Excel file: ' + error.message);
}
};



const downloadSampleExcelV2 = async () => {
try {
console.log('Downloading Excel template with instructions...');

const response = await fetch(`${API_URL}/upload/leads/sample-excel-simple`, {
method: 'GET',
headers: {
'Authorization': `Bearer ${authToken}`
}
});

if (!response.ok) {
throw new Error(`HTTP error! status: ${response.status}`);
}

const blob = await response.blob();
const url = window.URL.createObjectURL(blob);

const link = document.createElement('a');
link.href = url;
link.download = 'leads_template_with_instructions.xlsx';
document.body.appendChild(link);
link.click();
document.body.removeChild(link);

window.URL.revokeObjectURL(url);
alert('‚úÖ Excel template with clear instructions downloaded successfully!');

} catch (error) {
console.error('Error downloading Excel:', error);
alert('‚ùå Failed to download Excel file: ' + error.message);
}
};



if (!isOpen) return null;

return React.createElement('div', {
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50'
},
React.createElement('div', {
className: 'bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto'
},
// Modal Header (keeping your existing design)
React.createElement('div', {
className: 'flex items-center justify-between mb-4'
},
React.createElement('h2', {
className: 'text-2xl font-bold text-gray-900 dark:text-white'
}, `Upload ${type === 'leads' ? 'Leads' : 'Inventory'} (CSV/Excel)`),

React.createElement('button', {
onClick: onClose,
className: 'text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200'
}, '‚úï')
),

// NEW: Smart Client Detection Notice (only for leads)
type === 'leads' && React.createElement('div', {
className: 'mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg'
},
React.createElement('h3', {
className: 'font-semibold text-blue-800 dark:text-blue-200 mb-2'
}, 'üîç Smart Client Detection Enabled'),
React.createElement('ul', {
className: 'text-blue-700 dark:text-blue-300 text-sm space-y-1'
},
React.createElement('li', null, '‚Ä¢ Automatically detects existing clients by phone number'),
React.createElement('li', null, '‚Ä¢ Auto-assigns leads to the same person who handled previous leads'),
React.createElement('li', null, '‚Ä¢ Groups leads by client with relationship tracking'),
React.createElement('li', null, '‚Ä¢ Preview your upload to review assignments before import')
)
),

// Instructions (keeping your existing design)
React.createElement('div', {
className: 'mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg'
},
React.createElement('p', {
className: 'text-blue-800 dark:text-blue-200 mb-2'
}, 'üìã Upload a CSV or Excel file to bulk import your data.'),
React.createElement('p', {
className: 'text-blue-700 dark:text-blue-300 text-sm'
}, 'üí° Excel files include validation guidance and clear instructions!')
),

// Download Templates Section (keeping your existing design)
React.createElement('div', {
className: 'mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg'
},
React.createElement('h3', {
className: 'font-semibold mb-3 text-gray-900 dark:text-white'
}, 'üì• Download Sample Templates:'),

React.createElement('div', {
className: 'grid grid-cols-1 md:grid-cols-3 gap-2'
},
// CSV Download
React.createElement('button', {
onClick: downloadSampleCSV,
className: 'bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm flex items-center justify-center gap-2 transition-colors'
}, 'üìÑ CSV Template'),

// Excel Method 1 - UPDATED LABEL
type === 'leads' && React.createElement('button', {
onClick: downloadSampleExcel,
className: 'bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm flex items-center justify-center gap-2 transition-colors'
}, 'üìä Excel (Advanced)'),

// Excel Method 2 - UPDATED LABEL
type === 'leads' && React.createElement('button', {
onClick: downloadSampleExcelV2,
className: 'bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg text-sm flex items-center justify-center gap-2 transition-colors'
}, 'üìã Excel (Instructions)')
),

type === 'leads' && React.createElement('p', {
className: 'text-xs text-gray-600 dark:text-gray-400 mt-3 bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded border-l-4 border-yellow-400'
}, 'üéØ Try "Excel (Instructions)" for the clearest guidance - includes validation options and examples!')
),

// File Upload Section (keeping your existing design)
React.createElement('div', {
className: 'mb-6 p-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg'
},
React.createElement('h3', {
className: 'font-semibold mb-3 text-gray-900 dark:text-white'
}, 'üì§ Upload Your File:'),

React.createElement('input', {
type: 'file',
accept: '.csv,.xlsx,.xls,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
onChange: handleFileChange,
className: 'block w-full mb-3 text-gray-900 dark:text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100'
}),

file && React.createElement('div', {
className: 'flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 bg-green-50 dark:bg-green-900/20 p-2 rounded'
},
React.createElement('span', null, '‚úÖ'),
React.createElement('span', null, `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`)
)
),

// NEW: Preview Section (only for leads)
type === 'leads' && file && React.createElement('div', {
className: 'mb-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg'
},
React.createElement('h3', {
className: 'font-semibold mb-3 text-yellow-800 dark:text-yellow-200'
}, 'üîç Smart Client Detection Preview'),
React.createElement('p', {
className: 'text-yellow-700 dark:text-yellow-300 text-sm mb-3'
}, 'Preview your upload to see which leads will be assigned based on existing client relationships.'),
React.createElement('button', {
onClick: handlePreview,
disabled: previewLoading,
className: 'bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 disabled:opacity-50'
},
previewLoading && React.createElement('div', {
className: 'animate-spin rounded-full h-4 w-4 border-b-2 border-white'
}),
previewLoading ? 'Loading Preview...' : 'üîç Preview Upload'
)
),

// Upload Results (enhanced from your existing design)
uploadResult && React.createElement('div', {
className: `mb-6 p-4 rounded-lg ${
uploadResult.errorCount > 0 
? 'bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700' 
: 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700'
}`
},
React.createElement('div', {
className: 'flex items-center gap-2 mb-2'
},
React.createElement('span', {
className: 'text-lg'
}, uploadResult.errorCount > 0 ? '‚ö†Ô∏è' : '‚úÖ'),
React.createElement('p', {
className: `font-semibold ${
uploadResult.errorCount > 0 
? 'text-yellow-800 dark:text-yellow-200' 
: 'text-green-800 dark:text-green-200'
}`
}, uploadResult.message)
),

// Enhanced success metrics
uploadResult.successCount > 0 && React.createElement('div', {
className: 'text-sm text-green-700 dark:text-green-300 space-y-1'
},
React.createElement('p', null, `‚úÖ Successfully imported: ${uploadResult.successCount} records`),

// Smart client detection results (only for leads)
type === 'leads' && uploadResult.clientDetectionCount > 0 && React.createElement('p', null, 
`üîç Existing clients detected: ${uploadResult.clientDetectionCount}`),

type === 'leads' && uploadResult.autoAssignmentCount > 0 && React.createElement('p', null, 
`üéØ Auto-assignments applied: ${uploadResult.autoAssignmentCount}`),

type === 'leads' && uploadResult.clientAssignmentCount > 0 && React.createElement('p', null, 
`üìã Client-based assignments: ${uploadResult.clientAssignmentCount}`)
),

// Show client detection details button
type === 'leads' && uploadResult.clientDetectionResults && uploadResult.clientDetectionResults.length > 0 && 
React.createElement('button', {
onClick: () => setShowClientDetectionResults(true),
className: 'mt-2 text-blue-600 hover:text-blue-800 text-sm underline'
}, 'View Smart Client Detection Details ‚Üí'),

// Error section (keeping your existing design)
uploadResult.errors && uploadResult.errors.length > 0 && React.createElement('div', {
className: 'mt-3'
},
React.createElement('p', {
className: 'text-sm font-semibold text-red-700 dark:text-red-300 mb-2'
}, `‚ùå Errors found (${uploadResult.errors.length}):`),
React.createElement('div', {
className: 'max-h-32 overflow-y-auto bg-white dark:bg-gray-800 p-2 rounded border'
},
uploadResult.errors.map((error, index) => 
React.createElement('p', {
key: index,
className: 'text-xs text-red-600 dark:text-red-400 mb-1'
}, `Row ${error.row}: ${error.error}`)
)
)
)
),

// Action Buttons (keeping your existing design)
React.createElement('div', {
className: 'flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-600'
},
React.createElement('button', {
onClick: onClose,
className: 'px-6 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-700 transition-colors'
}, 'Cancel'),

React.createElement('button', {
onClick: handleUpload,
disabled: !file || uploading,
className: `px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors ${
uploading ? 'animate-pulse' : ''
}`
}, uploading ? 'Uploading...' : 'Upload File')
)
)
);
};



// UPDATED: Upload Preview Modal Component with proper continue functionality
const UploadPreviewModal = () => {
if (!showPreview || !uploadPreview) return null;

return React.createElement('div', {
className: 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50'
},
React.createElement('div', {
className: 'bg-white rounded-lg p-6 max-w-6xl max-h-5/6 overflow-auto'
},
React.createElement('div', {
className: 'flex justify-between items-center mb-4'
},
React.createElement('h3', {
className: 'text-lg font-semibold'
}, 'Bulk Upload Preview - Smart Client Detection'),
React.createElement('button', {
onClick: () => setShowPreview(false),
className: 'text-gray-400 hover:text-gray-600'
}, '‚úï')
),

// Summary
React.createElement('div', {
className: 'mb-6 p-4 bg-blue-50 rounded-lg'
},
React.createElement('h4', {
className: 'font-semibold mb-2'
}, 'üìä Upload Summary'),
React.createElement('div', {
className: 'grid grid-cols-2 md:grid-cols-4 gap-4 text-sm'
},
React.createElement('div', null,
React.createElement('span', { className: 'font-medium' }, 'Total Rows: '),
uploadPreview.total_rows
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium' }, 'Existing Clients: '),
uploadPreview.client_detection_summary.existing_clients_found
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium' }, 'New Clients: '),
uploadPreview.client_detection_summary.new_clients
),
React.createElement('div', null,
React.createElement('span', { className: 'font-medium' }, 'Will Auto-assign: '),
uploadPreview.client_detection_summary.will_be_client_assigned
)
)
),

// Preview Table
React.createElement('div', {
className: 'overflow-x-auto'
},
React.createElement('table', {
className: 'min-w-full table-auto border-collapse border'
},
React.createElement('thead', null,
React.createElement('tr', { className: 'bg-gray-50' },
React.createElement('th', { className: 'border p-2 text-left' }, 'Row'),
React.createElement('th', { className: 'border p-2 text-left' }, 'Name'),
React.createElement('th', { className: 'border p-2 text-left' }, 'Phone'),
React.createElement('th', { className: 'border p-2 text-left' }, 'CSV Assignment'),
React.createElement('th', { className: 'border p-2 text-left' }, 'Client Status'),
React.createElement('th', { className: 'border p-2 text-left' }, 'Final Assignment'),
React.createElement('th', { className: 'border p-2 text-left' }, 'Existing Leads')
)
),
React.createElement('tbody', null,
uploadPreview.preview.map((row, index) =>
React.createElement('tr', {
key: index,
className: row.client_detected ? 'bg-yellow-50' : 'bg-white'
},
React.createElement('td', { className: 'border p-2' }, row.row),
React.createElement('td', { className: 'border p-2' }, row.name),
React.createElement('td', { className: 'border p-2' }, row.phone),
React.createElement('td', { className: 'border p-2' }, row.assigned_to_in_csv || 'None'),
React.createElement('td', { className: 'border p-2' },
row.client_detected ? 
React.createElement('span', {
className: 'bg-yellow-200 text-yellow-800 px-2 py-1 rounded text-xs'
}, 'üìû Existing Client') :
React.createElement('span', {
className: 'bg-green-200 text-green-800 px-2 py-1 rounded text-xs'
}, 'üë§ New Client')
),
React.createElement('td', { className: 'border p-2' },
React.createElement('span', {
className: row.will_override_assignment ? 'bg-blue-200 text-blue-800 px-2 py-1 rounded text-xs' : ''
}, row.final_assigned_to)
),
React.createElement('td', { className: 'border p-2' },
row.existing_leads_count > 0 ? 
React.createElement('span', { className: 'text-sm' },
`${row.existing_leads_count} leads`,
row.existing_events.length > 0 && 
React.createElement('div', { className: 'text-xs text-gray-600' },
`Events: ${row.existing_events.join(', ')}`
)
) : 'None'
)
)
)
)
)
),

// Action Buttons
React.createElement('div', {
className: 'mt-6 flex justify-end space-x-3'
},
React.createElement('button', {
onClick: () => setShowPreview(false),
className: 'px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50'
}, 'Cancel'),
React.createElement('button', {
onClick: () => {
handleProceedFromPreview();
},
className: 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700'
}, 'Continue to Upload')
)
)
);
};



// Client Detection Results Modal Component
const ClientDetectionResultsModal = () => {
if (!showClientDetectionResults || !clientDetectionResults.length) return null;

return React.createElement('div', {
className: 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50'
},
React.createElement('div', {
className: 'bg-white rounded-lg p-6 max-w-4xl max-h-5/6 overflow-auto'
},
React.createElement('div', {
className: 'flex justify-between items-center mb-4'
},
React.createElement('h3', {
className: 'text-lg font-semibold'
}, 'üîç Smart Client Detection Results'),
React.createElement('button', {
onClick: () => setShowClientDetectionResults(false),
className: 'text-gray-400 hover:text-gray-600'
}, '‚úï')
),

React.createElement('div', {
className: 'overflow-x-auto'
},
React.createElement('table', {
className: 'min-w-full table-auto border-collapse border'
},
React.createElement('thead', null,
React.createElement('tr', { className: 'bg-gray-50' },
React.createElement('th', { className: 'border p-2 text-left' }, 'Row'),
React.createElement('th', { className: 'border p-2 text-left' }, 'Lead Name'),
React.createElement('th', { className: 'border p-2 text-left' }, 'Phone'),
React.createElement('th', { className: 'border p-2 text-left' }, 'Existing Leads'),
React.createElement('th', { className: 'border p-2 text-left' }, 'Assigned To'),
React.createElement('th', { className: 'border p-2 text-left' }, 'Previous Events')
)
),
React.createElement('tbody', null,
clientDetectionResults.map((result, index) =>
React.createElement('tr', {
key: index,
className: 'bg-yellow-50'
},
React.createElement('td', { className: 'border p-2' }, result.row),
React.createElement('td', { className: 'border p-2' }, result.lead_name),
React.createElement('td', { className: 'border p-2' }, result.phone),
React.createElement('td', { className: 'border p-2' }, result.total_existing_leads),
React.createElement('td', { className: 'border p-2' }, result.assigned_to_from_detection),
React.createElement('td', { className: 'border p-2' },
result.existing_events?.length > 0 ?
React.createElement('div', { className: 'text-sm' },
result.existing_events.join(', ')
) : 'None'
)
)
)
)
)
),

React.createElement('div', {
className: 'mt-6 flex justify-end'
},
React.createElement('button', {
onClick: () => setShowClientDetectionResults(false),
className: 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700'
}, 'Close')
)
)
);
}; 


// Main application layout

const renderHelpGuide = () => {
if (!showHelpGuide) return null;

return React.createElement('div', { 
className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4',
onClick: () => setShowHelpGuide(false)
},
React.createElement('div', { 
className: 'bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full p-6',
onClick: (e) => e.stopPropagation()
},
React.createElement('div', { className: 'flex justify-between items-center mb-4' },
React.createElement('h2', { className: 'text-2xl font-bold text-gray-900 dark:text-white' }, 'How to Use FanToPark CRM'),
React.createElement('button', {
onClick: () => setShowHelpGuide(false),
className: 'text-gray-500 hover:text-gray-700'
}, '‚úï')
),
React.createElement('div', { className: 'space-y-4 text-gray-700 dark:text-gray-300' },
React.createElement('h3', { className: 'font-bold text-lg' }, 'Workflow Overview:'),
React.createElement('ol', { className: 'list-decimal list-inside space-y-2' },
React.createElement('li', null, 'Sales Team: Create and qualify leads (Hot/Warm/Cold)'),
React.createElement('li', null, 'Sales Team: Convert qualified leads to orders'),
React.createElement('li', null, 'Finance Team: Approve orders (or Sales Head for Payment Post Service)'),
React.createElement('li', null, 'Supply Team: Schedule and manage deliveries'),
React.createElement('li', null, 'Finance Team: Generate invoices and track payments')
),
React.createElement('div', { className: 'mt-4 pt-4 border-t' },
React.createElement('p', { className: 'font-medium' }, 'Quick Tips:'),
React.createElement('ul', { className: 'list-disc list-inside mt-2 space-y-1 text-sm' },
React.createElement('li', null, 'Use the dark mode toggle for comfortable viewing'),
React.createElement('li', null, 'Check "My Actions" tab for your pending tasks'),
React.createElement('li', null, 'All actions are logged and tracked automatically')
)
)
)
)
);
};



return React.createElement('div', { className: 'flex h-screen bg-gray-100 dark:bg-gray-900' },
renderSidebar(),
React.createElement('div', { className: 'flex-1 flex flex-col overflow-hidden' },
React.createElement('header', { className: 'bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700 px-6 py-4' },
React.createElement('div', { className: 'flex items-center justify-between' },
React.createElement('div', null,
React.createElement('h1', { className: 'text-lg font-semibold' }, 'Welcome, ' + (user?.name || 'Admin User')),
React.createElement('p', { className: 'text-sm text-gray-600 dark:text-gray-400' }, USER_ROLES[user?.role]?.label + ' ‚Ä¢ ' + user?.department)
),
React.createElement('div', { className: 'flex items-center space-x-4' },
React.createElement('span', { className: 'text-lg' }, 'üîî'),
React.createElement('button', {
onClick: () => setShowHelpGuide(true),
className: 'p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors',
title: 'How to use CRM'
}, '‚ùì'),
React.createElement('button', {
onClick: () => {
setDarkMode(!darkMode);
document.documentElement.classList.toggle('dark');
localStorage.setItem('crm_dark_mode', !darkMode);
},
className: 'p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors',
title: darkMode ? 'Switch to light mode' : 'Switch to dark mode'
}, darkMode ? '‚òÄÔ∏è' : 'üåô'),
React.createElement('div', { className: 'w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center' },
React.createElement('span', { className: 'text-white text-sm' }, (user?.name || 'A')[0])
),
currentUser && currentUser.role === 'super_admin' && React.createElement('div', { 
className: 'flex items-center gap-2 ml-4'
},
React.createElement('button', {
onClick: () => {
const newMode = !testMode;
setTestMode(newMode);
localStorage.setItem('testMode', newMode.toString());
if (newMode) {
document.body.classList.add('test-mode-active');
} else {
document.body.classList.remove('test-mode-active');
}
},
className: 'relative inline-flex h-6 w-12 items-center rounded-full transition-colors ' + 
(testMode ? 'bg-red-600' : 'bg-gray-300'),
title: 'Toggle Test Mode'
},
React.createElement('span', {
className: 'inline-block h-4 w-4 transform rounded-full bg-white transition-transform ' +
(testMode ? 'translate-x-6' : 'translate-x-1')
})
),
testMode && React.createElement('span', { 
className: 'text-red-600 font-bold text-sm ml-2'
}, 'TEST MODE')
)
)
)
),
React.createElement('main', { className: 'flex-1 overflow-y-auto p-6' },
testMode && user.role === 'super_admin' && React.createElement('div', {
className: 'bg-red-100 border-2 border-red-500 text-red-700 p-4 rounded-lg mb-4 text-center font-bold animate-pulse'
}, 
'‚ö†Ô∏è TEST MODE ACTIVE - Delete buttons and test data fills are enabled!'
),
renderContent()
)
),
// Modal forms
ReminderDashboard(),  
renderInventoryForm(),                           
renderForm(),
showCSVUploadModal && React.createElement(CSVUploadModal, {
isOpen: showCSVUploadModal,
onClose: () => {
setShowCSVUploadModal(false);
setCSVUploadType('');
},
type: csvUploadType,
authToken: authToken
}),
renderAssignForm(),
renderBulkAssignModal(),                           
renderPaymentForm(),
renderLeadDetail(),
showInventoryDetail && renderInventoryDetail(),                   
renderAllocationForm(),
renderAllocationManagement(),
renderStadiumForm(),                           
renderChoiceModal(),
renderUserManagement(),
renderStatusProgressModal(),                           
renderUserForm(),
renderGSTInvoicePreview(),
renderOrderDetailModal(),
renderOrderAssignmentModal(),
renderOrderDetailModal(),
renderOrderAssignmentModal(),
renderDeliveryForm(),
renderOrderDetail(),
renderEditOrderForm(),
renderPaymentPostServiceForm(),
renderHelpGuide(),
showClientDetail && renderClientDetailModal(),
showEventDetail && renderEventDetailModal(),
showPreview && React.createElement(UploadPreviewModal),
showClientDetectionResults && React.createElement(ClientDetectionResultsModal),                           
showEventForm && renderEventFormModal() 
);
}

// Floating Test Mode Button for Super Admin
if (document.getElementById('root')) {
const checkAndAddTestButton = () => {
const user = JSON.parse(localStorage.getItem('crm_user') || '{}');
const authToken = localStorage.getItem('crm_auth_token');

if (user.role === 'super_admin' && authToken && !document.getElementById('test-mode-float')) {
const testModeState = localStorage.getItem('testMode') === 'true';
const floatDiv = document.createElement('div');
floatDiv.id = 'test-mode-float';
floatDiv.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:9999;';

const button = document.createElement('button');
button.style.cssText = 'padding:12px 24px;border-radius:8px;font-weight:bold;color:white;cursor:pointer;box-shadow:0 4px 6px rgba(0,0,0,0.1);' +
'background-color:' + (testModeState ? '#dc2626' : '#10b981') + ';';
button.textContent = testModeState ? 'üß™ TEST MODE ON' : 'üß™ TEST MODE OFF';
button.onclick = () => {
const currentState = localStorage.getItem('testMode') === 'true';
const newState = !currentState;
localStorage.setItem('testMode', String(newState));
alert('Test mode ' + (newState ? 'ENABLED' : 'DISABLED') + '. Page will reload.');
window.location.reload();
};



floatDiv.appendChild(button);
document.body.appendChild(floatDiv);
}
};



// Check on load and after login
setTimeout(checkAndAddTestButton, 1000);
window.addEventListener('storage', checkAndAddTestButton);
}



// Render the app
ReactDOM.render(React.createElement(App), document.getElementById('root'));

</script>

<div id="test-control-panel" style="position:fixed; bottom:80px; left:20px; background:#1f2937; color:white; padding:15px; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.3); display:none; z-index:9999; max-height:400px; overflow-y:auto; min-width:200px;">
<h3 style="margin:0 0 10px 0; font-size:16px; text-align:center;">üß™ Test Mode Controls</h3>
<p style="margin:5px 0; font-size:12px; color:#10b981; text-align:center;">‚úÖ Test Mode Active</p>
<hr style="margin:10px 0; border:none; border-top:1px solid #4b5563;">
<div style="margin-bottom:10px;">
<h4 style="margin:5px 0; font-size:14px; color:#f59e0b;">Create Test Data:</h4>
<button onclick="(async function() {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
// Get today's date in YYYY-MM-DD format
const today = new Date().toISOString().split('T')[0];

// Get inventory items to pick a random event
const invResponse = await fetch(API_URL + '/inventory', {
headers: { 'Authorization': 'Bearer ' + authToken }
});
let eventName = 'General Inquiry';
if (invResponse.ok) {
const invData = await invResponse.json();
if (invData.data && invData.data.length > 0) {
eventName = invData.data[Math.floor(Math.random() * invData.data.length)].event_name;
}
}

const cities = ['Mumbai City North East', 'Delhi NCR', 'Bangalore City', 'Chennai Metro', 'Kolkata Central'];
const sources = ['LinkedIn', 'Facebook', 'Instagram', 'Website', 'Friends and Family', 'Through Champion'];
const salesPeople = ['Ankita', 'Varun', 'Pratik', 'Rahul'];
const incomeBrackets = ['‚Çπ10-25 Lakhs', '‚Çπ25-50 Lakhs', '‚Çπ50-100 Lakhs', 'Above ‚Çπ1 Crore'];

const testData = {
// Basic info
name: 'Test Contact ' + Math.floor(Math.random() * 1000),
email: 'test' + Math.floor(Math.random() * 1000) + '@example.com',
phone: '8' + Math.floor(Math.random() * 900000000 + 100000000),
company: Math.random() > 0.5 ? 'Test Company ' + Math.floor(Math.random() * 100) : '',

// Business fields
business_type: Math.random() > 0.5 ? 'B2B' : 'B2C',
source: sources[Math.floor(Math.random() * sources.length)],

// Required date field
date_of_enquiry: today,

// Sales fields
first_touch_base_done_by: salesPeople[Math.floor(Math.random() * salesPeople.length)],

// Location
city_of_residence: cities[Math.floor(Math.random() * cities.length)],
country_of_residence: 'India',

// Event interest
lead_for_event: eventName,
number_of_people: String(Math.floor(Math.random() * 5) + 1),

// Travel readiness
has_valid_passport: Math.random() > 0.3 ? 'Yes' : 'No',
visa_available: Math.random() > 0.5 ? 'Yes' : 'No',
attended_sporting_event_before: Math.random() > 0.4 ? 'Yes' : 'No',

// Financial
annual_income_bracket: incomeBrackets[Math.floor(Math.random() * incomeBrackets.length)],
potential_value: Math.floor(Math.random() * 200000) + 50000,

// Status fields
status: 'unassigned',
assigned_to: '',
last_quoted_price: 0,
notes: 'Test lead created via test mode',

// Timestamps
created_date: new Date().toISOString(),
updated_date: new Date().toISOString()
};



console.log('Creating lead:', testData);

const response = await fetch(API_URL + '/leads', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
});

const result = await response.json();

if (response.ok) {
alert('Test lead created successfully!');
window.location.reload();
} else {
console.error('Failed:', result);
alert('Error: ' + (result.error || result.message || 'Failed to create lead'));
}
} catch (error) {
console.error('Error:', error);
alert('Error: ' + error.message);
}
})();" style="display:block; width:100%; margin:5px 0; padding:8px; background:#f59e0b; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px;">üß™ Create Test Lead</button>
<button onclick="(async function() {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
const testData = {
event_name: 'Test Cricket Match ' + Math.floor(Math.random() * 1000),
event_date: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0],
event_type: 'cricket',
sports: 'Cricket',
venue: 'Test Stadium Mumbai',
category_of_ticket: 'VIP',
total_tickets: 200,
available_tickets: 200,
mrp_of_ticket: 5000,
buying_price: 4000,
selling_price: 6000,
day_of_match: 'Not Applicable',
stand: 'North Stand',
inclusions: 'Snacks, Beverages, Parking',
booking_person: 'Test Supplier',
procurement_type: 'pre_inventory',
notes: 'Test inventory',
paymentStatus: 'paid',
created_by: JSON.parse(localStorage.getItem('crm_user') || '{}').name || 'Test User',
created_date: new Date().toISOString()
};



console.log('Creating inventory:', testData);

const response = await fetch(API_URL + '/inventory', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
});

const result = await response.json();

if (response.ok) {
alert('Test inventory created successfully!');
window.location.reload();
} else {
console.error('Failed:', result);
alert('Error: ' + (result.error || result.message || 'Failed to create inventory'));
}
} catch (error) {
console.error('Error:', error);
alert('Error: ' + error.message);
}
})();" style="display:block; width:100%; margin:5px 0; padding:8px; background:#f59e0b; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px;">üß™ Create Test Inventory</button>
</div>
<hr style="margin:10px 0; border:none; border-top:1px solid #4b5563;">
<div style="margin-bottom:10px;">
<h4 style="margin:5px 0; font-size:14px; color:#dc2626;">Delete All Data:</h4>
<button onclick="window.deleteAllIndividually('leads')" style="display:block; width:100%; margin:5px 0; padding:8px; background:#dc2626; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px;">üóëÔ∏è Delete All Leads</button>
<button onclick="window.deleteAllIndividually('inventory')" style="display:block; width:100%; margin:5px 0; padding:8px; background:#dc2626; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px;">üóëÔ∏è Delete All Inventory</button>
<button onclick="window.deleteAllIndividually('orders')" style="display:block; width:100%; margin:5px 0; padding:8px; background:#dc2626; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px;">üóëÔ∏è Delete All Orders</button>
<button onclick="window.deleteAllIndividually('deliveries')" style="display:block; width:100%; margin:5px 0; padding:8px; background:#dc2626; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px;">üóëÔ∏è Delete All Deliveries</button>
<button 
onclick="window.deleteAllFinancials()"
style="
width: 100%;
padding: 8px 16px;
background-color: #dc2626;
color: white;
border: none;
border-radius: 6px;
cursor: pointer;
font-size: 14px;
font-weight: 500;
display: flex;
align-items: center;
justify-content: center;
gap: 8px;
transition: background-color 0.2s;
"
onmouseover="this.style.backgroundColor='#b91c1c'"
onmouseout="this.style.backgroundColor='#dc2626'"
>
üóëÔ∏è Delete All Financials
</button>
</div>
<hr style="margin:10px 0; border:none; border-top:1px solid #4b5563;">
<button onclick="window.location.reload();" style="display:block; width:100%; margin:5px 0; padding:8px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px;">üîÑ Refresh Page</button>
<button onclick="document.getElementById('test-control-panel').style.display='none';" style="display:block; width:100%; margin:5px 0; padding:6px; background:#6b7280; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;">‚úñ Hide Panel</button>
</div>
<script>
// Show test control panel if test mode is on and user is super admin
window.updateTestPanel = function() {
const testMode = localStorage.getItem('testMode') === 'true';
const user = JSON.parse(localStorage.getItem('crm_user') || '{}');
const panel = document.getElementById('test-control-panel');
if (testMode && user.role === 'super_admin' && panel) {
panel.style.display = 'block';
}
};



// Delete all function
window.testDeleteAll = async function(type) {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
const response = await fetch(API_URL + '/' + type, {
method: 'DELETE',
headers: {
'Authorization': 'Bearer ' + authToken,
'X-Delete-All': 'true',
'X-Test-Mode': 'true'
}
});

if (response.ok) {
alert('All ' + type + ' deleted successfully!');
window.location.reload();
} else {
alert('Error: ' + response.statusText);
}
} catch (error) {
alert('Error: ' + error.message);
}
};



// Check on load
setTimeout(window.updateTestPanel, 1000);
</script>


<script>
// Test data creation functions
window.fillTestLead = function() {
if (confirm('Create a test lead?')) {
// Directly create test lead data
const testData = {
name: 'Test User ' + Math.floor(Math.random() * 1000),
email: 'test' + Math.floor(Math.random() * 1000) + '@example.com',
phone: '98' + Math.floor(Math.random() * 90000000 + 10000000),
company: 'Test Company ' + Math.floor(Math.random() * 100),
lead_for_event: 'General Inquiry',
lead_source: 'Website',
notes: 'Test lead created via test mode'
};



// Call the API directly
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

fetch(API_URL + '/leads', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
})
.then(response => response.json())
.then(data => {
alert('Test lead created successfully!');
window.location.reload();
})
.catch(error => {
alert('Error creating test lead: ' + error.message);
});
}
};



window.fillTestInventory = function() {
if (confirm('Create a test inventory item?')) {
const categories = ['Stall', 'Equipment', 'Service', 'Package'];
const testData = {
name: 'Test Item ' + Math.floor(Math.random() * 1000),
category: categories[Math.floor(Math.random() * categories.length)],
price: Math.floor(Math.random() * 90000) + 10000,
quantity: Math.floor(Math.random() * 50) + 1,
description: 'Test inventory item created via test mode',
size: '10x10 ft',
location: 'Zone ' + Math.floor(Math.random() * 5 + 1)
};



const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

fetch(API_URL + '/inventory', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
})
.then(response => response.json())
.then(data => {
alert('Test inventory item created successfully!');
window.location.reload();
})
.catch(error => {
alert('Error creating test inventory: ' + error.message);
});
}
};


</script>


<script>
// Working delete function that deletes individually
window.deleteAllIndividually = async function(type) {
if (!confirm('Delete ALL ' + type + '? This will delete them one by one.')) {
return;
}

const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
// Show loading
const loadingDiv = document.createElement('div');
loadingDiv.id = 'delete-loading';
loadingDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:10000;';
loadingDiv.innerHTML = '<h3>Fetching ' + type + '...</h3>';
document.body.appendChild(loadingDiv);

// Get all items
const response = await fetch(API_URL + '/' + type, {
method: 'GET',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
}
});

if (!response.ok) {
throw new Error('Failed to fetch ' + type);
}

const result = await response.json();
const items = result.data || [];

if (items.length === 0) {
document.body.removeChild(loadingDiv);
alert('No ' + type + ' to delete');
return;
}

// Update loading message
loadingDiv.innerHTML = '<h3>Deleting ' + type + '...</h3><p>Progress: <span id="delete-progress">0</span> / ' + items.length + '</p>';

let deleted = 0;
let failed = 0;

// Delete each item
for (const item of items) {
try {
const deleteUrl = API_URL + '/' + type + '/' + item.id;
console.log('Deleting:', deleteUrl);

const deleteResponse = await fetch(deleteUrl, {
method: 'DELETE',
headers: {
'Authorization': 'Bearer ' + authToken
}
});

if (deleteResponse.ok) {
deleted++;
console.log('Deleted:', item.id);
} else {
failed++;
console.log('Failed to delete:', item.id, deleteResponse.status);
}

document.getElementById('delete-progress').textContent = deleted;
} catch (error) {
console.error('Delete error:', error);
failed++;
}
}

// Remove loading
document.body.removeChild(loadingDiv);

// Show result
if (failed === 0) {
alert('Successfully deleted ' + deleted + ' ' + type + '!');
} else {
alert('Deleted ' + deleted + ' ' + type + ', but ' + failed + ' failed.');
}

// Reload
window.location.reload();

} catch (error) {
console.error('Error:', error);
alert('Error: ' + error.message);
const loadingDiv = document.getElementById('delete-loading');
if (loadingDiv) {
document.body.removeChild(loadingDiv);
}
}
};



// Working create functions
window.oldCreateTestLead = async function() {
// Get current date in YYYY-MM-DD format
const now = new Date();
const year = now.getFullYear();
const month = String(now.getMonth() + 1).padStart(2, '0');
const day = String(now.getDate()).padStart(2, '0');
const today = `${year}-${month}-${day}`;

// Create future date for follow up (3 days from now)
const futureDate = new Date(now.getTime() + (3 * 24 * 60 * 60 * 1000));
const futureYear = futureDate.getFullYear();
const futureMonth = String(futureDate.getMonth() + 1).padStart(2, '0');
const futureDay = String(futureDate.getDate()).padStart(2, '0');
const followUpDate = `${futureYear}-${futureMonth}-${futureDay}`;

const testData = {
name: 'Test User ' + Math.floor(Math.random() * 1000),
email: 'test' + Math.floor(Math.random() * 1000) + '@example.com',
phone: '98' + Math.floor(Math.random() * 90000000 + 10000000),
company: 'Test Company ' + Math.floor(Math.random() * 100),
lead_for_event: 'General Inquiry',
lead_source: 'Website',
lead_type: 'warm',
status: 'new',
date_of_enquiry: today,
follow_up_date: followUpDate,
notes: 'Test lead created via test mode',
requirements: 'Test requirements for stalls and equipment',
budget: Math.floor(Math.random() * 50000) + 10000,
event_date: followUpDate,
location: 'Test Location',
urgency: 'medium'
};



// Add created_by if user is logged in
try {
const user = JSON.parse(localStorage.getItem('crm_user') || '{}');
if (user.id) {
testData.created_by = user.id;
}
} catch (e) {
console.log('Could not get user ID');
}

const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

console.log('Creating lead with data:', testData);
console.log('Date of enquiry:', testData.date_of_enquiry);

try {
const response = await fetch(API_URL + '/leads', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
});

const result = await response.json();

if (response.ok) {
console.log('Lead created successfully:', result);
alert('Test lead created: ' + testData.name + '\nDate: ' + testData.date_of_enquiry);
window.location.reload();
} else {
console.error('Failed to create lead:', result);
alert('Error: ' + (result.error || result.message || 'Failed to create lead'));
}
} catch (error) {
console.error('Create lead error:', error);
alert('Error creating lead: ' + error.message);
}
};



window.oldCreateTestInventory = async function() {
const categories = ['Stall', 'Equipment', 'Service', 'Package'];
const testData = {
name: 'Test Item ' + Math.floor(Math.random() * 1000),
category: categories[Math.floor(Math.random() * categories.length)],
price: Math.floor(Math.random() * 90000) + 10000,
quantity: Math.floor(Math.random() * 50) + 1,
status: 'available',
description: 'Test inventory item created via test mode at ' + new Date().toLocaleString(),
size: '10x10 ft',
location: 'Zone ' + Math.floor(Math.random() * 5 + 1)
};



const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
const response = await fetch(API_URL + '/inventory', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
});

const result = await response.json();

if (response.ok) {
console.log('Inventory created:', result);
alert('Test inventory created: ' + testData.name);
window.location.reload();
} else {
console.error('Failed to create inventory:', result);
alert('Error: ' + (result.error || 'Failed to create inventory'));
}
} catch (error) {
console.error('Create inventory error:', error);
alert('Error creating inventory: ' + error.message);
}
};



// Debug function
window.debugLeads = async function() {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

const response = await fetch(API_URL + '/leads', {
method: 'GET',
headers: {
'Authorization': 'Bearer ' + authToken
}
});

const result = await response.json();
console.log('All leads:', result);
return result;
};




// Add floating button to show test panel if hidden
setTimeout(() => {
if (localStorage.getItem('testMode') === 'true') {
const showButton = document.createElement('button');
showButton.id = 'show-test-panel';
showButton.style.cssText = 'position:fixed;bottom:20px;left:20px;background:#1f2937;color:white;padding:10px;border-radius:50%;width:50px;height:50px;border:none;cursor:pointer;z-index:9998;font-size:20px;box-shadow:0 2px 4px rgba(0,0,0,0.2);';
showButton.innerHTML = 'üß™';
showButton.title = 'Show Test Panel';
showButton.onclick = () => {
const panel = document.getElementById('test-control-panel');
if (panel) {
panel.style.display = 'block';
showButton.style.display = 'none';
}
};


document.body.appendChild(showButton);

// Hide button if panel is visible
const checkPanel = setInterval(() => {
const panel = document.getElementById('test-control-panel');
if (panel && panel.style.display !== 'none') {
showButton.style.display = 'none';
} else {
showButton.style.display = 'block';
}
}, 500);
}
}, 1000);


// Debug function to see inventory structure
window.checkInventoryFields = async function() {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

const response = await fetch(API_URL + '/inventory', {
method: 'GET',
headers: {
'Authorization': 'Bearer ' + authToken
}
});

const result = await response.json();
if (result.data && result.data.length > 0) {
console.log('Sample inventory structure:', result.data[0]);
console.log('Fields:', Object.keys(result.data[0]));
} else {
console.log('No inventory found');
}
return result;
};



console.log('Test mode functions loaded. Type debugLeads() to see all leads.');
</script>

<!-- TEMP FINANCIALS DELETE FUNCTION -->
<script>
window.deleteAllFinancials = async function() {
if (!confirm('Delete all financial records (payables and receivables)?')) return;

const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
console.log('Starting to delete all financials...');
let deletedPayables = 0;
let deletedReceivables = 0;

// Delete all payables
try {
const payablesRes = await fetch(`${API_URL}/api/payables`, {
headers: {
'Authorization': `Bearer ${authToken}`,
'Content-Type': 'application/json'
}
});

if (payablesRes.ok) {
const payablesData = await payablesRes.json();
const payables = payablesData.data || [];
console.log(`Found ${payables.length} payables to delete`);

for (const payable of payables) {
const delRes = await fetch(`${API_URL}/api/payables/${payable.id}`, {
method: 'DELETE',
headers: {
'Authorization': `Bearer ${authToken}`,
'Content-Type': 'application/json'
}
});
if (delRes.ok) {
deletedPayables++;
console.log(`Deleted payable: ${payable.id}`);
}
}
}
} catch (e) {
console.error('Error deleting payables:', e);
}

// Delete all receivables - FIXED endpoint
try {
console.log('Fetching receivables...');
const receivablesRes = await fetch(`${API_URL}/api/receivables`, {
headers: {
'Authorization': `Bearer ${authToken}`,
'Content-Type': 'application/json'
}
});

console.log('Receivables response status:', receivablesRes.status);

if (receivablesRes.ok) {
const receivablesData = await receivablesRes.json();
const receivables = receivablesData.data || [];
console.log(`Found ${receivables.length} receivables to delete`);

// Delete each receivable
for (const receivable of receivables) {
console.log(`Deleting receivable: ${receivable.id}`);
const delRes = await fetch(`${API_URL}/api/receivables/${receivable.id}`, {
method: 'DELETE',
headers: {
'Authorization': `Bearer ${authToken}`,
'Content-Type': 'application/json'
}
});

if (delRes.ok) {
deletedReceivables++;
console.log(`Successfully deleted receivable: ${receivable.id}`);
} else {
console.error(`Failed to delete receivable ${receivable.id}:`, delRes.status);
}
}
} else {
console.error('Failed to fetch receivables:', receivablesRes.status);
}
} catch (e) {
console.error('Error deleting receivables:', e);
}

alert(`Financial records deleted!\nPayables: ${deletedPayables}\nReceivables: ${deletedReceivables}`);
window.location.reload();

} catch (error) {
console.error('Error:', error);
alert('Error: ' + error.message);
}
};


</script>

</body>
</html>
<!-- Password: Updated: Sun Jun 29 11:38:10 AM UTC 2025 -->
<!-- Password: LATEST_DEPLOY: 2025-06-29 11:41:06 UTC -->
<!-- Password: Deployed: Sun Jun 29 12:22:47 PM UTC 2025 -->

<div id="test-control-panel" style="position:fixed; bottom:80px; right:20px; background:#1f2937; color:white; padding:15px; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.3); display:none; z-index:9999;">
<h3 style="margin:0 0 10px 0; font-size:16px;">üß™ Test Mode Controls</h3>
<button onclick="if(confirm('Delete ALL leads?')) { window.testDeleteAll('leads'); }" style="display:block; width:100%; margin:5px 0; padding:8px; background:#dc2626; color:white; border:none; border-radius:4px; cursor:pointer;">üóëÔ∏è Delete All Leads</button>
<button onclick="if(confirm('Delete ALL inventory?')) { window.testDeleteAll('inventory'); }" style="display:block; width:100%; margin:5px 0; padding:8px; background:#dc2626; color:white; border:none; border-radius:4px; cursor:pointer;">üóëÔ∏è Delete All Inventory</button>
</div>
<script>
// Show test control panel if test mode is on and user is super admin
window.updateTestPanel = function() {
const testMode = localStorage.getItem('testMode') === 'true';
const user = JSON.parse(localStorage.getItem('crm_user') || '{}');
const panel = document.getElementById('test-control-panel');
if (testMode && user.role === 'super_admin' && panel) {
panel.style.display = 'block';
}
};



// Delete all function
window.testDeleteAll = async function(type) {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
const response = await fetch(API_URL + '/' + type, {
method: 'DELETE',
headers: {
'Authorization': 'Bearer ' + authToken,
'X-Delete-All': 'true',
'X-Test-Mode': 'true'
}
});

if (response.ok) {
alert('All ' + type + ' deleted successfully!');
window.location.reload();
} else {
alert('Error: ' + response.statusText);
}
} catch (error) {
alert('Error: ' + error.message);
}
};



// Check on load
setTimeout(window.updateTestPanel, 1000);
</script>


<script>
// Test data creation functions
window.fillTestLead = function() {
if (confirm('Create a test lead?')) {
// Directly create test lead data
const testData = {
name: 'Test User ' + Math.floor(Math.random() * 1000),
email: 'test' + Math.floor(Math.random() * 1000) + '@example.com',
phone: '98' + Math.floor(Math.random() * 90000000 + 10000000),
company: 'Test Company ' + Math.floor(Math.random() * 100),
lead_for_event: 'General Inquiry',
lead_source: 'Website',
notes: 'Test lead created via test mode'
};



// Call the API directly
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

fetch(API_URL + '/leads', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
})
.then(response => response.json())
.then(data => {
alert('Test lead created successfully!');
window.location.reload();
})
.catch(error => {
alert('Error creating test lead: ' + error.message);
});
}
};



window.fillTestInventory = function() {
if (confirm('Create a test inventory item?')) {
const categories = ['Stall', 'Equipment', 'Service', 'Package'];
const testData = {
name: 'Test Item ' + Math.floor(Math.random() * 1000),
category: categories[Math.floor(Math.random() * categories.length)],
price: Math.floor(Math.random() * 90000) + 10000,
quantity: Math.floor(Math.random() * 50) + 1,
description: 'Test inventory item created via test mode',
size: '10x10 ft',
location: 'Zone ' + Math.floor(Math.random() * 5 + 1)
};



const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

fetch(API_URL + '/inventory', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
})
.then(response => response.json())
.then(data => {
alert('Test inventory item created successfully!');
window.location.reload();
})
.catch(error => {
alert('Error creating test inventory: ' + error.message);
});
}
};


</script>


<script>
// Working delete function that deletes individually
window.deleteAllIndividually = async function(type) {
if (!confirm('Delete ALL ' + type + '? This will delete them one by one.')) {
return;
}

const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
// Show loading
const loadingDiv = document.createElement('div');
loadingDiv.id = 'delete-loading';
loadingDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:10000;';
loadingDiv.innerHTML = '<h3>Fetching ' + type + '...</h3>';
document.body.appendChild(loadingDiv);

// Get all items
const response = await fetch(API_URL + '/' + type, {
method: 'GET',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
}
});

if (!response.ok) {
throw new Error('Failed to fetch ' + type);
}

const result = await response.json();
const items = result.data || [];

if (items.length === 0) {
document.body.removeChild(loadingDiv);
alert('No ' + type + ' to delete');
return;
}

// Update loading message
loadingDiv.innerHTML = '<h3>Deleting ' + type + '...</h3><p>Progress: <span id="delete-progress">0</span> / ' + items.length + '</p>';

let deleted = 0;
let failed = 0;

// Delete each item
for (const item of items) {
try {
const deleteUrl = API_URL + '/' + type + '/' + item.id;
console.log('Deleting:', deleteUrl);

const deleteResponse = await fetch(deleteUrl, {
method: 'DELETE',
headers: {
'Authorization': 'Bearer ' + authToken
}
});

if (deleteResponse.ok) {
deleted++;
console.log('Deleted:', item.id);
} else {
failed++;
console.log('Failed to delete:', item.id, deleteResponse.status);
}

document.getElementById('delete-progress').textContent = deleted;
} catch (error) {
console.error('Delete error:', error);
failed++;
}
}

// Remove loading
document.body.removeChild(loadingDiv);

// Show result
if (failed === 0) {
alert('Successfully deleted ' + deleted + ' ' + type + '!');
} else {
alert('Deleted ' + deleted + ' ' + type + ', but ' + failed + ' failed.');
}

// Reload
window.location.reload();

} catch (error) {
console.error('Error:', error);
alert('Error: ' + error.message);
const loadingDiv = document.getElementById('delete-loading');
if (loadingDiv) {
document.body.removeChild(loadingDiv);
}
}
};



// Working create functions
window.oldCreateTestLead = async function() {
const testData = {
name: 'Test User ' + Math.floor(Math.random() * 1000),
email: 'test' + Math.floor(Math.random() * 1000) + '@example.com',
phone: '98' + Math.floor(Math.random() * 90000000 + 10000000),
company: 'Test Company ' + Math.floor(Math.random() * 100),
lead_for_event: 'General Inquiry',
lead_source: 'Website',
lead_type: 'warm',
status: 'new',
notes: 'Test lead created via test mode at ' + new Date().toLocaleString()
};



const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
const response = await fetch(API_URL + '/leads', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
});

const result = await response.json();

if (response.ok) {
console.log('Lead created:', result);
alert('Test lead created: ' + testData.name);
window.location.reload();
} else {
console.error('Failed to create lead:', result);
alert('Error: ' + (result.error || 'Failed to create lead'));
}
} catch (error) {
console.error('Create lead error:', error);
alert('Error creating lead: ' + error.message);
}
};



window.oldCreateTestInventory = async function() {
const categories = ['Stall', 'Equipment', 'Service', 'Package'];
const testData = {
name: 'Test Item ' + Math.floor(Math.random() * 1000),
category: categories[Math.floor(Math.random() * categories.length)],
price: Math.floor(Math.random() * 90000) + 10000,
quantity: Math.floor(Math.random() * 50) + 1,
status: 'available',
description: 'Test inventory item created via test mode at ' + new Date().toLocaleString(),
size: '10x10 ft',
location: 'Zone ' + Math.floor(Math.random() * 5 + 1)
};



const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
const response = await fetch(API_URL + '/inventory', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
});

const result = await response.json();

if (response.ok) {
console.log('Inventory created:', result);
alert('Test inventory created: ' + testData.name);
window.location.reload();
} else {
console.error('Failed to create inventory:', result);
alert('Error: ' + (result.error || 'Failed to create inventory'));
}
} catch (error) {
console.error('Create inventory error:', error);
alert('Error creating inventory: ' + error.message);
}
};



// Debug function
window.debugLeads = async function() {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

const response = await fetch(API_URL + '/leads', {
method: 'GET',
headers: {
'Authorization': 'Bearer ' + authToken
}
});

const result = await response.json();
console.log('All leads:', result);
return result;
};




// Add floating button to show test panel if hidden
setTimeout(() => {
if (localStorage.getItem('testMode') === 'true') {
const showButton = document.createElement('button');
showButton.id = 'show-test-panel';
showButton.style.cssText = 'position:fixed;bottom:20px;left:20px;background:#1f2937;color:white;padding:10px;border-radius:50%;width:50px;height:50px;border:none;cursor:pointer;z-index:9998;font-size:20px;box-shadow:0 2px 4px rgba(0,0,0,0.2);';
showButton.innerHTML = 'üß™';
showButton.title = 'Show Test Panel';
showButton.onclick = () => {
const panel = document.getElementById('test-control-panel');
if (panel) {
panel.style.display = 'block';
showButton.style.display = 'none';
}
};


document.body.appendChild(showButton);

// Hide button if panel is visible
const checkPanel = setInterval(() => {
const panel = document.getElementById('test-control-panel');
if (panel && panel.style.display !== 'none') {
showButton.style.display = 'none';
} else {
showButton.style.display = 'block';
}
}, 500);
}
}, 1000);


// Debug function to see inventory structure
window.checkInventoryFields = async function() {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

const response = await fetch(API_URL + '/inventory', {
method: 'GET',
headers: {
'Authorization': 'Bearer ' + authToken
}
});

const result = await response.json();
if (result.data && result.data.length > 0) {
console.log('Sample inventory structure:', result.data[0]);
console.log('Fields:', Object.keys(result.data[0]));
} else {
console.log('No inventory found');
}
return result;
};



console.log('Test mode functions loaded. Type debugLeads() to see all leads.');


// Test date formatting
window.testDateFormat = function() {
const now = new Date();
const year = now.getFullYear();
const month = String(now.getMonth() + 1).padStart(2, '0');
const day = String(now.getDate()).padStart(2, '0');
const today = `${year}-${month}-${day}`;

console.log('Current date:', now);
console.log('Formatted date:', today);
console.log('Type:', typeof today);

return today;
};



// Function to manually create a lead with custom data
window.createCustomLead = async function(leadData) {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

console.log('Creating lead with custom data:', leadData);

try {
const response = await fetch(API_URL + '/leads', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(leadData)
});

const result = await response.json();
console.log('Response:', result);

if (response.ok) {
alert('Lead created successfully!');
return result;
} else {
alert('Error: ' + (result.error || result.message));
return null;
}
} catch (error) {
console.error('Error:', error);
alert('Error: ' + error.message);
return null;
}
};





// Analyze existing lead structure
window.analyzeLeadStructure = async function() {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
// Get existing leads
const response = await fetch(API_URL + '/leads', {
method: 'GET',
headers: {
'Authorization': 'Bearer ' + authToken
}
});

const result = await response.json();
console.log('Leads response:', result);

if (result.data && result.data.length > 0) {
const lead = result.data[0];
console.log('Sample lead:', lead);
console.log('Lead fields:', Object.keys(lead));
console.log('Field types:');
for (const key in lead) {
console.log(`  ${key}: ${typeof lead[key]} = ${lead[key]}`);
}

// Check date fields specifically
if (lead.date_of_enquiry) {
console.log('date_of_enquiry format:', lead.date_of_enquiry);
}

return lead;
} else {
console.log('No existing leads found');
return null;
}
} catch (error) {
console.error('Error analyzing leads:', error);
return null;
}
};



// Create lead with minimal required fields
window.createMinimalLead = async function() {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

// Start with absolute minimum fields
const minimalData = {
name: 'Minimal Test ' + Math.floor(Math.random() * 1000),
email: 'minimal' + Math.floor(Math.random() * 1000) + '@test.com',
phone: '9876543210',
status: 'new'
};



console.log('Creating minimal lead:', minimalData);

try {
const response = await fetch(API_URL + '/leads', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(minimalData)
});

const result = await response.json();
console.log('Response status:', response.status);
console.log('Response:', result);

if (response.ok) {
alert('Minimal lead created successfully!');
return result;
} else {
console.error('Failed:', result);
alert('Failed: ' + (result.error || result.message || 'Unknown error'));
return null;
}
} catch (error) {
console.error('Error:', error);
alert('Error: ' + error.message);
return null;
}
};



// Fixed create test lead based on backend requirements
window.oldCreateTestLead = async function() {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

// First analyze existing lead to understand structure
console.log('Analyzing existing lead structure...');
const existingLead = await analyzeLeadStructure();

// Create test data matching the structure
const testData = {
name: 'Test User ' + Math.floor(Math.random() * 1000),
email: 'test' + Math.floor(Math.random() * 1000) + '@example.com',
phone: '98' + Math.floor(Math.random() * 90000000 + 10000000),
company: 'Test Company ' + Math.floor(Math.random() * 100),
lead_for_event: 'General Inquiry',
lead_source: 'Website',
lead_type: 'warm',
status: 'new',
notes: 'Test lead created via test mode',
requirements: 'Test requirements'
};



// If we found date fields in existing lead, add them
if (existingLead && existingLead.date_of_enquiry) {
// Copy the date format from existing lead
const dateFormat = existingLead.date_of_enquiry;
console.log('Using date format from existing lead:', dateFormat);

// If it's a timestamp, use current timestamp
if (typeof dateFormat === 'object' || dateFormat.includes('T')) {
testData.date_of_enquiry = new Date().toISOString();
} else {
// Otherwise use YYYY-MM-DD format
const now = new Date();
testData.date_of_enquiry = now.getFullYear() + '-' + 
String(now.getMonth() + 1).padStart(2, '0') + '-' + 
String(now.getDate()).padStart(2, '0');
}
}

console.log('Creating lead with data:', testData);

try {
const response = await fetch(API_URL + '/leads', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
});

const result = await response.json();

if (response.ok) {
console.log('Lead created successfully:', result);
alert('Test lead created: ' + testData.name);
window.location.reload();
} else {
console.error('Failed to create lead:', result);

// If date_of_enquiry is the issue, try without it
if (result.error && result.error.includes('date_of_enquiry')) {
console.log('Retrying without date_of_enquiry...');
delete testData.date_of_enquiry;

const retry = await fetch(API_URL + '/leads', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
});

const retryResult = await retry.json();

if (retry.ok) {
alert('Test lead created (without date): ' + testData.name);
window.location.reload();
} else {
alert('Error: ' + (retryResult.error || retryResult.message || 'Failed to create lead'));
}
} else {
alert('Error: ' + (result.error || result.message || 'Failed to create lead'));
}
}
} catch (error) {
console.error('Create lead error:', error);
alert('Error creating lead: ' + error.message);
}
};





// Create test lead following form business logic
window.oldCreateTestLead = async function() {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
// First, get the active events (same as form does)
console.log('Fetching active events...');
const eventsResponse = await fetch(API_URL + '/events?status=active', {
method: 'GET',
headers: {
'Authorization': 'Bearer ' + authToken
}
});

let activeEvent = null;
if (eventsResponse.ok) {
const eventsResult = await eventsResponse.json();
if (eventsResult.data && eventsResult.data.length > 0) {
activeEvent = eventsResult.data[0].name;
console.log('Found active event:', activeEvent);
}
}

// Get lead sources and statuses from form options if they exist
const leadSources = ['Website', 'Social Media', 'Referral', 'Direct Contact', 'Exhibition', 'Cold Call'];
const leadTypes = ['hot', 'warm', 'cold'];
const urgencyLevels = ['high', 'medium', 'low'];

// Create test data following form structure
const testData = {
name: 'Test User ' + Math.floor(Math.random() * 1000),
email: 'test' + Math.floor(Math.random() * 1000) + '@example.com',
phone: '98' + Math.floor(Math.random() * 90000000 + 10000000),
company: 'Test Company ' + Math.floor(Math.random() * 100),
lead_for_event: activeEvent || 'General Inquiry', // Use active event if found
lead_source: leadSources[Math.floor(Math.random() * leadSources.length)],
lead_type: leadTypes[Math.floor(Math.random() * leadTypes.length)],
status: 'unassigned', // Use unassigned as default like the form
notes: 'Test lead created via test mode on ' + new Date().toLocaleString(),
requirements: 'Looking for ' + Math.floor(Math.random() * 5 + 1) + ' stalls and equipment',
budget: Math.floor(Math.random() * 100000) + 25000,
urgency: urgencyLevels[Math.floor(Math.random() * urgencyLevels.length)],
location: 'Test Location ' + ['Delhi', 'Mumbai', 'Bangalore', 'Chennai'][Math.floor(Math.random() * 4)]
};



// Add date fields if needed
const now = new Date();
const dateStr = now.getFullYear() + '-' + 
String(now.getMonth() + 1).padStart(2, '0') + '-' + 
String(now.getDate()).padStart(2, '0');

// Check if date_of_enquiry is needed by trying to get existing lead structure
const leadsCheck = await fetch(API_URL + '/leads?limit=1', {
method: 'GET',
headers: {
'Authorization': 'Bearer ' + authToken
}
});

if (leadsCheck.ok) {
const leadsResult = await leadsCheck.json();
if (leadsResult.data && leadsResult.data.length > 0) {
const sampleLead = leadsResult.data[0];
// If existing leads have date_of_enquiry, add it in the same format
if (sampleLead.date_of_enquiry) {
if (typeof sampleLead.date_of_enquiry === 'object') {
// Firestore timestamp format
testData.date_of_enquiry = {
_seconds: Math.floor(now.getTime() / 1000),
_nanoseconds: 0
};


} else {
testData.date_of_enquiry = dateStr;
}
}

// Copy the created_by format if it exists
if (sampleLead.created_by) {
const user = JSON.parse(localStorage.getItem('crm_user') || '{}');
testData.created_by = user.id || user.email || 'admin';
}
}
}

console.log('Creating lead with business logic data:', testData);

// Create the lead
const response = await fetch(API_URL + '/leads', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
});

const result = await response.json();

if (response.ok) {
console.log('Lead created successfully:', result);
alert('Test lead created successfully!\n' +
'Name: ' + testData.name + '\n' +
'Event: ' + testData.lead_for_event + '\n' +
'Status: ' + testData.status + '\n' +
'Budget: ‚Çπ' + testData.budget.toLocaleString());
window.location.reload();
} else {
console.error('Failed to create lead:', result);

// If it's still about date_of_enquiry, try without it
if (result.error && result.error.includes('date_of_enquiry')) {
delete testData.date_of_enquiry;
console.log('Retrying without date_of_enquiry...');

const retry = await fetch(API_URL + '/leads', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
});

const retryResult = await retry.json();
if (retry.ok) {
alert('Test lead created successfully (without date)!');
window.location.reload();
} else {
alert('Error: ' + (retryResult.error || 'Failed to create lead'));
}
} else {
alert('Error: ' + (result.error || result.message || 'Failed to create lead'));
}
}
} catch (error) {
console.error('Error:', error);
alert('Error creating lead: ' + error.message);
}
};



// Function to see what status options exist in the form
window.checkFormOptions = function() {
// This would analyze the form to see what options are available
console.log('Checking form options...');

// Look for select elements and their options
const selects = document.querySelectorAll('select');
selects.forEach(select => {
if (select.options && select.options.length > 0) {
console.log('Select field:', select.name || 'unknown');
Array.from(select.options).forEach(opt => {
console.log('  Option:', opt.value, '-', opt.text);
});
}
});
};





// Create test inventory following form business logic
window.oldCreateTestInventory = async function() {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
// First check existing inventory to understand structure
console.log('Checking existing inventory structure...');
const invResponse = await fetch(API_URL + '/inventory?limit=1', {
method: 'GET',
headers: {
'Authorization': 'Bearer ' + authToken
}
});

let sampleInventory = null;
if (invResponse.ok) {
const invResult = await invResponse.json();
if (invResult.data && invResult.data.length > 0) {
sampleInventory = invResult.data[0];
console.log('Sample inventory:', sampleInventory);
}
}

// Define proper business values
const categories = ['Stall', 'Equipment', 'Service', 'Package'];
const sizes = ['3x3', '6x6', '9x9', '10x10', '12x12', '15x15', '20x20', 'Custom'];
const locations = ['Hall A', 'Hall B', 'Hall C', 'Outdoor Area', 'Food Court', 'Main Entrance'];
const units = ['Per Day', 'Per Event', 'Per Hour', 'Per Unit'];
const statuses = ['available', 'booked', 'maintenance', 'unavailable'];

// Generate realistic inventory data
const category = categories[Math.floor(Math.random() * categories.length)];
const basePrice = category === 'Stall' ? 15000 : 
category === 'Equipment' ? 5000 : 
category === 'Service' ? 10000 : 25000;

const quantity = category === 'Service' ? 1 : Math.floor(Math.random() * 20) + 5;

const testData = {
name: 'Test ' + category + ' ' + Math.floor(Math.random() * 1000),
category: category,
price: basePrice + Math.floor(Math.random() * 10000),
quantity: quantity,
available_quantity: quantity, // Initially all available
status: 'available', // New inventory is available
description: 'High quality ' + category.toLowerCase() + ' suitable for exhibitions and events. ' +
'Includes all standard amenities and facilities.',
size: category === 'Stall' ? sizes[Math.floor(Math.random() * sizes.length)] : 'Standard',
location: locations[Math.floor(Math.random() * locations.length)],
unit: units[Math.floor(Math.random() * units.length)],
min_booking_quantity: 1,
max_booking_quantity: category === 'Service' ? 1 : Math.min(quantity, 10),
features: category === 'Stall' ? 'Power outlet, Lighting, Table, Chairs, Fascia board' :
category === 'Equipment' ? 'Professional grade, Well maintained, Delivery included' :
category === 'Service' ? 'Professional staff, Experienced team, Quality assured' :
'Complete package with all inclusions',
terms_conditions: 'Standard rental terms apply. Advance booking required. Cancellation policy applicable.',
specifications: category === 'Stall' ? 
JSON.stringify({
power_supply: '15 Amp',
height: '8 feet',
type: 'Octanorm',
flooring: 'Carpet'
}) :
JSON.stringify({
brand: 'Premium',
condition: 'Excellent',
year: '2024'
}),
// Ensure no undefined values
tickets_available: 0, // Not applicable for inventory
booking_start_date: null,
booking_end_date: null,
images: [],
tags: [category.toLowerCase(), 'test', 'available']
};



// Add created_by from current user
const user = JSON.parse(localStorage.getItem('crm_user') || '{}');
if (user.id) {
testData.created_by = user.id;
}

// Add timestamps
const now = new Date();
testData.created_date = now.toISOString();
testData.updated_date = now.toISOString();

// If sample inventory exists, match any additional fields
if (sampleInventory) {
// Check for any fields we might have missed
Object.keys(sampleInventory).forEach(key => {
if (testData[key] === undefined && 
!['id', 'created_at', 'updated_at'].includes(key)) {
// Set appropriate default based on type
if (typeof sampleInventory[key] === 'number') {
testData[key] = 0;
} else if (typeof sampleInventory[key] === 'boolean') {
testData[key] = false;
} else if (typeof sampleInventory[key] === 'string') {
testData[key] = '';
} else if (Array.isArray(sampleInventory[key])) {
testData[key] = [];
} else if (sampleInventory[key] === null) {
testData[key] = null;
}
console.log('Added missing field:', key, 'with default:', testData[key]);
}
});
}

console.log('Creating inventory with business logic data:', testData);

// Create the inventory
const response = await fetch(API_URL + '/inventory', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
});

const result = await response.json();

if (response.ok) {
console.log('Inventory created successfully:', result);
alert('Test inventory created successfully!\n' +
'Name: ' + testData.name + '\n' +
'Category: ' + testData.category + '\n' +
'Price: ‚Çπ' + testData.price.toLocaleString() + ' ' + testData.unit + '\n' +
'Quantity: ' + testData.quantity + '\n' +
'Location: ' + testData.location);
window.location.reload();
} else {
console.error('Failed to create inventory:', result);
alert('Error: ' + (result.error || result.message || 'Failed to create inventory'));

// Log which fields might be causing issues
if (result.error) {
console.log('Error details:', result.error);
console.log('Sent data:', testData);
}
}
} catch (error) {
console.error('Error:', error);
alert('Error creating inventory: ' + error.message);
}
};



// Function to analyze inventory fields
window.analyzeInventoryStructure = async function() {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
const response = await fetch(API_URL + '/inventory', {
method: 'GET',
headers: {
'Authorization': 'Bearer ' + authToken
}
});

const result = await response.json();
if (result.data && result.data.length > 0) {
const item = result.data[0];
console.log('Sample inventory item:', item);
console.log('Fields:', Object.keys(item));
console.log('Field types:');
Object.keys(item).forEach(key => {
const value = item[key];
console.log(`  ${key}: ${typeof value} = ${value === null ? 'null' : value}`);
});
return item;
} else {
console.log('No inventory items found');
return null;
}
} catch (error) {
console.error('Error:', error);
re


// Test functions with correct field names from your actual forms
window.createTestInventory = async function() {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
// Using exact field names from inventoryFormFields
const testData = {
// Required fields
event_name: 'Test Cricket Match ' + Math.floor(Math.random() * 1000),
event_date: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0], // 30 days from now
event_type: ['football', 'cricket', 'tennis', 'formula1', 'olympics', 'basketball', 'badminton', 'hockey'][Math.floor(Math.random() * 8)],
sports: ['Cricket', 'Football', 'Tennis', 'Formula 1', 'Olympics', 'Basketball', 'Badminton', 'Hockey', 'Golf', 'Wrestling'][Math.floor(Math.random() * 10)],
venue: 'Test Stadium ' + ['Mumbai', 'Delhi', 'Bangalore', 'Chennai', 'Kolkata'][Math.floor(Math.random() * 5)],

// Ticket details
category_of_ticket: ['VIP', 'Premium', 'Gold', 'Silver', 'Bronze', 'General', 'Corporate Box', 'Hospitality'][Math.floor(Math.random() * 8)],
total_tickets: Math.floor(Math.random() * 500) + 100,
available_tickets: Math.floor(Math.random() * 500) + 100,
mrp_of_ticket: Math.floor(Math.random() * 5000) + 1000,
buying_price: Math.floor(Math.random() * 4000) + 800,
selling_price: Math.floor(Math.random() * 6000) + 1500,

// Optional fields
day_of_match: 'Not Applicable',
stand: 'North Stand',
inclusions: 'Snacks, Beverages, Parking',
booking_person: 'Test Supplier ' + Math.floor(Math.random() * 100),
procurement_type: ['pre_inventory', 'on_demand', 'partnership', 'direct_booking'][Math.floor(Math.random() * 4)],
notes: 'Test inventory created via test mode',

// Payment fields
paymentStatus: 'paid',
supplierName: 'Test Supplier Company',

// System fields
created_by: JSON.parse(localStorage.getItem('crm_user') || '{}').name || 'Test User',
created_date: new Date().toISOString()
};



console.log('Creating inventory with correct fields:', testData);

const response = await fetch(API_URL + '/inventory', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
});

const result = await response.json();

if (response.ok) {
alert('Test inventory created!\n' +
'Event: ' + testData.event_name + '\n' +
'Sports: ' + testData.sports + '\n' +
'Venue: ' + testData.venue + '\n' +
'Category: ' + testData.category_of_ticket + '\n' +
'Available: ' + testData.available_tickets + ' tickets');
window.location.reload();
} else {
console.error('Failed:', result);
alert('Error: ' + (result.error || result.message || 'Failed to create inventory'));
}
} catch (error) {
console.error('Error:', error);
alert('Error: ' + error.message);
}
};



window.createTestLead = async function() {
const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
// Using exact field names from leadFormFields
const testData = {
// Basic fields (required)
name: 'Test Contact ' + Math.floor(Math.random() * 1000),
email: 'test' + Math.floor(Math.random() * 1000) + '@example.com',
phone: '98' + Math.floor(Math.random() * 90000000 + 10000000),
company: 'Test Company ' + Math.floor(Math.random() * 100),
business_type: ['B2C', 'B2B'][Math.floor(Math.random() * 2)],

// Lead details
source: ['Facebook', 'Instagram', 'LinkedIn', 'Friends and Family', 'Through Champion', 
'Website', 'Existing Client', 'Contacted on Social Media', 'Middlemen'][Math.floor(Math.random() * 9)],

// Business fields
potential_value: Math.floor(Math.random() * 500000) + 50000,
notes: 'Test lead interested in event tickets',

// System fields
status: 'unassigned', // Using lowercase as per your code
created_by: JSON.parse(localStorage.getItem('crm_user') || '{}').name || 'Test User',
created_date: new Date().toISOString()
};



console.log('Creating lead with correct fields:', testData);

const response = await fetch(API_URL + '/leads', {
method: 'POST',
headers: {
'Authorization': 'Bearer ' + authToken,
'Content-Type': 'application/json'
},
body: JSON.stringify(testData)
});

const result = await response.json();

if (response.ok) {
alert('Test lead created!\n' +
'Name: ' + testData.name + '\n' +
'Company: ' + testData.company + '\n' +
'Source: ' + testData.source);
window.location.reload();
} else {
console.error('Failed:', result);
alert('Error: ' + (result.error || result.message || 'Failed to create lead'));
}
} catch (error) {
console.error('Error:', error);
alert('Error: ' + error.message);
}
};



console.log('Test functions loaded with correct field names');

return null;
}
};



</script>

<!-- TEMP FINANCIALS DELETE FUNCTION -->
<script>
window.deleteAllFinancials = async function() {
if (!confirm('Delete all financial records (payables and receivables)?')) return;

const authToken = localStorage.getItem('crm_auth_token');
// Using global API_URL variable

try {
console.log('Starting to delete all financials...');
let deletedPayables = 0;
let deletedReceivables = 0;

// Delete all payables
try {
const payablesRes = await fetch(`${API_URL}/api/payables`, {
headers: {
'Authorization': `Bearer ${authToken}`,
'Content-Type': 'application/json'
}
});

if (payablesRes.ok) {
const payablesData = await payablesRes.json();
const payables = payablesData.data || [];
console.log(`Found ${payables.length} payables to delete`);

for (const payable of payables) {
const delRes = await fetch(`${API_URL}/api/payables/${payable.id}`, {
method: 'DELETE',
headers: {
'Authorization': `Bearer ${authToken}`,
'Content-Type': 'application/json'
}
});
if (delRes.ok) {
deletedPayables++;
console.log(`Deleted payable: ${payable.id}`);
}
}
}
} catch (e) {
console.error('Error deleting payables:', e);
}

// Delete all receivables - FIXED endpoint
try {
console.log('Fetching receivables...');
const receivablesRes = await fetch(`${API_URL}/api/receivables`, {
headers: {
'Authorization': `Bearer ${authToken}`,
'Content-Type': 'application/json'
}
});

console.log('Receivables response status:', receivablesRes.status);

if (receivablesRes.ok) {
const receivablesData = await receivablesRes.json();
const receivables = receivablesData.data || [];
console.log(`Found ${receivables.length} receivables to delete`);

// Delete each receivable
for (const receivable of receivables) {
console.log(`Deleting receivable: ${receivable.id}`);
const delRes = await fetch(`${API_URL}/api/receivables/${receivable.id}`, {
method: 'DELETE',
headers: {
'Authorization': `Bearer ${authToken}`,
'Content-Type': 'application/json'
}
});

if (delRes.ok) {
deletedReceivables++;
console.log(`Successfully deleted receivable: ${receivable.id}`);
} else {
console.error(`Failed to delete receivable ${receivable.id}:`, delRes.status);
}
}
} else {
console.error('Failed to fetch receivables:', receivablesRes.status);
}
} catch (e) {
console.error('Error deleting receivables:', e);
}

alert(`Financial records deleted!\nPayables: ${deletedPayables}\nReceivables: ${deletedReceivables}`);
window.location.reload();

} catch (error) {
console.error('Error:', error);
alert('Error: ' + error.message);
}
};


</script>

</body>
</html>
