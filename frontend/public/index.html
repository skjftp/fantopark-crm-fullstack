<!-- CRM Version:FIELD-MAPPING-FIXED-20250630 -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FanToPark CRM Pro</title>

<!-- PERFORMANCE OPTIMIZATION SCRIPTS - PLACE FIRST -->
<script> 
  
// 1. Global debug control - Set to true to disable all logs
window.PRODUCTION_MODE = true;
window.debugLog = window.PRODUCTION_MODE ? () => {} : console.log;

// 2. Emergency Performance Fixes
(function() {
  'use strict';
  
  
  // GLOBAL LOG SUPPRESSION
  window.EMERGENCY_MODE = true;
  
  // Override console.log for specific patterns
  const originalLog = console.log;
  const logCounts = {};
  const MAX_SAME_LOGS = 3;
  
  console.log = function(...args) {
    if (window.EMERGENCY_MODE) {
      const message = args.join(' ');
      
      // Suppress excessive debug patterns
      const suppressPatterns = [
        '🔍 DEBUGGING STATE SETTERS',
        'state.setShowInventoryForm:',
        'state.setEditingInventory:',
        'state.setShowAllocationManagement:',
        'Available inventory-related setters:',
        '🔍 ALLOCATION FORM DEBUG:',
        '🔍 DELIVERY FORM DEBUG:',
        '❌ Not showing allocation form:',
        'chart not found',
        'Chart not found!'
      ];
      
      // Check if this log should be suppressed
      const shouldSuppress = suppressPatterns.some(pattern => 
        message.includes(pattern)
      );
      
      if (shouldSuppress) {
        // Count this log
        const key = args[0] || 'unknown';
        logCounts[key] = (logCounts[key] || 0) + 1;
        
        // Only allow first few instances
        if (logCounts[key] <= MAX_SAME_LOGS) {
          originalLog.apply(console, args);
          
          if (logCounts[key] === MAX_SAME_LOGS) {
            originalLog(`🚨 [SUPPRESSED] Further "${key}" logs suppressed to improve performance`);
          }
        }
        return;
      }
    }
    
    // Allow other logs through
    originalLog.apply(console, args);
  };
  
  // CHART ERROR SUPPRESSION
  const originalError = console.error;
  const errorCounts = {};
  
  console.error = function(...args) {
    const message = args.join(' ');
    
    // Suppress chart-related errors that are spamming
    if (message.includes('chart') && message.includes('not found')) {
      const key = 'chart-not-found';
      errorCounts[key] = (errorCounts[key] || 0) + 1;
      
      if (errorCounts[key] <= 1) {
        originalError('⚠️ Chart containers not ready - will retry automatically');
      }
      return;
    }
    
    // Allow other errors through
    originalError.apply(console, args);
  };
  
  // PREVENT COMPONENT SPAM
  window._componentLogSuppressionFlags = {};
  
  window.suppressComponentLog = function(componentName, message) {
    const key = `${componentName}-${message}`;
    
    if (!window._componentLogSuppressionFlags[key]) {
      console.log(`📋 ${componentName}: ${message}`);
      window._componentLogSuppressionFlags[key] = true;
      
      // Auto-reset after 30 seconds
      setTimeout(() => {
        delete window._componentLogSuppressionFlags[key];
      }, 30000);
    }
  };
  
  // THROTTLE STATE UPDATES
  window._stateUpdateThrottle = {};
  
  window.throttledStateUpdate = function(key, updateFunction, delay = 100) {
    if (window._stateUpdateThrottle[key]) {
      clearTimeout(window._stateUpdateThrottle[key]);
    }
    
    window._stateUpdateThrottle[key] = setTimeout(() => {
      updateFunction();
      delete window._stateUpdateThrottle[key];
    }, delay);
  };
  
  // HANDLE BROWSER EXTENSION ERRORS
  window.addEventListener('error', function(e) {
    // Suppress extension-related errors
    if (e.filename && (
      e.filename.includes('content_script') ||
      e.filename.includes('extension') ||
      e.message.includes('toString')
    )) {
      e.preventDefault();
      return false;
    }
  });
  
  // CHART INITIALIZATION FIX
  window.safeChartInit = function() {
    if (window._chartInitAttempted) return;
    window._chartInitAttempted = true;
    
    const checkAndInit = () => {
      const containers = ['leadSplitChart', 'tempCountChart', 'tempValueChart'];
      const allReady = containers.every(id => document.getElementById(id));
      
      if (allReady && typeof Chart !== 'undefined') {
        try {
          // Only log success
          if (window.initializeCharts) {
            window.initializeCharts();
            console.log('✅ Charts initialized successfully');
          }
        } catch (error) {
          console.error('❌ Chart initialization failed:', error.message);
        }
      } else {
        // Don't spam retry messages
        setTimeout(checkAndInit, 1000);
      }
    };
    
    checkAndInit();
  };
  
  // PERFORMANCE TRACKER
  window.performanceTracker = {
    _operations: {},
    
    start: function(name) {
      this._operations[name] = performance.now();
    },
    
    end: function(name) {
      if (this._operations[name]) {
        const duration = performance.now() - this._operations[name];
        if (duration > 200) { // Only log slow operations
          console.warn(`⚠️ Slow: ${name} took ${duration.toFixed(2)}ms`);
        }
        delete this._operations[name];
      }
    }
  };
  
  // AUTO-CLEANUP
  window.addEventListener('beforeunload', function() {
    // Clear all timeouts
    Object.values(window._stateUpdateThrottle || {}).forEach(timeout => {
      clearTimeout(timeout);
    });
    
    // Reset flags
    window._componentLogSuppressionFlags = {};
    logCounts = {};
    errorCounts = {};
  });
  
  
})();
</script>

<!-- React and Dependencies -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Load all constant files -->
<script src="constants/config.js"></script>
<script src="constants/status-config.js"></script>
<script src="constants/user-roles.js"></script>
<script src="constants/form-config.js"></script>
<script src="constants/default-data.js"></script>

<!-- Utility Functions -->
<script src="utils/api.js"></script>
<script src="utils/permissions.js"></script>
<script src="utils/helpers.js"></script>

<!-- Component Files -->
<script src="components/assignment-rules.js"></script>
<script src="components/my-actions.js"></script>
<script src="components/leads.js"></script>
<script src="components/dashboard.js"></script>  
<script src="components/content-router.js"></script>
<script src="components/inventory.js"></script>
<script src="components/financials.js"></script>
<script src="components/orders.js"></script> 
<script src="components/user-management.js"></script>
<script src="components/stadiums.js"></script> 
<script src="components/delivery.js"></script>
<script src="components/sports-calendar.js"></script> 
<script src="components/reminders.js"></script>
<script src="components/inventory-form.js"></script>
<script src="components/lead-form.js"></script> 
<script src="components/lead-detail.js"></script>
<script src="components/payment-form.js"></script>
<script src="components/inventory-detail.js"></script>
<script src="components/order-detail-modal.js"></script>
<script src="components/user-form.js"></script>
<script src="components/gst-invoice-preview.js"></script>
<script src="components/assign-form.js"></script>
<script src="components/bulk-assign-modal.js"></script>
<script src="components/choice-modal.js"></script> 
<script src="components/status-progress-modal.js"></script>
<script src="components/allocation-management.js"></script>
<script src="components/help-guide.js"></script>  
<script src="components/stadium-form.js"></script>
<script src="components/payment-post-service-form.js"></script>
<script src="components/edit-order-form.js"></script>
<script src="components/client-detail-modal.js"></script>
<script src="components/payment-submit-handler.js"></script>
<script src="components/inventory-form-submit-handler.js"></script>
<script src="components/delete-handler.js"></script>
<script src="components/test-mode-system.js"></script>
<script src="components/csv-upload-system.js"></script>
<script src="components/form-handlers.js"></script>
<script src="components/gst-calculation-system.js"></script>
<script src="components/communication-system.js"></script>
<script src="components/chart-system.js"></script>
<script src="components/financial-system.js"></script>
<script src="components/lead-status-management.js"></script>
<script src="components/my-actions-data.js"></script>
<script src="components/user-management-handlers.js"></script>
<script src="components/reminder-management.js"></script>
<script src="components/allocation-form.js"></script>  
<script src="components/delivery-form.js"></script>
<script src="components/event-modals.js"></script>
<script src="components/reminder-form.js"></script> 
<script src="components/enhanced-recent-activity.js"></script>
  <script src="console-override.js"></script>

<!-- New Extracted Components -->
<script src="components/main-app-component.js"></script>
<script src="components/app-business-logic.js"></script>
<script src="components/app-effects-lifecycle.js"></script>
<script src="components/simplified-app-component.js"></script>

<!-- External Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
<script>
// Login Performance Optimization
window.optimizeLoginPerformance = function() {
  // Debounce component re-renders during login
  const originalSetState = window.setState;
  let loginOptimizationActive = false;
  
  // Detect login process
  const originalSetIsLoggedIn = window.setIsLoggedIn;
  if (originalSetIsLoggedIn) {
    window.setIsLoggedIn = function(value) {
      if (value) {
        loginOptimizationActive = true;
        
        // Disable optimization after 3 seconds
        setTimeout(() => {
          loginOptimizationActive = false;
          
        }, 3000);
      }
      
      return originalSetIsLoggedIn(value);
    };
  }
  
  // Reduce component logging during login
  const componentLoggers = [
    'suppressComponentLog',
    'allocLog', 
    'deliveryLog',
    'dashLog'
  ];
  
  componentLoggers.forEach(loggerName => {
    if (window[loggerName]) {
      const originalLogger = window[loggerName];
      window[loggerName] = function(...args) {
        if (!loginOptimizationActive) {
          return originalLogger.apply(this, args);
        }
        // Suppress during login
      };
    }
  });
};

// Apply optimization
window.optimizeLoginPerformance();

</script>  

<!-- CSS Styles -->
<style>
/* Global Styles */
.dark {
  color-scheme: dark;
}

.sidebar-container {
  position: relative;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.sidebar-content {
  flex: 1;
  overflow-y: auto;
}

.sidebar-bottom {
  margin-top: auto;
  padding: 1rem;
  border-top: 1px solid #e5e7eb;
}

/* Dark mode styles */
.dark .sidebar-bottom {
  border-top-color: #374151;
}

/* Sidebar logout section adjustments */
.sidebar-logout {
  position: sticky;
  bottom: 0;
  background: inherit;
  padding: 1rem;
  border-top: 1px solid #e5e7eb;
}

.dark .sidebar-logout {
  border-top-color: #374151;
}

/* For mobile responsiveness */
@media (max-width: 768px) {
  .sidebar-container {
    height: auto;
    min-height: 100vh;
  }
}

/* Scrollbar styling */
.sidebar-content::-webkit-scrollbar {
  width: 4px;
}

.sidebar-content::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.sidebar-content::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 2px;
}

.sidebar-content::-webkit-scrollbar-thumb:hover {
  background: #555;
}

/* Dark mode scrollbar */
.dark .sidebar-content::-webkit-scrollbar-track {
  background: #374151;
}

.dark .sidebar-content::-webkit-scrollbar-thumb {
  background: #6b7280;
}

/* Prevent sidebar overlap issues */
.sidebar-navigation {
  overflow: visible !important;
  position: static !important;
}

/* Fix for modal z-index issues */
.modal-backdrop {
  z-index: 1000;
}

.modal-content {
  z-index: 1001;
}

/* Hide scrollbar for Chrome, Safari and Opera */
.no-scrollbar::-webkit-scrollbar {
  display: none;
}

/* Hide scrollbar for IE, Edge and Firefox */
.no-scrollbar {
  -ms-overflow-style: none;  /* IE and Edge */
  scrollbar-width: none;  /* Firefox */
}

/* Additional overflow and positioning fixes */
.sidebar-container {
  position: relative;
  overflow: visible;
}

.sidebar-container .fixed {
  position: relative !important;
}

.sidebar-container .absolute {
  position: relative !important;
}

/* Prevent negative margins and overlaps */
.sidebar-container > div {
  margin: 0 !important;
}

/* Ensure content doesn't get cut off */
.sidebar-content {
  padding-bottom: 80px; /* Make room for logout button */
}

/* Position logout area properly */
.sidebar-logout {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: inherit;
}

/* Override any problematic positioning */
.sidebar-container .bottom-0 {
  position: static !important;
}

.sidebar-container .left-0 {
  position: static !important;
}

.sidebar-container .right-0 {
  position: static !important;
}

/* Dark theme logout area */
.dark .sidebar-logout {
  background: #1f2937;
  border-top: 1px solid #374151;
}

/* Light theme logout area */
.sidebar-logout {
  background: white;
  border-top: 1px solid #e5e7eb;
}

/* Fix overflow issues in the container */
.sidebar-container {
  overflow-x: hidden;
  overflow-y: visible;
}

/* Make sure navigation doesn't get hidden */
.sidebar-navigation {
  position: relative;
  z-index: 1;
}

/* Logout button positioning */
.sidebar-logout {
  position: relative;
  z-index: 2;
}

/* Responsive fixes */
@media (min-width: 1024px) {
  .sidebar-container {
    height: 100vh;
    position: sticky;
    top: 0;
  }
}

/* Fix for small screens */
@media (max-width: 1023px) {
  .sidebar-logout {
    position: relative;
    margin-top: 2rem;
  }
  
  .sidebar-content {
    padding-bottom: 0;
  }
}

/* Additional positioning fixes */
.sidebar-container > div:last-child {
  margin-top: auto;
}

/* Override any transform or positioning that might cause issues */
.sidebar-container * {
  transform: none !important;
}

.sidebar-container .transform {
  transform: none !important;
}

/* Ensure proper layout flow */
.sidebar-container {
  display: flex;
  flex-direction: column;
}

.sidebar-navigation {
  flex: 1;
  min-height: 0;
}

.sidebar-logout {
  flex-shrink: 0;
}

/* More specific positioning override */
.sidebar-container [style*="position: fixed"],
.sidebar-container [style*="position: absolute"] {
  position: relative !important;
  top: auto !important;
  left: auto !important;
  right: auto !important;
  bottom: auto !important;
}

/* Force relative positioning for problematic elements */
.sidebar-container .absolute,
.sidebar-container .fixed {
  position: relative !important;
  inset: auto !important;
}

/* Alternative approach - hide problematic positioning */
.sidebar-container > div[class*="fixed"],
.sidebar-container > div[class*="absolute"] {
  position: relative !important;
  top: unset !important;
  left: unset !important;
  right: unset !important;
  bottom: unset !important;
}

/* Make logout area visible and prevent hiding */
.sidebar-logout {
  visibility: visible !important;
  display: block !important;
  opacity: 1 !important;
  position: relative !important;
  transform: none !important;
  top: auto !important;
  left: auto !important;
  right: auto !important;
  bottom: auto !important;
  margin-left: 0 !important;
  margin-right: 0 !important;
}

/* Ensure container doesn't hide content */
.sidebar-container {
  max-height: none !important;
  height: auto !important;
  min-height: 100vh;
  overflow: visible !important;
}

/* Force visibility for navigation items */
.sidebar-navigation > * {
  visibility: visible !important;
  position: relative !important;
}

/* Specific fix for logout button container */
.sidebar-container > div:has(.sidebar-logout),
.sidebar-container > div[class*="logout"] {
  position: relative !important;
  visibility: visible !important;
  display: block !important;
}

/* Last resort - force display */
.sidebar-logout,
.sidebar-logout * {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  position: relative !important;
  z-index: 999 !important;
}

/* Alternative container structure fix */
.sidebar-container {
  position: relative !important;
  display: flex !important;
  flex-direction: column !important;
  height: 100vh !important;
  overflow: visible !important;
}

.sidebar-navigation {
  flex: 1 !important;
  overflow-y: auto !important;
  position: relative !important;
}

.sidebar-logout {
  flex-shrink: 0 !important;
  position: relative !important;
  margin-top: auto !important;
}

/* Prevent any CSS that might hide the logout */
.sidebar-container * {
  max-height: none !important;
  overflow: visible !important;
}

/* Ensure proper spacing */
.sidebar-logout {
  padding: 1rem !important;
  margin: 0 !important;
  border-top: 1px solid #e5e7eb !important;
}

.dark .sidebar-logout {
  border-top-color: #374151 !important;
}

/* Remove any transforms or positions that could cause issues */
.sidebar-container * {
  position: static !important;
  transform: none !important;
  left: auto !important;
  right: auto !important;
  top: auto !important;
  bottom: auto !important;
}

/* Exception for the specific layout we want */
.sidebar-container {
  position: relative !important;
  display: flex !important;
  flex-direction: column !important;
}

.sidebar-logout {
  position: relative !important;
  margin-top: auto !important;
}

/* Force visibility for all sidebar elements */
.sidebar-container,
.sidebar-container *,
.sidebar-navigation,
.sidebar-navigation *,
.sidebar-logout,
.sidebar-logout * {
  visibility: visible !important;
  display: block !important;
  opacity: 1 !important;
}

.sidebar-container button,
.sidebar-logout button {
  display: inline-flex !important;
}

/* Ensure no content is cut off */
.sidebar-container {
  min-height: 100vh !important;
  height: auto !important;
  max-height: none !important;
  overflow-y: auto !important;
  overflow-x: hidden;
}

/* Final positioning fix */
.sidebar-container > div:last-child {
  position: relative !important;
  bottom: auto !important;
  left: auto !important;
  right: auto !important;
  margin-top: auto !important;
}

/* Ensure the logout button area is always visible */
.sidebar-logout {
  background: inherit !important;
  position: relative !important;
  z-index: 10 !important;
  margin-top: auto !important;
  flex-shrink: 0 !important;
}

/* Ensure proper stacking context */
.sidebar-container {
  z-index: 1 !important;
}

.sidebar-navigation {
  z-index: 2 !important;
  flex: 1 !important;
  overflow-y: auto !important;
}

.sidebar-logout {
  z-index: 3 !important;
  flex-shrink: 0 !important;
}

/* Remove problematic CSS classes that might interfere */
.sidebar-container .fixed,
.sidebar-container .absolute,
.sidebar-container .sticky {
  position: relative !important;
}

.sidebar-container .inset-0,
.sidebar-container .top-0,
.sidebar-container .bottom-0,
.sidebar-container .left-0,
.sidebar-container .right-0 {
  top: auto !important;
  bottom: auto !important;
  left: auto !important;
  right: auto !important;
  inset: auto !important;
}

/* Override Tailwind positioning utilities specifically in sidebar */
.sidebar-container .absolute {
  position: relative !important;
}

.sidebar-container .fixed {
  position: relative !important;
}

.sidebar-container .inset-x-0 {
  left: auto !important;
  right: auto !important;
}

.sidebar-container .inset-y-0 {
  top: auto !important;
  bottom: auto !important;
}

/* Make sure logout area has proper background */
.sidebar-logout {
  background-color: inherit !important;
}

/* Dark mode background fix */
.dark .sidebar-logout {
  background-color: #1f2937 !important;
}

/* Light mode background fix */
.sidebar-logout {
  background-color: white !important;
}

/* Additional safety measures */
.sidebar-container {
  contain: layout !important;
}

.sidebar-navigation {
  contain: layout !important;
}

/* Prevent any overflow issues */
.sidebar-container {
  overflow-x: hidden !important;
  overflow-y: visible !important;
}

/* Make sure content flows properly */
.sidebar-container > * {
  position: relative !important;
  width: 100% !important;
  flex-shrink: 0 !important;
}

.sidebar-navigation {
  flex-shrink: 1 !important;
  min-height: 0 !important;
}

.sidebar-logout {
  flex-shrink: 0 !important;
}

/* Final override for any problematic styles */
.sidebar-container * [class*="absolute"],
.sidebar-container * [class*="fixed"],
.sidebar-container * [style*="position: absolute"],
.sidebar-container * [style*="position: fixed"] {
  position: relative !important;
}

/* Emergency visibility fix */
.sidebar-container,
.sidebar-navigation,
.sidebar-logout {
  visibility: visible !important;
  display: flex !important;
  flex-direction: column !important;
}

.sidebar-container button,
.sidebar-navigation button,
.sidebar-logout button {
  display: inline-flex !important;
  visibility: visible !important;
}

/* Prevent hidden overflow */
.sidebar-container,
.sidebar-navigation {
  overflow: visible !important;
}

/* One more positioning fix attempt */
.sidebar-container > div:not(.sidebar-navigation):not(.sidebar-logout) {
  position: relative !important;
}

/* Fix for flex container */
.sidebar-container {
  display: flex !important;
  flex-direction: column !important;
  height: 100vh !important;
}

.sidebar-navigation {
  flex: 1 !important;
  display: block !important;
}

.sidebar-logout {
  display: block !important;
  margin-top: auto !important;
}

/* Ensure no elements are positioned outside the container */
.sidebar-container * {
  max-width: 100% !important;
  box-sizing: border-box !important;
}

/* Prevent any negative margins */
.sidebar-container * {
  margin-left: 0 !important;
  margin-right: 0 !important;
}

/* Ensure logout button container is part of the flow */
.sidebar-logout {
  width: 100% !important;
  box-sizing: border-box !important;
  padding: 1rem !important;
}

/* Override any external positioning */
.sidebar-container [style] {
  position: relative !important;
  top: auto !important;
  left: auto !important;
  right: auto !important;
  bottom: auto !important;
  transform: none !important;
}

/* Exception for the container itself */
.sidebar-container {
  position: relative !important;
  display: flex !important;
  flex-direction: column !important;
  transform: none !important;
}

/* Specific fix for any absolutely positioned children */
.sidebar-container > div {
  position: relative !important;
  display: block !important;
  width: 100% !important;
}

/* Ensure logout section is always at the bottom but visible */
.sidebar-logout {
  order: 999 !important;
  position: relative !important;
  margin-top: auto !important;
  background: inherit !important;
  border-top: 1px solid #e5e7eb !important;
}

.dark .sidebar-logout {
  border-top-color: #374151 !important;
  background: #1f2937 !important;
}

/* Override any CSS that might be hiding content */
.sidebar-container * {
  overflow: visible !important;
  clip: none !important;
  clip-path: none !important;
}

/* Ensure all content is accessible */
.sidebar-container * {
  height: auto !important;
  min-height: 0 !important;
  max-height: none !important;
}

/* Specific height for the navigation area */
.sidebar-navigation {
  min-height: 0 !important;
  height: auto !important;
  flex: 1 !important;
}

/* Specific height for logout area */
.sidebar-logout {
  height: auto !important;
  min-height: auto !important;
  flex: none !important;
}

/* Remove any CSS that might interfere with layout */
.sidebar-container .overflow-hidden {
  overflow: visible !important;
}

.sidebar-container .h-full {
  height: auto !important;
}

.sidebar-container .w-full {
  width: 100% !important;
}

/* Force proper display properties */
.sidebar-container {
  display: flex !important;
}

.sidebar-navigation {
  display: block !important;
  flex: 1 !important;
}

.sidebar-logout {
  display: block !important;
  flex: none !important;
}

/* Final attempt - use grid layout as backup */
.sidebar-container {
  display: grid !important;
  grid-template-rows: 1fr auto !important;
  height: 100vh !important;
}

.sidebar-navigation {
  grid-row: 1 !important;
  overflow-y: auto !important;
}

.sidebar-logout {
  grid-row: 2 !important;
}

/* Revert to flex if grid doesn't work */
.sidebar-container {
  display: flex !important;
  flex-direction: column !important;
}

/* Make absolutely sure logout is visible */
.sidebar-logout {
  visibility: visible !important;
  opacity: 1 !important;
  display: block !important;
  position: relative !important;
  z-index: 9999 !important;
  background: white !important;
  border-top: 1px solid #e5e7eb !important;
  padding: 1rem !important;
  margin: 0 !important;
  width: 100% !important;
  box-sizing: border-box !important;
}

.dark .sidebar-logout {
  background: #1f2937 !important;
  border-top-color: #374151 !important;
}

/* Ensure container doesn't cut off content */
.sidebar-container {
  overflow: visible !important;
  min-height: 100vh !important;
  height: auto !important;
  position: relative !important;
}

/* Force layout recalculation if needed */
.sidebar-container::after {
  content: "";
  display: block;
  clear: both;
  height: 0;
  visibility: hidden;
}

/* Logout button area fix */
.sidebar-logout {
  margin-top: auto;
  padding: 1rem;
  border-top: 1px solid #e5e7eb;
}

.sidebar-logout button {
  width: 100%;
  max-width: 200px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  padding: 0.75rem 1rem;
  border-radius: 0.375rem;
  transition: background-color 0.2s;
}

.sidebar-logout button:hover {
  background-color: #f9fafb;
}

/* Prevent any overlay issues */
.sidebar-container > div:last-child {
  position: relative !important;
  bottom: auto !important;
  left: auto !important;
  right: auto !important;
}

.test-mode-active {
  border: 4px solid #dc2626 !important;
  box-shadow: inset 0 0 0 4px #dc2626;
}
</style>
</head>
<body>
<div id="test-mode-indicator" style="display:none; background:#dc2626; color:white; text-align:center; padding:10px; font-weight:bold;">
  🧪 TEST MODE ACTIVE - Delete All buttons enabled
</div>
<script>if(localStorage.getItem('testMode')==='true') document.getElementById('test-mode-indicator').style.display='block';</script>
<div id="root"></div>
<div id="error-message" style="position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 12px 20px; border-radius: 6px; display: none; z-index: 9999;"></div>

<!-- API Configuration and Main App Script -->
<script>
// Show previous logs on page load
window.addEventListener('load', () => {
  const logs = JSON.parse(sessionStorage.getItem('debugLogs') || '[]');
  if (logs.length > 0) {
    
    logs.forEach(log => console.log('[' + (log.time) + '] ' + (log.key) + ':', log.data));
    console.log('=== End Previous Logs ===');
  }
});

// Clear logs button (press Ctrl+Shift+L)
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.shiftKey && e.key === 'L') {
    sessionStorage.removeItem('debugLogs');
    console.log('Debug logs cleared');
  }
});

const { useState, useEffect, useRef } = React;

// Safe Console Log Filter - Add this right after the React import
(function() {
  'use strict';
  
  const originalLog = console.log;
  
  // Patterns to suppress
  const suppressPatterns = [
    '✅', '🔍', '📊', '🔄', '🎯', '🚀', '❌', '🎉',
    'component loaded successfully',
    'All app effects initialized', 
    'Not showing allocation management',
    'Not showing delivery form',
    'Bulk Assign Modal',
    'ALLOCATION MANAGEMENT DEBUG',
    'DELIVERY FORM DEBUG',
    'Rendering Enhanced Recent Activity'
  ];
  
  console.log = function(...args) {
    const message = String(args[0] || '');
    const shouldSuppress = suppressPatterns.some(pattern => 
      message.includes(pattern)
    );
    if (!shouldSuppress) {
      originalLog.apply(console, args);
    }
  };
  
  window.toggleDebugLogs = function(enabled = true) {
    console.log = enabled ? originalLog : console.log;
  };
})();  

window.getRoleDisplayLabel = function(roleName) {
  const roleLabels = {
    'super_admin': 'Super Admin',
    'admin': 'Admin', 
    'sales_manager': 'Sales Manager',
    'sales_executive': 'Sales Executive',
    'finance': 'Finance',
    'supply': 'Supply',
    'warehouse': 'Warehouse'
  };
  return roleLabels[roleName] || roleName;
};

// Configure API endpoint
window.handleProceedFromPreview = () => {
  if (window.currentUploadFile) {
    console.log("🚀 Starting upload with file:", window.currentUploadFile.name);

    const cancelBtn = Array.from(document.querySelectorAll("button")).find(b => b.textContent === "Cancel");
    if (cancelBtn) cancelBtn.click();

    const formData = new FormData();
    formData.append("file", window.currentUploadFile);
    fetch(window.API_CONFIG.API_URL + "/upload/leads/csv", {
      method: "POST",
      headers: { Authorization: authToken ? 'Bearer ' + authToken : '' },
      body: formData
    }).then(response => response.json())
    .then(data => {
      if (data.success) {
        alert("✅ Upload successful!");
        window.location.reload();
      } else {
        alert("❌ Upload failed: " + (data.message || "Unknown error"));
      }
    }).catch(error => {
      console.error("Upload error:", error);
      alert("❌ Upload failed: " + error.message);
    });
  }
};

// ✅ Initialize the SimplifiedApp
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(window.SimplifiedApp));
</script>

<!-- CHART INITIALIZATION PATCH - PLACE AT THE END -->
<script>
// ===============================================
// EMERGENCY CHART INITIALIZATION PATCH
// ===============================================

window.fixChartInitialization = function() {
  console.log('🔧 Applying chart initialization fix...');
  
  // Clear any existing chart state
  if (window.chartState) {
    window.chartState.initialized = false;
    window.chartState.initializing = false;
    window.chartState.initAttempts = 0;
  }
  
  // Create a smart chart initializer that waits for proper DOM state
  window.smartChartInit = function() {
    return new Promise((resolve, reject) => {
      let attempts = 0;
      const maxAttempts = 15; // Reduced from 20
      
      const checkAndInit = () => {
        attempts++;
        
        // Check if we're on the dashboard tab
        if (window.activeTab !== 'dashboard') {
          console.log('⏭️ Not on dashboard tab, skipping chart init');
          resolve();
          return;
        }
        
        // Check for Chart.js
        if (typeof Chart === 'undefined') {
          if (attempts < maxAttempts) {
            setTimeout(checkAndInit, 500);
            return;
          } else {
            console.warn('⚠️ Chart.js not available after max attempts');
            resolve(); // Don't reject, just resolve without charts
            return;
          }
        }
        
        // Check for DOM containers with more specific selectors
        const containers = {
          leadSplit: document.querySelector('#leadSplitChart'),
          tempCount: document.querySelector('#tempCountChart'),
          tempValue: document.querySelector('#tempValueChart')
        };
        
        const missingContainers = Object.entries(containers)
          .filter(([key, element]) => !element)
          .map(([key]) => key);
        
        if (missingContainers.length > 0) {
          if (attempts < maxAttempts) {
            console.log(`⏳ Waiting for containers: ${missingContainers.join(', ')} (attempt ${attempts})`);
            setTimeout(checkAndInit, 500);
            return;
          } else {
            console.warn('⚠️ Chart containers not found after max attempts');
            resolve(); // Don't reject, just resolve without charts
            return;
          }
        }
        
        // All good - initialize charts
        try {
          console.log('✅ All chart prerequisites met, initializing...');
          
          // Use the fixed chart initialization
          if (window.initializeCharts) {
            window.initializeCharts()
              .then(() => {
                console.log('✅ Charts initialized successfully via smartChartInit');
                resolve();
              })
              .catch(error => {
                console.warn('⚠️ Chart initialization failed, but continuing:', error.message);
                resolve(); // Don't reject, just resolve without charts
              });
          } else {
            console.warn('⚠️ initializeCharts function not available');
            resolve();
          }
          
        } catch (error) {
          console.warn('⚠️ Chart initialization error:', error.message);
          resolve(); // Don't reject, just resolve without charts
        }
      };
      
      // Start the check
      checkAndInit();
    });
  };
  
  // Override the auto-initialization to use our smart version
  const originalInit = window.addEventListener;
  
  // Clear any existing event listeners for chart init
  window.removeEventListener('DOMContentLoaded', window.smartChartInit);
  
  // Add our fixed initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        window.smartChartInit().catch(console.warn);
      }, 1000); // Wait 1 second after DOM ready
    });
  } else {
    // DOM already ready
    setTimeout(() => {
      window.smartChartInit().catch(console.warn);
    }, 1000);
  }
  
  console.log('✅ Chart initialization fix applied');
};

// Auto-apply the fix
window.fixChartInitialization();

// Also add a manual trigger for dashboard tab switches
const originalSetActiveTab = window.setActiveTab;
if (originalSetActiveTab) {
  window.setActiveTab = function(tab) {
    originalSetActiveTab(tab);
    
    // If switching to dashboard, try to init charts
    if (tab === 'dashboard') {
      setTimeout(() => {
        if (!window.chartState?.initialized) {
          console.log('🎯 Dashboard activated, attempting chart initialization...');
          window.smartChartInit().catch(console.warn);
        }
      }, 500);
    }
  };
}

console.log('🔧 Emergency chart patch loaded');
console.log('🚀 FanToPark CRM - Fully Optimized & Fixed');
</script>

</body>
</html>
